<!DOCTYPE html>
<html class="dark" lang="en">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>WAVE - Main Chat Interface</title>
    <!-- Apply theme immediately to prevent flash -->
    <script>
        (function() {
            const theme = localStorage.getItem('theme') || 'dark';
            if (theme === 'dark') {
                document.documentElement.classList.add('dark');
            } else if (theme === 'light') {
                document.documentElement.classList.remove('dark');
            } else if (theme === 'auto') {
                if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
                    document.documentElement.classList.add('dark');
                } else {
                    document.documentElement.classList.remove('dark');
                }
            }
        })();
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols_Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
    <script src="/js/auth-guard.js"></script>
    <script src="/js/mobile-detector.js"></script>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#0db9f2",
                        "primary-hover": "#0a91be",
                        // Light mode colors
                        "bg-light": "#f5f8f8",
                        "bg-light-secondary": "#f5f8f8",
                        "surface-light": "#ffffff",
                        "surface-light-hover": "#f1f5f9",
                        "border-light": "#e2e8f0",
                        "text-light": "#0f172a",
                        "text-light-muted": "#64748b",
                        // Dark mode colors (new Wave design)
                        "bg-dark": "#101e22",
                        "bg-dark-secondary": "#0c161a",
                        "surface-dark": "#16262c",
                        "surface-dark-hover": "#1d2f36",
                        "border-dark": "#223f49",
                        "text-dark": "#ffffff",
                        "text-dark-muted": "#90bccb",
                    },
                    fontFamily: {
                        "display": ["Inter", "sans-serif"],
                        "body": ["Inter", "sans-serif"],
                    },
                    borderRadius: {
                        "DEFAULT": "0.5rem",
                        "lg": "0.75rem",
                        "xl": "1rem",
                        "2xl": "1.5rem",
                        "full": "9999px"
                    },
                    boxShadow: {
                        'glow': '0 0 15px -3px rgba(13, 185, 242, 0.3)',
                    }
                },
            },
        }
    </script>
    <style>
        /* Theme CSS Variables */
        :root {
            --bg-primary: #f5f8f8;
            --bg-secondary: #f5f8f8;
            --surface: #ffffff;
            --surface-hover: #f1f5f9;
            --border: #e2e8f0;
            --text-primary: #0f172a;
            --text-secondary: #64748b;
            --shadow: rgba(0, 0, 0, 0.1);
        }
        
        .dark {
            --bg-primary: #101e22;
            --bg-secondary: #0c161a;
            --surface: #16262c;
            --surface-hover: #1d2f36;
            --border: #223f49;
            --text-primary: #ffffff;
            --text-secondary: #90bccb;
            --shadow: rgba(13, 185, 242, 0.1);
        }
        
        body {
            background-color: var(--bg-primary);
            color: var(--text-primary);
        }
        /* Mobile-specific fixes */
        @media (max-width: 1279px) {
            #roomInfoPanel {
                display: none !important;
            }
            #chatScreen {
                grid-template-columns: 1fr !important;
            }
            /* Show back button on mobile */
            #backToRoomBtn {
                display: flex !important;
            }
        }
        
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        ::-webkit-scrollbar-track {
            background: var(--bg-secondary);
        }
        ::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 3px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: var(--surface-hover);
        }
        
        .glass-panel {
            background: var(--surface);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-bottom: 1px solid var(--border);
        }
        
        .dark .glass-panel {
            background: rgba(17, 17, 17, 0.95);
            border-bottom: 1px solid var(--border);
        }
        
        .login-screen {
            display: flex;
            position: fixed;
            inset: 0;
            z-index: 100;
        }
        
        .login-screen.hidden {
            display: none !important;
        }
        
        .chat-screen {
            display: none;
            position: fixed;
            inset: 0;
            z-index: 50;
        }
        
        .chat-screen.active {
            display: flex !important;
            flex-direction: column;
            height: 100vh;
        }
        
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
        }
        
        /* Popup and Modal Animations - Smoother with spring-like easing */
        #reactionPicker {
            opacity: 0;
            transform: scale(0.9) translateY(8px);
            transition: opacity 0.35s cubic-bezier(0.34, 1.56, 0.64, 1), 
                        transform 0.35s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        
        #attachmentMenu {
            opacity: 0;
            transform: scale(0.9) translateY(8px);
            transition: opacity 0.35s cubic-bezier(0.34, 1.56, 0.64, 1), 
                        transform 0.35s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        
        #searchResults {
            opacity: 0;
            transform: translateY(-8px);
            transition: opacity 0.3s cubic-bezier(0.16, 1, 0.3, 1), 
                        transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }
        
        #pollModal, #settingsModal, #newDMModal, #createJoinRoomModal {
            opacity: 0;
            transition: opacity 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }
        
        #pollModal .bg-surface-dark, #settingsModal .bg-surface-dark, #newDMModal .bg-surface-dark, #createJoinRoomModal .bg-surface-dark {
            transform: scale(0.92);
            opacity: 0;
            transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1), 
                        opacity 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }
        
        /* Message animations - Smoother slide in */
        .message-enter {
            animation: messageSlideIn 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }
        
        @keyframes messageSlideIn {
            from {
                opacity: 0;
                transform: translateY(15px) scale(0.98);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        
        /* Button hover animations - Smoother */
        button {
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        button:hover {
            transform: translateY(-1px);
        }
        
        button:active {
            transform: scale(0.96) translateY(0);
            transition: all 0.1s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        /* Smooth transitions for all interactive elements */
        .transition-all {
            transition-property: all;
            transition-timing-function: cubic-bezier(0.16, 1, 0.3, 1);
            transition-duration: 250ms;
        }
        
        /* Hover effects for interactive elements */
        .hover\:bg-surface-lighter:hover,
        .hover\:bg-primary\/20:hover,
        .hover\:bg-primary-hover:hover {
            transition: background-color 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        /* Backdrop blur animation */
        @keyframes backdropFadeIn {
            from {
                backdrop-filter: blur(0px);
                -webkit-backdrop-filter: blur(0px);
            }
            to {
                backdrop-filter: blur(8px);
                -webkit-backdrop-filter: blur(8px);
            }
        }
        
        /* DM notification slide up animation */
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .animate-slide-up {
            animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards;
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        
        /* Chat tabs */
        .chat-tab {
            position: relative;
            transition: all 0.2s ease;
            border-bottom: 2px solid transparent;
        }
        
        .chat-tab:not(.active) {
            color: #94a3b8;
            background: transparent;
        }
        
        .chat-tab:not(.active):hover {
            color: #fff;
            background: rgba(255, 255, 255, 0.05);
        }
        
        .chat-tab .close-tab {
            opacity: 0;
            transition: opacity 0.2s;
        }
        
        .chat-tab:hover .close-tab {
            opacity: 1;
        }
        
        .chat-tab.has-unread .tab-name::after {
            content: '';
            position: absolute;
            top: 8px;
            right: 8px;
            width: 8px;
            height: 8px;
            background: #3b82f6;
            border-radius: 50%;
        }
        
        /* Smooth scroll behavior */
        * {
            scroll-behavior: smooth;
        }
        
        /* Mobile responsive adjustments */
        @media (max-width: 768px) {
            .chat-screen {
                padding-bottom: 5rem;
            }
        }
    </style>
</head>
<body class="bg-background-dark font-display text-text-main h-screen overflow-hidden flex flex-col">
    <!-- Loading Screen (shown while checking auth) -->
    <div class="login-screen h-full items-center justify-center bg-background-dark" id="loginScreen">
        <div class="w-full max-w-md p-8 bg-surface-dark rounded-2xl border border-slate-800 shadow-2xl">
            <div class="flex flex-col items-center gap-6">
                <div class="w-16 h-16 rounded-full bg-gradient-to-tr from-surface-dark to-primary flex items-center justify-center shadow-lg animate-pulse">
                    <span class="material-symbols-outlined text-primary text-4xl">waves</span>
                </div>
                <div class="text-center">
                    <img src="/nobackweave.png" alt="WaveChat" class="h-16 w-16 mx-auto mb-4 object-contain theme-logo" data-theme-logo />
                    <h1 class="text-white text-4xl font-bold mb-2">WAVE</h1>
                    <p class="text-text-muted text-sm">Checking authentication...</p>
                </div>
                <div class="w-12 h-12 border-4 border-primary/30 border-t-primary rounded-full animate-spin"></div>
            </div>
        </div>
    </div>
    
    <!-- Chat Screen -->
    <div class="chat-screen" id="chatScreen">
        <!-- Window Controls (Desktop only) -->
        <div class="h-8 bg-[#0b1120] hidden lg:flex items-center justify-between px-4 select-none shrink-0 border-b border-slate-800/50">
            <div class="flex items-center gap-2">
                <span class="material-symbols-outlined text-primary text-[18px]">waves</span>
                <span class="text-xs font-semibold tracking-wide text-slate-400">WAVE Messenger</span>
            </div>
            <div class="flex gap-4">
                <div class="w-3 h-3 rounded-full bg-slate-600 hover:bg-slate-500 cursor-pointer"></div>
                <div class="w-3 h-3 rounded-full bg-slate-600 hover:bg-slate-500 cursor-pointer"></div>
                <div class="w-3 h-3 rounded-full bg-slate-600 hover:bg-primary cursor-pointer"></div>
            </div>
        </div>
        
        <!-- Main Layout -->
        <div class="flex flex-1 overflow-hidden pb-20 lg:pb-0">
            <!-- LEFT SIDEBAR (Desktop only) -->
            <aside class="hidden lg:flex w-80 flex-col bg-surface-dark border-r border-slate-800 shrink-0 z-20">
                <!-- Profile & Search Header -->
                <div class="p-4 pb-2">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <div class="relative group cursor-pointer">
                                <div class="w-10 h-10 rounded-full bg-surface-lighter flex items-center justify-center border-2 border-transparent group-hover:border-primary transition-all">
                                    <span class="material-symbols-outlined text-text-muted">person</span>
                                </div>
                                <div class="absolute bottom-0 right-0 w-3 h-3 bg-accent-cyan border-2 border-surface-dark rounded-full"></div>
                            </div>
                            <div class="flex flex-col">
                                <span class="text-sm font-bold text-white" id="userNickname">User</span>
                                <span class="text-xs text-primary cursor-pointer hover:underline" id="setStatusLink">Set Status</span>
                            </div>
                        </div>
                        <a href="/settings.html" class="text-slate-400 hover:text-primary transition-colors">
                            <span class="material-symbols-outlined">settings</span>
                        </a>
                    </div>
                    
                    <!-- Search Bar -->
                    <div class="relative group mt-3 flex gap-2">
                        <div class="flex-1 relative">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <span class="material-symbols-outlined text-slate-400 group-focus-within:text-primary text-[20px]">search</span>
                            </div>
                            <input id="sidebarSearchInput" class="block w-full pl-10 pr-3 py-2 border-none rounded-lg bg-surface-lighter text-white placeholder-slate-400 focus:outline-none focus:ring-1 focus:ring-primary text-sm transition-all" placeholder="Search users & channels..." type="text"/>
                            <!-- Search Results Dropdown -->
                            <div id="sidebarSearchResults" class="absolute top-full left-0 right-0 mt-2 bg-surface-dark border border-slate-700 rounded-lg shadow-xl max-h-64 overflow-y-auto hidden z-50"></div>
                        </div>
                        <button id="createJoinRoomBtn" class="w-10 h-10 flex items-center justify-center rounded-lg bg-primary hover:bg-primary-hover text-white transition-colors shrink-0" title="Create/Join Room">
                            <span class="material-symbols-outlined text-[20px]">add</span>
                        </button>
                    </div>
                </div>
                
                <!-- Chats Section (DMs + Rooms together) -->
                <div class="flex-1 overflow-y-auto px-4 py-3">
                    <h3 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Chats</h3>
                    <div id="chatsList" class="space-y-1">
                        <!-- DMs and Rooms will be added here dynamically -->
                    </div>
                </div>
            </aside>
            
            <!-- MAIN CHAT AREA -->
            <main class="flex-1 flex flex-col relative bg-background-dark min-w-0">
                <!-- Top Bar (Glassmorphism) -->
                <header class="h-16 px-6 flex items-center justify-between z-10 glass-panel sticky top-0">
                    <div class="flex items-center gap-4">
                        <button id="backToRoomBtn" class="w-10 h-10 flex items-center justify-center rounded-lg hover:bg-surface-lighter text-slate-400 hover:text-primary transition-colors hidden">
                            <span class="material-symbols-outlined">arrow_back</span>
                        </button>
                        <img src="/nobackweave.png" alt="WaveChat" class="h-8 w-8 object-contain theme-logo" data-theme-logo />
                        <div class="flex flex-col">
                            <h1 class="text-lg font-bold text-white flex items-center gap-2" id="roomName">
                                Design Clan
                                <span class="material-symbols-outlined text-primary text-sm">verified</span>
                            </h1>
                            <p id="roomStatus" class="text-xs text-primary font-medium">Active now</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-4">
                        <button class="w-10 h-10 flex items-center justify-center rounded-lg hover:bg-surface-lighter text-slate-400 transition-colors">
                            <span class="material-symbols-outlined">search</span>
                        </button>
                        <a href="/feed.html" class="w-10 h-10 flex items-center justify-center rounded-lg hover:bg-surface-lighter text-slate-400 hover:text-primary transition-colors" title="Feed">
                            <span class="material-symbols-outlined">newspaper</span>
                        </a>
                        <a href="/music.html" id="musicBtn" class="w-10 h-10 flex items-center justify-center rounded-lg hover:bg-surface-lighter text-slate-400 hover:text-primary transition-colors" title="Music">
                            <span class="material-symbols-outlined">music_note</span>
                        </a>
                        <a href="/ai-chat.html" id="aiBtn" class="w-10 h-10 flex items-center justify-center rounded-lg hover:bg-surface-lighter text-slate-400 hover:text-primary transition-colors" title="AI Assistant">
                            <span class="material-symbols-outlined">smart_toy</span>
                        </a>
                        <a href="/profile.html" class="w-10 h-10 flex items-center justify-center rounded-lg hover:bg-surface-lighter text-slate-400 hover:text-primary transition-colors" title="Profile">
                            <span class="material-symbols-outlined">person</span>
                        </a>
                        <a href="/settings.html" class="w-10 h-10 flex items-center justify-center rounded-lg hover:bg-surface-lighter text-slate-400 hover:text-primary transition-colors" title="Settings">
                            <span class="material-symbols-outlined">settings</span>
                        </a>
                        <button class="w-10 h-10 flex items-center justify-center rounded-lg hover:bg-surface-lighter text-slate-400 transition-colors lg:hidden">
                            <span class="material-symbols-outlined">info</span>
                        </button>
                    </div>
                </header>
                <!-- Message Feed Container -->
                <div class="flex-1 relative overflow-hidden">
                    <!-- Message Feed -->
                    <div class="h-full overflow-y-auto px-6 py-6 space-y-6 scroll-smooth" id="messagesFeed">
                        <!-- Pinned Messages Section -->
                        <div id="pinnedMessages" class="hidden mb-4 bg-surface-dark/50 border border-primary/30 rounded-xl p-4">
                            <div class="flex items-center justify-between mb-2">
                                <div class="flex items-center gap-2">
                                    <span class="material-symbols-outlined text-primary text-[20px]">push_pin</span>
                                    <span class="text-sm font-bold text-white">Pinned Messages</span>
                                </div>
                                <button id="closePinnedBtn" class="text-slate-400 hover:text-white">
                                    <span class="material-symbols-outlined text-[18px]">close</span>
                                </button>
                            </div>
                            <div id="pinnedMessagesList" class="space-y-2 max-h-32 overflow-y-auto">
                                <!-- Pinned messages will appear here -->
                            </div>
                        </div>
                        
                        <!-- Date Separator -->
                        <div class="flex justify-center">
                            <span class="text-xs font-semibold text-slate-400 bg-surface-lighter px-3 py-1 rounded-full uppercase tracking-wider">Today</span>
                        </div>
                        <div id="messages" class="space-y-6"></div>
                    </div>
                    
                    <!-- Scroll to Bottom Button (absolute to message feed container) -->
                    <button id="scrollToBottomBtn" class="hidden absolute bottom-6 right-6 w-12 h-12 bg-primary hover:bg-primary-hover rounded-full shadow-lg flex items-center justify-center text-white transition-all z-30">
                        <span class="material-symbols-outlined">arrow_downward</span>
                        <span id="unreadCount" class="hidden absolute -top-1 -right-1 bg-red-500 text-white text-xs font-bold rounded-full w-5 h-5 flex items-center justify-center">0</span>
                    </button>
                </div>
                <!-- Input Area -->
                <div class="p-6 pt-2 pb-6">
                    <!-- Typing Indicator -->
                    <div id="typingIndicator" class="mb-2 px-2 text-xs text-slate-400 italic hidden">
                        <span id="typingText"></span>
                    </div>
                    
                    <div class="bg-surface-dark rounded-xl border border-slate-800 shadow-lg flex items-end p-2 gap-2 relative z-20">
                        <button id="attachmentBtn" class="p-2 text-slate-400 hover:text-primary transition-colors rounded-lg hover:bg-surface-lighter">
                            <span class="material-symbols-outlined">add_circle</span>
                        </button>
                        <div class="flex-1 py-2">
                            <input id="messageInput" class="w-full bg-transparent border-none text-sm text-white placeholder-slate-400 focus:ring-0 p-0 outline-none" placeholder="Type a message..." type="text"/>
                        </div>
                        <div class="flex items-center gap-1">
                            <button id="emojiBtn" class="p-2 text-slate-400 hover:text-primary transition-colors rounded-lg hover:bg-surface-lighter">
                                <span class="material-symbols-outlined">sentiment_satisfied</span>
                            </button>
                            <button id="pollBtn" class="p-2 text-slate-400 hover:text-primary transition-colors rounded-lg hover:bg-surface-lighter" title="Create Poll">
                                <span class="material-symbols-outlined">poll</span>
                            </button>
                            <button id="voiceBtn" class="p-2 text-slate-400 hover:text-primary transition-colors rounded-lg hover:bg-surface-lighter">
                                <span class="material-symbols-outlined">mic</span>
                            </button>
                            <button id="sendButton" class="p-2 bg-primary hover:bg-primary-hover text-white rounded-lg shadow-md shadow-primary/20 transition-all ml-1 flex items-center justify-center">
                                <span class="material-symbols-outlined text-[20px]">send</span>
                            </button>
                        </div>
                    </div>
                </div>
            </main>
            
            <!-- RIGHT PANEL (Info & Widgets - Desktop only) -->
            <aside id="roomInfoPanel" class="w-80 bg-surface-dark border-l border-slate-800 shrink-0 hidden xl:flex flex-col overflow-y-auto">
                <!-- Group Header -->
                <div class="p-6 flex flex-col items-center border-b border-slate-800">
                    <div class="w-24 h-24 rounded-full bg-surface-lighter shadow-lg ring-4 ring-background-dark mb-4 flex items-center justify-center">
                        <span class="material-symbols-outlined text-primary text-5xl">waves</span>
                    </div>
                    <h2 class="text-xl font-bold text-white mb-1" id="roomNameRight">Room</h2>
                    <p class="text-sm text-slate-400 text-center mb-4">WaveChat room</p>
                    <div class="flex gap-4 w-full">
                        <button class="flex-1 py-2 rounded-lg bg-surface-lighter hover:bg-slate-700 text-sm font-medium text-white transition-colors flex items-center justify-center gap-2">
                            <span class="material-symbols-outlined text-[18px]">notifications_off</span>
                            Mute
                        </button>
                        <button class="flex-1 py-2 rounded-lg bg-surface-lighter hover:bg-slate-700 text-sm font-medium text-white transition-colors flex items-center justify-center gap-2">
                            <span class="material-symbols-outlined text-[18px]">group_add</span>
                            Add
                        </button>
                    </div>
                </div>
                <!-- Room Info -->
                <div class="p-4 flex-1">
                    <h3 class="text-sm font-bold text-white mb-3">Room Settings</h3>
                    
                    <!-- Notification Toggle -->
                    <div class="mb-4 p-3 bg-surface-lighter rounded-lg">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-sm text-white">Notifications</span>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="notificationToggle" class="sr-only peer">
                                <div class="w-11 h-6 bg-slate-700 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-primary rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary"></div>
                            </label>
                        </div>
                        <p class="text-xs text-slate-400">Get notified for new messages</p>
                    </div>
                    
                    <!-- Room Code Regeneration / Create Room -->
                    <div class="mb-4" id="roomActionContainer">
                        <!-- Create Room Button (shown when no room) -->
                        <button id="createNewRoomBtn" class="hidden w-full py-2 px-4 bg-primary hover:bg-primary-hover border border-primary rounded-lg text-sm font-medium text-white transition-colors flex items-center justify-center gap-2 shadow-lg shadow-primary/20">
                            <span class="material-symbols-outlined text-[18px]">add_circle</span>
                            Create New Room
                        </button>
                        
                        <!-- Regenerate Code Button (shown when in room) -->
                        <button id="regenerateCodeBtn" class="hidden w-full py-2 px-4 bg-surface-lighter hover:bg-slate-700 border border-slate-700 rounded-lg text-sm font-medium text-white transition-colors flex items-center justify-center gap-2">
                            <span class="material-symbols-outlined text-[18px]">refresh</span>
                            Regenerate Room Code
                        </button>
                    </div>
                    
                    <h3 class="text-sm font-bold text-white mb-3 mt-6">Room Members</h3>
                    <div id="roomMembersList" class="space-y-2 mb-6">
                        <!-- Members will be added here dynamically -->
                        <div class="text-xs text-slate-400 text-center py-2">No room joined</div>
                    </div>
                    
                    <h3 class="text-sm font-bold text-white mb-3 mt-6">Room Info</h3>
                    <div id="roomInfoContainer" class="space-y-2">
                        <!-- No Room State -->
                        <div id="noRoomState" class="p-4 bg-surface-lighter rounded-lg text-center">
                            <span class="material-symbols-outlined text-slate-500 text-4xl mb-2">meeting_room</span>
                            <p class="text-xs text-slate-400 mb-3">Not in a room yet</p>
                            <button id="quickCreateRoomBtn" class="w-full py-2 px-4 bg-primary hover:bg-primary-hover rounded-lg text-xs font-medium text-white transition-colors">
                                Create Room
                            </button>
                        </div>
                        
                        <!-- Room Code Display (shown when in room) -->
                        <div id="roomCodeContainer" class="hidden p-3 bg-surface-lighter rounded-lg">
                            <div class="flex items-center justify-between">
                                <span class="text-xs text-slate-400">Room Code</span>
                                <button id="copyRoomCodeBtn" class="text-xs text-primary hover:text-primary-hover transition-colors flex items-center gap-1">
                                    <span class="material-symbols-outlined text-[14px]">content_copy</span>
                                    Copy
                                </button>
                            </div>
                            <p id="roomCodeDisplay" class="text-sm font-mono font-bold text-white mt-1">-</p>
                        </div>
                    </div>
                </div>
            </aside>
            
            <!-- MOBILE BOTTOM NAVIGATION -->
            <nav id="mobileBottomNav" class="fixed bottom-0 left-0 right-0 z-50 bg-surface-dark/95 backdrop-blur-lg border-t border-slate-800 lg:hidden">
                <div class="flex justify-between items-center h-20 px-6 pb-2">
                    <!-- Chats Tab -->
                    <button data-tab="chats" class="mobile-tab-btn flex flex-col items-center gap-1 w-12 text-primary transition-colors">
                        <div class="w-10 h-8 flex items-center justify-center bg-primary/10 rounded-full">
                            <span class="material-symbols-outlined fill-current" style="font-size: 24px;">chat_bubble</span>
                        </div>
                        <span class="text-[10px] font-semibold">Chats</span>
                    </button>
                    
                    <!-- Music Tab -->
                    <a href="/music.html" class="mobile-tab-btn flex flex-col items-center gap-1 w-12 text-slate-400 hover:text-slate-200 transition-colors">
                        <span class="material-symbols-outlined" style="font-size: 24px;">music_note</span>
                        <span class="text-[10px] font-medium">Music</span>
                    </a>
                    
                    <!-- Feed Center Button -->
                    <a href="/feed.html" class="mobile-tab-btn flex flex-col items-center justify-center -mt-6">
                        <div class="w-14 h-14 rounded-full bg-gradient-to-tr from-primary to-blue-400 shadow-[0_8px_16px_rgba(43,140,238,0.3)] flex items-center justify-center text-white transform active:scale-95 transition-transform">
                            <span class="material-symbols-outlined" style="font-size: 28px;">newspaper</span>
                        </div>
                    </a>
                    
                    <!-- AI Tab -->
                    <a href="/ai-chat.html" class="mobile-tab-btn flex flex-col items-center gap-1 w-12 text-slate-400 hover:text-slate-200 transition-colors">
                        <span class="material-symbols-outlined" style="font-size: 24px;">smart_toy</span>
                        <span class="text-[10px] font-medium">AI</span>
                    </a>
                    
                    <!-- Profile Tab -->
                    <a href="/profile.html" class="mobile-tab-btn flex flex-col items-center gap-1 w-12 text-slate-400 hover:text-slate-200 transition-colors">
                        <div class="w-6 h-6 rounded-full overflow-hidden bg-slate-700 ring-2 ring-transparent hover:ring-primary transition-all">
                            <span class="material-symbols-outlined text-slate-400 text-[20px]">person</span>
                        </div>
                        <span class="text-[10px] font-medium">Profile</span>
                    </a>
                </div>
            </nav>
            
            <!-- MOBILE TAB CONTENT CONTAINERS - Removed, now using separate pages -->
        </div>
    </div>
    
    <!-- Attachment Menu -->
    <div id="attachmentMenu" class="fixed bg-surface-dark border border-slate-700 rounded-xl shadow-2xl z-50 hidden">
        <div class="p-2 space-y-1 min-w-[200px]">
            <button id="attachImage" class="w-full px-4 py-3 hover:bg-surface-lighter rounded-lg text-left flex items-center gap-3 text-white transition-colors">
                <span class="material-symbols-outlined text-primary">image</span>
                <span class="text-sm">Image</span>
            </button>
            <button id="attachFile" class="w-full px-4 py-3 hover:bg-surface-lighter rounded-lg text-left flex items-center gap-3 text-white transition-colors">
                <span class="material-symbols-outlined text-primary">attach_file</span>
                <span class="text-sm">File</span>
            </button>
            <button id="attachSticker" class="w-full px-4 py-3 hover:bg-surface-lighter rounded-lg text-left flex items-center gap-3 text-white transition-colors">
                <span class="material-symbols-outlined text-primary">emoji_emotions</span>
                <span class="text-sm">Sticker</span>
            </button>
            <button id="attachAudio" class="w-full px-4 py-3 hover:bg-surface-lighter rounded-lg text-left flex items-center gap-3 text-white transition-colors">
                <span class="material-symbols-outlined text-primary">audio_file</span>
                <span class="text-sm">Audio (MP3)</span>
            </button>
            <div class="h-px bg-slate-700 my-1"></div>
            <button id="startVoiceCall" class="w-full px-4 py-3 hover:bg-surface-lighter rounded-lg text-left flex items-center gap-3 text-white transition-colors">
                <span class="material-symbols-outlined text-accent-cyan">call</span>
                <span class="text-sm">Voice Call</span>
            </button>
        </div>
    </div>
    
    <!-- Poll Creation Modal -->
    <div id="pollModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden flex items-center justify-center">
        <div class="bg-surface-dark border border-slate-700 rounded-2xl p-6 w-full max-w-md shadow-2xl">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-bold text-white">Create Poll</h3>
                <button id="closePollModal" class="text-slate-400 hover:text-white">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>
            <div class="space-y-4">
                <input id="pollQuestion" type="text" placeholder="Ask a question..." class="w-full px-4 py-3 bg-surface-lighter border border-slate-700 rounded-lg text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-primary"/>
                <div id="pollOptions" class="space-y-2">
                    <input type="text" placeholder="Option 1" class="poll-option w-full px-4 py-2 bg-surface-lighter border border-slate-700 rounded-lg text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-primary"/>
                    <input type="text" placeholder="Option 2" class="poll-option w-full px-4 py-2 bg-surface-lighter border border-slate-700 rounded-lg text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-primary"/>
                </div>
                <button id="addPollOption" class="text-sm text-primary hover:text-primary-hover flex items-center gap-1">
                    <span class="material-symbols-outlined text-[18px]">add</span>
                    Add Option
                </button>
                <div class="flex gap-3">
                    <button id="cancelPoll" class="flex-1 py-2 px-4 bg-surface-lighter hover:bg-slate-700 rounded-lg text-white font-medium transition-colors">
                        Cancel
                    </button>
                    <button id="createPoll" class="flex-1 py-2 px-4 bg-primary hover:bg-primary-hover rounded-lg text-white font-medium transition-colors">
                        Create Poll
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Reaction Picker Modal -->
    <div id="reactionPicker" class="fixed bg-surface-dark border border-slate-700 rounded-xl p-3 shadow-2xl z-50 hidden">
        <div class="grid grid-cols-8 gap-2">
            <button class="reaction-btn text-2xl hover:scale-125 transition-transform">üëç</button>
            <button class="reaction-btn text-2xl hover:scale-125 transition-transform">‚ù§Ô∏è</button>
            <button class="reaction-btn text-2xl hover:scale-125 transition-transform">üòÇ</button>
            <button class="reaction-btn text-2xl hover:scale-125 transition-transform">üòÆ</button>
            <button class="reaction-btn text-2xl hover:scale-125 transition-transform">üò¢</button>
            <button class="reaction-btn text-2xl hover:scale-125 transition-transform">üôè</button>
            <button class="reaction-btn text-2xl hover:scale-125 transition-transform">üéâ</button>
            <button class="reaction-btn text-2xl hover:scale-125 transition-transform">üî•</button>
            <button class="reaction-btn text-2xl hover:scale-125 transition-transform">üëè</button>
            <button class="reaction-btn text-2xl hover:scale-125 transition-transform">üíØ</button>
            <button class="reaction-btn text-2xl hover:scale-125 transition-transform">‚ú®</button>
            <button class="reaction-btn text-2xl hover:scale-125 transition-transform">üöÄ</button>
            <button class="reaction-btn text-2xl hover:scale-125 transition-transform">üëÄ</button>
            <button class="reaction-btn text-2xl hover:scale-125 transition-transform">ü§î</button>
            <button class="reaction-btn text-2xl hover:scale-125 transition-transform">üòé</button>
            <button class="reaction-btn text-2xl hover:scale-125 transition-transform">üí™</button>
        </div>
    </div>
    
    <!-- Create/Join Room Modal -->
    <div id="createJoinRoomModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden flex items-center justify-center">
        <div class="bg-surface-dark border border-slate-700 rounded-2xl p-6 w-full max-w-md shadow-2xl">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-bold text-white">Create or Join Room</h3>
                <button id="closeCreateJoinModal" class="text-slate-400 hover:text-white">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-slate-300 mb-2">Room Code</label>
                    <input id="roomCodeInput" class="block w-full px-3 py-2 border-none rounded-lg bg-surface-lighter text-white placeholder-slate-400 focus:outline-none focus:ring-1 focus:ring-primary text-sm" placeholder="Enter room code to join..." type="text"/>
                    <p class="text-xs text-slate-400 mt-1">Leave empty to create a new room</p>
                </div>
                <button id="submitRoomBtn" class="w-full py-2 px-4 bg-primary hover:bg-primary-hover rounded-lg text-white font-medium transition-colors">
                    Continue
                </button>
            </div>
        </div>
    </div>
    
    <!-- New DM Modal -->
    <div id="newDMModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden flex items-center justify-center">
        <div class="bg-surface-dark border border-slate-700 rounded-2xl p-6 w-full max-w-md shadow-2xl">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-bold text-white">New Direct Message</h3>
                <button id="closeNewDMModal" class="text-slate-400 hover:text-white">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-slate-300 mb-2">Search for a user</label>
                    <div class="relative">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <span class="material-symbols-outlined text-slate-400 text-[20px]">search</span>
                        </div>
                        <input id="dmUserSearchInput" class="block w-full pl-10 pr-3 py-2 border-none rounded-lg bg-surface-lighter text-white placeholder-slate-400 focus:outline-none focus:ring-1 focus:ring-primary text-sm" placeholder="Type username..." type="text"/>
                    </div>
                    <!-- Search Results -->
                    <div id="dmSearchResults" class="mt-2 max-h-64 overflow-y-auto space-y-1 hidden"></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Settings Modal -->
    <div id="settingsModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden flex items-center justify-center">
        <div class="bg-surface-dark border border-slate-700 rounded-2xl p-6 w-full max-w-md shadow-2xl">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-lg font-bold text-white">Settings</h3>
                <button id="closeSettingsModal" class="text-slate-400 hover:text-white">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>
            <div class="space-y-4">
                <!-- Profile Section -->
                <div class="pb-4 border-b border-slate-700">
                    <h4 class="text-sm font-bold text-white mb-3">Profile</h4>
                    <div class="flex items-center gap-3 mb-3">
                        <div class="w-12 h-12 rounded-full bg-surface-lighter flex items-center justify-center">
                            <span class="material-symbols-outlined text-slate-400">person</span>
                        </div>
                        <div>
                            <p class="text-sm font-medium text-white" id="settingsNickname">User</p>
                            <p class="text-xs text-slate-400" id="settingsUsername">@username</p>
                        </div>
                    </div>
                </div>
                
                <!-- Notifications -->
                <div class="pb-4 border-b border-slate-700">
                    <h4 class="text-sm font-bold text-white mb-3">Notifications</h4>
                    <div class="flex items-center justify-between">
                        <span class="text-sm text-slate-300">Desktop Notifications</span>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="settingsNotificationToggle" class="sr-only peer">
                            <div class="w-11 h-6 bg-slate-700 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-primary rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary"></div>
                        </label>
                    </div>
                </div>
                
                <!-- Theme -->
                <div class="pb-4 border-b border-slate-700">
                    <h4 class="text-sm font-bold text-white mb-3">Appearance</h4>
                    <button class="w-full py-2 px-4 bg-surface-lighter hover:bg-slate-700 rounded-lg text-sm text-white transition-colors text-left">
                        Theme: Dark Mode
                    </button>
                </div>
                
                <!-- Actions -->
                <div class="space-y-2">
                    <button id="clearChatBtn" class="w-full py-2 px-4 bg-surface-lighter hover:bg-slate-700 rounded-lg text-sm text-white transition-colors text-left flex items-center gap-2">
                        <span class="material-symbols-outlined text-[18px]">delete_sweep</span>
                        Clear Chat History
                    </button>
                    <button id="logoutBtn" class="w-full py-2 px-4 bg-red-500/20 hover:bg-red-500/30 border border-red-500/50 rounded-lg text-sm text-red-400 transition-colors text-left flex items-center gap-2">
                        <span class="material-symbols-outlined text-[18px]">logout</span>
                        Logout
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Invite Notifications Container -->
    <div id="inviteNotifications" class="fixed top-20 right-4 z-50 space-y-3 max-w-sm">
        <!-- Invite notifications will be added here dynamically -->
    </div>
    
    <!-- Socket.IO -->
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    
    <!-- 
      Application Architecture:
      - config.js: Configuration management
      - utils.js: Helper functions
      - api.js: HTTP API client (REST)
      - socket.js: WebSocket manager (real-time)
      - state.js: State management (reactive)
      - ui.js: DOM manipulation (view)
      - app.js: Application controller (coordinator)
      
      See /js/README.md for full documentation
    -->
    <script src="/js/config.js"></script>
    <script src="/js/utils.js"></script>
    <script src="/js/api.js"></script>
    <script src="/js/socket.js"></script>
    <script src="/js/state.js"></script>
    <script src="/js/ui.js"></script>
    <script src="/js/app.js"></script>
    
    <!-- Mobile back button handler -->
    <script>
        // Add back button handler for mobile
        document.addEventListener('DOMContentLoaded', () => {
            const backBtn = document.getElementById('backToRoomBtn');
            if (backBtn) {
                backBtn.addEventListener('click', () => {
                    // Check if we're on mobile
                    const isMobile = window.innerWidth <= 1279;
                    if (isMobile) {
                        // Go back to mobile chat list
                        window.location.href = '/mobile/chat.html';
                    }
                });
            }
        });
    </script>
</body>
</html>
