<!doctype html>
<html class="dark" lang="en">
    <head>
        <meta charset="utf-8" />
        <meta content="width=device-width, initial-scale=1.0" name="viewport" />
        <title>WaveFeed - Channels</title>
        <script src="/js/theme-init.js"></script>
        <link href="/css/theme.css" rel="stylesheet" />
        <link
            href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap"
            rel="stylesheet"
        />
        <link
            href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap"
            rel="stylesheet"
        />
        <link
            href="https://vjs.zencdn.net/8.23.4/video-js.css"
            rel="stylesheet"
        />
        <script src="/js/auth-guard.js"></script>
        <script src="/js/mobile-detector.js"></script>
        <script src="/js/update-checker.js"></script>
        <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
        <script>
            tailwind.config = {
                darkMode: "class",
                theme: {
                    extend: {
                        colors: {
                            primary: "#0db9f2",
                            "primary-soft": "#16262c",
                            "primary-dark-bg": "#101e22",
                            secondary: "#90bccb",
                            "background-dark": "#101e22",
                            "card-dark": "#16262c",
                            "accent-green": "#22c55e",
                            "border-dark": "#223f49",
                        },
                        fontFamily: {
                            display: ["Inter", "sans-serif"],
                            body: ["Inter", "sans-serif"],
                        },
                        borderRadius: {
                            DEFAULT: "1rem",
                            lg: "1.5rem",
                            xl: "2rem",
                            "2xl": "2.5rem",
                            full: "9999px",
                        },
                        boxShadow: {
                            soft: "0 4px 20px -2px rgba(0, 0, 0, 0.5)",
                            card: "0 2px 8px -1px rgba(0, 0, 0, 0.3)",
                        },
                    },
                },
            };
        </script>
        <style>
            .material-symbols-outlined {
                font-variation-settings:
                    "FILL" 0,
                    "wght" 400,
                    "GRAD" 0,
                    "opsz" 24;
            }
            .material-symbols-outlined.filled {
                font-variation-settings: "FILL" 1;
            }
            .wave-bg-dark {
                background: radial-gradient(
                    circle at 50% -20%,
                    #1e293b 0%,
                    #0b1116 60%
                );
            }
            .no-scrollbar::-webkit-scrollbar {
                display: none;
            }
            .no-scrollbar {
                -ms-overflow-style: none;
                scrollbar-width: none;
            }
            
            /* Fullscreen video styling */
            .video-js.vjs-fullscreen {
                width: 100% !important;
                height: 100% !important;
            }
            
            .video-js.vjs-fullscreen video {
                width: 100% !important;
                height: 100% !important;
                object-fit: contain !important;
            }
            
            /* Ensure video fills container properly */
            .video-js video {
                object-fit: contain;
            }
        </style>
    </head>
    <body class="bg-background-dark font-display text-white antialiased pb-24">
        <header
            class="sticky top-0 z-50 bg-[#0B1116]/90 backdrop-blur-md border-b border-border-dark"
        >
            <div class="wave-bg-dark w-full pb-2">
                <div
                    class="flex items-center justify-between p-4 pb-2 max-w-6xl mx-auto"
                >
                    <div class="flex items-center gap-2">
                        <a
                            href="/chat.html"
                            class="text-primary flex size-10 shrink-0 items-center justify-center rounded-full bg-[#1e293b] hover:bg-[#334155] transition-colors"
                        >
                            <span class="material-symbols-outlined"
                                >arrow_back</span
                            >
                        </a>
                        <h1
                            class="text-white text-xl font-bold leading-tight tracking-tight"
                        >
                            WaveFeed
                        </h1>
                    </div>
                    <div class="flex items-center gap-3">
                        <a
                            href="/music.html"
                            class="flex items-center justify-center size-10 rounded-full bg-[#1e293b] text-white hover:bg-[#334155] transition-colors border border-border-dark"
                        >
                            <span class="material-symbols-outlined"
                                >music_note</span
                            >
                        </a>
                        <a
                            href="/ai-chat.html"
                            class="flex items-center justify-center size-10 rounded-full bg-[#1e293b] text-white hover:bg-[#334155] transition-colors border border-border-dark"
                        >
                            <span class="material-symbols-outlined"
                                >smart_toy</span
                            >
                        </a>
                        <a
                            href="/profile.html"
                            class="flex items-center justify-center size-10 rounded-full bg-[#1e293b] text-white hover:bg-[#334155] transition-colors border border-border-dark"
                        >
                            <span class="material-symbols-outlined"
                                >person</span
                            >
                        </a>
                        <a
                            href="/settings.html"
                            class="flex items-center justify-center size-10 rounded-full bg-[#1e293b] text-white hover:bg-[#334155] transition-colors border border-border-dark"
                        >
                            <span class="material-symbols-outlined"
                                >settings</span
                            >
                        </a>
                        <button
                            class="flex items-center justify-center size-10 rounded-full bg-[#1e293b] text-white hover:bg-[#334155] transition-colors border border-border-dark"
                        >
                            <span class="material-symbols-outlined"
                                >search</span
                            >
                        </button>
                        <button
                            onclick="showAddChannelModal()"
                            class="flex items-center justify-center size-10 rounded-full bg-gradient-to-r from-primary to-blue-600 text-white hover:shadow-lg transition-all"
                        >
                            <span class="material-symbols-outlined">add</span>
                        </button>
                    </div>
                </div>
                <div
                    class="flex gap-3 px-4 py-2 overflow-x-auto no-scrollbar max-w-6xl mx-auto"
                >
                    <label
                        class="flex h-9 shrink-0 cursor-pointer items-center gap-2 rounded-full border border-border-dark bg-[#151f2b] pl-4 pr-1 shadow-sm transition-all hover:bg-[#1e293b] has-[:checked]:border-primary/30 has-[:checked]:bg-[#1e293b]"
                    >
                        <span
                            class="material-symbols-outlined text-gray-400 text-[18px]"
                            >translate</span
                        >
                        <p class="text-gray-200 text-sm font-medium mr-1">
                            Auto-Translate
                        </p>
                        <div
                            class="relative flex h-6 w-10 items-center rounded-full bg-gray-700 p-0.5 transition-colors has-[:checked]:bg-primary"
                        >
                            <div
                                class="h-5 w-5 rounded-full bg-white shadow-sm transition-transform has-[:checked]:translate-x-4"
                            ></div>
                            <input id="autoTranslateToggle" checked class="hidden" type="checkbox" onchange="handleAutoTranslate()" />
                        </div>
                    </label>
                    <button
                        class="group flex h-9 shrink-0 items-center justify-center gap-x-2 rounded-full bg-gradient-to-r from-primary to-[#5CAAF8] pl-4 pr-4 shadow-md shadow-primary/20 hover:shadow-lg hover:shadow-primary/30 transition-all active:scale-95"
                        onclick="handleSummarize()"
                    >
                        <span
                            class="material-symbols-outlined text-white text-[18px]"
                            >auto_awesome</span
                        >
                        <p class="text-white text-sm font-bold">Summarize</p>
                        <span
                            class="text-white/80 text-[10px] font-bold px-1.5 py-0.5 rounded-full bg-white/20"
                            >PRO</span
                        >
                    </button>
                    <button
                        onclick="loadFeedPosts()"
                        class="flex h-9 shrink-0 items-center justify-center gap-x-2 rounded-full bg-[#151f2b] border border-border-dark pl-4 pr-4 hover:bg-[#1e293b] text-gray-300 active:scale-95 transition-transform"
                    >
                        <span class="material-symbols-outlined text-[18px]"
                            >refresh</span
                        >
                        <p class="text-sm font-medium">Refresh</p>
                    </button>
                </div>
            </div>
        </header>

        <main class="flex flex-col gap-4 p-4 max-w-4xl mx-auto w-full">
            <!-- Feed posts will be loaded here dynamically -->
        </main>
                    <button
                        class="text-gray-500 hover:text-primary transition-colors pt-2"
                    >
                        <span class="material-symbols-outlined text-[22px]"
                            >bookmark</span
                        >
                    </button>
                </div>
            </article>
        </main>

        <!-- Add Channel Modal -->
        <div
            id="addChannelModal"
            class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm p-4"
        >
            <div
                class="bg-card-dark rounded-3xl p-6 w-full max-w-2xl border border-border-dark shadow-2xl max-h-[90vh] overflow-y-auto"
            >
                <div class="flex items-center justify-between mb-6">
                    <div class="flex items-center gap-3">
                        <div class="bg-primary/10 p-2 rounded-xl">
                            <span class="material-symbols-outlined text-primary text-[24px]">add_circle</span>
                        </div>
                        <div>
                            <h3 class="text-xl font-bold text-white">Add Channel</h3>
                            <p class="text-sm text-gray-400">Choose from popular channels or add your own</p>
                        </div>
                    </div>
                    <button
                        onclick="closeAddChannelModal()"
                        class="text-slate-400 hover:text-white transition-colors p-2 hover:bg-white/5 rounded-lg"
                    >
                        <span class="material-symbols-outlined">close</span>
                    </button>
                </div>

                <!-- Custom Channel Input -->
                <div class="mb-6">
                    <label class="text-sm font-medium text-gray-300 mb-2 block">Custom Telegram Channel</label>
                    <div class="flex gap-2">
                        <input
                            id="channelUrlInput"
                            type="text"
                            class="flex-1 bg-background-dark text-white rounded-xl px-4 py-3 border border-border-dark focus:border-primary/50 focus:outline-none transition-colors"
                            placeholder="t.me/channelname or https://t.me/channelname"
                        />
                        <button
                            onclick="addTelegramChannel()"
                            class="px-6 py-3 rounded-xl bg-gradient-to-r from-primary to-blue-600 text-white font-bold shadow-lg hover:shadow-xl transition-all hover:scale-105 active:scale-95"
                        >
                            Add
                        </button>
                    </div>
                </div>

                <!-- Divider -->
                <div class="flex items-center gap-3 mb-6">
                    <div class="flex-1 h-px bg-border-dark"></div>
                    <span class="text-xs font-medium text-gray-500 uppercase tracking-wider">Popular Channels</span>
                    <div class="flex-1 h-px bg-border-dark"></div>
                </div>

                <!-- Popular Channels Grid -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                    <!-- Crypto Channels (Verified Working) -->
                    <button onclick="addPopularChannel('https://t.me/binance')" class="group flex items-center gap-3 p-4 rounded-xl bg-background-dark border border-border-dark hover:border-primary/30 hover:bg-[#1e293b] transition-all text-left">
                        <div class="bg-amber-500/10 p-2 rounded-lg">
                            <span class="material-symbols-outlined text-amber-400 text-[20px]">account_balance</span>
                        </div>
                        <div class="flex-1">
                            <h4 class="text-white font-semibold text-sm">Binance</h4>
                            <p class="text-gray-400 text-xs">Crypto exchange</p>
                        </div>
                        <span class="material-symbols-outlined text-gray-600 group-hover:text-primary transition-colors">add</span>
                    </button>

                    <button onclick="addPopularChannel('https://t.me/bitcoin')" class="group flex items-center gap-3 p-4 rounded-xl bg-background-dark border border-border-dark hover:border-primary/30 hover:bg-[#1e293b] transition-all text-left">
                        <div class="bg-orange-500/10 p-2 rounded-lg">
                            <span class="material-symbols-outlined text-orange-400 text-[20px]">currency_bitcoin</span>
                        </div>
                        <div class="flex-1">
                            <h4 class="text-white font-semibold text-sm">Bitcoin</h4>
                            <p class="text-gray-400 text-xs">BTC community</p>
                        </div>
                        <span class="material-symbols-outlined text-gray-600 group-hover:text-primary transition-colors">add</span>
                    </button>

                    <button onclick="addPopularChannel('https://t.me/ethereum')" class="group flex items-center gap-3 p-4 rounded-xl bg-background-dark border border-border-dark hover:border-primary/30 hover:bg-[#1e293b] transition-all text-left">
                        <div class="bg-indigo-500/10 p-2 rounded-lg">
                            <span class="material-symbols-outlined text-indigo-400 text-[20px]">currency_exchange</span>
                        </div>
                        <div class="flex-1">
                            <h4 class="text-white font-semibold text-sm">Ethereum</h4>
                            <p class="text-gray-400 text-xs">ETH community</p>
                        </div>
                        <span class="material-symbols-outlined text-gray-600 group-hover:text-primary transition-colors">add</span>
                    </button>

                    <button onclick="addPopularChannel('https://t.me/CryptoNews')" class="group flex items-center gap-3 p-4 rounded-xl bg-background-dark border border-border-dark hover:border-primary/30 hover:bg-[#1e293b] transition-all text-left">
                        <div class="bg-yellow-500/10 p-2 rounded-lg">
                            <span class="material-symbols-outlined text-yellow-400 text-[20px]">trending_up</span>
                        </div>
                        <div class="flex-1">
                            <h4 class="text-white font-semibold text-sm">Crypto News</h4>
                            <p class="text-gray-400 text-xs">Crypto news</p>
                        </div>
                        <span class="material-symbols-outlined text-gray-600 group-hover:text-primary transition-colors">add</span>
                    </button>
                </div>

                <div class="mt-6 p-4 rounded-xl bg-blue-500/10 border border-blue-500/20">
                    <div class="flex gap-3">
                        <span class="material-symbols-outlined text-blue-400 text-[20px]">info</span>
                        <div class="flex-1">
                            <p class="text-sm text-blue-200 font-medium mb-1">How it works</p>
                            <p class="text-xs text-blue-300/80">Add channels to see their latest posts in your feed. You can add channels by clicking the buttons above or entering a custom URL like <code class="bg-black/20 px-1 py-0.5 rounded">t.me/durov</code></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <script src="/js/features-api.js"></script>
        <script src="https://vjs.zencdn.net/8.23.4/video.min.js"></script>
        <script>
            const authToken = localStorage.getItem("authToken");
            const API_BASE_URL = window.location.protocol + "//" + window.location.hostname + ":" + window.location.port;

            if (!authToken) {
                window.location.href = "/login.html";
            }

            // Load posts immediately on startup
            document.addEventListener("DOMContentLoaded", () => {
                // Load auto-translate preference
                const autoTranslate = localStorage.getItem('autoTranslate');
                if (autoTranslate === 'false') {
                    document.getElementById('autoTranslateToggle').checked = false;
                }
                
                loadFeedPosts();
            });

            async function loadFeedPosts() {
                const container = document.querySelector("main");
                
                // Show loading state
                container.innerHTML = `
                    <div class="text-center mt-10">
                        <div class="bg-card-dark rounded-3xl p-8 border border-border-dark inline-block">
                            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-primary mx-auto mb-4"></div>
                            <p class="text-gray-400">Loading your feed...</p>
                            <p class="text-xs text-gray-500 mt-2">Fetching latest posts from your channels</p>
                        </div>
                    </div>
                `;

                try {
                    console.log('Fetching feed from:', `${API_BASE_URL}/api/feed/posts?limit=50`);
                    const response = await fetch(
                        `${API_BASE_URL}/api/feed/posts?limit=50`,
                        {
                            headers: {
                                'Authorization': `Bearer ${authToken}`
                            }
                        }
                    );
                    
                    console.log('Response status:', response.status);
                    const data = await response.json();
                    console.log('Response data:', data);

                    if (data.success && data.posts) {
                        if (data.posts.length === 0) {
                            container.innerHTML = `
                                <div class="text-center mt-10 max-w-md mx-auto">
                                    <div class="bg-card-dark rounded-3xl p-8 border border-border-dark">
                                        <span class="material-symbols-outlined text-primary text-[64px] mb-4">rss_feed</span>
                                        <h3 class="text-xl font-bold text-white mb-2">No Posts Yet</h3>
                                        <p class="text-gray-400 mb-6">Add some Telegram channels to start seeing posts in your feed!</p>
                                        <button onclick="showAddChannelModal()" class="px-6 py-3 rounded-xl bg-gradient-to-r from-primary to-blue-600 text-white font-bold shadow-lg hover:shadow-xl transition-all">
                                            Add Your First Channel
                                        </button>
                                    </div>
                                </div>
                            `;
                        } else {
                            await renderPosts(data.posts);
                            showNotification(`‚úÖ Loaded ${data.posts.length} posts from your channels`);
                        }
                    } else if (data.error && data.error.includes('telegram_channels')) {
                        // Database tables don't exist
                        container.innerHTML = `
                            <div class="text-center mt-10 max-w-2xl mx-auto">
                                <div class="bg-card-dark rounded-3xl p-8 border border-yellow-500/30">
                                    <span class="material-symbols-outlined text-yellow-400 text-[64px] mb-4">warning</span>
                                    <h3 class="text-xl font-bold text-white mb-2">Feed Tables Not Set Up</h3>
                                    <p class="text-gray-300 mb-4">The feed feature requires database tables to be created.</p>
                                    <div class="bg-background-dark rounded-xl p-4 text-left mb-4">
                                        <p class="text-sm text-gray-400 mb-2">Run this SQL in your Supabase SQL Editor:</p>
                                        <code class="text-xs text-green-400 block whitespace-pre-wrap">See migrations/003_add_telegram_feed_tables_fixed.sql</code>
                                    </div>
                                </div>
                            </div>
                        `;
                    } else {
                        console.error("Failed to load feed:", data);
                        container.innerHTML = `
                            <div class="text-center mt-10 max-w-md mx-auto">
                                <div class="bg-card-dark rounded-3xl p-8 border border-red-500/30">
                                    <span class="material-symbols-outlined text-red-400 text-[64px] mb-4">error</span>
                                    <h3 class="text-xl font-bold text-white mb-2">Failed to Load Feed</h3>
                                    <p class="text-gray-400 mb-4">${data.error || 'Unknown error'}</p>
                                    <button onclick="loadFeedPosts()" class="px-6 py-3 rounded-xl bg-primary text-white font-bold hover:bg-blue-500 transition-all">
                                        Try Again
                                    </button>
                                </div>
                            </div>
                        `;
                    }
                } catch (error) {
                    console.error("Error loading feed:", error);
                    container.innerHTML =
                        '<div class="text-center text-gray-500 mt-10 flex flex-col items-center gap-4 max-w-md mx-auto">' +
                        '<div class="bg-card-dark rounded-3xl p-8 border border-border-dark w-full">' +
                        '<span class="material-symbols-outlined text-4xl text-red-400 mb-4">cloud_off</span>' +
                        "<h3 class='text-lg font-bold text-white mb-2'>Failed to Connect</h3>" +
                        '<p class="text-sm text-gray-400 mb-4">Could not connect to the server. Make sure both the backend and feed bot are running.</p>' +
                        '<div class="bg-background-dark rounded-xl p-3 text-left mb-4 text-xs">' +
                        '<p class="text-gray-400 mb-2">Backend: <code class="text-green-400">npm run dev</code> or <code class="text-green-400">start-dev.bat</code></p>' +
                        '<p class="text-gray-400">Feed Bot: <code class="text-green-400">start-feed-bot.bat</code></p>' +
                        '</div>' +
                        '<button onclick="loadFeedPosts()" class="px-6 py-3 rounded-xl bg-primary text-white font-bold hover:bg-blue-500 transition-all">' +
                        'Try Again' +
                        '</button>' +
                        '</div>' +
                        "</div>";
                }
            }

            function showAddChannelModal() {
                document
                    .getElementById("addChannelModal")
                    .classList.remove("hidden");
                document.getElementById("channelUrlInput").focus();
            }

            function closeAddChannelModal() {
                document
                    .getElementById("addChannelModal")
                    .classList.add("hidden");
                document.getElementById("channelUrlInput").value = "";
            }

            async function addTelegramChannel() {
                let url = document
                    .getElementById("channelUrlInput")
                    .value.trim();

                if (!url) {
                    showNotification("Please enter a channel URL");
                    return;
                }

                // Normalize URL - accept both t.me/channel and https://t.me/channel
                if (!url.startsWith('http')) {
                    url = 'https://' + url;
                }

                if (!url.includes("t.me/")) {
                    showNotification("Please enter a valid Telegram channel URL (e.g., t.me/channelname)");
                    return;
                }

                await addChannelToFeed(url);
            }

            async function addPopularChannel(url) {
                await addChannelToFeed(url);
            }

            async function addChannelToFeed(url) {
                // Normalize URL
                if (!url.startsWith('http')) {
                    url = 'https://' + url;
                }

                // Show loading notification
                showNotification("Adding channel...");
                
                try {
                    // Call main backend API
                    const response = await fetch(`${API_BASE_URL}/api/feed/channels`, {
                        method: "POST",
                        headers: { 
                            "Content-Type": "application/json",
                            'Authorization': `Bearer ${authToken}`
                        },
                        body: JSON.stringify({
                            channelUrl: url,
                        }),
                    });

                    const data = await response.json();

                    if (data.success) {
                        showNotification("‚úÖ Channel added successfully!");
                        closeAddChannelModal();
                        // Refresh the feed to show new posts
                        setTimeout(() => loadFeedPosts(), 1000);
                    } else {
                        showNotification("‚ùå Failed to add channel: " + (data.error || "Unknown error"));
                    }
                } catch (error) {
                    console.error("Add channel error:", error);
                    showNotification("‚ùå Failed to connect to server. Make sure the feed bot is running.");
                }
            }

            // Auto-translate toggle handler
            function handleAutoTranslate() {
                const isEnabled = document.getElementById('autoTranslateToggle').checked;
                localStorage.setItem('autoTranslate', isEnabled ? 'true' : 'false');
                
                // Show notification
                const message = isEnabled 
                    ? 'Auto-translate enabled. Posts will be translated to English.' 
                    : 'Auto-translate disabled.';
                showNotification(message);
            }

            // Check Pro status helper
            async function checkProStatus() {
                try {
                    if (typeof getSubscriptionStatus === "function") {
                        const status = await getSubscriptionStatus();
                        console.log('Pro status check:', status);
                        return status.isPro || false;
                    }
                    console.warn('getSubscriptionStatus function not available');
                    return false;
                } catch (error) {
                    console.error('Pro status check error:', error);
                    return false;
                }
            }

            // Summarize feed posts (Pro only)
            async function handleSummarize() {
                try {
                    // Check Pro status
                    const isPro = await checkProStatus();

                    if (!isPro) {
                        if (
                            confirm(
                                "üåü AI Summarize is a Pro feature!\n\nGet instant AI-powered summaries of your feed posts.\n\nWould you like to upgrade to Pro?",
                            )
                        ) {
                            window.location.href = "/settings.html";
                        }
                        return;
                    }

                    // Get all visible posts
                    const posts = document.querySelectorAll('main article');
                    if (posts.length === 0) {
                        showNotification('No posts to summarize. Add channels first!');
                        return;
                    }

                    // Show loading state
                    const btn = event.target.closest('button');
                    const originalHTML = btn.innerHTML;
                    btn.innerHTML = '<span class="material-symbols-outlined text-white text-[18px] animate-spin">progress_activity</span><p class="text-white text-sm font-bold">Summarizing...</p>';
                    btn.disabled = true;

                    // Collect post texts
                    const postTexts = [];
                    posts.forEach((post, index) => {
                        const textElement = post.querySelector('.text-gray-200');
                        if (textElement && textElement.textContent.trim()) {
                            postTexts.push(`Post ${index + 1}: ${textElement.textContent.trim()}`);
                        }
                    });

                    if (postTexts.length === 0) {
                        showNotification('No text content found in posts.');
                        btn.innerHTML = originalHTML;
                        btn.disabled = false;
                        return;
                    }

                    // Call AI to summarize
                    const apiKey = localStorage.getItem('openRouterApiKey');
                    const headers = {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    };
                    
                    if (apiKey) {
                        headers['X-API-Key'] = apiKey;
                    }

                    const response = await fetch(`${API_BASE_URL}/api/ai/summarize-feed`, {
                        method: 'POST',
                        headers: headers,
                        body: JSON.stringify({ 
                            posts: postTexts.slice(0, 10) // Limit to 10 posts
                        })
                    });

                    const data = await response.json();

                    if (data.success) {
                        showSummaryModal(data.summary);
                    } else {
                        showNotification('Failed to generate summary: ' + (data.error || 'Unknown error'));
                    }

                    btn.innerHTML = originalHTML;
                    btn.disabled = false;
                } catch (error) {
                    console.error("Summarize error:", error);
                    showNotification('Failed to summarize feed. Please try again.');
                    const btn = event.target.closest('button');
                    if (btn) {
                        btn.innerHTML = '<span class="material-symbols-outlined text-white text-[18px]">auto_awesome</span><p class="text-white text-sm font-bold">Summarize</p><span class="text-white/80 text-[10px] font-bold px-1.5 py-0.5 rounded-full bg-white/20">PRO</span>';
                        btn.disabled = false;
                    }
                }
            }

            // Show notification toast
            function showNotification(message) {
                const toast = document.createElement('div');
                toast.className = 'fixed top-20 left-1/2 transform -translate-x-1/2 bg-card-dark border border-primary/30 text-white px-6 py-3 rounded-full shadow-lg z-50 animate-fade-in';
                toast.textContent = message;
                document.body.appendChild(toast);
                
                setTimeout(() => {
                    toast.style.opacity = '0';
                    toast.style.transition = 'opacity 0.3s';
                    setTimeout(() => toast.remove(), 300);
                }, 3000);
            }

            // Show summary modal
            function showSummaryModal(summary) {
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm';
                modal.innerHTML = `
                    <div class="bg-card-dark rounded-3xl p-6 w-full max-w-2xl mx-4 border border-border-dark shadow-2xl max-h-[80vh] overflow-y-auto">
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex items-center gap-2">
                                <span class="material-symbols-outlined text-primary text-[24px]">auto_awesome</span>
                                <h3 class="text-lg font-bold text-white">Feed Summary</h3>
                            </div>
                            <button onclick="this.closest('.fixed').remove()" class="text-slate-400 hover:text-white transition-colors">
                                <span class="material-symbols-outlined">close</span>
                            </button>
                        </div>
                        <div class="prose prose-invert max-w-none">
                            <p class="text-gray-200 text-sm leading-relaxed whitespace-pre-wrap">${summary}</p>
                        </div>
                        <div class="mt-6 flex justify-end">
                            <button onclick="this.closest('.fixed').remove()" class="px-6 py-2 rounded-xl bg-gradient-to-r from-primary to-blue-600 text-white font-bold shadow-lg hover:shadow-xl transition-all">
                                Got it
                            </button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            }

            // Helper function to make URLs clickable and style button-like text
            function linkifyText(text) {
                if (!text) return '';
                
                // Handle button URLs section (üîó Links:)
                // This is added by the bot when it extracts inline button URLs
                const linksPattern = /üîó Links:\n((?:.+: https?:\/\/.+\n?)+)/g;
                text = text.replace(linksPattern, (match, linksSection) => {
                    const links = linksSection.trim().split('\n');
                    const buttonHtml = links.map(link => {
                        const [buttonText, url] = link.split(': ');
                        if (buttonText && url) {
                            return `<a href="${url.trim()}" target="_blank" rel="noopener noreferrer" class="inline-block px-4 py-2 bg-primary/20 hover:bg-primary/30 text-primary rounded-lg text-sm font-medium border border-primary/40 transition-colors">${buttonText.trim()}</a>`;
                        }
                        return '';
                    }).filter(h => h).join(' ');
                    return `<div class="flex flex-wrap gap-2 mt-3 mb-2">${buttonHtml}</div>`;
                });
                
                // Handle Telegram button-style text (News | Markets | YouTube)
                // These show as text but aren't clickable since bot doesn't capture URLs
                const buttonPattern = /^([^|\n]+(?:\s*\|\s*[^|\n]+)+)\s*$/gm;
                text = text.replace(buttonPattern, (match) => {
                    const buttons = match.split('|').map(b => b.trim()).filter(b => b);
                    if (buttons.length > 1) {
                        // Style as button group (not clickable, just visual)
                        const buttonHtml = buttons.map(btn => 
                            `<span class="inline-block px-3 py-1.5 bg-gray-700/50 text-gray-300 rounded-lg text-sm font-medium border border-gray-600">${btn}</span>`
                        ).join(' ');
                        return `<div class="flex flex-wrap gap-2 mt-2">${buttonHtml}</div>`;
                    }
                    return match;
                });
                
                // First, handle URLs without protocol (like send.monobank.ua/jar/xxx)
                // Match domain-like patterns that aren't already part of a URL
                text = text.replace(/(?<!https?:\/\/)(?<![\w.])([a-zA-Z0-9][-a-zA-Z0-9]*\.)+[a-zA-Z]{2,}(\/[^\s]*)?(?=\s|$|[.,!?)])/g, (match) => {
                    // Skip if it looks like an email
                    if (match.includes('@')) return match;
                    // Add https:// prefix
                    return `https://${match}`;
                });
                
                // Make actual URLs into nice buttons with domain names
                text = text.replace(/(https?:\/\/[^\s]+)/g, (url) => {
                    let cleanUrl = url;
                    let trailingPunct = '';
                    const lastChar = url.slice(-1);
                    if (['.', ',', '!', '?', ')', ']', '}', ':'].includes(lastChar)) {
                        cleanUrl = url.slice(0, -1);
                        trailingPunct = lastChar;
                    }
                    
                    // Extract domain name for button text
                    try {
                        const urlObj = new URL(cleanUrl);
                        let domain = urlObj.hostname.replace('www.', '');
                        
                        // Get nice names for popular domains
                        const domainNames = {
                            'youtube.com': 'YouTube',
                            'youtu.be': 'YouTube',
                            'twitter.com': 'Twitter',
                            'x.com': 'X',
                            't.me': 'Telegram',
                            'instagram.com': 'Instagram',
                            'facebook.com': 'Facebook',
                            'tiktok.com': 'TikTok',
                            'reddit.com': 'Reddit',
                            'github.com': 'GitHub',
                            'medium.com': 'Medium',
                            'linkedin.com': 'LinkedIn',
                            'monobank.ua': 'Monobank'
                        };
                        
                        const buttonText = domainNames[domain] || domain.split('.')[0].charAt(0).toUpperCase() + domain.split('.')[0].slice(1);
                        
                        // Create a nice button
                        return `<a href="${cleanUrl}" target="_blank" rel="noopener noreferrer" class="inline-flex items-center gap-1.5 px-3 py-1.5 bg-primary/20 hover:bg-primary/30 text-primary rounded-lg text-sm font-medium border border-primary/40 transition-all hover:scale-105">
                            <span class="material-symbols-outlined text-[16px]">link</span>
                            <span>${buttonText}</span>
                        </a>${trailingPunct}`;
                    } catch (e) {
                        // Fallback to simple link if URL parsing fails
                        return `<a href="${cleanUrl}" target="_blank" rel="noopener noreferrer" class="text-primary hover:text-blue-400 underline break-all">${cleanUrl}</a>${trailingPunct}`;
                    }
                });
                
                return text;
            }

            async function renderPosts(posts) {
                const container = document.querySelector("main");
                // Clear current posts
                container.innerHTML = "";

                if (!posts || posts.length === 0) {
                    container.innerHTML = `
                        <div class="text-center mt-10 max-w-2xl mx-auto">
                            <div class="bg-card-dark rounded-3xl p-8 border border-border-dark">
                                <div class="mb-6">
                                    <span class="material-symbols-outlined text-primary text-[80px] mb-4 inline-block">rss_feed</span>
                                </div>
                                <h3 class="text-2xl font-bold text-white mb-3">Welcome to WaveFeed!</h3>
                                <p class="text-gray-400 mb-8 text-lg">Your personalized Telegram channel feed</p>
                                
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8 text-left">
                                    <div class="bg-background-dark rounded-xl p-4 border border-border-dark">
                                        <div class="bg-primary/10 w-12 h-12 rounded-full flex items-center justify-center mb-3">
                                            <span class="material-symbols-outlined text-primary text-[24px]">add_circle</span>
                                        </div>
                                        <h4 class="text-white font-bold mb-2">1. Add Channels</h4>
                                        <p class="text-gray-400 text-sm">Choose from popular channels or add your own</p>
                                    </div>
                                    
                                    <div class="bg-background-dark rounded-xl p-4 border border-border-dark">
                                        <div class="bg-green-500/10 w-12 h-12 rounded-full flex items-center justify-center mb-3">
                                            <span class="material-symbols-outlined text-green-400 text-[24px]">translate</span>
                                        </div>
                                        <h4 class="text-white font-bold mb-2">2. Enable Translation</h4>
                                        <p class="text-gray-400 text-sm">Auto-translate posts to your language</p>
                                    </div>
                                    
                                    <div class="bg-background-dark rounded-xl p-4 border border-border-dark">
                                        <div class="bg-blue-500/10 w-12 h-12 rounded-full flex items-center justify-center mb-3">
                                            <span class="material-symbols-outlined text-blue-400 text-[24px]">auto_awesome</span>
                                        </div>
                                        <h4 class="text-white font-bold mb-2">3. Enjoy Your Feed</h4>
                                        <p class="text-gray-400 text-sm">Get latest posts from all channels in one place</p>
                                    </div>
                                </div>
                                
                                <button onclick="showAddChannelModal()" class="px-8 py-4 rounded-xl bg-gradient-to-r from-primary to-blue-600 text-white font-bold shadow-lg hover:shadow-xl transition-all text-lg">
                                    <span class="material-symbols-outlined inline-block mr-2 align-middle">add</span>
                                    Add Your First Channel
                                </button>
                            </div>
                        </div>
                    `;
                    return;
                }

                for (const msg of posts) {
                    const article = document.createElement("article");
                    article.className =
                        "flex flex-col gap-3 rounded-[24px] bg-card-dark p-4 shadow-card hover:shadow-soft transition-shadow border border-border-dark/50";

                    // Clean up message text - remove "[Translation]: nothing" or similar
                    let messageText = msg.message || '';
                    
                    // Remove translation markers if translation is "nothing" or empty
                    messageText = messageText.replace(/\n\n\[Translation\]:\s*nothing\.?/gi, '');
                    messageText = messageText.replace(/\n\n\[Translation\]:\s*$/gi, '');
                    messageText = messageText.replace(/\[Translation\]:\s*nothing\.?/gi, '');
                    
                    // If message starts with translation marker and has actual translation, format it better
                    if (messageText.includes('[Translation]:')) {
                        const parts = messageText.split('[Translation]:');
                        if (parts.length === 2 && parts[1].trim() && parts[1].trim() !== 'nothing') {
                            messageText = parts[0].trim() + '\n\nüìù ' + parts[1].trim();
                        } else {
                            messageText = parts[0].trim();
                        }
                    }
                    
                    // Make URLs clickable
                    messageText = linkifyText(messageText);

                    // Prepare Media HTML
                    let mediaHtml = "";
                    if (msg.media_url || msg.media_path) {
                        const mediaUrl = msg.media_url || msg.media_path;
                        const ext = mediaUrl.split(".").pop().toLowerCase().split('?')[0];
                        const videoId = "vid-" + msg.message_id;

                        if (["mp4", "webm", "mov", "avi", "mkv", "m4v", "3gp", "flv"].includes(ext)) {
                            // Better MIME type detection
                            let mimeType = "video/mp4"; // Default
                            if (ext === "webm") mimeType = "video/webm";
                            else if (ext === "mov") mimeType = "video/quicktime";
                            else if (ext === "avi") mimeType = "video/x-msvideo";
                            else if (ext === "mkv") mimeType = "video/x-matroska";
                            else if (ext === "m4v") mimeType = "video/x-m4v";
                            else if (ext === "3gp") mimeType = "video/3gpp";
                            else if (ext === "flv") mimeType = "video/x-flv";
                            
                            mediaHtml = `
                            <div class="mt-2 rounded-xl overflow-hidden bg-black/20 flex justify-center">
                                <video id="${videoId}" class="video-js vjs-big-play-centered" controls preload="metadata" data-setup="{}" style="width:100%; height:auto; max-height: 600px;">
                                    <source src="${mediaUrl}" type="${mimeType}" />
                                    <source src="${mediaUrl}" type="video/mp4" />
                                    <source src="${mediaUrl}" type="video/webm" />
                                    Your browser does not support the video tag.
                                </video>
                            </div>`;
                            setTimeout(() => {
                                if (window.videojs) {
                                    const player = videojs(videoId);
                                    player.ready(function() {
                                        // Let video maintain its aspect ratio
                                        this.fluid(false);
                                        this.aspectRatio('auto');
                                    });
                                }
                            }, 100);
                        } else if (["jpg", "jpeg", "png", "gif", "webp"].includes(ext)) {
                            mediaHtml = `
                            <div class="mt-2 rounded-xl overflow-hidden cursor-pointer" onclick="window.open('${mediaUrl}', '_blank')">
                                <img src="${mediaUrl}" loading="lazy" class="w-full h-auto object-contain max-h-[600px] hover:opacity-95 transition-opacity" onerror="this.parentElement.style.display='none'" />
                            </div>`;
                        }
                    }

                    // Format Channel Name and get profile picture
                    const channelName = msg.channel_name || "Telegram Channel";
                    const formattedDate = msg.date ? new Date(msg.date).toLocaleString() : 'Unknown date';
                    
                    // Try to get real channel profile picture, fallback to UI Avatars
                    const channelInitial = channelName.charAt(0).toUpperCase();
                    const fallbackAvatarUrl = `https://ui-avatars.com/api/?name=${encodeURIComponent(channelName)}&background=0db9f2&color=fff&size=128&bold=true`;
                    
                    // Fetch real profile picture from feed bot
                    let avatarUrl = fallbackAvatarUrl;
                    try {
                        const photoResponse = await fetch(`http://192.168.2.34:3000/channel-photo/${msg.channel_id}`);
                        const photoData = await photoResponse.json();
                        if (photoData.status === 'success' && photoData.photo_url) {
                            avatarUrl = `http://192.168.2.34:3000${photoData.photo_url}`;
                        }
                    } catch (e) {
                        // Use fallback if fetch fails
                    }

                    article.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <div class="bg-center bg-no-repeat aspect-square bg-cover rounded-full h-12 w-12 border border-gray-700 overflow-hidden">
                                <img src="${avatarUrl}" alt="${channelName}" class="w-full h-full object-cover" onerror="this.src='${fallbackAvatarUrl}'" />
                            </div>
                            <div class="flex flex-col">
                                <div class="flex items-center gap-1.5">
                                    <h3 class="text-white text-base font-bold leading-tight">${channelName}</h3>
                                    <span class="material-symbols-outlined text-primary text-[14px] filled">verified</span>
                                </div>
                                <p class="text-secondary text-xs font-medium">${formattedDate} ‚Ä¢ <span class="text-gray-400">üëÅÔ∏è ${msg.views || 0}</span></p>
                            </div>
                        </div>
                    </div>
                    <div class="px-1">
                        <p class="text-gray-200 text-[15px] font-normal leading-relaxed whitespace-pre-wrap">${messageText}</p>
                        ${mediaHtml}
                    </div>
                `;
                    container.appendChild(article);
                }
            }
        </script>

        <!-- Bottom Navigation (Desktop Sidebar Style) -->
        <nav class="hidden lg:block fixed bottom-6 left-6 z-50">
            <div
                class="p-2 bg-[#0b1418] border border-slate-800/40 rounded-xl shadow-2xl"
            >
                <div
                    class="flex items-center gap-1 rounded-xl bg-background-dark p-1"
                >
                    <a
                        class="flex flex-col items-center justify-center p-2 rounded-lg text-[#90bccb] hover:text-white hover:bg-surface-hover transition-colors"
                        href="/chat.html"
                    >
                        <span class="material-symbols-outlined text-[24px]"
                            >chat_bubble</span
                        >
                        <span class="text-[10px] font-medium mt-1">Chats</span>
                    </a>
                    <a
                        class="flex flex-col items-center justify-center p-2 rounded-lg text-[#90bccb] hover:text-white hover:bg-surface-hover transition-colors"
                        href="/ai-chat.html"
                    >
                        <span class="material-symbols-outlined text-[24px]"
                            >smart_toy</span
                        >
                        <span class="text-[10px] font-medium mt-1">AI</span>
                    </a>
                    <a
                        class="flex flex-col items-center justify-center p-2 rounded-lg text-primary bg-primary/10 transition-colors"
                        href="/feed.html"
                    >
                        <span class="material-symbols-outlined text-[24px]"
                            >newspaper</span
                        >
                        <span class="text-[10px] font-medium mt-1">Feed</span>
                    </a>
                    <a
                        class="flex flex-col items-center justify-center p-2 rounded-lg text-[#90bccb] hover:text-white hover:bg-surface-hover transition-colors"
                        href="/music.html"
                    >
                        <span class="material-symbols-outlined text-[24px]"
                            >music_note</span
                        >
                        <span class="text-[10px] font-medium mt-1">Music</span>
                    </a>
                    <a
                        class="flex flex-col items-center justify-center p-2 rounded-lg text-[#90bccb] hover:text-white hover:bg-surface-hover transition-colors"
                        href="/profile.html"
                    >
                        <span class="material-symbols-outlined text-[24px]"
                            >person</span
                        >
                        <span class="text-[10px] font-medium mt-1"
                            >Profile</span
                        >
                    </a>
                    <a
                        class="flex flex-col items-center justify-center p-2 rounded-lg text-[#90bccb] hover:text-white hover:bg-surface-hover transition-colors"
                        href="/settings.html"
                    >
                        <span class="material-symbols-outlined text-[24px]"
                            >settings</span
                        >
                        <span class="text-[10px] font-medium mt-1"
                            >Settings</span
                        >
                    </a>
                </div>
            </div>
        </nav>

        <!-- Mobile Bottom Navigation -->
        <nav
            class="lg:hidden fixed bottom-0 left-0 right-0 z-50 bg-surface-dark/95 backdrop-blur-lg border-t border-slate-800"
        >
            <div class="flex justify-between items-center h-20 px-6 pb-2">
                <a
                    href="/chat.html"
                    class="flex flex-col items-center gap-1 w-12 text-slate-400 hover:text-slate-200 transition-colors"
                >
                    <span
                        class="material-symbols-outlined"
                        style="font-size: 24px"
                        >chat_bubble</span
                    >
                    <span class="text-[10px] font-medium">Chats</span>
                </a>

                <a
                    href="/music.html"
                    class="flex flex-col items-center gap-1 w-12 text-slate-400 hover:text-slate-200 transition-colors"
                >
                    <span
                        class="material-symbols-outlined"
                        style="font-size: 24px"
                        >music_note</span
                    >
                    <span class="text-[10px] font-medium">Music</span>
                </a>

                <a
                    href="/feed.html"
                    class="flex flex-col items-center justify-center -mt-6"
                >
                    <div
                        class="w-14 h-14 rounded-full bg-gradient-to-tr from-primary to-blue-400 shadow-[0_8px_16px_rgba(43,140,238,0.3)] flex items-center justify-center text-white transform active:scale-95 transition-transform"
                    >
                        <span
                            class="material-symbols-outlined"
                            style="font-size: 28px"
                            >newspaper</span
                        >
                    </div>
                </a>

                <a
                    href="/ai-chat.html"
                    class="flex flex-col items-center gap-1 w-12 text-slate-400 hover:text-slate-200 transition-colors"
                >
                    <span
                        class="material-symbols-outlined"
                        style="font-size: 24px"
                        >smart_toy</span
                    >
                    <span class="text-[10px] font-medium">AI</span>
                </a>

                <a
                    href="/profile.html"
                    class="flex flex-col items-center gap-1 w-12 text-slate-400 hover:text-slate-200 transition-colors"
                >
                    <div
                        class="w-6 h-6 rounded-full overflow-hidden bg-slate-700 ring-2 ring-transparent hover:ring-primary transition-all"
                    >
                        <span
                            class="material-symbols-outlined text-slate-400 text-[20px]"
                            >person</span
                        >
                    </div>
                    <span class="text-[10px] font-medium">Profile</span>
                </a>
            </div>
        </nav>
    </body>
</html>
