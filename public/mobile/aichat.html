<!DOCTYPE html>
<html class="dark" lang="en">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>WaveChat AI Helper</title>
    <!-- Theme Init -->
    <script src="/js/theme-init.js"></script>
    <link href="/css/theme.css" rel="stylesheet" />
    <link href="/css/theme-config.css" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap"
        rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap"
        rel="stylesheet" />
    <script src="/js/auth-guard.js"></script>
    <script src="/js/mobile-detector.js"></script>
    <script src="/js/update-checker.js"></script>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#0db9f2",
                        "primary-hover": "#0a91be",
                        "primary-light": "#34caff",
                        "background-dark": "#101e22",
                        "surface-dark": "#16262c",
                        "surface-dark-lighter": "#1d2f36",
                        "accent-cyan": "#06b6d4",
                    },
                    fontFamily: {
                        "display": ["Inter", "sans-serif"],
                        "body": ["Inter", "sans-serif"],
                    },
                    borderRadius: { "DEFAULT": "1rem", "lg": "1.5rem", "xl": "2rem", "full": "9999px" },
                },
            },
        }
    </script>
    <style>
        body {
            min-height: 100vh;
            scrollbar-width: thin;
            scrollbar-color: #1d2f36 #101e22;
        }

        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: #101e22;
        }

        ::-webkit-scrollbar-thumb {
            background-color: #1d2f36;
            border-radius: 20px;
        }

        .mask-gradient-right {
            mask-image: linear-gradient(to right, black 85%, transparent 100%);
            -webkit-mask-image: linear-gradient(to right, black 85%, transparent 100%);
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-fade-in {
            animation: fadeIn 0.3s ease-out;
        }

        /* Transparency Mode Styles */
        body.transparency-mode .bg-surface-dark,
        body.transparency-mode .bg-background-dark {
            background: rgba(16, 30, 34, 0.4) !important;
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-color: rgba(255, 255, 255, 0.1);
        }

        body.transparency-mode .bg-background-dark\/80 {
            background: rgba(16, 30, 34, 0.6) !important;
            backdrop-filter: blur(24px);
            -webkit-backdrop-filter: blur(24px);
        }

        body.transparency-mode .bg-surface-dark-lighter {
            background: rgba(29, 47, 54, 0.5) !important;
        }

        /* Mobile Swipeable Sidebar */
        .mobile-sidebar {
            position: fixed;
            top: 0;
            bottom: 0;
            left: 0;
            width: 320px;
            max-width: 85vw;
            height: 100vh;
            z-index: 100;
            transform: translateX(-100%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            overflow-y: auto;
        }

        .mobile-sidebar.open {
            transform: translateX(0);
        }

        .sidebar-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 99;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        .sidebar-overlay.active {
            opacity: 1;
            pointer-events: all;
        }
    </style>
</head>

<body
    class="bg-background-dark font-display text-white antialiased overflow-hidden selection:bg-primary selection:text-white pb-20 lg:pb-0 relative">
    <!-- Sidebar Overlay (Mobile Only) -->
    <div class="sidebar-overlay lg:hidden" onclick="closeSidebar()"></div>

    <!-- Swipeable Sidebar Menu (Mobile Only) -->
    <aside class="mobile-sidebar lg:hidden bg-surface-dark border-r border-white/5 flex flex-col">
        <div class="p-6">
            <div class="flex items-center justify-between mb-6">
                <div class="flex items-center gap-3">
                    <img src="/wavechat.png" alt="Wave" class="size-9 rounded-xl object-contain" />
                    <h1 class="text-xl font-bold tracking-tight text-white">WaveChat</h1>
                </div>
                <button onclick="closeSidebar()"
                    class="size-8 rounded-lg bg-background-dark hover:bg-surface-dark-lighter text-slate-400 hover:text-white flex items-center justify-center transition-colors">
                    <span class="material-symbols-outlined text-[20px]">close</span>
                </button>
            </div>

            <!-- AI Chats Section -->
            <div class="mb-6">
                <div class="flex items-center justify-between mb-3 px-2">
                    <h3 class="text-xs font-semibold text-slate-400 uppercase tracking-wider">AI Chats</h3>
                    <button onclick="clearChat(); closeSidebar();"
                        class="text-primary hover:text-primary-hover transition-colors">
                        <span class="material-symbols-outlined text-[18px]">add</span>
                    </button>
                </div>
                <div id="sidebarChatsList" class="space-y-1 max-h-[300px] overflow-y-auto">
                    <!-- Saved chats will be loaded here -->
                </div>
            </div>

            <!-- Navigation -->
            <nav class="space-y-2 border-t border-white/5 pt-4">
                <a href="/mobile/chat.html"
                    class="flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-surface-dark-lighter text-slate-300 hover:text-white transition-all">
                    <span class="material-symbols-outlined">chat_bubble</span>
                    <span class="font-medium">Chats</span>
                </a>
                <a href="/mobile/aichat.html"
                    class="flex items-center gap-3 px-4 py-3 rounded-xl bg-primary/10 text-primary transition-all">
                    <span class="material-symbols-outlined">smart_toy</span>
                    <span class="font-medium">AI Chat</span>
                </a>
                <a href="/mobile/feed.html"
                    class="flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-surface-dark-lighter text-slate-300 hover:text-white transition-all">
                    <span class="material-symbols-outlined">newspaper</span>
                    <span class="font-medium">Feed</span>
                </a>
                <a href="/mobile/playlist.html"
                    class="flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-surface-dark-lighter text-slate-300 hover:text-white transition-all">
                    <span class="material-symbols-outlined">music_note</span>
                    <span class="font-medium">Music</span>
                </a>
                <a href="/mobile/settings.html"
                    class="flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-surface-dark-lighter text-slate-300 hover:text-white transition-all">
                    <span class="material-symbols-outlined">settings</span>
                    <span class="font-medium">Settings</span>
                </a>
            </nav>
        </div>
    </aside>
    <!-- Custom Background Image -->
    <div id="customBackground" class="fixed inset-0 z-0 pointer-events-none hidden"></div>

    <div class="relative flex h-screen w-full flex-col max-w-7xl mx-auto z-20">
        <div
            class="flex items-center px-6 py-3 justify-between bg-surface-dark/95 backdrop-blur-xl sticky top-0 z-30 border-b border-border-dark">
            <div class="flex items-center gap-3">
                <a href="/chat.html"
                    class="hidden lg:flex items-center justify-center size-10 rounded-full hover:bg-white/10 transition-colors active:scale-95">
                    <span class="material-symbols-outlined text-slate-400">arrow_back</span>
                </a>
                <button onclick="toggleSidebar()"
                    class="lg:hidden w-10 h-10 flex items-center justify-center rounded-lg bg-surface-lighter text-slate-400 hover:text-primary transition-colors active:scale-95">
                    <div class="hamburger-menu">
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                </button>
                <div class="relative group cursor-pointer">
                    <div class="bg-center bg-no-repeat aspect-square bg-cover rounded-full size-10 border-2 border-primary/50 group-hover:border-primary transition-colors"
                        style="background-image: url('https://api.dicebear.com/7.x/bottts/svg?seed=AIAgent&backgroundColor=transparent'); box-shadow: 0 0 15px var(--accent-glow);">
                    </div>
                    <div
                        class="absolute -bottom-0.5 -right-0.5 size-3 bg-green-500 rounded-full border-2 border-[#09090b]">
                    </div>
                </div>
                <div class="flex flex-col">
                    <h2 class="text-base font-bold leading-tight tracking-wide">WaveBot AI</h2>
                    <div class="flex items-center gap-1">
                        <span class="size-1.5 rounded-full bg-primary animate-pulse"></span>
                        <p class="text-xs text-primary font-medium">Online</p>
                    </div>
                </div>
            </div>
            <div class="flex items-center gap-2">
                <button onclick="showSavedChats()"
                    class="w-10 h-10 flex items-center justify-center rounded-lg bg-surface-lighter text-slate-400 hover:text-primary transition-colors active:scale-95"
                    title="Saved Chats">
                    <span class="material-symbols-outlined text-[22px]">history</span>
                </button>
                <button onclick="saveCurrentChat()"
                    class="w-10 h-10 flex items-center justify-center rounded-lg bg-surface-lighter text-slate-400 hover:text-primary transition-colors active:scale-95"
                    title="Save Chat">
                    <span class="material-symbols-outlined text-[22px]">bookmark</span>
                </button>
                <button onclick="clearChat()"
                    class="w-10 h-10 flex items-center justify-center rounded-lg bg-surface-lighter text-slate-400 hover:text-primary transition-colors active:scale-95"
                    title="New Chat">
                    <span class="material-symbols-outlined text-[22px]">add</span>
                </button>
                <a href="/settings.html"
                    class="w-10 h-10 flex items-center justify-center rounded-lg bg-surface-lighter text-slate-400 hover:text-primary transition-colors active:scale-95">
                    <span class="material-symbols-outlined text-[22px]">settings</span>
                </a>
            </div>
        </div>

        <div class="flex-1 overflow-y-auto p-6 space-y-6 scroll-smooth" id="chat-container">
            <div class="flex justify-center my-4">
                <span
                    class="text-[10px] font-semibold tracking-wider text-slate-500 uppercase bg-surface-dark px-3 py-1 rounded-full border border-white/5">Today</span>
            </div>
        </div>

        <div class="bg-background-dark/95 backdrop-blur-xl border-t border-white/5 pb-6 pt-2 z-40">
            <div class="flex gap-2 overflow-x-auto px-6 py-2 mb-1 no-scrollbar mask-gradient-right">
                <button id="thinkingToggle"
                    class="flex shrink-0 items-center justify-center gap-1.5 h-8 rounded-full bg-surface-dark border border-white/10 px-4 hover:bg-primary hover:border-primary hover:shadow-[0_0_15px_rgba(14,165,233,0.3)] transition-all group active:scale-95"
                    onclick="toggleThinking()">
                    <span
                        class="material-symbols-outlined text-[16px] text-slate-400 group-hover:text-white transition-colors">psychology</span>
                    <span
                        class="text-xs font-medium text-slate-400 group-hover:text-white transition-colors">Thinking</span>
                </button>
                <button id="searchToggle"
                    class="flex shrink-0 items-center justify-center gap-1.5 h-8 rounded-full bg-surface-dark border border-white/10 px-4 hover:bg-primary hover:border-primary hover:shadow-[0_0_15px_rgba(14,165,233,0.3)] transition-all group active:scale-95"
                    onclick="toggleSearch()">
                    <span
                        class="material-symbols-outlined text-[16px] text-slate-400 group-hover:text-white transition-colors">search</span>
                    <span
                        class="text-xs font-medium text-slate-400 group-hover:text-white transition-colors">Search</span>
                </button>
                <button
                    class="flex shrink-0 items-center justify-center gap-1.5 h-8 rounded-full bg-surface-dark border border-white/10 px-4 hover:bg-primary hover:border-primary hover:shadow-[0_0_15px_rgba(14,165,233,0.3)] transition-all group active:scale-95"
                    onclick="showAICommand('translate')">
                    <span
                        class="material-symbols-outlined text-[16px] text-primary group-hover:text-white transition-colors">translate</span>
                    <span
                        class="text-xs font-medium text-slate-200 group-hover:text-white transition-colors">Translate</span>
                </button>
                <button
                    class="flex shrink-0 items-center justify-center gap-1.5 h-8 rounded-full bg-surface-dark border border-white/10 px-4 hover:bg-primary hover:border-primary hover:shadow-[0_0_15px_rgba(14,165,233,0.3)] transition-all group active:scale-95"
                    onclick="showAICommand('summarize')">
                    <span
                        class="material-symbols-outlined text-[16px] text-primary group-hover:text-white transition-colors">summarize</span>
                    <span
                        class="text-xs font-medium text-slate-200 group-hover:text-white transition-colors">Summarize</span>
                </button>
                <button
                    class="flex shrink-0 items-center justify-center gap-1.5 h-8 rounded-full bg-surface-dark border border-white/10 px-4 hover:bg-primary hover:border-primary hover:shadow-[0_0_15px_rgba(14,165,233,0.3)] transition-all group active:scale-95"
                    onclick="showAICommand('code')">
                    <span
                        class="material-symbols-outlined text-[16px] text-primary group-hover:text-white transition-colors">code</span>
                    <span class="text-xs font-medium text-slate-200 group-hover:text-white transition-colors">Write
                        Code</span>
                </button>
                <button
                    class="flex shrink-0 items-center justify-center gap-1.5 h-8 rounded-full bg-surface-dark border border-white/10 px-4 hover:bg-primary hover:border-primary hover:shadow-[0_0_15px_rgba(14,165,233,0.3)] transition-all group active:scale-95"
                    onclick="showAICommand('explain')">
                    <span
                        class="material-symbols-outlined text-[16px] text-primary group-hover:text-white transition-colors">school</span>
                    <span
                        class="text-xs font-medium text-slate-200 group-hover:text-white transition-colors">Explain</span>
                </button>
            </div>
            <div class="px-6 flex items-end gap-2 mt-2">
                <div class="relative">
                    <button id="attachButton" onclick="toggleAttachMenu()"
                        class="size-11 shrink-0 flex items-center justify-center rounded-full bg-surface-dark border border-white/5 text-slate-400 hover:text-primary hover:border-primary/50 transition-all active:scale-95">
                        <span class="material-symbols-outlined text-[24px]">add</span>
                    </button>
                    <!-- Attach Menu -->
                    <div id="attachMenu"
                        class="hidden absolute bottom-full left-0 mb-2 bg-surface-dark rounded-2xl border border-white/10 shadow-2xl p-2 min-w-[200px]">
                        <button onclick="openCodeEditor()"
                            class="w-full flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-primary/10 hover:border-primary/30 border border-transparent transition-all text-left group">
                            <span class="material-symbols-outlined text-primary text-[20px]">code</span>
                            <div>
                                <div class="text-sm font-medium text-white group-hover:text-primary transition-colors">
                                    Attach Code</div>
                                <div class="text-xs text-slate-400">Open code editor</div>
                            </div>
                        </button>
                        <button onclick="openFileUpload()"
                            class="w-full flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-primary/10 hover:border-primary/30 border border-transparent transition-all text-left group">
                            <span class="material-symbols-outlined text-primary text-[20px]">description</span>
                            <div>
                                <div class="text-sm font-medium text-white group-hover:text-primary transition-colors">
                                    Attach File</div>
                                <div class="text-xs text-slate-400">Upload text file</div>
                            </div>
                        </button>
                    </div>
                </div>
                <div
                    class="flex-1 bg-surface-dark rounded-3xl min-h-[2.75rem] px-4 py-2.5 flex items-center gap-2 border border-white/5 focus-within:border-primary/50 focus-within:bg-surface-dark-lighter transition-all shadow-sm">
                    <input id="messageInput"
                        class="bg-transparent border-none outline-none text-sm w-full text-white placeholder-slate-500 focus:ring-0 p-0"
                        placeholder="Message or type / for commands..." type="text"
                        onkeypress="handleKeyPress(event)" />
                </div>
                <button onclick="sendMessage()"
                    class="size-11 shrink-0 flex items-center justify-center rounded-full bg-primary text-white shadow-[0_4px_12px_rgba(14,165,233,0.3)] hover:scale-105 hover:bg-primary-hover transition-all active:scale-95">
                    <span class="material-symbols-outlined text-[24px]">send</span>
                </button>
            </div>
        </div>
    </div>

    <!-- AI Command Modal -->
    <div id="aiCommandModal"
        class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm">
        <div class="bg-surface-dark rounded-3xl p-6 w-full max-w-2xl mx-4 border border-white/10 shadow-2xl">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-bold text-white flex items-center gap-2" id="modalTitle">
                    <span class="material-symbols-outlined text-primary">translate</span>
                    AI Command
                </h3>
                <button onclick="closeAIModal()" class="text-slate-400 hover:text-white transition-colors">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>

            <!-- Language Selection (for translate) -->
            <div id="languageSelection" class="hidden mb-4">
                <p class="text-sm text-slate-400 mb-3">Select target language:</p>
                <div class="grid grid-cols-3 gap-2 max-h-[300px] overflow-y-auto">
                    <button onclick="selectLanguage('Spanish', 'üá™üá∏')"
                        class="flex items-center gap-2 p-3 rounded-xl bg-background-dark hover:bg-primary/20 hover:border-primary border border-white/10 transition-all group">
                        <span class="text-2xl">üá™üá∏</span>
                        <span class="text-sm font-medium text-slate-300 group-hover:text-white">Spanish</span>
                    </button>
                    <button onclick="selectLanguage('French', 'üá´üá∑')"
                        class="flex items-center gap-2 p-3 rounded-xl bg-background-dark hover:bg-primary/20 hover:border-primary border border-white/10 transition-all group">
                        <span class="text-2xl">üá´üá∑</span>
                        <span class="text-sm font-medium text-slate-300 group-hover:text-white">French</span>
                    </button>
                    <button onclick="selectLanguage('German', 'üá©üá™')"
                        class="flex items-center gap-2 p-3 rounded-xl bg-background-dark hover:bg-primary/20 hover:border-primary border border-white/10 transition-all group">
                        <span class="text-2xl">üá©üá™</span>
                        <span class="text-sm font-medium text-slate-300 group-hover:text-white">German</span>
                    </button>
                    <button onclick="selectLanguage('Italian', 'üáÆüáπ')"
                        class="flex items-center gap-2 p-3 rounded-xl bg-background-dark hover:bg-primary/20 hover:border-primary border border-white/10 transition-all group">
                        <span class="text-2xl">üáÆüáπ</span>
                        <span class="text-sm font-medium text-slate-300 group-hover:text-white">Italian</span>
                    </button>
                    <button onclick="selectLanguage('Portuguese', 'üáµüáπ')"
                        class="flex items-center gap-2 p-3 rounded-xl bg-background-dark hover:bg-primary/20 hover:border-primary border border-white/10 transition-all group">
                        <span class="text-2xl">üáµüáπ</span>
                        <span class="text-sm font-medium text-slate-300 group-hover:text-white">Portuguese</span>
                    </button>
                    <button onclick="selectLanguage('Russian', 'üá∑üá∫')"
                        class="flex items-center gap-2 p-3 rounded-xl bg-background-dark hover:bg-primary/20 hover:border-primary border border-white/10 transition-all group">
                        <span class="text-2xl">üá∑üá∫</span>
                        <span class="text-sm font-medium text-slate-300 group-hover:text-white">Russian</span>
                    </button>
                    <button onclick="selectLanguage('Chinese', 'üá®üá≥')"
                        class="flex items-center gap-2 p-3 rounded-xl bg-background-dark hover:bg-primary/20 hover:border-primary border border-white/10 transition-all group">
                        <span class="text-2xl">üá®üá≥</span>
                        <span class="text-sm font-medium text-slate-300 group-hover:text-white">Chinese</span>
                    </button>
                    <button onclick="selectLanguage('Japanese', 'üáØüáµ')"
                        class="flex items-center gap-2 p-3 rounded-xl bg-background-dark hover:bg-primary/20 hover:border-primary border border-white/10 transition-all group">
                        <span class="text-2xl">üáØüáµ</span>
                        <span class="text-sm font-medium text-slate-300 group-hover:text-white">Japanese</span>
                    </button>
                    <button onclick="selectLanguage('Korean', 'üá∞üá∑')"
                        class="flex items-center gap-2 p-3 rounded-xl bg-background-dark hover:bg-primary/20 hover:border-primary border border-white/10 transition-all group">
                        <span class="text-2xl">üá∞üá∑</span>
                        <span class="text-sm font-medium text-slate-300 group-hover:text-white">Korean</span>
                    </button>
                    <button onclick="selectLanguage('Arabic', 'üá∏üá¶')"
                        class="flex items-center gap-2 p-3 rounded-xl bg-background-dark hover:bg-primary/20 hover:border-primary border border-white/10 transition-all group">
                        <span class="text-2xl">üá∏üá¶</span>
                        <span class="text-sm font-medium text-slate-300 group-hover:text-white">Arabic</span>
                    </button>
                    <button onclick="selectLanguage('Hindi', 'üáÆüá≥')"
                        class="flex items-center gap-2 p-3 rounded-xl bg-background-dark hover:bg-primary/20 hover:border-primary border border-white/10 transition-all group">
                        <span class="text-2xl">üáÆüá≥</span>
                        <span class="text-sm font-medium text-slate-300 group-hover:text-white">Hindi</span>
                    </button>
                    <button onclick="selectLanguage('Turkish', 'üáπüá∑')"
                        class="flex items-center gap-2 p-3 rounded-xl bg-background-dark hover:bg-primary/20 hover:border-primary border border-white/10 transition-all group">
                        <span class="text-2xl">üáπüá∑</span>
                        <span class="text-sm font-medium text-slate-300 group-hover:text-white">Turkish</span>
                    </button>
                    <button onclick="selectLanguage('Polish', 'üáµüá±')"
                        class="flex items-center gap-2 p-3 rounded-xl bg-background-dark hover:bg-primary/20 hover:border-primary border border-white/10 transition-all group">
                        <span class="text-2xl">üáµüá±</span>
                        <span class="text-sm font-medium text-slate-300 group-hover:text-white">Polish</span>
                    </button>
                    <button onclick="selectLanguage('Dutch', 'üá≥üá±')"
                        class="flex items-center gap-2 p-3 rounded-xl bg-background-dark hover:bg-primary/20 hover:border-primary border border-white/10 transition-all group">
                        <span class="text-2xl">üá≥üá±</span>
                        <span class="text-sm font-medium text-slate-300 group-hover:text-white">Dutch</span>
                    </button>
                    <button onclick="selectLanguage('Ukrainian', 'üá∫üá¶')"
                        class="flex items-center gap-2 p-3 rounded-xl bg-background-dark hover:bg-primary/20 hover:border-primary border border-white/10 transition-all group">
                        <span class="text-2xl">üá∫üá¶</span>
                        <span class="text-sm font-medium text-slate-300 group-hover:text-white">Ukrainian</span>
                    </button>
                    <button onclick="selectLanguage('Swedish', 'üá∏üá™')"
                        class="flex items-center gap-2 p-3 rounded-xl bg-background-dark hover:bg-primary/20 hover:border-primary border border-white/10 transition-all group">
                        <span class="text-2xl">üá∏üá™</span>
                        <span class="text-sm font-medium text-slate-300 group-hover:text-white">Swedish</span>
                    </button>
                    <button onclick="selectLanguage('Greek', 'üá¨üá∑')"
                        class="flex items-center gap-2 p-3 rounded-xl bg-background-dark hover:bg-primary/20 hover:border-primary border border-white/10 transition-all group">
                        <span class="text-2xl">üá¨üá∑</span>
                        <span class="text-sm font-medium text-slate-300 group-hover:text-white">Greek</span>
                    </button>
                    <button onclick="selectLanguage('Czech', 'üá®üáø')"
                        class="flex items-center gap-2 p-3 rounded-xl bg-background-dark hover:bg-primary/20 hover:border-primary border border-white/10 transition-all group">
                        <span class="text-2xl">üá®üáø</span>
                        <span class="text-sm font-medium text-slate-300 group-hover:text-white">Czech</span>
                    </button>
                </div>
            </div>

            <!-- Text Input -->
            <div id="textInputSection">
                <textarea id="aiCommandInput"
                    class="w-full bg-background-dark text-white rounded-xl p-4 border border-white/10 focus:border-primary/50 focus:outline-none resize-none"
                    rows="4" placeholder="Enter your text here..."></textarea>
            </div>

            <div class="flex gap-3 mt-4">
                <button onclick="closeAIModal()"
                    class="flex-1 py-3 rounded-xl bg-surface-lighter text-slate-300 font-medium hover:bg-slate-700 transition-all">
                    Cancel
                </button>
                <button onclick="executeAICommand()"
                    class="flex-1 py-3 rounded-xl bg-gradient-to-r from-primary to-blue-600 text-white font-bold shadow-lg hover:shadow-xl transition-all">
                    Execute
                </button>
            </div>
        </div>
    </div>

    <!-- Saved Chats Modal -->
    <div id="savedChatsModal"
        class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm">
        <div
            class="bg-surface-dark rounded-3xl p-6 w-full max-w-2xl mx-4 border border-white/10 shadow-2xl max-h-[80vh] flex flex-col">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-bold text-white">Saved Chats</h3>
                <button onclick="closeSavedChatsModal()" class="text-slate-400 hover:text-white transition-colors">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>
            <div id="savedChatsList" class="flex-1 overflow-y-auto space-y-2">
                <!-- Saved chats will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Save Chat Modal -->
    <div id="saveChatModal"
        class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm">
        <div class="bg-surface-dark rounded-3xl p-6 w-full max-w-md mx-4 border border-white/10 shadow-2xl">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-bold text-white">Save Chat</h3>
                <button onclick="closeSaveChatModal()" class="text-slate-400 hover:text-white transition-colors">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>
            <input id="chatNameInput" type="text"
                class="w-full bg-background-dark text-white rounded-xl p-4 border border-white/10 focus:border-primary/50 focus:outline-none"
                placeholder="Enter chat name..." />
            <div class="flex gap-3 mt-4">
                <button onclick="closeSaveChatModal()"
                    class="flex-1 py-3 rounded-xl bg-surface-lighter text-slate-300 font-medium hover:bg-slate-700 transition-all">
                    Cancel
                </button>
                <button onclick="confirmSaveChat()"
                    class="flex-1 py-3 rounded-xl bg-gradient-to-r from-primary to-blue-600 text-white font-bold shadow-lg hover:shadow-xl transition-all">
                    Save
                </button>
            </div>
        </div>
    </div>

    <!-- Audio Player Pop-out -->
    <div id="audioPlayer"
        class="hidden fixed top-4 right-4 z-[100] bg-surface-dark/95 backdrop-blur-xl border border-white/10 rounded-2xl p-4 shadow-2xl flex items-center gap-4 animate-fade-in translate-x-0 transition-transform duration-300">
        <div class="size-10 rounded-full bg-primary/20 flex items-center justify-center relative">
            <span class="material-symbols-outlined text-primary text-[20px] animate-pulse">equalizer</span>
        </div>
        <div>
            <div class="text-xs font-bold text-slate-400 mb-0.5 uppercase tracking-widest">Speaking</div>
            <div class="flex items-center gap-3">
                <div id="audioTime" class="text-sm font-mono text-white">0:00</div>
                <div class="h-1 w-24 bg-white/5 rounded-full overflow-hidden">
                    <div id="audioProgress" class="h-full bg-primary transition-all duration-300" style="width: 0%">
                    </div>
                </div>
            </div>
        </div>
        <button onclick="stopSpeaking()"
            class="size-9 rounded-xl bg-red-500/10 hover:bg-red-500/20 text-red-400 flex items-center justify-center transition-all group active:scale-95">
            <span class="material-symbols-outlined text-[20px] group-hover:rotate-90 transition-transform">close</span>
        </button>
    </div>

    <!-- Code Editor Modal -->
    <div id="codeEditorModal"
        class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm">
        <div
            class="bg-surface-dark rounded-3xl p-6 w-full max-w-4xl mx-4 border border-white/10 shadow-2xl max-h-[80vh] flex flex-col">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-bold text-white flex items-center gap-2">
                    <span class="material-symbols-outlined text-primary">code</span>
                    Code Editor
                </h3>
                <button onclick="closeCodeEditor()" class="text-slate-400 hover:text-white transition-colors">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>
            <div class="mb-3">
                <label class="text-sm text-slate-400 mb-2 block">Language (optional)</label>
                <input id="codeLanguage" type="text"
                    class="w-full bg-background-dark text-white rounded-xl px-4 py-2 border border-white/10 focus:border-primary/50 focus:outline-none text-sm"
                    placeholder="e.g., javascript, python, html..." />
            </div>
            <textarea id="codeEditorInput"
                class="flex-1 w-full bg-background-dark text-white rounded-xl p-4 border border-white/10 focus:border-primary/50 focus:outline-none resize-none font-mono text-sm"
                placeholder="Paste or type your code here..."></textarea>
            <div class="flex gap-3 mt-4">
                <button onclick="closeCodeEditor()"
                    class="flex-1 py-3 rounded-xl bg-surface-lighter text-slate-300 font-medium hover:bg-slate-700 transition-all">
                    Cancel
                </button>
                <button onclick="attachCode()"
                    class="flex-1 py-3 rounded-xl bg-gradient-to-r from-primary to-blue-600 text-white font-bold shadow-lg hover:shadow-xl transition-all">
                    Attach Code
                </button>
            </div>
        </div>
    </div>

    <!-- File Upload Input (hidden) -->
    <input type="file" id="fileInput" accept=".txt,.md,.json,.js,.ts,.py,.html,.css,.java,.cpp,.c,.go,.rs"
        class="hidden" onchange="handleFileUpload(event)" />

    <script src="/js/features-api.js"></script>
    <script>
        const socket = io();
        const messagesContainer = document.getElementById('chat-container');
        const messageInput = document.getElementById('messageInput');
        let currentAICommand = null;
        let conversationHistory = [];
        let thinkingEnabled = false;
        let searchEnabled = false;
        let attachedCode = null; // Store attached code

        // Auto-save conversation to localStorage
        function saveConversation() {
            try {
                localStorage.setItem('aiCurrentConversation', JSON.stringify({
                    history: conversationHistory,
                    timestamp: Date.now(),
                    model: localStorage.getItem('preferredAIModel') || 'wave-flash-2'
                }));
            } catch (e) {
                console.error('Failed to save conversation:', e);
            }
        }

        // Track if conversation has been restored to prevent duplicates
        let conversationRestored = false;

        // Restore conversation from localStorage on page load
        function restoreConversation() {
            // Prevent multiple restorations
            if (conversationRestored) {
                console.log('Conversation already restored, skipping...');
                return;
            }

            try {
                const saved = localStorage.getItem('aiCurrentConversation');
                if (saved) {
                    const data = JSON.parse(saved);
                    // Only restore if less than 24 hours old
                    if (Date.now() - data.timestamp < 24 * 60 * 60 * 1000) {
                        conversationHistory = data.history || [];
                        console.log(`Restored ${conversationHistory.length} messages from previous session`);

                        // Display restored messages (skip hidden system messages)
                        conversationHistory.forEach(msg => {
                            // Skip hidden messages (search results, system prompts)
                            if (msg._hidden) return;

                            if (msg.role === 'user') {
                                addMessage(msg.parts[0].text, true);
                            } else if (msg.role === 'model') {
                                addMessage(msg.parts[0].text, false);
                            }
                        });

                        conversationRestored = true;
                    }
                }
            } catch (e) {
                console.error('Failed to restore conversation:', e);
            }
        }

        // Restore conversation on page load (only once)
        if (!conversationRestored) {
            restoreConversation();
        }

        // ===== FILE/CODE ATTACHMENT FUNCTIONS =====

        // Toggle attach menu
        function toggleAttachMenu() {
            const menu = document.getElementById('attachMenu');
            menu.classList.toggle('hidden');
        }

        // Close attach menu when clicking outside
        document.addEventListener('click', function (event) {
            const menu = document.getElementById('attachMenu');
            const button = document.getElementById('attachButton');
            if (!menu.contains(event.target) && !button.contains(event.target)) {
                menu.classList.add('hidden');
            }
        });

        // Open code editor
        function openCodeEditor() {
            document.getElementById('attachMenu').classList.add('hidden');
            document.getElementById('codeEditorModal').classList.remove('hidden');
            document.getElementById('codeEditorInput').focus();
        }

        // Close code editor
        function closeCodeEditor() {
            document.getElementById('codeEditorModal').classList.add('hidden');
            document.getElementById('codeEditorInput').value = '';
            document.getElementById('codeLanguage').value = '';
        }

        // Attach code
        function attachCode() {
            const code = document.getElementById('codeEditorInput').value.trim();
            const language = document.getElementById('codeLanguage').value.trim() || 'code';

            if (!code) {
                alert('Please enter some code first!');
                return;
            }

            const lineCount = code.split('\n').length;
            attachedCode = { code, language, lineCount };

            // Show attached code indicator in input
            messageInput.placeholder = `üìé ${language} code attached (${lineCount} lines) - Type your question...`;
            messageInput.classList.add('text-primary');

            closeCodeEditor();
        }

        // Open file upload
        function openFileUpload() {
            document.getElementById('attachMenu').classList.add('hidden');
            document.getElementById('fileInput').click();
        }

        // Handle file upload
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function (e) {
                const content = e.target.result;
                const lineCount = content.split('\n').length;
                const extension = file.name.split('.').pop();

                attachedCode = {
                    code: content,
                    language: extension,
                    lineCount,
                    filename: file.name
                };

                messageInput.placeholder = `üìé ${file.name} attached (${lineCount} lines) - Type your question...`;
                messageInput.classList.add('text-primary');
            };
            reader.readAsText(file);

            // Reset file input
            event.target.value = '';
        }

        // Check authentication
        const authToken = localStorage.getItem('authToken');
        if (!authToken) {
            window.location.href = '/login.html';
        }

        // Register user for socket events
        const userId = localStorage.getItem('userId');
        const username = localStorage.getItem('username');
        const nickname = localStorage.getItem('nickname');

        if (userId && username) {
            socket.emit('user:setup', { userId });
        }

        function toggleThinking() {
            thinkingEnabled = !thinkingEnabled;
            const btn = document.getElementById('thinkingToggle');
            const icon = btn.querySelector('.material-symbols-outlined');
            const text = btn.querySelector('.text-xs');

            if (thinkingEnabled) {
                btn.classList.add('bg-primary', 'border-primary');
                btn.classList.remove('bg-surface-dark');
                icon.classList.remove('text-slate-400');
                icon.classList.add('text-white');
                text.classList.remove('text-slate-400');
                text.classList.add('text-white');
            } else {
                btn.classList.remove('bg-primary', 'border-primary');
                btn.classList.add('bg-surface-dark');
                icon.classList.add('text-slate-400');
                icon.classList.remove('text-white');
                text.classList.add('text-slate-400');
                text.classList.remove('text-white');
            }
        }

        function toggleSearch() {
            searchEnabled = !searchEnabled;
            const btn = document.getElementById('searchToggle');
            const icon = btn.querySelector('.material-symbols-outlined');
            const text = btn.querySelector('.text-xs');

            if (searchEnabled) {
                btn.classList.add('bg-primary', 'border-primary');
                btn.classList.remove('bg-surface-dark');
                icon.classList.remove('text-slate-400');
                icon.classList.add('text-white');
                text.classList.remove('text-slate-400');
                text.classList.add('text-white');
            } else {
                btn.classList.remove('bg-primary', 'border-primary');
                btn.classList.add('bg-surface-dark');
                icon.classList.add('text-slate-400');
                icon.classList.remove('text-white');
                text.classList.add('text-slate-400');
                text.classList.remove('text-white');
            }
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        let selectedLanguage = null;
        let selectedLanguageFlag = null;

        function showAICommand(command) {
            currentAICommand = command;
            const modal = document.getElementById('aiCommandModal');
            const title = document.getElementById('modalTitle');
            const input = document.getElementById('aiCommandInput');
            const languageSelection = document.getElementById('languageSelection');
            const textInputSection = document.getElementById('textInputSection');

            const titles = {
                'translate': 'üåê Translate Text',
                'summarize': 'üìù Summarize Text',
                'code': 'üíª Write Code',
                'explain': 'üéì Explain Topic'
            };

            const placeholders = {
                'translate': 'Enter text to translate...',
                'summarize': 'Enter text to summarize...',
                'code': 'Describe what code you need...',
                'explain': 'What would you like me to explain?'
            };

            title.innerHTML = titles[command] || 'AI Command';
            input.placeholder = placeholders[command] || 'Enter your text...';
            input.value = '';

            // Show language selection only for translate
            if (command === 'translate') {
                languageSelection.classList.remove('hidden');
                selectedLanguage = null;
                selectedLanguageFlag = null;
            } else {
                languageSelection.classList.add('hidden');
            }

            modal.classList.remove('hidden');
            input.focus();
        }

        function selectLanguage(language, flag) {
            selectedLanguage = language;
            selectedLanguageFlag = flag;

            // Update title to show selected language
            const title = document.getElementById('modalTitle');
            title.innerHTML = `üåê Translate to ${flag} ${language}`;

            // Hide language selection, show text input
            document.getElementById('languageSelection').classList.add('hidden');
            document.getElementById('aiCommandInput').focus();
        }

        function closeAIModal() {
            document.getElementById('aiCommandModal').classList.add('hidden');
            currentAICommand = null;
            selectedLanguage = null;
            selectedLanguageFlag = null;
        }

        async function executeAICommand() {
            const input = document.getElementById('aiCommandInput');
            const text = input.value.trim();

            if (!text) return;

            let prompt;
            if (currentAICommand === 'translate') {
                if (!selectedLanguage) {
                    alert('Please select a target language first!');
                    document.getElementById('languageSelection').classList.remove('hidden');
                    return;
                }
                prompt = `Translate the following text to ${selectedLanguage}. 

Respond with ONLY a JSON object in this format (no explanations, no code blocks, just the JSON):

{"original": "text here", "translation": "translated text", "language": "${selectedLanguage}"}

Text to translate: ${text}`;
            } else {
                const prompts = {
                    'summarize': `Summarize the following text concisely:\n\n${text}`,
                    'code': `Write clean, well-commented code for: ${text}`,
                    'explain': `Explain in detail: ${text}`
                };
                prompt = prompts[currentAICommand] || text;
            }

            closeAIModal();

            // Add user message with language flag if translating
            if (currentAICommand === 'translate' && selectedLanguageFlag) {
                addMessage(`${selectedLanguageFlag} Translate to ${selectedLanguage}: ${text}`, true);
            } else {
                addMessage(text, true);
            }

            // Send to AI
            await sendToQwenAI(prompt);
        }

        async function sendMessage() {
            const content = messageInput.value.trim();
            if (!content && !attachedCode) return;

            let userMessage = content;
            let aiPrompt = content;

            // Handle attached code
            if (attachedCode) {
                // User sees: "üìé Attached code.js (50 lines)"
                userMessage = `üìé Attached ${attachedCode.filename || attachedCode.language} code (${attachedCode.lineCount} lines)\n${content}`;

                // AI gets: full code + user question
                aiPrompt = `Here's the code:\n\`\`\`${attachedCode.language}\n${attachedCode.code}\n\`\`\`\n\n${content}`;

                // Clear attachment
                attachedCode = null;
                messageInput.placeholder = 'Message or type / for commands...';
                messageInput.classList.remove('text-primary');
            }

            // Add user message to UI (shows attachment summary)
            addMessage(userMessage, true);

            // Add to conversation history (only once, not in sendToQwenAI)
            conversationHistory.push({ role: 'user', parts: [{ text: aiPrompt }] });
            saveConversation();

            messageInput.value = '';

            // Send to AI (with full code)
            await sendToQwenAI(aiPrompt, true); // Pass flag to skip adding to history
        }

        async function sendToQwenAI(content) {
            try {
                // Get preferred model from localStorage (set in Settings)
                const preferredModel = localStorage.getItem('preferredAIModel');

                // Model mapping from settings ID to OpenRouter model (matching ai.md)
                const modelMap = {
                    // Wave Flash (Free - Fast models)
                    'wave-flash-2': 'arcee-ai/trinity-mini:free',
                    'wave-flash-3': 'nvidia/nemotron-3-nano-30b-a3b:free',
                    'wave-flash-4': 'mistralai/mistral-small-3.1-24b-instruct:free',
                    'wave-flash-5': 'arcee-ai/trinity-large-preview:free', // Pro

                    // Wave (Standard models)
                    'wave-2': 'meta-llama/llama-3.3-70b-instruct:free',
                    'wave-3': 'z-ai/glm-4.5-air:free',
                    'wave-4': 'openai/gpt-oss-120b:free', // Pro

                    // Wave O (Reasoning models)
                    'wave-o3': 'deepseek/deepseek-r1-0528:free', // Pro
                    'wave-o4': 'z-ai/glm-4.5-air:free', // Pro (thinking enabled)
                    'wave-o5': 'deepseek/deepseek-r1:free', // Pro

                    // Wave Coder
                    'wave-coder-4': 'qwen/qwen3-coder:free', // Pro

                    // Auto/default (use Wave Flash 2)
                    'auto': 'arcee-ai/trinity-mini:free'
                };

                // Select model (default to free MiMo Flash)
                const selectedModel = modelMap[preferredModel] || 'xiaomi/mimo-v2-flash:free';
                const modelName = preferredModel ? preferredModel.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase()) : 'Wave Flash 2';

                console.log('ü§ñ Using AI model:', selectedModel, '(', modelName, ')');

                // Build OpenRouter-compatible message history
                let messages = [];

                // Add system message with model identity and search instructions
                messages.push({
                    role: 'system',
                    content: `You are a helpful AI assistant with web search and weather capabilities.

üö® CRITICAL RULES - YOU MUST FOLLOW THESE:

1. NEVER EVER say "I cannot answer" or "I don't know"
2. ALWAYS use search for current information (prices, news, products, events)
3. ALWAYS use weather for weather questions
4. You can perform MULTIPLE searches or weather checks in ONE response if you need multiple pieces of info.
   Example: [SEARCH: vivo x200 ultra specs] [SEARCH: oppo x8 ultra specs] [WEATHER: London]

HOW TO USE SEARCH:
When user asks about:
- Product prices (e.g., "how much is X on AliExpress")
- Current news or events
- Information after 2023
- Anything you're not 100% certain about

YOU MUST respond with ONLY this format:
[SEARCH: your search query here]

Example:
User: "How much is OnePlus Pad 2 on AliExpress?"
You: [SEARCH: OnePlus Pad 2 price AliExpress 2025]

User: "Who is DreamRemake?"
You: [SEARCH: DreamRemake seller Yupoo]

HOW TO USE WEATHER:
When user asks about weather, temperature, or climate:
[WEATHER: city name]

Example:
User: "Weather in Munich?"
You: [WEATHER: Munich]

User: "What's the temperature in Tokyo?"
You: [WEATHER: Tokyo]

WHEN TO ANSWER DIRECTLY (without search):
- Math calculations (2+2=4)
- Code writing/debugging
- Translations
- Explanations of concepts you're certain about
- Questions about your own capabilities

üìù FORMATTING:
Use markdown: **bold**, *italic*, \`code\`, ### headings, - lists

‚ö†Ô∏è NEVER:
- Say "I cannot answer" or "I don't know"
- Add signatures, footers, or "powered by" messages
- Refuse to search when information is needed`
                });

                // Convert conversation history to OpenRouter format
                for (let i = 0; i < conversationHistory.length; i++) {
                    const msg = conversationHistory[i];
                    messages.push({
                        role: msg.role === 'model' ? 'assistant' : msg.role,
                        content: msg.parts[0].text
                    });
                }

                // Add current user message
                messages.push({ role: 'user', content: content });
                conversationHistory.push({ role: 'user', parts: [{ text: content }] });
                saveConversation(); // Auto-save after user message

                // Create streaming message bubble (no fixed ID to avoid conflicts)
                const isSlowModel = ['wave-o3', 'wave-o4', 'wave-o5'].includes(preferredModel);
                const streamingDiv = document.createElement('div');
                streamingDiv.className = 'flex gap-3 group streaming-ai-message';
                streamingDiv.innerHTML = `
                    <div class="bg-center bg-no-repeat aspect-square bg-cover rounded-full size-8 shrink-0 self-end mb-1 ring-2 ring-transparent group-hover:ring-primary/20 transition-all" style='background-image: url("/wavechat.png");'></div>
                    <div class="flex flex-col gap-1 max-w-[85%]">
                        <p class="text-[10px] font-medium text-slate-400 ml-1 mb-0.5">Wave AI</p>
                        <div class="bg-surface-dark p-3.5 rounded-2xl rounded-bl-none border border-white/5 shadow-sm">
                            <div class="streaming-content text-sm leading-relaxed text-slate-200">
                                ${isSlowModel ? '<div class="flex items-center gap-2 mb-2 text-primary/70 animate-pulse"><span class="material-symbols-outlined text-sm">psychology</span><span class="text-[10px] font-bold uppercase tracking-widest">Deep Thinking - Extended Wait</span></div>' : ''}
                                <span class="inline-block w-2 h-4 bg-primary animate-pulse"></span>
                            </div>
                        </div>
                    </div>
                `;
                messagesContainer.appendChild(streamingDiv);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;

                // Call backend AI chat API with selected model
                const requestBody = {
                    messages: messages,
                    enableSearch: searchEnabled,
                    model: preferredModel || 'auto'
                };

                const response = await fetch('/api/ai-chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    streamingDiv?.remove();
                    if (response.status === 429) {
                        addMessage('‚ö†Ô∏è Rate limit reached. Please wait a moment and try again.', false);
                    } else {
                        addMessage(`Error: ${errorData.error || errorData.message || 'Something went wrong'}`, false);
                    }
                    return;
                }

                // Get response from backend
                const data = await response.json();

                if (!data.success) {
                    streamingDiv?.remove();
                    addMessage(`Error: ${data.message || 'AI request failed'}`, false);
                    return;
                }

                const fullResponse = data.response;

                // Update streaming message with final response
                const contentDiv = streamingDiv.querySelector('.streaming-content');
                contentDiv.innerHTML = '';
                const textContainer = document.createElement('span');
                textContainer.className = 'whitespace-pre-wrap';
                textContainer.textContent = fullResponse;
                contentDiv.appendChild(textContainer);

                // Collect all searches and weather requests
                const searchMatches = [...fullResponse.matchAll(/\[SEARCH:\s*(.+?)\]/g)];
                const weatherMatches = [...fullResponse.matchAll(/\[WEATHER:\s*(.+?)\]/g)];

                if (searchMatches.length > 0 || weatherMatches.length > 0) {
                    const searchQueries = searchMatches.map(m => m[1].trim());
                    const weatherCities = weatherMatches.map(m => m[1].trim());

                    console.log('üîç AI requested searches:', searchQueries);
                    console.log('üå§Ô∏è AI requested weathers:', weatherCities);

                    // Remove the streaming message
                    streamingDiv.remove();

                    // Show consolidated searching indicator
                    let statusText = 'üîç Processing requests...';
                    if (searchQueries.length > 0 && weatherCities.length > 0) {
                        statusText = `üîç Searching for ${searchQueries.length} items and getting weather for ${weatherCities.length} cities...`;
                    } else if (searchQueries.length > 0) {
                        statusText = `üîç Searching for: ${searchQueries.join(', ')}...`;
                    } else if (weatherCities.length > 0) {
                        statusText = `üå§Ô∏è Getting weather for: ${weatherCities.join(', ')}...`;
                    }

                    const statusMsg = addMessage(statusText, false);

                    try {
                        const results = [];

                        // Execute searches in parallel
                        const searchPromises = searchQueries.map(async (query) => {
                            try {
                                const res = await fetch('/api/search', {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({ query, maxResults: 5 })
                                });
                                const data = await res.json();
                                if (data.success && data.results.length > 0) {
                                    return `Results for "${query}":\n` + data.results.map((r, i) =>
                                        `${i + 1}. ${r.title}\n   URL: ${r.url}\n   ${r.snippet || 'No description'}`
                                    ).join('\n\n');
                                }
                                return `No results found for "${query}".`;
                            } catch (e) {
                                return `Search failed for "${query}".`;
                            }
                        });

                        // Execute weather checks in parallel
                        const weatherPromises = weatherCities.map(async (city) => {
                            try {
                                const res = await fetch('/api/weather', {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({ city })
                                });
                                const data = await res.json();
                                if (data.success && data.formatted) {
                                    return `Weather for ${city}:\n${data.formatted}`;
                                }
                                return `Could not get weather for ${city}.`;
                            } catch (e) {
                                return `Weather check failed for ${city}.`;
                            }
                        });

                        const allResults = await Promise.all([...searchPromises, ...weatherPromises]);
                        const consolidatedContext = allResults.join('\n\n---\n\n');

                        // Add results to conversation (hidden)
                        conversationHistory.push({
                            role: 'system',
                            parts: [{ text: consolidatedContext }],
                            _hidden: true
                        });

                        // Ask AI to answer using consolidated context
                        conversationHistory.push({
                            role: 'user',
                            parts: [{ text: `Here is the information I found:\n\n${consolidatedContext}\n\nNow, please provide a comprehensive answer using this information.` }],
                            _hidden: true
                        });
                        saveConversation();

                        // Remove status message
                        statusMsg.remove();

                        // Call AI again with consolidated results
                        await sendToQwenAI(`Here is the information I found:\n\n${consolidatedContext}\n\nNow, please provide a comprehensive answer using this information.`);
                    } catch (err) {
                        console.error('Error processing multi-requests:', err);
                        statusMsg.remove();
                        addMessage('‚ùå Something went wrong while gathering information.', false);
                    }

                    return;
                }

                // Now format the complete response (only once, after streaming is done)
                // Remove the cursor/loading indicator if it exists
                const cursor = streamingDiv.querySelector('.animate-pulse');
                if (cursor) cursor.remove();

                textContainer.innerHTML = formatAIContent(fullResponse);

                // Add speech and stop buttons after streaming is done
                const buttonContainer = document.createElement('div');
                buttonContainer.className = 'flex items-center gap-2 justify-start ml-1 mt-1';
                buttonContainer.innerHTML = `
                    <button onclick="speakText(this.closest('.flex-col').querySelector('.text-sm').innerText, this)" class="speak-btn p-1 text-slate-500 hover:text-primary transition-colors" title="Read Aloud">
                        <span class="material-symbols-outlined text-[16px]">volume_up</span>
                    </button>
                    <button onclick="stopSpeaking()" class="p-1 text-slate-500 hover:text-red-400 transition-colors" title="Stop Reading">
                        <span class="material-symbols-outlined text-[16px]">stop_circle</span>
                    </button>
                `;
                streamingDiv.querySelector('.flex-col').appendChild(buttonContainer);

                // Add AI response to history
                if (fullResponse) {
                    conversationHistory.push({ role: 'model', parts: [{ text: fullResponse }] });
                    saveConversation(); // Auto-save after AI response
                }

            } catch (error) {
                console.error('AI error:', error);
                streamingDiv?.remove();
                addMessage('Sorry, I encountered an error. Please try again.', false);
            }
        }

        function sendCommand(command) {
            messageInput.value = command + ' ';
            messageInput.focus();
        }

        let currentUtterance = null;
        let audioTimer = null;
        let audioStartTime = 0;

        function speakText(text, buttonElement) {
            const player = document.getElementById('audioPlayer');
            const progress = document.getElementById('audioProgress');
            const timeDisplay = document.getElementById('audioTime');

            // If already speaking, stop it
            if (window.speechSynthesis.speaking) {
                window.speechSynthesis.cancel();
                if (audioTimer) clearInterval(audioTimer);

                // If the same button was clicked, we just want to stop
                if (currentUtterance && currentUtterance._button === buttonElement) {
                    resetButtonStates();
                    player.classList.add('translate-x-[200%]');
                    setTimeout(() => player.classList.add('hidden'), 300);
                    currentUtterance = null;
                    return;
                }

                resetButtonStates();
            }

            // Simple text cleanup for better reading
            const cleanText = text.replace(/\[SEARCH:.*?\]/g, '')
                .replace(/\[WEATHER:.*?\]/g, '')
                .replace(/>\s*‚ö†Ô∏è\s*Notice:.*?\n\n/g, '') // Remove fallback notice
                .replace(/```[\s\S]*?```/g, 'Code block skipped.') // Skip large code blocks
                .replace(/[*#\_`]/g, ''); // Remove basic markdown

            const utterance = new SpeechSynthesisUtterance(cleanText);

            // Try to find a better voice (Microsoft/Google voices are usually better)
            const voices = window.speechSynthesis.getVoices();
            const preferredVoice = voices.find(v => (v.name.includes('Google') || v.name.includes('Microsoft') || v.name.includes('Natural')) && v.lang.startsWith('en')) ||
                voices.find(v => v.lang.startsWith('en'));

            if (preferredVoice) utterance.voice = preferredVoice;

            utterance._button = buttonElement;
            currentUtterance = utterance;

            utterance.onstart = () => {
                buttonElement.querySelector('.material-symbols-outlined').textContent = 'stop_circle';
                buttonElement.classList.add('text-primary');
                buttonElement.classList.remove('text-slate-500');

                // Show player
                player.classList.remove('hidden');
                setTimeout(() => player.classList.remove('translate-x-[200%]'), 10);

                // Start timer
                audioStartTime = Date.now();
                audioTimer = setInterval(() => {
                    const elapsed = Math.floor((Date.now() - audioStartTime) / 1000);
                    const mins = Math.floor(elapsed / 60);
                    const secs = elapsed % 60;
                    timeDisplay.textContent = `${mins}:${secs.toString().padStart(2, '0')}`;

                    // Simple progress estimation based on chars (crude but better than nothing)
                    const percent = Math.min(95, (elapsed / (cleanText.length / 15)) * 100);
                    progress.style.width = `${percent}%`;
                }, 1000);
            };

            utterance.onend = () => {
                resetButtonStates();
                player.classList.add('translate-x-[200%]');
                setTimeout(() => player.classList.add('hidden'), 300);
                if (audioTimer) clearInterval(audioTimer);
                currentUtterance = null;
            };

            utterance.onerror = () => {
                resetButtonStates();
                player.classList.add('hidden');
                if (audioTimer) clearInterval(audioTimer);
                currentUtterance = null;
            };

            window.speechSynthesis.speak(utterance);
        }

        function stopSpeaking() {
            window.speechSynthesis.cancel();
            resetButtonStates();
            const player = document.getElementById('audioPlayer');
            player.classList.add('translate-x-[200%]');
            setTimeout(() => player.classList.add('hidden'), 300);
            if (audioTimer) clearInterval(audioTimer);
            currentUtterance = null;
        }

        function resetButtonStates() {
            document.querySelectorAll('.speak-btn').forEach(btn => {
                btn.querySelector('.material-symbols-outlined').textContent = 'volume_up';
                btn.classList.remove('text-primary');
                btn.classList.add('text-slate-500');
            });
        }

        function addMessage(content, isUser = false) {
            const messageDiv = document.createElement('div');
            messageDiv.className = isUser ? 'flex gap-3 flex-row-reverse group' : 'flex gap-3 group';

            const avatar = isUser
                ? '<div class="bg-center bg-no-repeat aspect-square bg-cover rounded-full size-8 shrink-0 self-end mb-1 bg-primary"></div>'
                : '<div class="bg-center bg-no-repeat aspect-square bg-cover rounded-full size-8 shrink-0 self-end mb-1 ring-2 ring-transparent group-hover:ring-primary/20 transition-all" style=\'background-image: url("/wavechat.png");\'></div>';

            const bubbleClass = isUser
                ? 'bg-gradient-to-br from-primary to-sky-600 p-3.5 rounded-2xl rounded-br-none shadow-lg shadow-primary/10'
                : 'bg-surface-dark p-3.5 rounded-2xl rounded-bl-none border border-white/5 shadow-sm';

            const textClass = isUser ? 'text-white' : 'text-slate-200';

            // Format content with markdown-like formatting
            const formattedContent = formatAIContent(content);

            messageDiv.innerHTML = `
                ${avatar}
                <div class="flex flex-col gap-1 max-w-[85%]">
                    ${!isUser ? '<p class="text-[10px] font-medium text-slate-400 ml-1 mb-0.5">Wave AI</p>' : ''}
                    <div class="${bubbleClass}">
                        <div class="text-sm leading-relaxed ${textClass}">${formattedContent}</div>
                    </div>
                    <div class="flex items-center gap-2 ${isUser ? 'justify-end mr-1' : 'justify-start ml-1'}">
                        ${!isUser ? `
                            <button onclick="speakText(this.closest('.flex-col').querySelector('.text-sm').innerText, this)" class="speak-btn p-1 text-slate-500 hover:text-primary transition-colors" title="Read Aloud">
                                <span class="material-symbols-outlined text-[16px]">volume_up</span>
                            </button>
                            <button onclick="stopSpeaking()" class="p-1 text-slate-500 hover:text-red-400 transition-colors" title="Stop Reading">
                                <span class="material-symbols-outlined text-[16px]">stop_circle</span>
                            </button>
                        ` : ''}
                        ${isUser ? '<span class="text-[10px] font-medium text-slate-500 opacity-0 group-hover:opacity-100 transition-opacity">' + new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' }) + '</span>' : ''}
                    </div>
                </div>
            `;

            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;

            return messageDiv; // Return the element so it can be manipulated
        }

        // Get language flag emoji
        function getLanguageFlag(language) {
            const flags = {
                'Spanish': 'üá™üá∏', 'French': 'üá´üá∑', 'German': 'üá©üá™', 'Italian': 'üáÆüáπ',
                'Portuguese': 'üáµüáπ', 'Russian': 'üá∑üá∫', 'Chinese': 'üá®üá≥', 'Japanese': 'üáØüáµ',
                'Korean': 'üá∞üá∑', 'Arabic': 'üá∏üá¶', 'Hindi': 'üáÆüá≥', 'Turkish': 'üáπüá∑',
                'Polish': 'üáµüá±', 'Dutch': 'üá≥üá±', 'Ukrainian': 'üá∫üá¶', 'Swedish': 'üá∏üá™',
                'Greek': 'üá¨üá∑', 'Czech': 'üá®üáø', 'English': 'üá¨üáß'
            };
            return flags[language] || 'üåê';
        }

        function formatAIContent(content) {
            const trimmedContent = content.trim();

            // Check if it's standalone JSON
            let cleanContent = trimmedContent;
            if (cleanContent.toLowerCase().startsWith('json')) {
                cleanContent = cleanContent.substring(4).trim();
            }

            // Check if the cleaned content is a JSON object
            if (cleanContent.startsWith('{') && cleanContent.endsWith('}')) {
                try {
                    // Replace any weird whitespace with regular spaces
                    cleanContent = cleanContent.replace(/\s+/g, ' ');
                    const parsed = JSON.parse(cleanContent);

                    // Check if it's a translation JSON (has original, translation, language)
                    if (parsed.original && parsed.translation && parsed.language) {
                        // Render as beautiful translation card
                        const flag = getLanguageFlag(parsed.language);
                        return `<div class="bg-gradient-to-br from-slate-800 to-slate-900 rounded-2xl shadow-xl p-6 border border-primary/20 hover:border-primary/40 transition-all duration-300 my-3">
                            <div class="flex items-center gap-2 mb-4">
                                <span class="text-2xl">${flag}</span>
                                <h3 class="text-xl font-bold text-white">Translation</h3>
                            </div>
                            <div class="space-y-3">
                                <div class="bg-slate-900/50 rounded-xl p-3 border border-white/5">
                                    <span class="text-xs font-semibold text-slate-400 uppercase tracking-wider">Original</span>
                                    <p class="text-base text-slate-200 mt-1">${parsed.original}</p>
                                </div>
                                <div class="bg-gradient-to-r from-primary/10 to-sky-500/10 rounded-xl p-3 border border-primary/30">
                                    <span class="text-xs font-semibold text-primary uppercase tracking-wider">Translation</span>
                                    <p class="text-lg text-white font-medium mt-1">${parsed.translation}</p>
                                </div>
                                <div class="flex items-center gap-2 text-sm">
                                    <span class="text-slate-400">Language:</span>
                                    <span class="px-3 py-1 rounded-full bg-primary/20 text-primary font-semibold">${parsed.language}</span>
                                </div>
                            </div>
                        </div>`;
                    }

                    // Otherwise, render as code block with compact spacing (left-aligned, max-width)
                    const formattedJson = JSON.stringify(parsed, null, 1); // Changed from 2 to 1 for tighter spacing
                    return `<div class="my-3 rounded-xl overflow-hidden border border-slate-700/50 bg-slate-900/30 inline-block max-w-[90%]">
                        <div class="bg-gradient-to-r from-slate-800 to-slate-800/80 px-4 py-2.5 flex items-center justify-between border-b border-slate-700/50">
                            <span class="text-xs font-bold text-slate-300 uppercase tracking-wide">json</span>
                            <button onclick="copyCode(this)" class="px-3 py-1.5 text-xs text-slate-400 hover:text-white hover:bg-slate-700 rounded-lg transition-all flex items-center gap-1.5 font-medium">
                                <span class="material-symbols-outlined text-[16px]">content_copy</span>
                                Copy
                            </button>
                        </div>
                        <pre class="bg-slate-950 p-4 overflow-x-auto max-h-[500px]"><code class="text-emerald-400 font-mono text-sm leading-snug">${formattedJson}</code></pre>
                    </div>`;
                } catch (e) {
                    console.error('Failed to parse JSON:', e);
                    console.error('Content was:', cleanContent);
                    // Not valid JSON, continue with normal formatting
                }
            }

            // Extract and process code blocks BEFORE escaping HTML
            let codeBlocks = [];
            let codeBlockCounter = 0;

            // Extract and process tables BEFORE escaping HTML
            let tables = [];
            let tableCounter = 0;

            // Replace tables with placeholders FIRST
            let contentWithTablePlaceholders = content.replace(/(\|.+\|\n)+/g, function (match) {
                const placeholder = `___TABLE_${tableCounter}___`;

                // Remove separator lines
                const cleanedTable = match.replace(/\|[\s\-:]+\|[\s\-:]*\|?\n/g, '');

                // Split into rows
                const rows = cleanedTable.trim().split('\n').filter(r => r.trim());
                if (rows.length === 0) return match;

                // Process each row
                const tableRows = rows.map((row, index) => {
                    const cells = row.split('|').filter(c => c.trim());
                    const isHeader = index === 0;
                    const tag = isHeader ? 'th' : 'td';
                    const cellClass = isHeader
                        ? 'border border-slate-700/50 px-3 py-2 text-sm font-bold text-white bg-slate-800/50 align-top'
                        : 'border border-slate-700/50 px-3 py-2 text-sm align-top';

                    return '<tr>' + cells.map(c => `<${tag} class="${cellClass}">${c.trim()}</${tag}>`).join('') + '</tr>';
                }).join('');

                tables[tableCounter] = '<div class="my-3 overflow-x-auto rounded-xl border border-slate-700/50 inline-block max-w-fit">' +
                    '<table class="border-collapse text-sm bg-slate-900/30">' + tableRows + '</table></div>';

                tableCounter++;
                return placeholder;
            });

            // Replace code blocks with placeholders
            let contentWithPlaceholders = contentWithTablePlaceholders.replace(/```(\w+)?\n([\s\S]+?)```/g, function (match, lang, code) {
                const placeholder = `___CODE_BLOCK_${codeBlockCounter}___`;
                const language = lang || 'code';
                const uniqueId = `code-block-${Date.now()}-${codeBlockCounter}`;

                // Get the raw code
                let rawCode = code.trim();

                // Detect if it's JSON and format it with compact spacing
                if (language === 'json' || (language === 'text' && (rawCode.startsWith('{') || rawCode.startsWith('[')))) {
                    try {
                        const parsed = JSON.parse(rawCode);
                        rawCode = JSON.stringify(parsed, null, 1); // Changed from 2 to 1 for tighter spacing
                    } catch (e) {
                        // Not valid JSON, keep as is
                    }
                }

                // Count actual lines
                const lineCount = rawCode.split(/\r?\n/).length;

                // Escape HTML for display but preserve line breaks
                const escapedCode = rawCode
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/"/g, '&quot;')
                    .replace(/'/g, '&#039;');

                const languageLabel = `<span class="text-xs font-bold text-slate-300 uppercase tracking-wide">${language}</span>`;

                // Store the formatted code block with better styling (left-aligned, max-width)
                codeBlocks[codeBlockCounter] = `<div class="my-3 rounded-xl overflow-hidden border border-slate-700/50 bg-slate-900/30 shadow-lg inline-block max-w-[90%]">
                    <div class="bg-gradient-to-r from-slate-800 to-slate-800/80 px-4 py-2.5 flex items-center justify-between border-b border-slate-700/50">
                        <div class="flex items-center gap-3">
                            ${languageLabel}
                            <span class="text-xs text-slate-500 font-medium">${lineCount} ${lineCount === 1 ? 'line' : 'lines'}</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <button onclick="copyCodeFromCollapsed('${uniqueId}')" class="px-3 py-1.5 text-xs text-slate-400 hover:text-white hover:bg-slate-700 rounded-lg transition-all flex items-center gap-1.5 font-medium">
                                <span class="material-symbols-outlined text-[16px]">content_copy</span>
                                Copy
                            </button>
                            <button onclick="toggleCodeBlock('${uniqueId}')" class="px-3 py-1.5 text-xs text-primary hover:text-white hover:bg-primary/20 rounded-lg transition-all flex items-center gap-1.5 font-medium">
                                <span class="material-symbols-outlined text-[18px]" id="${uniqueId}-icon">expand_more</span>
                                <span id="${uniqueId}-text">Show</span>
                            </button>
                        </div>
                    </div>
                    <div id="${uniqueId}" class="hidden">
                        <pre class="bg-slate-950 p-4 overflow-x-auto max-h-[600px] text-sm leading-snug"><code class="text-emerald-400 font-mono whitespace-pre">${escapedCode}</code></pre>
                    </div>
                </div>`;

                codeBlockCounter++;
                return placeholder;
            });

            // Now escape the rest of the HTML (non-code, non-table content)
            const div = document.createElement('div');
            div.textContent = contentWithPlaceholders;
            let formatted = div.innerHTML;

            // Restore tables from placeholders FIRST
            for (let i = 0; i < tables.length; i++) {
                formatted = formatted.replace(`___TABLE_${i}___`, tables[i]);
            }

            // Restore code blocks from placeholders
            for (let i = 0; i < codeBlocks.length; i++) {
                formatted = formatted.replace(`___CODE_BLOCK_${i}___`, codeBlocks[i]);
            }

            // Format headings (###, ##, #) - removed arrow symbols
            formatted = formatted.replace(/^### (.+)$/gm, '<h3 class="text-lg font-bold text-white mt-4 mb-2">$1</h3>');
            formatted = formatted.replace(/^## (.+)$/gm, '<h2 class="text-xl font-bold text-white mt-4 mb-2">$1</h2>');
            formatted = formatted.replace(/^# (.+)$/gm, '<h1 class="text-2xl font-bold text-white mt-4 mb-2">$1</h1>');

            // Format bold text (**text**)
            formatted = formatted.replace(/\*\*(.+?)\*\*/g, '<strong class="font-semibold text-white">$1</strong>');

            // Format italic text (*text* or _text_)
            formatted = formatted.replace(/\*(.+?)\*/g, '<em class="italic text-slate-300">$1</em>');
            formatted = formatted.replace(/_(.+?)_/g, '<em class="italic text-slate-300">$1</em>');

            // Format inline code (`code`)
            formatted = formatted.replace(/`([^`]+)`/g, '<code class="bg-slate-800 px-2 py-0.5 rounded text-primary font-mono text-xs border border-slate-700">$1</code>');

            // Format links [text](url)
            formatted = formatted.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank" class="text-primary hover:text-sky-400 underline decoration-primary/30 hover:decoration-sky-400 transition-colors">$1 <span class="material-symbols-outlined text-[12px] align-middle">open_in_new</span></a>');

            // Format unordered lists (- item or * item)
            formatted = formatted.replace(/^[‚Ä¢\-\*] (.+)$/gm, '<li class="ml-4 flex items-start gap-2"><span class="text-primary mt-1">‚Ä¢</span><span>$1</span></li>');

            // Format numbered lists (1. item)
            let listCounter = 0;
            formatted = formatted.replace(/^\d+\. (.+)$/gm, function (match, text) {
                listCounter++;
                return `<li class="ml-4 flex items-start gap-2"><span class="text-primary font-semibold min-w-[20px]">${listCounter}.</span><span>${text}</span></li>`;
            });

            // Wrap consecutive list items in ul
            formatted = formatted.replace(/(<li class="ml-4[^>]*>.*?<\/li>\n?)+/g, function (match) {
                return '<ul class="my-2 space-y-1.5">' + match + '</ul>';
            });

            // Format blockquotes (> text)
            formatted = formatted.replace(/^&gt; (.+)$/gm, '<blockquote class="border-l-4 border-primary/50 bg-slate-800/30 pl-4 py-2 italic text-slate-300 my-2 rounded-r">$1</blockquote>');

            // Format horizontal rules (---)
            formatted = formatted.replace(/^---$/gm, '<hr class="border-slate-700 my-4">');

            // Format checkboxes with Material Icons style
            formatted = formatted.replace(/\[x\]/gi, '<span class="inline-flex items-center justify-center w-5 h-5 rounded bg-green-500/20 border border-green-500/50"><span class="material-symbols-outlined text-green-500 text-[14px]">check</span></span>');
            formatted = formatted.replace(/\[ \]/g, '<span class="inline-flex items-center justify-center w-5 h-5 rounded bg-slate-700/30 border border-slate-600"><span class="material-symbols-outlined text-slate-500 text-[14px]">close</span></span>');

            // Format line breaks
            formatted = formatted.replace(/\n/g, '<br>');

            return formatted;
        }

        // Copy code to clipboard
        function copyCode(button) {
            try {
                // Find the code block - it's in the next sibling (pre element)
                const container = button.closest('.rounded-lg');
                const codeBlock = container.querySelector('code');

                if (!codeBlock) {
                    console.error('Code block not found');
                    return;
                }

                const text = codeBlock.textContent;

                navigator.clipboard.writeText(text).then(() => {
                    const originalText = button.innerHTML;
                    button.innerHTML = '<span class="material-symbols-outlined text-[14px]">check</span>Copied!';
                    button.classList.add('text-green-500');

                    setTimeout(() => {
                        button.innerHTML = originalText;
                        button.classList.remove('text-green-500');
                    }, 2000);
                }).catch(err => {
                    console.error('Failed to copy:', err);
                    alert('Failed to copy to clipboard');
                });
            } catch (error) {
                console.error('Copy error:', error);
            }
        }

        // Toggle collapsible code block
        function toggleCodeBlock(blockId) {
            const codeBlock = document.getElementById(blockId);
            const icon = document.getElementById(blockId + '-icon');
            const text = document.getElementById(blockId + '-text');

            if (codeBlock.classList.contains('hidden')) {
                // Show code
                codeBlock.classList.remove('hidden');
                icon.textContent = 'expand_less';
                text.textContent = 'Hide';
            } else {
                // Hide code
                codeBlock.classList.add('hidden');
                icon.textContent = 'expand_more';
                text.textContent = 'Show';
            }
        }

        // Copy code from collapsed block (without opening it)
        function copyCodeFromCollapsed(blockId) {
            const codeBlock = document.getElementById(blockId);
            const codeElement = codeBlock.querySelector('code');

            if (!codeElement) {
                console.error('Code element not found');
                return;
            }

            const text = codeElement.textContent;

            navigator.clipboard.writeText(text).then(() => {
                // Find the copy button
                const container = codeBlock.closest('.rounded-lg');
                const copyButton = container.querySelector('button[onclick*="copyCodeFromCollapsed"]');

                if (copyButton) {
                    const originalHTML = copyButton.innerHTML;
                    copyButton.innerHTML = '<span class="material-symbols-outlined text-[14px]">check</span>Copied!';
                    copyButton.classList.add('text-green-500');

                    setTimeout(() => {
                        copyButton.innerHTML = originalHTML;
                        copyButton.classList.remove('text-green-500');
                    }, 2000);
                }
            }).catch(err => {
                console.error('Failed to copy:', err);
                alert('Failed to copy to clipboard');
            });
        }

        // ===== CHAT SAVING FUNCTIONS =====

        function saveCurrentChat() {
            if (conversationHistory.length === 0) {
                alert('No conversation to save!');
                return;
            }
            document.getElementById('saveChatModal').classList.remove('hidden');
            document.getElementById('chatNameInput').focus();
        }

        function closeSaveChatModal() {
            document.getElementById('saveChatModal').classList.add('hidden');
            document.getElementById('chatNameInput').value = '';
        }

        function confirmSaveChat() {
            const chatName = document.getElementById('chatNameInput').value.trim();
            if (!chatName) {
                alert('Please enter a chat name');
                return;
            }

            // Get existing saved chats
            const savedChats = JSON.parse(localStorage.getItem('aiSavedChats') || '[]');

            // Create new chat object
            const newChat = {
                id: Date.now(),
                name: chatName,
                timestamp: new Date().toISOString(),
                history: conversationHistory,
                model: localStorage.getItem('preferredAIModel') || 'wave-flash-2',
                messageCount: conversationHistory.length
            };

            // Add to saved chats
            savedChats.unshift(newChat); // Add to beginning

            // Keep only last 50 chats
            if (savedChats.length > 50) {
                savedChats.pop();
            }

            // Save to localStorage
            localStorage.setItem('aiSavedChats', JSON.stringify(savedChats));

            closeSaveChatModal();

            // Show success message
            const successDiv = document.createElement('div');
            successDiv.className = 'fixed top-20 right-6 bg-primary text-white px-6 py-3 rounded-xl shadow-lg z-50 animate-fade-in';
            successDiv.innerHTML = `
                <div class="flex items-center gap-2">
                    <span class="material-symbols-outlined">check_circle</span>
                    <span>Chat saved successfully!</span>
                </div>
            `;
            document.body.appendChild(successDiv);
            setTimeout(() => successDiv.remove(), 3000);
        }

        function showSavedChats() {
            const savedChats = JSON.parse(localStorage.getItem('aiSavedChats') || '[]');
            const listContainer = document.getElementById('savedChatsList');

            if (savedChats.length === 0) {
                listContainer.innerHTML = `
                    <div class="text-center py-12 text-slate-400">
                        <span class="material-symbols-outlined text-5xl mb-3 opacity-50">bookmark_border</span>
                        <p>No saved chats yet</p>
                        <p class="text-xs mt-2">Save your conversations to access them later</p>
                    </div>
                `;
            } else {
                listContainer.innerHTML = savedChats.map(chat => {
                    const date = new Date(chat.timestamp);
                    const dateStr = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                    const timeStr = date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });

                    return `
                        <div class="bg-background-dark rounded-xl p-4 border border-white/5 hover:border-primary/30 transition-all group cursor-pointer">
                            <div class="flex items-start justify-between gap-3">
                                <div class="flex-1" onclick="loadSavedChat(${chat.id})">
                                    <h4 class="font-semibold text-white group-hover:text-primary transition-colors">${chat.name}</h4>
                                    <p class="text-xs text-slate-400 mt-1">${chat.messageCount} messages ‚Ä¢ ${dateStr} at ${timeStr}</p>
                                    <p class="text-xs text-slate-500 mt-1">Model: ${chat.model.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}</p>
                                </div>
                                <button onclick="deleteSavedChat(${chat.id}); event.stopPropagation();" class="text-slate-400 hover:text-red-400 transition-colors p-2" title="Delete">
                                    <span class="material-symbols-outlined text-[20px]">delete</span>
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            document.getElementById('savedChatsModal').classList.remove('hidden');
        }

        function closeSavedChatsModal() {
            document.getElementById('savedChatsModal').classList.add('hidden');
        }

        function loadSavedChat(chatId) {
            const savedChats = JSON.parse(localStorage.getItem('aiSavedChats') || '[]');
            const chat = savedChats.find(c => c.id === chatId);

            if (!chat) {
                alert('Chat not found');
                return;
            }

            // Clear current chat
            clearChat(false);

            // Load conversation history
            conversationHistory = chat.history;

            // Render messages
            chat.history.forEach(msg => {
                const isUser = msg.role === 'user';
                const content = msg.parts[0].text;
                addMessage(content, isUser);
            });

            closeSavedChatsModal();

            // Show success message
            const successDiv = document.createElement('div');
            successDiv.className = 'fixed top-20 right-6 bg-primary text-white px-6 py-3 rounded-xl shadow-lg z-50';
            successDiv.innerHTML = `
                <div class="flex items-center gap-2">
                    <span class="material-symbols-outlined">history</span>
                    <span>Chat loaded: ${chat.name}</span>
                </div>
            `;
            document.body.appendChild(successDiv);
            setTimeout(() => successDiv.remove(), 3000);
        }

        function deleteSavedChat(chatId) {
            if (!confirm('Delete this chat? This cannot be undone.')) {
                return;
            }

            let savedChats = JSON.parse(localStorage.getItem('aiSavedChats') || '[]');
            savedChats = savedChats.filter(c => c.id !== chatId);
            localStorage.setItem('aiSavedChats', JSON.stringify(savedChats));

            // Refresh the list
            showSavedChats();
        }

        function clearChat(showConfirm = true) {
            if (showConfirm && conversationHistory.length > 0) {
                if (!confirm('Start a new chat? Current conversation will be lost if not saved.')) {
                    return;
                }
            }

            // Clear conversation history
            conversationHistory = [];

            // Clear saved conversation from localStorage
            localStorage.removeItem('aiCurrentConversation');

            // Clear messages container
            messagesContainer.innerHTML = `
                <div class="flex justify-center my-4">
                    <span class="text-[10px] font-semibold tracking-wider text-slate-500 uppercase bg-surface-dark px-3 py-1 rounded-full border border-white/5">Today</span>
                </div>
            `;

            // Reload welcome message
            loadAIStatus();
        }

        // Load AI status on page load
        async function loadAIStatus() {
            // Get preferred model from localStorage
            const preferredModel = localStorage.getItem('preferredAIModel');
            const modelName = preferredModel ? preferredModel.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase()) : 'Wave Flash 2';

            // Add welcome message without HTML tags
            const welcomeDiv = document.createElement('div');
            welcomeDiv.className = 'flex gap-3 group';
            welcomeDiv.innerHTML = `
                <div class="bg-center bg-no-repeat aspect-square bg-cover rounded-full size-8 shrink-0 self-end mb-1 ring-2 ring-transparent group-hover:ring-primary/20 transition-all" style='background-image: url("/wavechat.png");'></div>
                <div class="flex flex-col gap-1 max-w-[85%]">
                    <p class="text-[10px] font-medium text-slate-400 ml-1 mb-0.5">Wave AI</p>
                    <div class="bg-surface-dark p-3.5 rounded-2xl rounded-bl-none border border-white/5 shadow-sm">
                        <div class="text-sm leading-relaxed text-slate-200">
                            Hello! I'm your Wave AI assistant üåä<br><br>
                            I can help you translate, summarize, write code, and explain topics. Use the buttons below or just chat with me!
                        </div>
                        <div class="text-[10px] text-slate-500 mt-2">Currently using: ${modelName} ‚Ä¢ Change in Settings</div>
                    </div>
                </div>
            `;
            messagesContainer.appendChild(welcomeDiv);
        }

        loadAIStatus();
    </script>

    <!-- Bottom Navigation (Desktop Sidebar Style) -->
    <nav class="hidden lg:block fixed bottom-6 left-6 z-50">
        <div class="p-2 bg-[#0b1418] border border-slate-800/40 rounded-xl shadow-2xl">
            <div class="flex items-center gap-1 rounded-xl bg-background-dark p-1">
                <a class="flex flex-col items-center justify-center p-2 rounded-lg text-[#90bccb] hover:text-white hover:bg-surface-hover transition-colors"
                    href="/chat.html" title="Chats">
                    <span class="material-symbols-outlined text-[24px]">chat_bubble</span>
                    <span class="text-[10px] font-medium mt-1">Chats</span>
                </a>
                <a class="flex flex-col items-center justify-center p-2 rounded-lg text-primary bg-primary/10 transition-colors"
                    href="/ai-chat.html" title="AI">
                    <span class="material-symbols-outlined text-[24px]">smart_toy</span>
                    <span class="text-[10px] font-medium mt-1">AI</span>
                </a>
                <a class="flex flex-col items-center justify-center p-2 rounded-lg text-[#90bccb] hover:text-white hover:bg-surface-hover transition-colors"
                    href="/feed.html" title="Feed">
                    <span class="material-symbols-outlined text-[24px]">newspaper</span>
                    <span class="text-[10px] font-medium mt-1">Feed</span>
                </a>
                <a class="flex flex-col items-center justify-center p-2 rounded-lg text-[#90bccb] hover:text-white hover:bg-surface-hover transition-colors"
                    href="/music.html" title="Music">
                    <span class="material-symbols-outlined text-[24px]">music_note</span>
                    <span class="text-[10px] font-medium mt-1">Music</span>
                </a>
                <a class="flex flex-col items-center justify-center p-2 rounded-lg text-[#90bccb] hover:text-white hover:bg-surface-hover transition-colors"
                    href="/profile.html" title="Profile">
                    <span class="material-symbols-outlined text-[24px]">person</span>
                    <span class="text-[10px] font-medium mt-1">Profile</span>
                </a>
                <a class="flex flex-col items-center justify-center p-2 rounded-lg text-[#90bccb] hover:text-white hover:bg-surface-hover transition-colors"
                    href="/settings.html" title="Settings">
                    <span class="material-symbols-outlined text-[24px]">settings</span>
                    <span class="text-[10px] font-medium mt-1">Settings</span>
                </a>
            </div>
        </div>
    </nav>

    <!-- Duplicate Nav Removed -->

    <!-- Background Image Script -->
    <script>
        // Load theme colors from localStorage
        (function () {
            const primary = localStorage.getItem('themeColorPrimary');
            const secondary = localStorage.getItem('themeColorSecondary');
            const tertiary = localStorage.getItem('themeColorTertiary');
            const background = localStorage.getItem('themeColorBackground');
            const surface = localStorage.getItem('themeColorSurface');
            const highlight = localStorage.getItem('themeColorHighlight');

            if (primary) document.documentElement.style.setProperty('--color-primary', primary);
            if (secondary) document.documentElement.style.setProperty('--color-secondary', secondary);
            if (tertiary) document.documentElement.style.setProperty('--color-tertiary', tertiary);
            if (background) {
                document.documentElement.style.setProperty('--bg-page', background);
                document.body.style.backgroundColor = background;
                setTimeout(() => {
                    const mainAreas = document.querySelectorAll('main, .relative.flex.h-screen, #chat-container');
                    mainAreas.forEach(el => el.style.backgroundColor = background);
                }, 100);
            }
            if (surface) {
                document.documentElement.style.setProperty('--bg-surface', surface);
                setTimeout(() => {
                    const surfaceElements = document.querySelectorAll('.bg-surface-dark, .bg-\\[\\#16262c\\], .bg-\\[\\#1e2433\\]');
                    surfaceElements.forEach(el => el.style.backgroundColor = surface);
                }, 100);
            }
            if (highlight) {
                document.documentElement.style.setProperty('--surface-hover', highlight);
                document.documentElement.style.setProperty('--bg-surface-lighter', highlight);
            }
        })();

        // Load transparency mode from localStorage
        (function () {
            const isTransparent = localStorage.getItem('transparencyMode') === 'true';
            if (isTransparent) {
                document.body.classList.add('transparency-mode');
            }
        })();

        // Load custom background from localStorage
        (function () {
            const bgDiv = document.getElementById('customBackground');
            if (!bgDiv) return;

            const chatBackground = localStorage.getItem('chatBackground');
            const customBgUrl = localStorage.getItem('customBackgroundUrl');
            const bgOpacity = localStorage.getItem('bgOpacity') || 10;
            const bgBlur = localStorage.getItem('bgBlur') || 4;

            let backgroundUrl = '';

            if (chatBackground && chatBackground !== 'none') {
                if (chatBackground === 'custom' && customBgUrl) {
                    backgroundUrl = customBgUrl;
                } else if (chatBackground.startsWith('bg')) {
                    const bgMap = {
                        'bg1': '1769528516',
                        'bg2': '1769528550',
                        'bg3': '1769528632',
                        'bg4': '1769528667',
                        'bg5': '1769528899',
                        'bg6': '1769529072'
                    };
                    const bgNum = bgMap[chatBackground];
                    if (bgNum) {
                        backgroundUrl = `/backgrounds/${bgNum}.png`;
                    }
                }
            }

            if (backgroundUrl) {
                bgDiv.classList.remove('hidden');
                // NEW STYLING: Image in center, solid color on sides
                bgDiv.style.cssText = `
                    background-image: url('${backgroundUrl}');
                    background-size: contain;
                    background-position: center;
                    background-repeat: no-repeat;
                    background-color: #101e22;
                    opacity: ${bgOpacity / 100};
                    filter: blur(${bgBlur}px);
                `;
            } else {
                bgDiv.classList.add('hidden');
            }
        })();

        // ===== MOBILE-SPECIFIC ADDITIONS =====

        // Mobile Sidebar Functions
        function openSidebar() {
            const sidebar = document.querySelector('.mobile-sidebar');
            const overlay = document.querySelector('.sidebar-overlay');
            if (sidebar) sidebar.classList.add('open');
            if (overlay) overlay.classList.add('active');
            document.body.style.overflow = 'hidden';
            loadSidebarChats();
            // Update hamburger menu state
            updateHamburgerState();
        }

        function closeSidebar() {
            const sidebar = document.querySelector('.mobile-sidebar');
            const overlay = document.querySelector('.sidebar-overlay');
            if (sidebar) sidebar.classList.remove('open');
            if (overlay) overlay.classList.remove('active');
            document.body.style.overflow = '';
            // Update hamburger menu state
            updateHamburgerState();
        }

        function toggleSidebar() {
            const sidebar = document.querySelector('.mobile-sidebar');
            if (sidebar && sidebar.classList.contains('open')) {
                closeSidebar();
            } else {
                openSidebar();
            }
        }

        function updateHamburgerState() {
            const sidebar = document.querySelector('.mobile-sidebar');
            const hamburger = document.querySelector('.hamburger-menu');
            if (hamburger) {
                if (sidebar && sidebar.classList.contains('open')) {
                    hamburger.classList.add('active');
                } else {
                    hamburger.classList.remove('active');
                }
            }
        }

        // Mobile Swipe Gestures
        (function initMobileGestures() {
            let touchStartX = 0;
            let touchStartY = 0;

            const mainContent = document.querySelector('.relative.flex.h-screen');
            const sidebar = document.querySelector('.mobile-sidebar');

            if (mainContent) {
                mainContent.addEventListener('touchstart', (e) => {
                    touchStartX = e.changedTouches[0].screenX;
                    touchStartY = e.changedTouches[0].screenY;
                });

                mainContent.addEventListener('touchend', (e) => {
                    const touchEndX = e.changedTouches[0].screenX;
                    const touchEndY = e.changedTouches[0].screenY;

                    const diffX = touchEndX - touchStartX;
                    const diffY = touchEndY - touchStartY;

                    if (Math.abs(diffX) > Math.abs(diffY) && Math.abs(diffX) > 80) {
                        if (diffX > 0 && touchStartX < 50) {
                            openSidebar();
                        }
                    }
                });
            }

            if (sidebar) {
                sidebar.addEventListener('touchstart', (e) => {
                    touchStartX = e.changedTouches[0].screenX;
                });

                sidebar.addEventListener('touchend', (e) => {
                    const touchEndX = e.changedTouches[0].screenX;
                    const diffX = touchEndX - touchStartX;

                    if (Math.abs(diffX) > 80 && diffX < 0) {
                        closeSidebar();
                    }
                });
            }
        })();

        // Load saved chats in sidebar
        function loadSidebarChats() {
            try {
                const savedChats = JSON.parse(localStorage.getItem('aiSavedChats') || '[]');
                const container = document.getElementById('sidebarChatsList');

                if (!container) return;

                if (savedChats.length === 0) {
                    container.innerHTML = '<p class="text-xs text-slate-500 text-center py-4">No saved chats</p>';
                } else {
                    container.innerHTML = savedChats.slice(0, 10).map(chat => `
                        <div class="flex items-center justify-between p-3 rounded-lg bg-background-dark hover:bg-surface-dark-lighter border border-white/5 transition-all cursor-pointer" onclick="loadChat(${chat.id})">
                            <div class="flex-1 min-w-0">
                                <div class="font-medium text-sm text-white truncate">${chat.name}</div>
                                <div class="text-xs text-slate-400 mt-0.5">${new Date(chat.timestamp).toLocaleDateString()}</div>
                            </div>
                            <button onclick="event.stopPropagation(); deleteChat(${chat.id})" class="ml-2 p-1.5 text-slate-400 hover:text-red-400 transition-colors">
                                <span class="material-symbols-outlined text-[18px]">delete</span>
                            </button>
                        </div>
                    `).join('');
                }
            } catch (e) {
                console.error('Failed to load sidebar chats:', e);
            }
        }

        function loadChat(chatId) {
            try {
                const savedChats = JSON.parse(localStorage.getItem('aiSavedChats') || '[]');
                const chat = savedChats.find(c => c.id === chatId);

                if (chat) {
                    conversationHistory = chat.history;
                    messagesContainer.innerHTML = '<div class="flex justify-center my-4"><span class="text-[10px] font-semibold tracking-wider text-slate-500 uppercase bg-surface-dark px-3 py-1 rounded-full border border-white/5">Today</span></div>';

                    conversationHistory.forEach(msg => {
                        if (msg._hidden) return;
                        if (msg.role === 'user') {
                            addMessage(msg.parts[0].text, true);
                        } else if (msg.role === 'model') {
                            addMessage(msg.parts[0].text, false);
                        }
                    });

                    saveConversation();
                    closeSidebar();
                }
            } catch (e) {
                console.error('Failed to load chat:', e);
            }
        }

        function deleteChat(chatId) {
            if (confirm('Delete this chat?')) {
                try {
                    const savedChats = JSON.parse(localStorage.getItem('aiSavedChats') || '[]');
                    const filtered = savedChats.filter(c => c.id !== chatId);
                    localStorage.setItem('aiSavedChats', JSON.stringify(filtered));
                    loadSidebarChats();
                } catch (e) {
                    console.error('Failed to delete chat:', e);
                }
            }
        }
    </script>

    <!-- Mobile Bottom Navigation -->
    <nav
        class="lg:hidden fixed bottom-0 left-0 right-0 z-50 bg-surface-dark/95 backdrop-blur-lg border-t border-border-dark pb-safe">
        <div class="flex justify-around items-center h-20 px-6 pb-2">
            <!-- Chats -->
            <a href="/mobile/chat.html"
                class="flex flex-col items-center gap-1 w-12 text-slate-400 hover:text-slate-200 transition-colors">
                <span class="material-symbols-outlined" style="font-size: 24px;">chat_bubble</span>
                <span class="text-[10px] font-medium">Chats</span>
            </a>

            <!-- Feed (Floating) -->
            <a href="/mobile/feed.html" class="flex flex-col items-center justify-center -mt-6">
                <div
                    class="w-14 h-14 rounded-full bg-gradient-to-tr from-primary to-blue-400 shadow-[0_8px_16px_rgba(13,185,242,0.3)] flex items-center justify-center text-white transform active:scale-95 transition-transform">
                    <span class="material-symbols-outlined" style="font-size: 28px;">newspaper</span>
                </div>
            </a>

            <!-- AI (Active) -->
            <button class="flex flex-col items-center gap-1 w-12 text-primary">
                <div class="w-10 h-8 flex items-center justify-center bg-primary/10 rounded-full">
                    <span class="material-symbols-outlined fill-current" style="font-size: 24px;">smart_toy</span>
                </div>
                <span class="text-[10px] font-semibold">AI</span>
            </button>

            <!-- Profile -->
            <a href="/mobile/bio.html"
                class="flex flex-col items-center gap-1 w-12 text-slate-400 hover:text-slate-200 transition-colors">
                <div
                    class="w-6 h-6 rounded-full overflow-hidden bg-slate-700 ring-2 ring-transparent hover:ring-primary transition-all">
                    <span class="material-symbols-outlined text-slate-400 text-[20px]">person</span>
                </div>
                <span class="text-[10px] font-medium">Profile</span>
            </a>
        </div>
    </nav>
</body>

</html>