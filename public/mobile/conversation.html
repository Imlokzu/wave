<!DOCTYPE html>
<html class="dark" lang="en">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" name="viewport"/>
    <title>Wave - Chat</title>
    <link href="/css/theme.css" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#0db9f2",
                        "primary-dark": "#0a8fc4",
                        "background-light": "#f5f8f8",
                        "background-dark": "#0a0f12",
                        "surface-dark": "#0f1419",
                        "surface-hover": "#151b21",
                        "surface-lighter": "#1a2128",
                        "border-dark": "#1f2830",
                    },
                    fontFamily: {
                        "display": ["Inter", "sans-serif"]
                    },
                    borderRadius: {"DEFAULT": "0.25rem", "lg": "0.5rem", "xl": "0.75rem", "2xl": "1rem", "full": "9999px"},
                },
            },
        }
    </script>
    <style>
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        body { min-height: 100dvh; }
        
        .context-menu {
            position: fixed;
            background: rgba(15, 20, 25, 0.95);
            backdrop-filter: blur(24px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
            z-index: 9999;
            min-width: 200px;
            padding: 6px;
            display: none;
        }
        .context-menu.show { display: block; }
        .context-menu-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.2s;
            color: rgba(255, 255, 255, 0.95);
            font-size: 14px;
        }
        .context-menu-item:hover {
            background: rgba(13, 185, 242, 0.7);
            color: white;
        }
        .context-menu-item.danger:hover {
            background: rgba(239, 68, 68, 0.7);
        }
        
        #attachmentMenu {
            opacity: 0;
            transform: translateY(10px);
            transition: opacity 0.2s, transform 0.2s;
            pointer-events: none;
        }
        #attachmentMenu.show {
            opacity: 1;
            transform: translateY(0);
            pointer-events: all;
        }
    </style>
</head>
<body class="bg-background-dark text-white font-display overflow-x-hidden min-h-screen flex flex-col">

<header class="sticky top-0 z-50 bg-surface-dark/95 backdrop-blur-xl px-4 py-3 border-b border-border-dark">
    <div class="flex items-center gap-3">
        <button onclick="goBack()" class="w-10 h-10 flex items-center justify-center rounded-lg text-slate-400 hover:text-primary transition-colors">
            <span class="material-symbols-outlined">arrow_back</span>
        </button>
        <div class="flex-1">
            <h1 id="chatTitle" class="text-lg font-bold text-white">Chat</h1>
            <p id="chatStatus" class="text-xs text-slate-400"></p>
        </div>
        <button onclick="toggleInfo()" class="w-10 h-10 flex items-center justify-center rounded-lg text-slate-400 hover:text-primary transition-colors">
            <span class="material-symbols-outlined">info</span>
        </button>
    </div>
</header>

<div id="messagesFeed" class="flex-1 overflow-y-auto hide-scrollbar px-4 py-4 space-y-4 relative">
    <div class="absolute inset-0 z-0 opacity-20 pointer-events-none">
        <div class="absolute top-[20%] right-[10%] w-[300px] h-[300px] bg-primary/20 blur-[100px] rounded-full animate-pulse"></div>
        <div class="absolute bottom-[10%] left-[10%] w-[250px] h-[250px] bg-indigo-600/20 blur-[80px] rounded-full"></div>
    </div>
    <div id="messages" class="relative z-10"></div>
</div>

<button id="scrollToBottomBtn" class="hidden fixed bottom-24 right-4 w-12 h-12 bg-primary hover:bg-primary-dark rounded-full shadow-lg flex items-center justify-center text-white transition-all z-30">
    <span class="material-symbols-outlined">arrow_downward</span>
</button>

<div class="sticky bottom-0 z-50 bg-surface-dark/95 backdrop-blur-xl p-4 border-t border-border-dark">
    <div id="typingIndicator" class="mb-2 text-xs text-slate-400 italic hidden">
        <span id="typingText"></span>
    </div>
    
    <div id="replyIndicator" class="hidden mb-2 bg-surface-lighter border-l-4 border-primary rounded-lg p-3">
        <div class="flex items-center justify-between">
            <div class="flex items-center gap-2 flex-1 min-w-0">
                <span class="material-symbols-outlined text-primary text-[18px]">reply</span>
                <div class="flex-1 min-w-0">
                    <p class="text-xs text-primary font-medium">Replying to</p>
                    <p id="replyText" class="text-xs text-slate-400 truncate"></p>
                </div>
            </div>
            <button onclick="cancelReply()" class="text-slate-400 hover:text-white ml-2">
                <span class="material-symbols-outlined text-[18px]">close</span>
            </button>
        </div>
    </div>
    
    <div class="flex items-end gap-2 bg-surface-lighter rounded-xl p-2 relative">
        <button id="attachBtn" class="p-2 text-slate-400 hover:text-primary transition-colors">
            <span class="material-symbols-outlined">add_circle</span>
        </button>
        <input id="messageInput" class="flex-1 bg-transparent border-none text-sm text-white placeholder-slate-400 focus:ring-0 p-2 outline-none" placeholder="Type a message..." type="text"/>
        <button id="emojiBtn" class="p-2 text-slate-400 hover:text-primary transition-colors">
            <span class="material-symbols-outlined">sentiment_satisfied</span>
        </button>
        <button id="sendButton" class="p-2 bg-primary hover:bg-primary-dark text-white rounded-lg transition-colors">
            <span class="material-symbols-outlined">send</span>
        </button>
    </div>
</div>

<div id="attachmentMenu" class="fixed bottom-24 left-4 right-4 bg-surface-dark/95 backdrop-blur-xl border border-border-dark rounded-xl shadow-2xl z-40 p-2">
    <button onclick="attachImage()" class="w-full px-4 py-3 hover:bg-surface-lighter rounded-lg text-left flex items-center gap-3 text-white transition-colors">
        <span class="material-symbols-outlined text-primary">image</span>
        <span class="text-sm">Image</span>
    </button>
    <button onclick="attachFile()" class="w-full px-4 py-3 hover:bg-surface-lighter rounded-lg text-left flex items-center gap-3 text-white transition-colors">
        <span class="material-symbols-outlined text-primary">attach_file</span>
        <span class="text-sm">File</span>
    </button>
    <button onclick="attachAudio()" class="w-full px-4 py-3 hover:bg-surface-lighter rounded-lg text-left flex items-center gap-3 text-white transition-colors">
        <span class="material-symbols-outlined text-primary">audio_file</span>
        <span class="text-sm">Audio</span>
    </button>
    <button onclick="createPoll()" class="w-full px-4 py-3 hover:bg-surface-lighter rounded-lg text-left flex items-center gap-3 text-white transition-colors">
        <span class="material-symbols-outlined text-primary">poll</span>
        <span class="text-sm">Create Poll</span>
    </button>
</div>

<div id="messageContextMenu" class="context-menu">
    <div class="context-menu-item" data-action="reply">
        <span class="material-symbols-outlined text-[20px]">reply</span>
        <span>Reply</span>
    </div>
    <div class="context-menu-item" data-action="copy">
        <span class="material-symbols-outlined text-[20px]">content_copy</span>
        <span>Copy</span>
    </div>
    <div class="context-menu-item" data-action="forward">
        <span class="material-symbols-outlined text-[20px]">forward</span>
        <span>Forward</span>
    </div>
    <div class="context-menu-item" data-action="react">
        <span class="material-symbols-outlined text-[20px]">add_reaction</span>
        <span>React</span>
    </div>
    <div class="context-menu-item" data-action="pin">
        <span class="material-symbols-outlined text-[20px]">push_pin</span>
        <span>Pin</span>
    </div>
    <div style="height: 1px; background: rgba(255,255,255,0.1); margin: 4px 0;"></div>
    <div class="context-menu-item" data-action="edit">
        <span class="material-symbols-outlined text-[20px]">edit</span>
        <span>Edit</span>
    </div>
    <div class="context-menu-item danger" data-action="delete">
        <span class="material-symbols-outlined text-[20px]">delete</span>
        <span>Delete</span>
    </div>
</div>

<script src="/js/config.js"></script>
<script src="/js/utils.js"></script>
<script src="/js/api.js"></script>
<script src="/js/socket.js"></script>
<script src="/js/state.js"></script>

<script>
// Check auth manually
const authToken = localStorage.getItem('authToken');
if (!authToken) {
    console.log('[Mobile] No auth token, redirecting to login');
    window.location.href = '/login.html';
}

const username = localStorage.getItem('username');
const currentDM = localStorage.getItem('currentDM');
const currentRoomCode = localStorage.getItem('currentRoomCode');

console.log('[Mobile] Auth token:', authToken ? 'EXISTS' : 'MISSING');
console.log('[Mobile] Username:', username);
console.log('[Mobile] Current DM:', currentDM);
console.log('[Mobile] Current Room:', currentRoomCode);

// Check if required scripts loaded
if (typeof socketManager === 'undefined') {
    console.error('[Mobile] socketManager not loaded!');
    alert('Error: Socket manager not loaded. Check console.');
}

if (typeof fetch === 'undefined') {
    console.error('[Mobile] fetch not available!');
}

console.log('[Mobile] Page loaded successfully');

let messages = [];
let replyingTo = null;
let contextMenuTarget = null;

// Only proceed if socketManager is available
if (typeof socketManager !== 'undefined') {
    socketManager.connect();

    if (username) {
        socketManager.socket.on('connect', () => {
            socketManager.registerUsername(username, username);
            
            if (currentDM) {
                socketManager.socket.emit('dm:join', { username: currentDM });
            } else if (currentRoomCode) {
                socketManager.socket.emit('room:join', { code: currentRoomCode });
            }
        });
    }
} else {
    console.error('[Mobile] Cannot connect - socketManager not available');
}

if (currentDM) {
    document.getElementById('chatTitle').textContent = currentDM;
    document.getElementById('chatStatus').textContent = 'Direct Message';
} else if (currentRoomCode) {
    document.getElementById('chatTitle').textContent = 'Room ' + currentRoomCode;
    document.getElementById('chatStatus').textContent = 'Group Chat';
}

function goBack() {
    window.location.href = '/mobile/chat.html';
}

function toggleInfo() {
    alert('Chat info coming soon!');
}

async function loadMessages() {
    try {
        if (currentDM) {
            const response = await fetch(`/api/dm/${currentDM}/messages`, {
                headers: { 'Authorization': `Bearer ${authToken}` }
            });
            if (response.ok) {
                const data = await response.json();
                messages = data.messages || [];
                renderMessages();
            }
        } else if (currentRoomCode) {
            const savedSession = localStorage.getItem('wave_session');
            if (savedSession) {
                const session = JSON.parse(savedSession);
                const room = session.rooms?.find(r => r.code === currentRoomCode);
                if (room && room.messages) {
                    messages = room.messages;
                    renderMessages();
                }
            }
        }
    } catch (error) {
        console.error('[Mobile] Error loading messages:', error);
    }
}

function renderMessages() {
    const container = document.getElementById('messages');
    
    if (messages.length === 0) {
        container.innerHTML = `
            <div class="text-center py-12">
                <span class="material-symbols-outlined text-slate-500 text-6xl">chat</span>
                <p class="text-slate-400 mt-4">No messages yet</p>
                <p class="text-slate-500 text-sm mt-2">Start the conversation!</p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = messages.map((msg, index) => {
        const isOwn = msg.sender === username || msg.username === username;
        const senderName = msg.sender || msg.username || 'Unknown';
        const timestamp = msg.timestamp ? new Date(msg.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : '';
        const messageId = msg.id || index;
        
        return `
            <div class="flex ${isOwn ? 'justify-end' : 'justify-start'}" data-message-id="${messageId}" data-sender-id="${msg.senderId || msg.userId || ''}">
                <div class="max-w-[75%]">
                    ${!isOwn ? `<p class="text-xs text-slate-400 mb-1 ml-2">${senderName}</p>` : ''}
                    <div class="px-4 py-2 rounded-2xl ${isOwn ? 'bg-primary text-white' : 'bg-surface-lighter text-white'} message-bubble">
                        ${msg.replyTo ? `
                            <div class="mb-2 pb-2 border-b border-white/20">
                                <p class="text-xs opacity-70">â†© Replying to</p>
                                <p class="text-xs opacity-80">${escapeHtml(msg.replyTo)}</p>
                            </div>
                        ` : ''}
                        <p class="text-sm break-words message-text">${escapeHtml(msg.text || msg.content || '')}</p>
                        ${timestamp ? `<p class="text-[10px] mt-1 ${isOwn ? 'text-white/70' : 'text-slate-500'}">${timestamp}</p>` : ''}
                    </div>
                </div>
            </div>
        `;
    }).join('');
    
    setTimeout(() => {
        const feed = document.getElementById('messagesFeed');
        feed.scrollTop = feed.scrollHeight;
    }, 100);
    
    checkScrollButton();
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

async function sendMessage() {
    const input = document.getElementById('messageInput');
    const text = input.value.trim();
    
    if (!text) return;
    
    try {
        if (currentDM) {
            const response = await fetch('/api/dm/send', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${authToken}`
                },
                body: JSON.stringify({
                    recipient: currentDM,
                    content: text,
                    replyTo: replyingTo
                })
            });
            
            if (response.ok) {
                input.value = '';
                cancelReply();
            }
        } else if (currentRoomCode) {
            socketManager.socket.emit('room:message', {
                code: currentRoomCode,
                text: text,
                replyTo: replyingTo
            });
            input.value = '';
            cancelReply();
        }
    } catch (error) {
        console.error('[Mobile] Error sending message:', error);
    }
}

document.getElementById('sendButton').onclick = sendMessage;
document.getElementById('messageInput').onkeypress = (e) => {
    if (e.key === 'Enter') sendMessage();
};

function setReplyTo(messageText) {
    replyingTo = messageText;
    document.getElementById('replyIndicator').classList.remove('hidden');
    document.getElementById('replyText').textContent = messageText;
    document.getElementById('messageInput').focus();
}

function cancelReply() {
    replyingTo = null;
    document.getElementById('replyIndicator').classList.add('hidden');
}

document.getElementById('attachBtn').onclick = (e) => {
    e.stopPropagation();
    const menu = document.getElementById('attachmentMenu');
    menu.classList.toggle('show');
};

document.addEventListener('click', (e) => {
    const menu = document.getElementById('attachmentMenu');
    const btn = document.getElementById('attachBtn');
    if (!menu.contains(e.target) && !btn.contains(e.target)) {
        menu.classList.remove('show');
    }
});

function attachImage() {
    alert('Image attachment coming soon!');
    document.getElementById('attachmentMenu').classList.remove('show');
}

function attachFile() {
    alert('File attachment coming soon!');
    document.getElementById('attachmentMenu').classList.remove('show');
}

function attachAudio() {
    alert('Audio attachment coming soon!');
    document.getElementById('attachmentMenu').classList.remove('show');
}

function createPoll() {
    alert('Poll creation coming soon!');
    document.getElementById('attachmentMenu').classList.remove('show');
}

document.addEventListener('contextmenu', (e) => {
    const messageEl = e.target.closest('[data-message-id]');
    if (messageEl) {
        e.preventDefault();
        contextMenuTarget = messageEl;
        
        const menu = document.getElementById('messageContextMenu');
        menu.style.left = e.pageX + 'px';
        menu.style.top = e.pageY + 'px';
        menu.classList.add('show');
    }
});

let longPressTimer;
document.addEventListener('touchstart', (e) => {
    const messageEl = e.target.closest('[data-message-id]');
    if (messageEl) {
        longPressTimer = setTimeout(() => {
            contextMenuTarget = messageEl;
            const touch = e.touches[0];
            const menu = document.getElementById('messageContextMenu');
            menu.style.left = touch.pageX + 'px';
            menu.style.top = touch.pageY + 'px';
            menu.classList.add('show');
            
            if (navigator.vibrate) navigator.vibrate(50);
        }, 500);
    }
});

document.addEventListener('touchend', () => clearTimeout(longPressTimer));
document.addEventListener('touchmove', () => clearTimeout(longPressTimer));

document.addEventListener('click', (e) => {
    const menu = document.getElementById('messageContextMenu');
    if (!menu.contains(e.target)) {
        menu.classList.remove('show');
    }
});

document.getElementById('messageContextMenu').addEventListener('click', (e) => {
    const action = e.target.closest('[data-action]')?.dataset.action;
    if (!action || !contextMenuTarget) return;
    
    const messageText = contextMenuTarget.querySelector('.message-text')?.textContent || '';
    
    switch(action) {
        case 'reply':
            setReplyTo(messageText);
            break;
        case 'copy':
            navigator.clipboard.writeText(messageText).then(() => {
                showToast('Message copied!');
            });
            break;
        case 'forward':
            alert('Forward feature coming soon!');
            break;
        case 'react':
            alert('Reactions coming soon!');
            break;
        case 'pin':
            alert('Pin feature coming soon!');
            break;
        case 'edit':
            alert('Edit feature coming soon!');
            break;
        case 'delete':
            if (confirm('Delete this message?')) {
                showToast('Message deleted');
            }
            break;
    }
    
    document.getElementById('messageContextMenu').classList.remove('show');
});

function showToast(message) {
    const toast = document.createElement('div');
    toast.className = 'fixed bottom-24 left-1/2 transform -translate-x-1/2 bg-primary text-white px-4 py-2 rounded-lg shadow-lg z-50';
    toast.textContent = message;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 2000);
}

function checkScrollButton() {
    const feed = document.getElementById('messagesFeed');
    const btn = document.getElementById('scrollToBottomBtn');
    const isAtBottom = feed.scrollHeight - feed.scrollTop - feed.clientHeight < 100;
    
    if (isAtBottom) {
        btn.classList.add('hidden');
    } else {
        btn.classList.remove('hidden');
    }
}

document.getElementById('messagesFeed').onscroll = checkScrollButton;

document.getElementById('scrollToBottomBtn').onclick = () => {
    const feed = document.getElementById('messagesFeed');
    feed.scrollTo({ top: feed.scrollHeight, behavior: 'smooth' });
};

socketManager.on('dm:received', (data) => {
    if (data.sender === currentDM || data.recipient === currentDM) {
        messages.push(data);
        renderMessages();
    }
});

socketManager.on('dm:sent', (data) => {
    if (data.recipient === currentDM) {
        messages.push(data);
        renderMessages();
    }
});

socketManager.on('room:message', (data) => {
    if (data.code === currentRoomCode) {
        messages.push(data);
        renderMessages();
    }
});

socketManager.on('user:typing', (data) => {
    if (currentDM && data.username === currentDM) {
        document.getElementById('typingIndicator').classList.remove('hidden');
        document.getElementById('typingText').textContent = `${data.username} is typing...`;
        
        setTimeout(() => {
            document.getElementById('typingIndicator').classList.add('hidden');
        }, 3000);
    }
});

let typingTimeout;
document.getElementById('messageInput').oninput = () => {
    clearTimeout(typingTimeout);
    
    if (currentDM) {
        socketManager.socket.emit('dm:typing', { recipient: currentDM });
    } else if (currentRoomCode) {
        socketManager.socket.emit('room:typing', { code: currentRoomCode });
    }
    
    typingTimeout = setTimeout(() => {}, 1000);
};

loadMessages();
</script>

</body>
</html>

<style>
/* Mobile optimizations for conversation page */
@media (max-width: 1023px) {
    .desktop-sidebar { display: none !important; }
    #roomInfoPanel { display: none !important; }
    
    /* Make back button visible on mobile */
    #backToRoomBtn { display: flex !important; }
    
    /* Hide desktop-only nav items in header */
    header a[href="/feed.html"],
    header a[href="/music.html"],
    header a[href="/ai-chat.html"],
    header a[href="/profile.html"],
    header a[href="/settings.html"] {
        display: none !important;
    }
}
</style>

<script>
// Mobile: Update back button to go to mobile chat list
document.addEventListener('DOMContentLoaded', () => {
    const backBtn = document.getElementById('backToRoomBtn');
    if (backBtn && window.innerWidth <= 1023) {
        backBtn.onclick = () => {
            window.location.href = '/mobile/chat.html';
        };
    }
});
</script>

<script>
// Force show chat screen on mobile
if (window.innerWidth <= 1023) {
    document.addEventListener('DOMContentLoaded', () => {
        // Hide login screen
        const loginScreen = document.getElementById('loginScreen');
        if (loginScreen) {
            loginScreen.classList.add('hidden');
        }
        
        // Show chat screen
        const chatScreen = document.getElementById('chatScreen');
        if (chatScreen) {
            chatScreen.classList.add('active');
        }
        
        // Hide the entire left sidebar with tabs
        const sidebar = document.querySelector('.desktop-sidebar');
        if (sidebar) {
            sidebar.style.display = 'none';
        }
        
        // Make main chat area full width
        const mainChat = document.querySelector('main.flex-1');
        if (mainChat) {
            mainChat.style.width = '100%';
        }
    });
}
</script>

<style>
/* FORCE HIDE EVERYTHING EXCEPT CHAT ON MOBILE */
@media (max-width: 1023px) {
    aside.desktop-sidebar,
    .desktop-sidebar,
    #roomInfoPanel,
    aside#roomInfoPanel {
        display: none !important;
        visibility: hidden !important;
        width: 0 !important;
        height: 0 !important;
        overflow: hidden !important;
    }
    
    /* Make chat full screen */
    main.flex-1 {
        width: 100vw !important;
        max-width: 100vw !important;
    }
    
    .chat-screen {
        display: flex !important;
    }
    
    .login-screen {
        display: none !important;
    }
}
</style>
