<!DOCTYPE html>
<html class="dark" lang="en">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <link rel="icon" type="image/png" href="/nobackwave.png" />
    <title>WaveChat AI Helper</title>
    <!-- Theme Init -->
    <script src="/js/theme-init.js"></script>
    <link href="/css/theme.css" rel="stylesheet" />
    <link href="/css/theme-config.css" rel="stylesheet" />
    <link
        href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800;900&family=Plus+Jakarta+Sans:ital,wght@0,200;0,300;0,400;0,500;0,600;0,700;0,800;1,200;1,300;1,400;1,500;1,600;1,700;1,800&family=JetBrains+Mono:ital,wght@0,100..800;1,100..800&display=swap"
        rel="stylesheet" />
    <link
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-25..0"
        rel="stylesheet" />
    <script src="/js/auth-guard.js"></script>
    <script src="/js/mobile-detector.js"></script>
    <script src="/js/update-checker.js"></script>
    <script src="/js/i18n.js"></script>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        // Set worker source for PDF.js
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#0db9f2",
                        "primary-hover": "#0a91be",
                        "primary-light": "#34caff",
                        "background-dark": "#101e22",
                        "surface-dark": "#16262c",
                        "surface-dark-lighter": "#1d2f36",
                        "accent-cyan": "#06b6d4",
                    },
                    fontFamily: {
                        "display": ["Outfit", "sans-serif"],
                        "body": ["Plus Jakarta Sans", "sans-serif"],
                    },
                    borderRadius: { "DEFAULT": "1rem", "lg": "1.5rem", "xl": "2rem", "full": "9999px" },
                },
            },
        }
    </script>
    <style>
        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            min-height: 100vh;
            scrollbar-width: thin;
            scrollbar-color: #1d2f36 #101e22;
        }

        h1,
        h2,
        h3,
        h4,
        h5,
        h6,
        .font-display {
            font-family: 'Outfit', sans-serif;
        }

        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: #101e22;
        }

        ::-webkit-scrollbar-thumb {
            background-color: #1d2f36;
            border-radius: 20px;
        }

        /* Custom Scrollbar - Darker */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #1f2830;
            border-radius: 3px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #2a3440;
        }

        .mask-gradient-right {
            mask-image: linear-gradient(to right, black 85%, transparent 100%);
            -webkit-mask-image: linear-gradient(to right, black 85%, transparent 100%);
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-fade-in {
            animation: fadeIn 0.3s ease-out;
        }

        /* Transparency Mode Styles */
        body.transparency-mode .bg-surface-dark,
        body.transparency-mode .bg-background-dark {
            background: rgba(16, 30, 34, 0.4) !important;
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-color: rgba(255, 255, 255, 0.1);
        }

        body.transparency-mode .bg-background-dark\/80 {
            background: rgba(16, 30, 34, 0.6) !important;
            backdrop-filter: blur(24px);
            -webkit-backdrop-filter: blur(24px);
        }

        body.transparency-mode .bg-surface-dark-lighter {
            background: rgba(29, 47, 54, 0.5) !important;
        }

        /* Enhanced Transparency Mode Targets */
        body.transparency-mode .mobile-sidebar {
            background: rgba(15, 20, 25, 0.65) !important;
            backdrop-filter: blur(25px) !important;
            -webkit-backdrop-filter: blur(25px) !important;
            border-right: 1px solid rgba(255, 255, 255, 0.1) !important;
        }

        body.transparency-mode .bg-surface-dark-lighter {
            background: rgba(29, 47, 54, 0.5) !important;
        }

        /* Transparency Mode for Input, Attach Menu, Modals & Buttons */
        body.transparency-mode #chatInputContainer .bg-surface-dark,
        body.transparency-mode #attachMenu,
        body.transparency-mode #messageContextMenu,
        body.transparency-mode #chatInputContainer button.bg-surface-dark,
        body.transparency-mode #aiCommandModal .bg-surface-dark,
        body.transparency-mode #codeEditorModal .bg-surface-dark,
        body.transparency-mode #savedChatsModal .bg-surface-dark,
        body.transparency-mode #saveChatModal .bg-surface-dark,
        body.transparency-mode #aiCommandInput,
        body.transparency-mode #codeEditorInput,
        body.transparency-mode #chatNameInput,
        body.transparency-mode #codeLanguage {
            background: rgba(16, 30, 34, 0.4) !important;
            backdrop-filter: blur(12px) !important;
            /* Small blur */
            -webkit-backdrop-filter: blur(12px) !important;
            border-color: rgba(255, 255, 255, 0.1) !important;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        }

        /* Mobile Swipeable Sidebar - Copied from chat.html */
        .mobile-sidebar {
            position: fixed !important;
            top: 0 !important;
            bottom: 0 !important;
            left: 0 !important;
            right: auto !important;
            height: 100vh !important;
            max-height: 100vh !important;
            overflow-y: auto !important;
            overflow-x: hidden !important;
            z-index: 100 !important;
            transition: transform 0.3s ease-out !important;
            display: flex !important;
            visibility: visible !important;
            opacity: 1 !important;
            width: 320px !important;
            max-width: 85vw !important;
            background: #0f1419 !important;
            transform: translateX(-100%) !important;
            box-shadow: 4px 0 12px rgba(0, 0, 0, 0.5) !important;
        }

        /* Sidebar Transparency Support */
        body.transparency-mode .mobile-sidebar {
            background: rgba(15, 20, 25, 0.6) !important;
            backdrop-filter: blur(25px) !important;
            -webkit-backdrop-filter: blur(25px) !important;
            border-right: 1px solid rgba(255, 255, 255, 0.1) !important;
        }

        .mobile-sidebar.open {
            transform: translateX(0) !important;
        }
        
        /* Show sidebar on desktop */
        @media (min-width: 1024px) {
            .mobile-sidebar {
                position: relative !important;
                transform: translateX(0) !important;
                display: flex !important;
                width: 380px !important;
                max-width: 380px !important;
            }
        }

        .sidebar-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 99;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        .sidebar-overlay.active {
            opacity: 1;
            pointer-events: all;
        }

        /* Tab Styles */
        .tab-button.active {
            background-color: rgba(13, 185, 242, 0.1);
            color: #0db9f2;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .material-symbols-outlined {
            font-family: 'Material Symbols Outlined' !important;
            font-weight: normal !important;
            font-style: normal !important;
            display: inline-block !important;
            line-height: 1 !important;
            text-transform: none !important;
            letter-spacing: normal !important;
            word-wrap: normal !important;
            white-space: nowrap !important;
            direction: ltr !important;
        }

        @media (min-width: 1024px) {
            .desktop-focused-container {
                max-width: 850px;
                margin-left: auto;
                margin-right: auto;
                width: 100%;
            }
        }

        .material-symbols-outlined {
            font-family: 'Material Symbols Outlined' !important;
            font-weight: normal !important;
            font-style: normal !important;
            display: inline-block !important;
            line-height: 1 !important;
            text-transform: none !important;
            letter-spacing: normal !important;
            word-wrap: normal !important;
            white-space: nowrap !important;
            direction: ltr !important;
            font-variation-settings: 'FILL' 1, 'wght' 400, 'GRAD' 0, 'opsz' 24 !important;
        }
    </style>
</head>

<body
    class="bg-background-dark font-display text-white antialiased overflow-hidden selection:bg-primary selection:text-white relative lg:flex">
    <!-- Sidebar Overlay (Mobile Only) -->
    <div class="sidebar-overlay lg:hidden" onclick="closeSidebar()"></div>

    <!-- Navigation Sidebar (Desktop & Mobile) -->
    <aside id="chatListSidebar"
        class="mobile-sidebar bg-surface-dark border-r border-slate-800/40 flex flex-col lg:w-[320px] shrink-0">
        <!-- Header -->
        <div class="px-6 pt-6 pb-2 shrink-0">
            <div class="flex items-center justify-between mb-6">
                <div class="flex items-center gap-3">
                    <img src="/nobackwave.png" alt="Wave" class="size-9 rounded-xl object-contain" />
                    <h1 class="text-xl font-bold tracking-tight text-white" data-i18n="ai.waveAI">Wave AI</h1>
                </div>
                <button onclick="closeSidebar()"
                    class="lg:hidden size-8 rounded-lg bg-background-dark hover:bg-surface-hover text-slate-400 hover:text-white flex items-center justify-center transition-colors border border-slate-700/50">
                    <span class="material-symbols-outlined text-[18px]">close</span>
                </button>
            </div>

            <div class="mb-5">
                <!-- Tab Navigation -->
                <div class="flex rounded-lg bg-background-dark p-1 mb-4">
                    <button class="tab-button active flex-1 py-2 px-3 rounded-md text-sm font-medium transition-colors" data-tab="chats" onclick="switchTab('chats')" data-i18n="ai.chatHistory">
                        Chats
                    </button>
                    <button class="tab-button flex-1 py-2 px-3 rounded-md text-sm font-medium transition-colors text-slate-400" data-tab="settings" onclick="switchTab('settings')" data-i18n="nav.settings">
                        Settings
                    </button>
                </div>
                <div class="flex gap-2">
                    <button onclick="saveCurrentChat()"
                        class="size-8 rounded-lg bg-background-dark hover:bg-surface-hover text-slate-400 hover:text-primary flex items-center justify-center transition-colors border border-slate-700/50"
                        data-i18n-title="ai.savedChats" title="Save Chat">
                        <span class="material-symbols-outlined text-[20px]">bookmark</span>
                    </button>
                    <button onclick="clearChat()"
                        class="size-8 rounded-lg bg-background-dark hover:bg-surface-hover text-slate-400 hover:text-primary flex items-center justify-center transition-colors border border-slate-700/50"
                        data-i18n-title="ai.newChat" title="New Chat">
                        <span class="material-symbols-outlined text-[20px]">add</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Tab Content -->
        <div id="chats-tab" class="tab-content active flex-1 overflow-y-auto custom-scrollbar px-4 py-2">
            <div id="sidebarChatsList" class="flex flex-col gap-1">
                <!-- Saved chats will be loaded here -->
            </div>
        </div>
        <div id="settings-tab" class="tab-content flex-1 overflow-y-auto custom-scrollbar px-4 py-2">
            <!-- AI Settings Form -->
            <div class="space-y-4">
                <!-- Model Selection -->
                <div>
                    <label class="block text-sm font-medium text-slate-300 mb-2" data-i18n="ai.model">Model</label>
                    <select id="modelSelect" class="w-full px-3 py-2 bg-background-dark border border-slate-700 rounded-lg text-white">
                        <optgroup label="Wave Flash (Fast)">
                            <option value="wave-flash-1">Wave Flash 1</option>
                            <option value="wave-flash-2">Wave Flash 2</option>
                            <option value="wave-flash-3">Wave Flash 3</option>
                            <option value="wave-flash-4">Wave Flash 4</option>
                        </optgroup>
                        <optgroup label="Wave (Balanced)">
                            <option value="wave-1">Wave 1</option>
                            <option value="wave-2">Wave 2</option>
                            <option value="wave-3">Wave 3</option>
                            <option value="wave-4">Wave 4 (Pro)</option>
                            <option value="wave-5">Wave 5 (Pro)</option>
                        </optgroup>
                        <optgroup label="Wave O (Reasoning)">
                            <option value="wave-o1">Wave O1</option>
                            <option value="wave-o2">Wave O2 (Pro)</option>
                            <option value="wave-o3">Wave O3 (Pro)</option>
                            <option value="wave-o4">Wave O4 (Pro)</option>
                            <option value="wave-o5">Wave O5 (Pro)</option>
                        </optgroup>
                    </select>
                </div>
                <!-- Temperature -->
                <div>
                    <label class="block text-sm font-medium text-slate-300 mb-2" data-i18n="ai.temperature">Temperature</label>
                    <input type="range" id="temperatureSlider" min="0" max="2" step="0.1" value="0.7" class="w-full">
                    <span id="temperatureValue" class="text-sm text-slate-400">0.7</span>
                </div>
                <!-- Max Tokens -->
                <div>
                    <label class="block text-sm font-medium text-slate-300 mb-2" data-i18n="ai.maxTokens">Max Tokens</label>
                    <input type="range" id="maxTokensSlider" min="100" max="4000" step="100" value="1000" class="w-full">
                    <span id="maxTokensValue" class="text-sm text-slate-400">1000</span>
                </div>
                <!-- System Prompt -->
                <div>
                    <label class="block text-sm font-medium text-slate-300 mb-2" data-i18n="ai.systemPrompt">System Prompt</label>
                    <textarea id="systemPrompt" rows="3" class="w-full px-3 py-2 bg-background-dark border border-slate-700 rounded-lg text-white" data-i18n-placeholder="ai.enterSystemPrompt" placeholder="Enter system prompt..."></textarea>
                </div>
                <!-- Toggles -->
                <div class="space-y-3">
                    <label class="flex items-center justify-between">
                        <span class="text-sm font-medium text-slate-300" data-i18n="ai.thinkingMode">Thinking Mode</span>
                        <input type="checkbox" id="thinkingMode" class="rounded">
                    </label>
                    <label class="flex items-center justify-between">
                        <span class="text-sm font-medium text-slate-300" data-i18n="ai.searchMode">Search Mode</span>
                        <input type="checkbox" id="searchMode" class="rounded">
                    </label>
                </div>
                <!-- Save Button -->
                <button onclick="saveSettings()" class="w-full py-2 bg-primary hover:bg-primary-hover text-white rounded-lg font-medium transition-colors" data-i18n="ai.saveSettings">
                    Save Settings
                </button>
            </div>
        </div>

        <!-- Bottom Navigation Bar (Sidebar Footer) -->
        <div class="p-3 bg-[#0b1418] border-t border-slate-800/40 shrink-0">
            <nav class="grid grid-cols-5 gap-1 rounded-xl bg-background-dark p-1">
                <a class="flex flex-col items-center justify-center py-2 rounded-lg text-[#90bccb] hover:text-white hover:bg-surface-hover transition-colors min-w-0"
                    href="/chat.html" title="Chats" data-i18n-title="nav.chats">
                    <span class="material-symbols-outlined text-[20px]">chat_bubble</span>
                    <span class="text-[9px] font-bold mt-1 uppercase tracking-tighter" data-i18n="nav.chats">Chats</span>
                </a>
                <a class="flex flex-col items-center justify-center py-2 rounded-lg text-primary bg-primary/10 min-w-0"
                    href="/ai-chat.html" title="AI Chat" data-i18n-title="nav.ai">
                    <span class="material-symbols-outlined text-[20px]">smart_toy</span>
                    <span class="text-[9px] font-bold mt-1 uppercase tracking-tighter" data-i18n="nav.ai">AI</span>
                </a>
                <a class="flex flex-col items-center justify-center py-2 rounded-lg text-[#90bccb] hover:text-white hover:bg-surface-hover transition-colors min-w-0"
                    href="/feed.html" title="Feed" data-i18n-title="nav.feed">
                    <span class="material-symbols-outlined text-[20px]">newspaper</span>
                    <span class="text-[9px] font-bold mt-1 uppercase tracking-tighter" data-i18n="nav.feed">Feed</span>
                </a>
                <a class="flex flex-col items-center justify-center py-2 rounded-lg text-[#90bccb] hover:text-white hover:bg-surface-hover transition-colors min-w-0"
                    href="/profile.html" title="Profile" data-i18n-title="nav.profile">
                    <span class="material-symbols-outlined text-[20px]">person</span>
                    <span class="text-[9px] font-bold mt-1 uppercase tracking-tighter" data-i18n="nav.profile">Profile</span>
                </a>
                <a class="flex flex-col items-center justify-center py-2 rounded-lg text-[#90bccb] hover:text-white hover:bg-surface-hover transition-colors min-w-0"
                    href="/settings.html" title="Settings" data-i18n-title="nav.settings">
                    <span class="material-symbols-outlined text-[20px]">settings</span>
                    <span class="text-[9px] font-bold mt-1 uppercase tracking-tighter" data-i18n="nav.settings">Settings</span>
                </a>
            </nav>
        </div>
    </aside>

    <!-- Custom Background Image -->
    <div id="customBackground" class="fixed inset-0 z-0 pointer-events-none hidden"></div>

    <div class="flex-1 relative flex flex-col h-screen z-20 overflow-hidden">

        <!-- Main Content Area -->
        <div class="flex-1 flex flex-col h-full relative overflow-hidden bg-background-dark/30">
            <div
                class="flex items-center px-6 py-3 justify-between bg-background-dark/80 backdrop-blur-xl sticky top-0 z-30 border-b border-white/5">
                <div class="desktop-focused-container flex items-center justify-between w-full">
                    <div class="flex items-center gap-3">
                        <button onclick="event.stopPropagation(); toggleSidebar();"
                            class="lg:hidden w-10 h-10 flex items-center justify-center rounded-lg bg-surface-lighter text-slate-400 hover:text-primary transition-colors active:scale-95">
                            <div class="hamburger-menu">
                                <span></span>
                                <span></span>
                                <span></span>
                            </div>
                        </button>
                        <div class="relative group cursor-pointer">
                            <div class="bg-center bg-no-repeat aspect-square bg-cover rounded-full size-10 border-2 border-primary/50 group-hover:border-primary transition-colors"
                                style='background-image: url("/nobackwave.png");'></div>
                            <div
                                class="absolute bottom-0 right-0 size-3 bg-emerald-500 border-2 border-background-dark rounded-full shadow-[0_0_8px_rgba(16,185,129,0.5)]">
                            </div>
                        </div>
                        <div class="flex flex-col">
                            <h2 class="text-base font-bold leading-tight tracking-wide">Wave AI</h2>
                            <div class="flex items-center gap-2">
                                <div class="flex items-center gap-1">
                                    <span class="size-1.5 rounded-full bg-emerald-500 animate-pulse"></span>
                                    <p class="text-[10px] text-emerald-400 font-bold uppercase tracking-wider">Online
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="flex-1 overflow-y-auto w-full scroll-smooth custom-scrollbar" id="chat-container">
                <div id="messages-inner-container" class="desktop-focused-container p-6 space-y-6 min-h-full">
                    <div class="flex justify-center my-4">
                        <span
                            class="text-[10px] font-semibold tracking-wider text-slate-500 uppercase bg-surface-dark px-3 py-1 rounded-full border border-white/5">Today</span>
                    </div>
                </div>
            </div>

            <div id="chatInputContainer"
                class="z-40 w-full pt-2 bg-background-dark/95 backdrop-blur-md border-t border-white/10 shrink-0">
                <div class="desktop-focused-container px-6 pb-6">
                    <div class="flex gap-2 overflow-x-auto px-6 py-2 mb-1 no-scrollbar mask-gradient-right">
                        <button
                            class="flex shrink-0 items-center justify-center gap-1.5 h-8 rounded-full bg-surface-dark border border-white/10 px-4 hover:bg-primary hover:border-primary hover:shadow-[0_0_15px_rgba(14,165,233,0.3)] transition-all group active:scale-95"
                            onclick="showAICommand('translate')">
                            <span
                                class="material-symbols-outlined text-[16px] text-primary group-hover:text-white transition-colors">translate</span>
                            <span
                                class="text-xs font-medium text-slate-200 group-hover:text-white transition-colors" data-i18n="ai.translateThis">Translate</span>
                        </button>
                        <button
                            class="flex shrink-0 items-center justify-center gap-1.5 h-8 rounded-full bg-surface-dark border border-white/10 px-4 hover:bg-primary hover:border-primary hover:shadow-[0_0_15px_rgba(14,165,233,0.3)] transition-all group active:scale-95"
                            onclick="showAICommand('summarize')">
                            <span
                                class="material-symbols-outlined text-[16px] text-primary group-hover:text-white transition-colors">summarize</span>
                            <span
                                class="text-xs font-medium text-slate-200 group-hover:text-white transition-colors" data-i18n="ai.summarizeThis">Summarize</span>
                        </button>
                        <button
                            class="flex shrink-0 items-center justify-center gap-1.5 h-8 rounded-full bg-surface-dark border border-white/10 px-4 hover:bg-primary hover:border-primary hover:shadow-[0_0_15px_rgba(14,165,233,0.3)] transition-all group active:scale-95"
                            onclick="showAICommand('code')">
                            <span
                                class="material-symbols-outlined text-[16px] text-primary group-hover:text-white transition-colors">code</span>
                            <span
                                class="text-xs font-medium text-slate-200 group-hover:text-white transition-colors" data-i18n="ai.writeCode">Write
                                Code</span>
                        </button>
                        <button
                            class="flex shrink-0 items-center justify-center gap-1.5 h-8 rounded-full bg-surface-dark border border-white/10 px-4 hover:bg-primary hover:border-primary hover:shadow-[0_0_15px_rgba(14,165,233,0.3)] transition-all group active:scale-95"
                            onclick="showAICommand('explain')">
                            <span
                                class="material-symbols-outlined text-[16px] text-primary group-hover:text-white transition-colors">school</span>
                            <span
                                class="text-xs font-medium text-slate-200 group-hover:text-white transition-colors" data-i18n="ai.explain">Explain</span>
                        </button>
                        <div class="h-6 w-px bg-white/10 mx-1 self-center"></div>
                        <button onclick="toggleWebSearch()" id="webSearchBtn"
                            class="flex shrink-0 items-center justify-center gap-1.5 h-8 rounded-full bg-surface-dark border border-white/10 px-4 transition-all group active:scale-95 text-primary border-primary/50"
                            title="Toggle Web Search">
                            <span
                                class="material-symbols-outlined text-[16px] group-hover:scale-110 transition-transform">travel_explore</span>
                            <span class="text-xs font-medium" data-i18n="ai.searchOn">Search On</span>
                        </button>
                    </div>
                    <div class="px-6 flex items-center gap-2 mt-2">
                        <div class="relative">
                            <button id="attachButton" onclick="toggleAttachMenu()"
                                class="size-12 shrink-0 flex items-center justify-center rounded-full bg-surface-dark border border-white/5 text-slate-400 hover:text-primary hover:border-primary/50 transition-all active:scale-95">
                                <span class="material-symbols-outlined text-[24px]">add</span>
                            </button>
                            <!-- Attach Menu with Animation -->
                            <div id="attachMenu"
                                class="hidden absolute bottom-full left-0 mb-2 bg-surface-dark/95 backdrop-blur-xl rounded-2xl border border-white/10 shadow-2xl p-2 min-w-[200px] transform origin-bottom-left transition-all duration-200 ease-out scale-95 opacity-0">
                                <button onclick="openCodeEditor()"
                                    class="w-full flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-primary/10 hover:border-primary/30 border border-transparent transition-all text-left group">
                                    <div class="size-8 rounded-lg bg-primary/20 flex items-center justify-center">
                                        <span class="material-symbols-outlined text-primary text-[20px]">code</span>
                                    </div>
                                    <div>
                                        <div
                                            class="text-sm font-medium text-white group-hover:text-primary transition-colors" data-i18n="ai.attachCode">
                                            Attach Code</div>
                                        <div class="text-xs text-slate-400" data-i18n="ai.openCodeEditor">Open code editor</div>
                                    </div>
                                </button>
                                <button onclick="openFileUpload()"
                                    class="w-full flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-primary/10 hover:border-primary/30 border border-transparent transition-all text-left group mt-1">
                                    <div class="size-8 rounded-lg bg-orange-500/20 flex items-center justify-center">
                                        <span
                                            class="material-symbols-outlined text-orange-400 text-[20px]">picture_as_pdf</span>
                                    </div>
                                    <div>
                                        <div
                                            class="text-sm font-medium text-white group-hover:text-primary transition-colors" data-i18n="ai.uploadPDF">
                                            Upload PDF</div>
                                        <div class="text-xs text-slate-400" data-i18n="ai.analyzePDF">Analyze PDF documents</div>
                                    </div>
                                </button>
                                <button onclick="openFileUpload()"
                                    class="w-full flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-primary/10 hover:border-primary/30 border border-transparent transition-all text-left group mt-1">
                                    <div class="size-8 rounded-lg bg-purple-500/20 flex items-center justify-center">
                                        <span
                                            class="material-symbols-outlined text-purple-400 text-[20px]">description</span>
                                    </div>
                                    <div>
                                        <div
                                            class="text-sm font-medium text-white group-hover:text-primary transition-colors" data-i18n="ai.attachFile">
                                            Attach File</div>
                                        <div class="text-xs text-slate-400" data-i18n="ai.uploadTextFile">Upload text file</div>
                                    </div>
                                </button>
                            </div>
                        </div>
                        <div
                            class="flex-1 bg-surface-dark rounded-3xl min-h-[3.5rem] px-5 py-3.5 flex items-center gap-2 border border-white/5 focus-within:border-primary/50 focus-within:bg-surface-dark-lighter transition-all shadow-sm">
                            <input id="messageInput"
                                class="bg-transparent border-none outline-none text-sm w-full text-white placeholder-slate-500 focus:ring-0 p-0"
                                placeholder="Message or type / for commands..." data-i18n-placeholder="ai.messagePlaceholder" type="text"
                                onkeypress="handleKeyPress(event)" />
                        </div>
                        <button id="sendMessageBtn" onclick="sendMessage()"
                            class="size-12 shrink-0 flex items-center justify-center rounded-full bg-primary text-white shadow-[0_4px_12px_rgba(14,165,233,0.3)] hover:scale-105 hover:bg-primary-hover transition-all active:scale-95">
                            <span class="material-symbols-outlined text-[24px]">send</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- AI Command Modal -->
            <div id="aiCommandModal"
                class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm p-4">
                <div class="bg-surface-dark rounded-2xl p-4 w-full max-w-lg mx-auto border border-white/10 shadow-2xl max-h-[90vh] overflow-y-auto">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="text-base font-bold text-white flex items-center gap-2" id="modalTitle">
                            <span class="material-symbols-outlined text-[18px] text-primary">translate</span>
                            <span class="text-sm">AI Command</span>
                        </h3>
                        <button onclick="closeAIModal()" class="text-slate-400 hover:text-white transition-colors">
                            <span class="material-symbols-outlined text-[20px]">close</span>
                        </button>
                    </div>

                    <!-- Language Selection (for translate) -->
                    <div id="languageSelection" class="hidden mb-3">
                        <p class="text-xs text-slate-400 mb-2">Select language:</p>
                        <div class="grid grid-cols-3 sm:grid-cols-4 gap-1.5 max-h-[50vh] overflow-y-auto">
                            <button onclick="selectLanguage('Spanish', 'ðŸ‡ªðŸ‡¸')"
                                class="flex items-center gap-1.5 p-2 rounded-lg bg-background-dark hover:bg-primary/20 hover:border-primary border border-white/10 transition-all group">
                                <span class="text-lg">ðŸ‡ªðŸ‡¸</span>
                                <span class="text-xs font-medium text-slate-300 group-hover:text-white">ES</span>
                            </button>
                            <button onclick="selectLanguage('French', 'ðŸ‡«ðŸ‡·')"
                                class="flex items-center gap-1.5 p-2 rounded-lg bg-background-dark hover:bg-primary/20 hover:border-primary border border-white/10 transition-all group">
                                <span class="text-lg">ðŸ‡«ðŸ‡·</span>
                                <span class="text-xs font-medium text-slate-300 group-hover:text-white">FR</span>
                            </button>
                            <button onclick="selectLanguage('German', 'ðŸ‡©ðŸ‡ª')"
                                class="flex items-center gap-1.5 p-2 rounded-lg bg-background-dark hover:bg-primary/20 hover:border-primary border border-white/10 transition-all group">
                                <span class="text-lg">ðŸ‡©ðŸ‡ª</span>
                                <span class="text-xs font-medium text-slate-300 group-hover:text-white">DE</span>
                            </button>
                            <button onclick="selectLanguage('Italian', 'ðŸ‡®ðŸ‡¹')"
                                class="flex items-center gap-1.5 p-2 rounded-lg bg-background-dark hover:bg-primary/20 hover:border-primary border border-white/10 transition-all group">
                                <span class="text-lg">ðŸ‡®ðŸ‡¹</span>
                                <span class="text-xs font-medium text-slate-300 group-hover:text-white">IT</span>
                            </button>
                            <button onclick="selectLanguage('Portuguese', 'ðŸ‡µðŸ‡¹')"
                                class="flex items-center gap-1.5 p-2 rounded-lg bg-background-dark hover:bg-primary/20 hover:border-primary border border-white/10 transition-all group">
                                <span class="text-lg">ðŸ‡µðŸ‡¹</span>
                                <span class="text-xs font-medium text-slate-300 group-hover:text-white">PT</span>
                            </button>
                            <button onclick="selectLanguage('Russian', 'ðŸ‡·ðŸ‡º')"
                                class="flex items-center gap-1.5 p-2 rounded-lg bg-background-dark hover:bg-primary/20 hover:border-primary border border-white/10 transition-all group">
                                <span class="text-lg">ðŸ‡·ðŸ‡º</span>
                                <span class="text-xs font-medium text-slate-300 group-hover:text-white">RU</span>
                            </button>
                            <button onclick="selectLanguage('Chinese', 'ðŸ‡¨ðŸ‡³')"
                                class="flex items-center gap-1.5 p-2 rounded-lg bg-background-dark hover:bg-primary/20 hover:border-primary border border-white/10 transition-all group">
                                <span class="text-lg">ðŸ‡¨ðŸ‡³</span>
                                <span class="text-xs font-medium text-slate-300 group-hover:text-white">CN</span>
                            </button>
                            <button onclick="selectLanguage('Japanese', 'ðŸ‡¯ðŸ‡µ')"
                                class="flex items-center gap-1.5 p-2 rounded-lg bg-background-dark hover:bg-primary/20 hover:border-primary border border-white/10 transition-all group">
                                <span class="text-lg">ðŸ‡¯ðŸ‡µ</span>
                                <span class="text-xs font-medium text-slate-300 group-hover:text-white">JP</span>
                            </button>
                            <button onclick="selectLanguage('Korean', 'ðŸ‡°ðŸ‡·')"
                                class="flex items-center gap-1.5 p-2 rounded-lg bg-background-dark hover:bg-primary/20 hover:border-primary border border-white/10 transition-all group">
                                <span class="text-lg">ðŸ‡°ðŸ‡·</span>
                                <span class="text-xs font-medium text-slate-300 group-hover:text-white">KR</span>
                            </button>
                            <button onclick="selectLanguage('Arabic', 'ðŸ‡¸ðŸ‡¦')"
                                class="flex items-center gap-1.5 p-2 rounded-lg bg-background-dark hover:bg-primary/20 hover:border-primary border border-white/10 transition-all group">
                                <span class="text-lg">ðŸ‡¸ðŸ‡¦</span>
                                <span class="text-xs font-medium text-slate-300 group-hover:text-white">AR</span>
                            </button>
                            <button onclick="selectLanguage('Hindi', 'ðŸ‡®ðŸ‡³')"
                                class="flex items-center gap-1.5 p-2 rounded-lg bg-background-dark hover:bg-primary/20 hover:border-primary border border-white/10 transition-all group">
                                <span class="text-lg">ðŸ‡®ðŸ‡³</span>
                                <span class="text-xs font-medium text-slate-300 group-hover:text-white">HI</span>
                            </button>
                            <button onclick="selectLanguage('Turkish', 'ðŸ‡¹ðŸ‡·')"
                                class="flex items-center gap-1.5 p-2 rounded-lg bg-background-dark hover:bg-primary/20 hover:border-primary border border-white/10 transition-all group">
                                <span class="text-lg">ðŸ‡¹ðŸ‡·</span>
                                <span class="text-xs font-medium text-slate-300 group-hover:text-white">TR</span>
                            </button>
                            <button onclick="selectLanguage('Polish', 'ðŸ‡µðŸ‡±')"
                                class="flex items-center gap-1.5 p-2 rounded-lg bg-background-dark hover:bg-primary/20 hover:border-primary border border-white/10 transition-all group">
                                <span class="text-lg">ðŸ‡µðŸ‡±</span>
                                <span class="text-xs font-medium text-slate-300 group-hover:text-white">PL</span>
                            </button>
                            <button onclick="selectLanguage('Dutch', 'ðŸ‡³ðŸ‡±')"
                                class="flex items-center gap-1.5 p-2 rounded-lg bg-background-dark hover:bg-primary/20 hover:border-primary border border-white/10 transition-all group">
                                <span class="text-lg">ðŸ‡³ðŸ‡±</span>
                                <span class="text-xs font-medium text-slate-300 group-hover:text-white">NL</span>
                            </button>
                            <button onclick="selectLanguage('Ukrainian', 'ðŸ‡ºðŸ‡¦')"
                                class="flex items-center gap-1.5 p-2 rounded-lg bg-background-dark hover:bg-primary/20 hover:border-primary border border-white/10 transition-all group">
                                <span class="text-lg">ðŸ‡ºðŸ‡¦</span>
                                <span class="text-xs font-medium text-slate-300 group-hover:text-white">UA</span>
                            </button>
                            <button onclick="selectLanguage('Swedish', 'ðŸ‡¸ðŸ‡ª')"
                                class="flex items-center gap-1.5 p-2 rounded-lg bg-background-dark hover:bg-primary/20 hover:border-primary border border-white/10 transition-all group">
                                <span class="text-lg">ðŸ‡¸ðŸ‡ª</span>
                                <span class="text-xs font-medium text-slate-300 group-hover:text-white">SE</span>
                            </button>
                            <button onclick="selectLanguage('Greek', 'ðŸ‡¬ðŸ‡·')"
                                class="flex items-center gap-1.5 p-2 rounded-lg bg-background-dark hover:bg-primary/20 hover:border-primary border border-white/10 transition-all group">
                                <span class="text-lg">ðŸ‡¬ðŸ‡·</span>
                                <span class="text-xs font-medium text-slate-300 group-hover:text-white">GR</span>
                            </button>
                            <button onclick="selectLanguage('Czech', 'ðŸ‡¨ðŸ‡¿')"
                                class="flex items-center gap-1.5 p-2 rounded-lg bg-background-dark hover:bg-primary/20 hover:border-primary border border-white/10 transition-all group">
                                <span class="text-lg">ðŸ‡¨ðŸ‡¿</span>
                                <span class="text-xs font-medium text-slate-300 group-hover:text-white">CZ</span>
                            </button>
                        </div>
                    </div>

                    <!-- Text Input -->
                    <div id="textInputSection">
                        <textarea id="aiCommandInput"
                            class="w-full bg-background-dark text-white rounded-lg p-3 border border-white/10 focus:border-primary/50 focus:outline-none resize-none text-sm"
                            rows="3" placeholder="Enter your text here..." data-i18n-placeholder="ai.enterTextHere"></textarea>
                    </div>

                    <div class="flex gap-2 mt-3">
                        <button onclick="closeAIModal()"
                            class="flex-1 py-2 rounded-lg bg-surface-lighter text-slate-300 text-sm font-medium hover:bg-slate-700 transition-all">
                            <span data-i18n="common.cancel">Cancel</span>
                        </button>
                        <button onclick="executeAICommand()"
                            class="flex-1 py-2 rounded-lg bg-gradient-to-r from-primary to-blue-600 text-white text-sm font-bold shadow-lg hover:shadow-xl transition-all">
                            <span data-i18n="ai.execute">Execute</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Saved Chats Modal -->
            <div id="savedChatsModal"
                class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm">
                <div
                    class="bg-surface-dark rounded-3xl p-6 w-full max-w-2xl mx-4 border border-white/10 shadow-2xl max-h-[80vh] flex flex-col">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-bold text-white" data-i18n="ai.savedChatsTitle">Saved Chats</h3>
                        <button onclick="closeSavedChatsModal()"
                            class="text-slate-400 hover:text-white transition-colors">
                            <span class="material-symbols-outlined">close</span>
                        </button>
                    </div>
                    <div id="savedChatsList" class="flex-1 overflow-y-auto space-y-2">
                        <!-- Saved chats will be loaded here -->
                    </div>
                </div>
            </div>

            <!-- Audio Player Pop-out -->
            <div id="audioPlayer"
                class="hidden fixed top-6 right-6 z-[100] bg-surface-dark/95 backdrop-blur-xl border border-white/10 rounded-2xl p-4 shadow-2xl flex items-center gap-4 animate-fade-in translate-x-0 transition-transform duration-300">
                <div class="size-10 rounded-full bg-primary/20 flex items-center justify-center relative">
                    <div class="loader loader-xs">
                        <div class="circle"></div>
                        <div class="circle"></div>
                        <div class="circle"></div>
                        <div class="circle"></div>
                    </div>
                </div>
                <div>
                    <div class="text-xs font-bold text-slate-400 mb-0.5 uppercase tracking-widest">Speaking</div>
                    <div class="flex items-center gap-3">
                        <div id="audioTime" class="text-sm font-mono text-white">0:00</div>
                        <div class="h-1 w-24 bg-white/5 rounded-full overflow-hidden">
                            <div id="audioProgress" class="h-full bg-primary transition-all duration-300"
                                style="width: 0%">
                            </div>
                        </div>
                    </div>
                </div>
                <button onclick="stopSpeaking()"
                    class="size-9 rounded-xl bg-red-500/10 hover:bg-red-500/20 text-red-400 flex items-center justify-center transition-all group active:scale-95">
                    <span
                        class="material-symbols-outlined text-[20px] group-hover:rotate-90 transition-transform">close</span>
                </button>
            </div>

            <!-- Save Chat Modal -->
            <div id="saveChatModal"
                class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm">
                <div class="bg-surface-dark rounded-3xl p-6 w-full max-w-md mx-4 border border-white/10 shadow-2xl">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-bold text-white">Save Chat</h3>
                        <button onclick="closeSaveChatModal()"
                            class="text-slate-400 hover:text-white transition-colors">
                            <span class="material-symbols-outlined">close</span>
                        </button>
                    </div>
                    <input id="chatNameInput" type="text"
                        class="w-full bg-background-dark text-white rounded-xl p-4 border border-white/10 focus:border-primary/50 focus:outline-none"
                        placeholder="Enter chat name..." />
                    <div class="flex gap-3 mt-4">
                        <button onclick="closeSaveChatModal()"
                            class="flex-1 py-3 rounded-xl bg-surface-lighter text-slate-300 font-medium hover:bg-slate-700 transition-all">
                            Cancel
                        </button>
                        <button onclick="confirmSaveChat()"
                            class="flex-1 py-3 rounded-xl bg-gradient-to-r from-primary to-blue-600 text-white font-bold shadow-lg hover:shadow-xl transition-all">
                            Save
                        </button>
                    </div>
                </div>
            </div>

            <!-- Code Editor Modal -->
            <div id="codeEditorModal"
                class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm">
                <div
                    class="bg-surface-dark rounded-3xl p-6 w-full max-w-4xl mx-4 border border-white/10 shadow-2xl max-h-[80vh] flex flex-col">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-bold text-white flex items-center gap-2">
                            <span class="material-symbols-outlined text-primary">code</span>
                            <span data-i18n="ai.codeEditor">Code Editor</span>
                        </h3>
                        <button onclick="closeCodeEditor()" class="text-slate-400 hover:text-white transition-colors">
                            <span class="material-symbols-outlined">close</span>
                        </button>
                    </div>
                    <div class="mb-3">
                        <label class="text-sm text-slate-400 mb-2 block" data-i18n="ai.languageOptional">Language (optional)</label>
                        <input id="codeLanguage" type="text"
                            class="w-full bg-background-dark text-white rounded-xl px-4 py-2 border border-white/10 focus:border-primary/50 focus:outline-none text-sm"
                            placeholder="e.g., javascript, python, html..." data-i18n-placeholder="ai.languagePlaceholder" />
                    </div>
                    <textarea id="codeEditorInput"
                        class="flex-1 w-full bg-background-dark text-white rounded-xl p-4 border border-white/10 focus:border-primary/50 focus:outline-none resize-none font-mono text-sm"
                        placeholder="Paste or type your code here..." data-i18n-placeholder="ai.pasteCodeHere"></textarea>
                    <div class="flex gap-3 mt-4">
                        <button onclick="closeCodeEditor()"
                            class="flex-1 py-3 rounded-xl bg-surface-lighter text-slate-300 font-medium hover:bg-slate-700 transition-all">
                            Cancel
                        </button>
                        <button onclick="attachCode()"
                            class="flex-1 py-3 rounded-xl bg-gradient-to-r from-primary to-blue-600 text-white font-bold shadow-lg hover:shadow-xl transition-all" data-i18n="ai.attachCode">
                            Attach Code
                        </button>
                    </div>
                </div>
            </div>

            <!-- File Upload Input (hidden) -->
            <input type="file" id="fileInput" accept=".txt,.md,.json,.js,.ts,.py,.html,.css,.java,.cpp,.c,.go,.rs"
                class="hidden" onchange="handleFileUpload(event)" />

            <!-- Message Context Menu -->
            <div id="messageContextMenu"
                class="hidden fixed z-[60] bg-surface-dark/95 backdrop-blur-xl border border-white/10 rounded-xl shadow-2xl py-1 w-56 overflow-hidden transform transition-all duration-200 origin-top-left scale-95 opacity-0">
                <button onclick="copyMessageText()"
                    class="w-full text-left px-4 py-3 hover:bg-white/5 flex items-center gap-3 text-slate-200 transition-colors active:bg-white/10 border-b border-white/5">
                    <span class="material-symbols-outlined text-[20px] text-slate-400">content_copy</span>
                    <span class="text-sm font-medium" data-i18n="ai.copyText">Copy Text</span>
                </button>
                <button onclick="viewSources()"
                    class="w-full text-left px-4 py-3 hover:bg-white/5 flex items-center gap-3 text-slate-200 transition-colors active:bg-white/10 border-b border-white/5">
                    <span class="material-symbols-outlined text-[20px] text-primary">source</span>
                    <span class="text-sm font-medium" data-i18n="ai.viewSources">View Sources</span>
                </button>
                <button onclick="handleContextAction('explain')"
                    class="w-full text-left px-4 py-3 hover:bg-white/5 flex items-center gap-3 text-slate-200 transition-colors active:bg-white/10">
                    <span class="material-symbols-outlined text-[20px] text-slate-400">school</span>
                    <span class="text-sm font-medium" data-i18n="ai.explainThis">Explain This</span>
                </button>
                <button onclick="handleContextAction('translate')"
                    class="w-full text-left px-4 py-3 hover:bg-white/5 flex items-center gap-3 text-slate-200 transition-colors active:bg-white/10">
                    <span class="material-symbols-outlined text-[20px] text-slate-400">translate</span>
                    <span class="text-sm font-medium" data-i18n="ai.translateThis">Translate</span>
                </button>
                <button onclick="handleContextAction('summarize')"
                    class="w-full text-left px-4 py-3 hover:bg-white/5 flex items-center gap-3 text-slate-200 transition-colors active:bg-white/10 border-b border-white/5">
                    <span class="material-symbols-outlined text-[20px] text-slate-400">summarize</span>
                    <span class="text-sm font-medium" data-i18n="ai.summarizeThis">Summarize</span>
                </button>
                <button onclick="handleContextAction('read')"
                    class="w-full text-left px-4 py-3 hover:bg-white/5 flex items-center gap-3 text-slate-200 transition-colors active:bg-white/10">
                    <span class="material-symbols-outlined text-[20px] text-slate-400">volume_up</span>
                    <span class="text-sm font-medium" data-i18n="ai.readAloud">Read Aloud</span>
                </button>
            </div>

            <!-- Sources Modal -->
            <div id="sourcesModal"
                class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm">
                <div
                    class="bg-surface-dark rounded-3xl p-6 w-full max-w-lg mx-4 border border-white/10 shadow-2xl animate-fade-in">
                    <div class="flex items-center justify-between mb-6">
                        <div class="flex items-center gap-3">
                            <div class="size-10 rounded-xl bg-primary/20 flex items-center justify-center">
                                <span class="material-symbols-outlined text-primary">source</span>
                            </div>
                            <div>
                                <h3 class="text-lg font-bold text-white">Message Sources</h3>
                                <p class="text-xs text-slate-400">Links and information used in this response</p>
                            </div>
                        </div>
                        <button onclick="document.getElementById('sourcesModal').classList.add('hidden')"
                            class="size-8 flex items-center justify-center rounded-full hover:bg-white/10 text-slate-400 hover:text-white transition-colors">
                            <span class="material-symbols-outlined text-[20px]">close</span>
                        </button>
                    </div>
                    <div id="sourceList" class="space-y-2 max-h-[400px] overflow-y-auto custom-scrollbar pr-2">
                        <!-- Sources will be injected here -->
                    </div>
                    <div class="mt-6">
                        <button onclick="document.getElementById('sourcesModal').classList.add('hidden')"
                            class="w-full py-3 rounded-xl bg-surface-lighter text-slate-300 font-bold hover:bg-slate-700 transition-all">
                            Close
                        </button>
                    </div>
                </div>
            </div>



            <script src="/js/features-api.js"></script>
            <script>
                const socket = io();
                const scrollContainer = document.getElementById('chat-container');
                const messagesContainer = document.getElementById('messages-inner-container');
                const messageInput = document.getElementById('messageInput');
                let currentAICommand = null;
                let conversationHistory = [];
                let thinkingEnabled = false;
                let searchEnabled = true;
                let attachedCode = null; // Store attached code

                // Context Menu State
                let contextMenuTargetText = '';
                let lastContextTargetBubble = null;
                let longPressTimer;

                // Setup Global Event Listeners for Context Menu
                document.addEventListener('click', (e) => {
                    const menu = document.getElementById('messageContextMenu');
                    if (menu && !menu.contains(e.target)) {
                        hideContextMenu();
                    }
                });

                document.addEventListener('scroll', hideContextMenu, true); // Hide on scroll

                // Helper to Hide Menu
                function hideContextMenu() {
                    const menu = document.getElementById('messageContextMenu');
                    if (menu && !menu.classList.contains('hidden')) {
                        menu.classList.add('scale-95', 'opacity-0');
                        setTimeout(() => menu.classList.add('hidden'), 200);
                    }
                }

                // Show Context Menu
                function showContextMenu(x, y, text) {
                    contextMenuTargetText = text;
                    const menu = document.getElementById('messageContextMenu');

                    // Position safely
                    const winWidth = window.innerWidth;
                    const winHeight = window.innerHeight;

                    // Adjust if going off screen
                    if (x + 200 > winWidth) x = winWidth - 210;
                    if (y + 100 > winHeight) y = y - 60;

                    menu.style.left = `${x}px`;
                    menu.style.top = `${y}px`;

                    menu.classList.remove('hidden');
                    // Trigger animation
                    void menu.offsetWidth;
                    menu.classList.remove('scale-95', 'opacity-0');
                    menu.classList.add('scale-100', 'opacity-100');

                    // Vibrate on mobile
                    if (navigator.vibrate) navigator.vibrate(50);
                }

                // Copy Message Text
                async function copyMessageText() {
                    if (!contextMenuTargetText) return;
                    try {
                        await navigator.clipboard.writeText(contextMenuTargetText);
                        hideContextMenu();
                    } catch (err) {
                        console.error('Failed to copy class text: ', err);
                    }
                }

                // Handle Context Menu Actions
                function handleContextAction(action) {
                    if (!contextMenuTargetText) return;
                    hideContextMenu();

                    if (action === 'read') {
                        const utterance = new SpeechSynthesisUtterance(contextMenuTargetText);
                        window.speechSynthesis.speak(utterance);
                        return;
                    }

                    // For AI commands, open the modal and pre-fill text
                    showAICommand(action);

                    // Pre-fill text after modal opens (small delay to ensure DOM update if needed, though sync usually works)
                    setTimeout(() => {
                        const input = document.getElementById('aiCommandInput');
                        if (input) {
                            input.value = contextMenuTargetText;
                            input.focus();
                        }
                    }, 50);
                }

                // Initialize Settings
                document.addEventListener('DOMContentLoaded', () => {
                    // Load Transparency Preference
                    const isTransparent = localStorage.getItem('transparencyMode') === 'true';
                    const toggle = document.getElementById('transparencyToggle');
                    if (toggle) toggle.checked = isTransparent;

                    // Apply initial state
                    if (isTransparent) {
                        document.body.classList.add('transparency-mode');
                    }

                    // Restore preferences
                    if (localStorage.getItem('aiSearchEnabled') === 'false') {
                        searchEnabled = false;
                    }
                    updateWebSearchUI();

                    if (localStorage.getItem('aiSearchEnabled') === 'false') {
                        searchEnabled = false;
                    }
                    updateWebSearchUI();

                    // Load sidebar chats
                    loadSidebarChats();
                });

                function toggleWebSearch() {
                    searchEnabled = !searchEnabled;
                    localStorage.setItem('aiSearchEnabled', searchEnabled);
                    updateWebSearchUI();

                    // Show notification
                    showToast(searchEnabled ? 'Web Search Enabled' : 'Web Search Disabled', searchEnabled ? 'info' : 'warning');
                }

                function updateWebSearchUI() {
                    const btn = document.getElementById('webSearchBtn');
                    if (!btn) return;
                    const t = window.i18n?.t ? window.i18n.t.bind(window.i18n) : (key) => key;

                    if (searchEnabled) {
                        btn.classList.remove('text-slate-400', 'border-white/10');
                        btn.classList.add('text-primary', 'border-primary/50', 'bg-primary/5');
                        btn.querySelector('span:last-child').innerText = t('ai.searchOn');
                    } else {
                        btn.classList.add('text-slate-400', 'border-white/10');
                        btn.classList.remove('text-primary', 'border-primary/50', 'bg-primary/5');
                        btn.querySelector('span:last-child').innerText = t('ai.searchOff');
                    }
                }


                function showToast(message, type = 'info') {
                    const toast = document.createElement('div');
                    toast.className = `fixed bottom-24 left-1/2 -translate-x-1/2 px-6 py-3 rounded-2xl bg-surface-dark border border-white/10 shadow-2xl z-[100] animate-fade-in flex items-center gap-3`;

                    const icon = type === 'warning' ? 'warning' : 'info';
                    const color = type === 'warning' ? 'text-amber-400' : 'text-primary';

                    toast.innerHTML = `
                    <span class="material-symbols-outlined ${color} text-sm">${icon}</span>
                    <span class="text-xs font-bold text-white uppercase tracking-widest">${message}</span>
                `;

                    document.body.appendChild(toast);
                    setTimeout(() => {
                        toast.classList.add('opacity-0', 'translate-y-2');
                        toast.style.transition = 'all 0.3s ease-out';
                        setTimeout(() => toast.remove(), 300);
                    }, 2000);
                }

                function openSettings() {
                    document.getElementById('settingsModal').classList.remove('hidden');
                }

                function closeSettingsModal() {
                    document.getElementById('settingsModal').classList.add('hidden');
                }

                function toggleTransparency(enabled) {
                    localStorage.setItem('transparencyMode', enabled);
                    if (enabled) {
                        document.body.classList.add('transparency-mode');
                    } else {
                        document.body.classList.remove('transparency-mode');
                    }
                }

                function saveSettings() {
                    const model = document.getElementById('aiModelSelect').value;
                    localStorage.setItem('preferredAIModel', model);
                    // Optionally show toast
                }

                // Attach listeners to delegated container for efficiency
                messagesContainer.addEventListener('contextmenu', (e) => {
                    const bubble = e.target.closest('.bg-surface-dark, .bg-gradient-to-br');
                    if (bubble) {
                        e.preventDefault();
                        lastContextTargetBubble = bubble;
                        // Clean text: strip out UI labels, icons, and system notices
                        let text = bubble.innerText
                            .replace(/âš ï¸ Notice:.*?\n*/g, '')
                            .replace(/psychology\n*MODEL REASONING.*?\n*expand_more/gi, '')
                            .replace(/MODEL REASONING/gi, '')
                            .replace(/copy_all|content_copy|volume_up|stop_circle|expand_more|expand_less/gi, '')
                            .replace(/code\n?\d+\s?lines/gi, '') // Remove code block headers
                            .replace(/Copy\b/g, '')
                            .replace(/Show\b|Hide\b/g, '')
                            .trim();
                        showContextMenu(e.clientX, e.clientY, text);
                    }
                });

                function viewSources() {
                    if (!lastContextTargetBubble) return;
                    const links = lastContextTargetBubble.querySelectorAll('a');
                    const sourceList = document.getElementById('sourceList');
                    if (!sourceList) return;

                    sourceList.innerHTML = '';
                    if (links.length === 0) {
                        sourceList.innerHTML = `
                            <div class="text-center py-8">
                                <span class="material-symbols-outlined text-4xl text-slate-600 mb-2">link_off</span>
                                <p class="text-slate-400 text-sm">No external sources found in this message.</p>
                            </div>
                        `;
                    } else {
                        // Use a Set to avoid duplicate URLs
                        const seenUrls = new Set();
                        links.forEach(link => {
                            if (seenUrls.has(link.href)) return;
                            seenUrls.add(link.href);

                            const url = link.href;
                            // Clean up text (remove icon keywords)
                            let text = link.innerText.replace(/open_in_new|openinnew/gi, '').trim();
                            if (!text || text === url) {
                                try {
                                    text = new URL(url).hostname;
                                } catch (e) {
                                    text = 'Source Link';
                                }
                            }

                            const div = document.createElement('div');
                            div.className = 'flex items-center justify-between p-3.5 rounded-2xl bg-background-dark border border-white/5 hover:border-primary/30 transition-all group';
                            div.innerHTML = `
                                <div class="flex-1 min-w-0 pr-4">
                                    <p class="text-sm font-bold text-white truncate group-hover:text-primary transition-colors">${text}</p>
                                    <p class="text-[10px] text-slate-500 truncate mt-0.5">${url}</p>
                                </div>
                                <a href="${url}" target="_blank" class="size-9 shrink-0 flex items-center justify-center rounded-xl bg-primary/10 text-primary hover:bg-primary hover:text-white transition-all shadow-sm">
                                    <span class="material-symbols-outlined text-[20px]">open_in_new</span>
                                </a>
                            `;
                            sourceList.appendChild(div);
                        });
                    }
                    document.getElementById('sourcesModal').classList.remove('hidden');
                    hideContextMenu();
                }

                // Long Press Logic for Mobile
                messagesContainer.addEventListener('touchstart', (e) => {
                    const bubble = e.target.closest('.bg-surface-dark, .bg-gradient-to-br');
                    if (bubble) {
                        longPressTimer = setTimeout(() => {
                            const touch = e.touches[0];
                            const text = bubble.innerText;
                            showContextMenu(touch.clientX, touch.clientY, text);
                        }, 500); // 500ms long press
                    }
                }, { passive: true });

                messagesContainer.addEventListener('touchend', () => {
                    clearTimeout(longPressTimer);
                });

                messagesContainer.addEventListener('touchmove', () => {
                    clearTimeout(longPressTimer);
                });

                // Auto-save conversation to localStorage
                function saveConversation() {
                    try {
                        localStorage.setItem('aiCurrentConversation', JSON.stringify({
                            history: conversationHistory,
                            timestamp: Date.now(),
                            model: localStorage.getItem('preferredAIModel') || 'wave-flash-2'
                        }));
                    } catch (e) {
                        console.error('Failed to save conversation:', e);
                    }
                }

                // Track if conversation has been restored to prevent duplicates
                let conversationRestored = false;

                // Restore conversation from localStorage on page load
                function restoreConversation() {
                    // Prevent multiple restorations
                    if (conversationRestored) {
                        console.log('Conversation already restored, skipping...');
                        return;
                    }

                    try {
                        const saved = localStorage.getItem('aiCurrentConversation');
                        if (saved) {
                            const data = JSON.parse(saved);
                            // Only restore if less than 24 hours old
                            if (Date.now() - data.timestamp < 24 * 60 * 60 * 1000) {
                                conversationHistory = data.history || [];
                                console.log(`Restored ${conversationHistory.length} messages from previous session`);

                                // Display restored messages (skip hidden system messages)
                                conversationHistory.forEach(msg => {
                                    // Skip hidden messages (search results, system prompts)
                                    if (msg._hidden) return;

                                    if (msg.role === 'user') {
                                        addMessage(msg.parts[0].text, true);
                                    } else if (msg.role === 'model') {
                                        addMessage(msg.parts[0].text, false);
                                    }
                                });

                                conversationRestored = true;
                            }
                        }
                    } catch (e) {
                        console.error('Failed to restore conversation:', e);
                    }
                }

                // ===== FILE/CODE ATTACHMENT FUNCTIONS =====

                // Toggle attach menu with animation
                window.toggleAttachMenu = function() {
                    console.log('toggleAttachMenu called');
                    const menu = document.getElementById('attachMenu');
                    console.log('Menu element:', menu);
                    if (!menu) {
                        console.error('attachMenu element not found!');
                        return;
                    }
                    if (menu.classList.contains('hidden')) {
                        menu.classList.remove('hidden');
                        // Trigger reflow
                        void menu.offsetWidth;
                        menu.classList.add('scale-100', 'opacity-100');
                        menu.classList.remove('scale-95', 'opacity-0');
                    } else {
                        menu.classList.add('scale-95', 'opacity-0');
                        menu.classList.remove('scale-100', 'opacity-100');
                        setTimeout(() => {
                            menu.classList.add('hidden');
                        }, 200);
                    }
                }

                // Close attach menu when clicking outside
                document.addEventListener('click', function (event) {
                    const menu = document.getElementById('attachMenu');
                    const button = document.getElementById('attachButton');
                    if (!menu.classList.contains('hidden') && !menu.contains(event.target) && !button.contains(event.target)) {
                        menu.classList.add('scale-95', 'opacity-0');
                        menu.classList.remove('scale-100', 'opacity-100');
                        setTimeout(() => {
                            menu.classList.add('hidden');
                        }, 200);
                    }
                });

                // Open code editor
                function openCodeEditor() {
                    document.getElementById('attachMenu').classList.add('hidden');
                    document.getElementById('codeEditorModal').classList.remove('hidden');
                    document.getElementById('codeEditorInput').focus();
                }

                // Close code editor
                function closeCodeEditor() {
                    document.getElementById('codeEditorModal').classList.add('hidden');
                    document.getElementById('codeEditorInput').value = '';
                    document.getElementById('codeLanguage').value = '';
                }

                // Attach code
                function attachCode() {
                    const code = document.getElementById('codeEditorInput').value.trim();
                    const language = document.getElementById('codeLanguage').value.trim() || 'code';

                    if (!code) {
                        alert('Please enter some code first!');
                        return;
                    }

                    const lineCount = code.split('\n').length;
                    attachedCode = { code, language, lineCount };

                    // Show attached code indicator in input
                    messageInput.placeholder = `ðŸ“Ž ${language} code attached (${lineCount} lines) - Type your question...`;
                    messageInput.classList.add('text-primary');

                    closeCodeEditor();
                }

                // Open file upload
                function openFileUpload() {
                    document.getElementById('attachMenu').classList.add('hidden');
                    document.getElementById('fileInput').click();
                }

                // Handle file upload
                function handleFileUpload(event) {
                    const file = event.target.files[0];
                    if (!file) return;

                    const isPdf = file.type === 'application/pdf' || file.name.toLowerCase().endsWith('.pdf');

                    if (isPdf) {
                        messageInput.placeholder = `ðŸ“„ Analyzing ${file.name}...`;
                        messageInput.disabled = true;

                        const reader = new FileReader();
                        reader.onload = async function (e) {
                            try {
                                const typedarray = new Uint8Array(e.target.result);
                                const pdf = await pdfjsLib.getDocument(typedarray).promise;
                                let fullText = '';

                                for (let i = 1; i <= pdf.numPages; i++) {
                                    const page = await pdf.getPage(i);
                                    const content = await page.getTextContent();
                                    const strings = content.items.map(item => item.str);
                                    fullText += strings.join(' ') + '\n';
                                }

                                attachedCode = {
                                    code: fullText.trim(),
                                    language: 'pdf',
                                    lineCount: pdf.numPages + ' pages',
                                    filename: file.name
                                };

                                messageInput.placeholder = `ðŸ“„ ${file.name} (Ready) - Type your query about this doc...`;
                                messageInput.classList.add('text-primary');
                            } catch (err) {
                                console.error('PDF Error:', err);
                                messageInput.placeholder = 'âŒ Failed to read PDF. Try again.';
                            } finally {
                                messageInput.disabled = false;
                                messageInput.focus();
                            }
                        };
                        reader.readAsArrayBuffer(file);
                    } else {
                        const reader = new FileReader();
                        reader.onload = function (e) {
                            const content = e.target.result;
                            const lineCount = content.split('\n').length;
                            const extension = file.name.split('.').pop();

                            attachedCode = {
                                code: content,
                                language: extension,
                                lineCount,
                                filename: file.name
                            };

                            messageInput.placeholder = `ðŸ“Ž ${file.name} attached (${lineCount} lines) - Type your question...`;
                            messageInput.classList.add('text-primary');
                        };
                        reader.readAsText(file);
                    }

                    // Reset file input
                    event.target.value = '';
                }

                // Check authentication
                const authToken = localStorage.getItem('authToken');
                if (!authToken) {
                    window.location.href = '/login.html';
                }

                // Register user for socket events
                const userId = localStorage.getItem('userId');
                const username = localStorage.getItem('username');
                const nickname = localStorage.getItem('nickname');

                if (userId && username) {
                    socket.emit('user:setup', { userId });
                }

                function toggleThinking() {
                    thinkingEnabled = !thinkingEnabled;
                    const btn = document.getElementById('thinkingToggle');
                    const icon = btn.querySelector('.material-symbols-outlined');
                    const text = btn.querySelector('.text-xs');

                    if (thinkingEnabled) {
                        btn.classList.add('bg-primary', 'border-primary');
                        btn.classList.remove('bg-surface-dark');
                        icon.classList.remove('text-slate-400');
                        icon.classList.add('text-white');
                        text.classList.remove('text-slate-400');
                        text.classList.add('text-white');
                    } else {
                        btn.classList.remove('bg-primary', 'border-primary');
                        btn.classList.add('bg-surface-dark');
                        icon.classList.add('text-slate-400');
                        icon.classList.remove('text-white');
                        text.classList.add('text-slate-400');
                        text.classList.remove('text-white');
                    }
                    
                    // Update settings checkbox
                    const checkbox = document.getElementById('thinkingMode');
                    if (checkbox) checkbox.checked = thinkingEnabled;
                }

                function toggleSearch() {
                    searchEnabled = !searchEnabled;
                    const btn = document.getElementById('searchToggle');
                    const icon = btn.querySelector('.material-symbols-outlined');
                    const text = btn.querySelector('.text-xs');

                    if (searchEnabled) {
                        btn.classList.add('bg-primary', 'border-primary');
                        btn.classList.remove('bg-surface-dark');
                        icon.classList.remove('text-slate-400');
                        icon.classList.add('text-white');
                        text.classList.remove('text-slate-400');
                        text.classList.add('text-white');
                    } else {
                        btn.classList.remove('bg-primary', 'border-primary');
                        btn.classList.add('bg-surface-dark');
                        icon.classList.add('text-slate-400');
                        icon.classList.remove('text-white');
                        text.classList.add('text-slate-400');
                        text.classList.remove('text-white');
                    }
                    
                    // Update settings checkbox
                    const checkbox = document.getElementById('searchMode');
                    if (checkbox) checkbox.checked = searchEnabled;
                }

                function handleKeyPress(event) {
                    if (event.key === 'Enter') {
                        sendMessage();
                    }
                }
                
                // Make handleKeyPress globally accessible
                window.handleKeyPress = handleKeyPress;

                let selectedLanguage = null;
                let selectedLanguageFlag = null;

                function showAICommand(command) {
                    currentAICommand = command;
                    const modal = document.getElementById('aiCommandModal');
                    const title = document.getElementById('modalTitle');
                    const input = document.getElementById('aiCommandInput');
                    const languageSelection = document.getElementById('languageSelection');
                    const textInputSection = document.getElementById('textInputSection');

                    const titles = {
                        'translate': 'ðŸŒ Translate Text',
                        'summarize': 'ðŸ“ Summarize Text',
                        'code': 'ðŸ’» Write Code',
                        'explain': 'ðŸŽ“ Explain Topic'
                    };

                    const placeholders = {
                        'translate': 'Enter text to translate...',
                        'summarize': 'Enter text to summarize...',
                        'code': 'Describe what code you need...',
                        'explain': 'What would you like me to explain?'
                    };

                    title.innerHTML = titles[command] || 'AI Command';
                    input.placeholder = placeholders[command] || 'Enter your text...';
                    input.value = '';

                    // Show language selection only for translate
                    if (command === 'translate') {
                        languageSelection.classList.remove('hidden');
                        selectedLanguage = null;
                        selectedLanguageFlag = null;
                    } else {
                        languageSelection.classList.add('hidden');
                    }

                    modal.classList.remove('hidden');
                    input.focus();
                }

                function selectLanguage(language, flag) {
                    selectedLanguage = language;
                    selectedLanguageFlag = flag;

                    // Update title to show selected language
                    const title = document.getElementById('modalTitle');
                    title.innerHTML = `ðŸŒ Translate to ${flag} ${language}`;

                    // Hide language selection, show text input
                    document.getElementById('languageSelection').classList.add('hidden');
                    document.getElementById('aiCommandInput').focus();
                }

                function closeAIModal() {
                    document.getElementById('aiCommandModal').classList.add('hidden');
                    currentAICommand = null;
                    selectedLanguage = null;
                    selectedLanguageFlag = null;
                }

                async function executeAICommand() {
                    const input = document.getElementById('aiCommandInput');
                    const text = input.value.trim();

                    if (!text) {
                        alert('Please enter some text!');
                        return;
                    }

                    let prompt;
                    if (currentAICommand === 'translate') {
                        if (!selectedLanguage) {
                            alert('Please select a target language first!');
                            document.getElementById('languageSelection').classList.remove('hidden');
                            return;
                        }
                        prompt = `Translate this text to ${selectedLanguage}. Respond ONLY with valid JSON in this exact format:

{"original": "${text.replace(/"/g, '\\"')}", "translation": "YOUR_TRANSLATION_HERE", "from": "DETECTED_LANGUAGE", "to": "${selectedLanguage}"}

Rules:
- Put the actual translation in "translation" field
- Detect source language and put it in "from" field
- NO extra text before or after the JSON
- NO explanations or comments

Text to translate: ${text}`;
                    } else {
                        const prompts = {
                            'summarize': `Summarize the following text concisely:\n\n${text}`,
                            'code': `Write clean, well-commented code for: ${text}`,
                            'explain': `Explain in detail: ${text}`
                        };
                        prompt = prompts[currentAICommand] || text;
                    }

                    closeAIModal();

                    // Add user message with a beautiful "Translation Request" card
                    if (currentAICommand === 'translate' && selectedLanguageFlag) {
                        const userCard = `
                            <div class="bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 rounded-xl shadow-lg p-0 overflow-hidden border border-primary/20 my-2 max-w-[95%]">
                                <div class="bg-primary/10 px-3 py-2 border-b border-white/5 flex items-center gap-2">
                                    <div class="size-5 rounded-lg bg-primary/20 flex items-center justify-center">
                                        <span class="material-symbols-outlined text-primary text-[12px]">translate</span>
                                    </div>
                                    <h3 class="text-[10px] font-bold text-white uppercase tracking-wider">Translation Request âž” ${selectedLanguageFlag} ${selectedLanguage}</h3>
                                </div>
                                <div class="p-3">
                                    <div class="bg-white/5 rounded-lg p-2.5 border border-white/5">
                                        <span class="text-[8px] font-bold text-slate-500 uppercase tracking-widest block mb-1">Original Text</span>
                                        <p class="text-sm text-white font-medium leading-relaxed">${text}</p>
                                    </div>
                                </div>
                            </div>
                        `;
                        addMessage(userCard, true);
                    } else {
                        addMessage(text, true);
                    }

                    // Add to conversation history
                    conversationHistory.push({ role: 'user', parts: [{ text: prompt }] });
                    saveConversation();

                    // Send to AI
                    await sendToQwenAI(prompt, true); // true = skip adding raw prompt to history UI
                }

                let isSending = false;

                async function sendMessage() {
                    console.log('sendMessage called');
                    const input = document.getElementById('messageInput');
                    const sendBtn = document.getElementById('sendMessageBtn');
                    if (!input) {
                        console.error('messageInput element not found!');
                        return;
                    }
                    if (isSending) {
                        if (typeof showToast === 'function') {
                            showToast('Please wait for the AI response...', 'info');
                        }
                        return;
                    }
                    const content = input.value.trim();
                    console.log('Message content:', content);
                    if (!content && !attachedCode) {
                        console.log('No content to send');
                        return;
                    }

                    let userMessage = content;
                    let aiPrompt = content;

                    // Handle attached code
                    if (attachedCode) {
                        // User sees: "ðŸ“Ž Attached code.js (50 lines)"
                        userMessage = `ðŸ“Ž Attached ${attachedCode.filename || attachedCode.language} code (${attachedCode.lineCount} lines)\n${content}`;

                        // AI gets: full code + user question
                        aiPrompt = `Here's the code:\n\`\`\`${attachedCode.language}\n${attachedCode.code}\n\`\`\`\n\n${content}`;

                        // Clear attachment
                        attachedCode = null;
                        input.placeholder = 'Message or type / for commands...';
                        input.classList.remove('text-primary');
                    }

                    // Add user message to UI (shows attachment summary)
                    addMessage(userMessage, true);

                    // Add to conversation history (only once, not in sendToQwenAI)
                    conversationHistory.push({ role: 'user', parts: [{ text: aiPrompt }] });
                    saveConversation();

                    input.value = '';

                    // Send to AI (with full code)
                    isSending = true;
                    input.disabled = true;
                    if (sendBtn) {
                        sendBtn.disabled = true;
                        sendBtn.classList.add('opacity-50', 'pointer-events-none');
                    }
                    try {
                        await sendToQwenAI(aiPrompt, true); // Pass flag to skip adding to history
                    } finally {
                        isSending = false;
                        input.disabled = false;
                        if (sendBtn) {
                            sendBtn.disabled = false;
                            sendBtn.classList.remove('opacity-50', 'pointer-events-none');
                        }
                        input.focus();
                    }
                }
                
                // Make sendMessage globally accessible
                window.sendMessage = sendMessage;

                async function sendToQwenAI(content, skipAddingToHistory = false) {
                    try {
                        console.log('sendToQwenAI called with content:', content);
                        
                        // Load saved settings from localStorage
                        const savedSettings = JSON.parse(localStorage.getItem('aiSettings') || '{}');
                        console.log('Loaded settings:', savedSettings);
                        
                        // Get preferred model from localStorage (set in Settings)
                        const preferredModel = savedSettings.model || localStorage.getItem('preferredAIModel') || 'auto';
                        console.log('Using model:', preferredModel);
                        
                        // Get temperature and max tokens from settings
                        const temperature = parseFloat(savedSettings.temperature || '0.7');
                        const maxTokens = parseInt(savedSettings.maxTokens || '1000');
                        const customSystemPrompt = savedSettings.systemPrompt || '';
                        
                        // Update thinking and search enabled from settings
                        if (savedSettings.thinkingMode !== undefined) {
                            thinkingEnabled = savedSettings.thinkingMode;
                        }
                        if (savedSettings.searchMode !== undefined) {
                            searchEnabled = savedSettings.searchMode;
                        }

                        // Model mapping from settings ID to OpenRouter model (matching ai.md)
                        const modelMap = {
                            // Wave Flash (Free - Fast models)
                            'wave-flash-1': 'liquid/lfm-2.5-1.2b-instruct:free',
                            'wave-flash-2': 'qwen/qwen3-4b:free',
                            'wave-flash-3': 'google/gemma-3n-e4b-it:free',
                            'wave-flash-4': 'google/gemma-3-12b-it:free',

                            // Wave (Standard models)
                            'wave-1': 'nvidia/nemotron-3-nano-30b-a3b:free',
                            'wave-2': 'arcee-ai/trinity-mini:free',
                            'wave-3': 'google/gemma-3-27b-it:free',
                            'wave-4': 'meta-llama/llama-3.3-70b-instruct:free', // Pro
                            'wave-5': 'arcee-ai/trinity-large-preview:free', // Pro

                            // Wave O (Reasoning models)
                            'wave-o1': 'liquid/lfm-2.5-1.2b-thinking:free',
                            'wave-o2': 'z-ai/glm-4.5-air:free', // Pro
                            'wave-o3': 'stepfun/step-3.5-flash:free', // Pro
                            'wave-o4': 'tngtech/tng-r1t-chimera:free', // Pro
                            'wave-o5': 'deepseek/deepseek-r1-0528:free', // Pro

                            // Auto/default (use Wave Flash 2)
                            'auto': 'qwen/qwen3-4b:free'
                        };

                        // Select model (default to free MiMo Flash)
                        const selectedModel = modelMap[preferredModel] || 'xiaomi/mimo-v2-flash:free';
                        const modelName = preferredModel ? preferredModel.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase()) : 'Wave Flash 2';

                        console.log('ðŸ¤– Using AI model:', selectedModel, '(', modelName, ')');

                        // Build OpenRouter-compatible message history
                        let messages = [];

                        // Model-specific system prompts with Wave guide
                        const getSystemPrompt = (modelId) => {
                            const waveGuide = `

ðŸ“± ABOUT WAVE MESSENGER:
Wave is a modern, feature-rich messaging platform you're integrated into. Here's what users can do:

**Core Features:**
- ðŸ’¬ Real-time messaging with friends and groups
- ðŸ¤– AI Chat (that's you!) - Help with translations, coding, questions, web search
- ðŸ“° Feed - News and content from Telegram channels
- ðŸ‘¤ User Profiles - Customizable profiles with avatars and bios
- ðŸŒ“ Dark/Light themes with transparency mode
- ðŸ“± Mobile-optimized interface with swipe gestures

**AI Features (Your Capabilities):**
- ðŸ” Web Search - AI can search DuckDuckGo automatically for current information
- ðŸŒ¤ï¸ Weather - ALWAYS use [WEATHER: city] for any weather request (no guessing)
- ðŸ“„ Read Files - Use [READ_FILE: filename.html] to read Wave HTML files for accurate help
- ðŸŒ Translation - Translate text to any language
- ðŸ’» Code Writing - Help with programming in any language
- ðŸ“„ PDF Analysis - Read and analyze PDF documents
- ðŸ“ Summarization - Summarize long texts
- ðŸ§  Reasoning Models - Some models can show their thinking process

**Latest Updates (Version 1.1.0 - February 1, 2026):**
- ðŸŽ¨ AI Model Selection (Wave Flash, Wave, Wave O, Wave Coder)
- ðŸ”„ Real-time AI Streaming with smooth batched updates
- ðŸŒ«ï¸ Transparency Mode with customizable blur effects
- ðŸ–¼ï¸ Custom Background uploads
- ðŸŽ¨ Advanced Theme System (Dark/Light with custom colors)
- ðŸ¤– Model-Specific AI Prompts (each model has unique personality)
- ðŸ“± Enhanced Mobile UI with improved swipe gestures
- ðŸŒ Compact Translation UI with original text display
- ðŸ§  Ultra-aggressive AI thinking filter
- âš¡ Performance improvements (no UI lag during streaming)

**Settings & Help:**
- Users can access Settings from the bottom navigation
- Settings include: Account, Appearance, Privacy, AI, Notifications, About
- Help Center available at /help.html
- Changelog available at /changelog.html
- Bug reporting at /report-bug.html
- Users can customize themes, transparency mode, and AI models
- Wave Pro users get access to premium AI models and features

**How to Help Users:**
- If they ask "what can Wave do?" - explain the features above
- If they ask about messaging - tell them about DMs, groups, profiles
- If they ask about AI - explain your search, weather, translation, coding abilities
- For any weather question, respond with ONLY: [WEATHER: city]
- If they need help with features - guide them through the UI (Settings â†’ specific tab)
- If they ask about updates - mention the latest version 1.0.0 features
- If they want to report bugs - direct them to /report-bug.html
- If they need help - direct them to /help.html or Settings â†’ About
- Always be helpful and friendly - you represent Wave!`;

                            // Note: Detailed AI behavior rules are now handled by the backend system prompt
                            // This keeps the codebase cleaner and ensures consistency

                            // Model-specific identities
                            const modelIdentities = {
                                'wave-flash-2': `You are **Wave AI Assistant** ðŸŒŠ, powered by Trinity Mini - a fast, efficient AI model perfect for quick responses.

You're the default AI helper in Wave Messenger, designed to be friendly, fast, and helpful. You excel at:
- Quick answers and explanations
- Translations and language help
- General knowledge questions
- Helping users understand Wave features

Your personality: Friendly, efficient, and always ready to help. You're like a helpful friend who knows a lot!`,

                                'wave-flash-3': `You are **Wave AI Assistant** ðŸŒŠ, powered by Nemotron Nano - a compact but powerful AI model.

You're optimized for speed and efficiency while maintaining high quality responses. You excel at:
- Fast, accurate answers
- Technical explanations
- Code assistance
- Wave feature guidance`,

                                'wave-flash-4': `You are **Wave AI Assistant** ðŸŒŠ, powered by Mistral Small - a balanced AI model for quality responses.

You provide thoughtful, well-structured answers. You excel at:
- Detailed explanations
- Complex problem solving
- Professional writing
- In-depth Wave feature help`,

                                'wave-2': `You are **Wave AI Assistant** ðŸŒŠ, powered by Llama 3.3 70B - a powerful, intelligent AI model.

You're a highly capable assistant with strong reasoning abilities. You excel at:
- Complex reasoning and analysis
- Detailed technical help
- Creative problem solving
- Comprehensive Wave guidance`,

                                'wave-3': `You are **Wave AI Assistant** ðŸŒŠ, powered by GLM-4.5 Air - an advanced AI model with strong multilingual capabilities.

You're excellent at understanding context and nuance. You excel at:
- Multilingual conversations
- Cultural context understanding
- Detailed analysis
- Wave feature expertise`,

                                'wave-4': `You are **Wave AI Assistant** ðŸŒŠ, powered by GPT OSS 120B - a large, reasoning-capable AI model.

You're a thinking model that can show your reasoning process when needed. You excel at:
- Deep reasoning and analysis
- Complex problem solving
- Step-by-step explanations
- Advanced Wave feature help

Note: You can show your thinking process in <thinking> tags when it helps users understand your reasoning.`,

                                'wave-o4': `You are **Wave AI Assistant** ðŸŒŠ, powered by GLM-4.5 Air with reasoning capabilities.

You're a reasoning model that thinks through problems carefully. You excel at:
- Logical reasoning
- Problem decomposition
- Thoughtful analysis
- Strategic Wave feature guidance

Note: Your thinking process may be visible to help users understand your reasoning.`,

                                'wave-coder-4': `You are **Wave AI Assistant** ðŸŒŠ, powered by Qwen3 Coder - a specialized coding AI model.

You're an expert programming assistant. You excel at:
- Writing clean, efficient code
- Debugging and optimization
- Explaining programming concepts
- Helping with Wave's technical features

You understand multiple programming languages and can help with everything from simple scripts to complex applications.`,

                                'auto': `You are **Wave AI Assistant** ðŸŒŠ, an intelligent AI helper integrated into Wave Messenger.

You're here to help users with anything they need - from answering questions to helping them use Wave's features. You excel at:
- Quick, helpful responses
- Understanding user needs
- Providing Wave feature guidance
- Being a friendly, reliable assistant`
                            };

                            const identity = modelIdentities[modelId] || modelIdentities['auto'];
                            // Note: baseRules are now in backend system prompt
                            return identity + waveGuide;
                        };

                        // Add system message with model-specific identity or custom system prompt
                        messages.push({
                            role: 'system',
                            content: customSystemPrompt || getSystemPrompt(preferredModel || 'auto')
                        });

                        // Convert conversation history to OpenRouter format
                        for (let i = 0; i < conversationHistory.length; i++) {
                            const msg = conversationHistory[i];
                            messages.push({
                                role: msg.role === 'model' ? 'assistant' : msg.role,
                                content: msg.parts[0].text
                            });
                        }

                        // Add current user message to local history if not skipped
                        if (!skipAddingToHistory) {
                            conversationHistory.push({ role: 'user', parts: [{ text: content }] });
                            saveConversation();
                        }

                        // Create streaming message bubble (no fixed ID to avoid conflicts)
                        const isSlowModel = ['wave-o3', 'wave-o4', 'wave-o5', 'wave-4'].includes(preferredModel);
                        const streamingDiv = document.createElement('div');
                        streamingDiv.className = 'flex gap-3 group streaming-ai-message';
                        streamingDiv.innerHTML = `
                    <div class="bg-center bg-no-repeat aspect-square bg-cover rounded-full size-8 shrink-0 self-end mb-1 ring-2 ring-transparent group-hover:ring-primary/20 transition-all" style='background-image: url("/nobackwave.png");'></div>
                    <div class="flex flex-col gap-2 max-w-[85%]">
                        <p class="text-[10px] font-medium text-slate-400 ml-1 mb-0.5">Wave AI</p>
                        ${isSlowModel ? '<div class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full bg-purple-500/10 border border-purple-500/20 w-fit"><div class="loader loader-xs"><div class="circle" style="--color: #a855f7;"></div><div class="circle" style="--color: #a855f7;"></div><div class="circle" style="--color: #a855f7;"></div><div class="circle" style="--color: #a855f7;"></div></div><span class="text-[9px] font-bold uppercase tracking-wider text-purple-300">Thinking...</span></div>' : ''}
                        <div class="bg-surface-dark p-3.5 rounded-2xl rounded-bl-none border border-white/5 shadow-sm">
                            <div class="streaming-content text-sm leading-relaxed text-slate-200">
                                <div class="loader loader-xs" style="display: inline-block; vertical-align: middle;">
                                    <div class="circle"></div>
                                    <div class="circle"></div>
                                    <div class="circle"></div>
                                    <div class="circle"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                        messagesContainer.appendChild(streamingDiv);
                        scrollContainer.scrollTop = scrollContainer.scrollHeight;

                        // Call backend AI chat API with streaming
                        const requestBody = {
                            messages: messages,
                            enableSearch: searchEnabled,
                            thinking: true, // Always request thinking if model supports it
                            model: preferredModel || 'auto',
                            temperature: temperature,
                            maxTokens: maxTokens
                        };
                        
                        console.log('Sending AI request:', requestBody);

                        async function runNonStreamingFallback() {
                            const fallbackResponse = await fetch('/api/ai-chat', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify(requestBody)
                            });

                            if (!fallbackResponse.ok) {
                                const errorData = await fallbackResponse.json().catch(() => ({}));
                                const rawError = errorData.error || errorData.message || '';
                                streamingDiv?.remove();
                                if (fallbackResponse.status === 429 || /429/.test(rawError)) {
                                    addMessage('âš ï¸ Rate limit reached. Please wait a moment and try again.', false);
                                } else if (fallbackResponse.status === 400 || /400/.test(rawError)) {
                                    addMessage('âš ï¸ Request was rejected. Try a shorter message or change the model.', false);
                                } else {
                                    addMessage(`Error: ${rawError || 'Something went wrong'}`, false);
                                }
                                return true;
                            }

                            const data = await fallbackResponse.json().catch(() => ({}));
                            const finalText = data.response || data.message || data.content || '';
                            if (!finalText) {
                                streamingDiv?.remove();
                                addMessage('âŒ Something went wrong while processing the information.', false);
                                return true;
                            }

                            // Render non-streaming response in the same bubble
                            const contentDiv = streamingDiv.querySelector('.streaming-content');
                            if (contentDiv) {
                                contentDiv.innerHTML = formatAIContent(finalText);
                            }

                            // Add speech and stop buttons
                            const buttonContainer = document.createElement('div');
                            buttonContainer.className = 'flex items-center gap-2 justify-start ml-1 mt-1';
                            buttonContainer.innerHTML = `
                    <button onclick="speakText(this.closest('.flex-col').querySelector('.text-sm').innerText, this)" class="speak-btn p-1 text-slate-500 hover:text-primary transition-colors opacity-0 group-hover:opacity-100" title="Read Aloud">
                        <span class="material-symbols-outlined text-[16px]">volume_up</span>
                    </button>
                    <button onclick="stopSpeaking()" class="p-1 text-slate-500 hover:text-red-400 transition-colors opacity-0 group-hover:opacity-100" title="Stop Reading">
                        <span class="material-symbols-outlined text-[16px]">stop_circle</span>
                    </button>
                `;
                            streamingDiv.querySelector('.flex-col').appendChild(buttonContainer);

                            conversationHistory.push({ role: 'model', parts: [{ text: finalText }] });
                            saveConversation();
                            return true;
                        }

                        // Use streaming for better UX
                        const response = await fetch('/api/ai-chat?stream=true', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(requestBody)
                        });
                        
                        console.log('Response status:', response.status, response.statusText);

                        if (!response.ok) {
                            const errorData = await response.json().catch(() => ({}));
                            const rawError = errorData.error || errorData.message || '';
                            streamingDiv?.remove();
                            if (response.status === 429 || /429/.test(rawError)) {
                                addMessage('âš ï¸ Rate limit reached. Please wait a moment and try again.', false);
                            } else if (response.status === 400 || /400/.test(rawError)) {
                                addMessage('âš ï¸ Request was rejected. Try a shorter message or change the model.', false);
                            } else {
                                const isStreamingError = /stream|streaming|openinference|upstream/i.test(rawError);
                                if (isStreamingError) {
                                    await runNonStreamingFallback();
                                    return;
                                }
                                addMessage(`Error: ${rawError || 'Something went wrong'}`, false);
                            }
                            return;
                        }

                        // Handle streaming response
                        const reader = response.body?.getReader();
                        if (!reader) {
                            streamingDiv?.remove();
                            addMessage('Error: Response body is not readable', false);
                            return;
                        }

                        const decoder = new TextDecoder();
                        let buffer = '';
                        let fullResponse = '';
                        let tokenBuffer = '';
                        let lastUpdate = Date.now();
                        const UPDATE_INTERVAL = 80; // Update UI every 80ms for smooth streaming

                        const contentDiv = streamingDiv.querySelector('.streaming-content');
                        const textContainer = document.createElement('span');
                        textContainer.className = 'whitespace-pre-wrap';
                        contentDiv.innerHTML = '';
                        contentDiv.appendChild(textContainer);

                        let hasReceivedContent = false;

                        try {
                            while (true) {
                                const { done, value } = await reader.read();
                                if (done) break;

                                buffer += decoder.decode(value, { stream: true });

                                // Process complete lines
                                while (true) {
                                    const lineEnd = buffer.indexOf('\n');
                                    if (lineEnd === -1) break;

                                    const line = buffer.slice(0, lineEnd).trim();
                                    buffer = buffer.slice(lineEnd + 1);

                                    if (line.startsWith('data: ')) {
                                        const data = line.slice(6);
                                        if (data === '[DONE]') break;

                                        try {
                                            const parsed = JSON.parse(data);
                                            
                                            if (parsed.error) {
                                                const errText = String(parsed.error || 'Unknown error');
                                                const isStreamingError = /stream|streaming|openinference|upstream|provider returned error/i.test(errText);
                                                if (isStreamingError) {
                                                    const handled = await runNonStreamingFallback();
                                                    if (handled) return;
                                                }
                                                streamingDiv?.remove();
                                                if (/429/.test(errText)) {
                                                    addMessage('âš ï¸ Rate limit reached. Please wait a moment and try again.', false);
                                                } else if (/400/.test(errText)) {
                                                    addMessage('âš ï¸ Request was rejected. Try a shorter message or change the model.', false);
                                                } else {
                                                    addMessage(`Error: ${errText}`, false);
                                                }
                                                return;
                                            }

                                            if (parsed.content) {
                                                // Remove thinking badge and loader on first content
                                                if (!hasReceivedContent) {
                                                    hasReceivedContent = true;
                                                    const thinkingBadge = streamingDiv.querySelector('.inline-flex.items-center.gap-1\\.5');
                                                    if (thinkingBadge) thinkingBadge.remove();
                                                }

                                                fullResponse += parsed.content;
                                                tokenBuffer += parsed.content;

                                                // Batched UI update - only update every UPDATE_INTERVAL ms
                                                const now = Date.now();
                                                if (now - lastUpdate >= UPDATE_INTERVAL) {
                                                    textContainer.textContent = fullResponse;
                                                    
                                                    // Smooth scroll without jumping
                                                    const isNearBottom = scrollContainer.scrollHeight - scrollContainer.scrollTop - scrollContainer.clientHeight < 200;
                                                    if (isNearBottom) {
                                                        scrollContainer.scrollTop = scrollContainer.scrollHeight;
                                                    }
                                                    
                                                    tokenBuffer = '';
                                                    lastUpdate = now;
                                                }
                                            }
                                        } catch (e) {
                                            // Ignore JSON parse errors
                                        }
                                    }
                                }
                            }

                            // Final update with any remaining tokens
                            if (tokenBuffer) {
                                textContainer.textContent = fullResponse;
                                scrollContainer.scrollTop = scrollContainer.scrollHeight;
                            }
                        } catch (streamError) {
                            console.error('Stream reading error:', streamError);
                            // Don't show error to user if we got some content
                            if (!hasReceivedContent) {
                                const handled = await runNonStreamingFallback();
                                if (!handled) {
                                    streamingDiv?.remove();
                                    addMessage('Connection interrupted. Please try again.', false);
                                }
                                return;
                            }
                        } finally {
                            try {
                                reader.cancel();
                            } catch (e) {
                                // Ignore cancel errors
                            }
                        }

                        // Parse JSON search requests from AI response
                        let searchQueries = [];
                        const jsonBlockMatch = fullResponse.match(/```json\s*({[\s\S]*?})\s*```/);
                        if (jsonBlockMatch) {
                            try {
                                const searchRequest = JSON.parse(jsonBlockMatch[1]);
                                if (searchRequest.searches && Array.isArray(searchRequest.searches)) {
                                    searchQueries = searchRequest.searches.map(s => s.query || s);
                                    console.log('ðŸ” Parsed JSON search request:', searchQueries);
                                }
                            } catch (e) {
                                console.error('Failed to parse JSON search request:', e);
                            }
                        }

                        // Fallback: Collect pattern-based searches for backward compatibility
                        if (searchQueries.length === 0) {
                            const searchMatches = [...fullResponse.matchAll(/\[SEARCH:\s*(.+?)\]/g)];
                            searchQueries = searchMatches.map(m => m[1].trim());
                        }

                        const weatherMatches = [...fullResponse.matchAll(/\[WEATHER:\s*(.+?)\]/g)];
                        const fileMatches = [...fullResponse.matchAll(/\[READ_FILE:\s*(.+?)\]/g)];

                        if (searchQueries.length > 0 || weatherMatches.length > 0 || fileMatches.length > 0) {
                            const weatherCities = weatherMatches.map(m => m[1].trim());
                            const filesToRead = fileMatches.map(m => m[1].trim());

                            console.log('ðŸ” AI requested searches:', searchQueries);
                            console.log('ðŸŒ¤ï¸ AI requested weathers:', weatherCities);
                            console.log('ðŸ“„ AI requested files:', filesToRead);

                            // Replace the streaming message content with processing indicator
                            let statusText = 'ðŸ” Processing requests...';
                            const parts = [];
                            if (searchQueries.length > 0) parts.push(`searching for ${searchQueries.length} items`);
                            if (weatherCities.length > 0) parts.push(`getting weather for ${weatherCities.length} cities`);
                            if (filesToRead.length > 0) parts.push(`reading ${filesToRead.length} files`);
                            
                            if (parts.length > 0) {
                                statusText = `ðŸ” ${parts.join(', ')}...`;
                            }

                            const statusContent = streamingDiv?.querySelector('.streaming-content');
                            if (statusContent) {
                                statusContent.textContent = statusText;
                            }

                            try {
                                const results = [];

                                // Execute searches in parallel
                                const searchPromises = searchQueries.map(async (query) => {
                                    try {
                                        const res = await fetch('/api/search', {
                                            method: 'POST',
                                            headers: { 'Content-Type': 'application/json' },
                                            body: JSON.stringify({ query, maxResults: 5, includeContent: true })
                                        });
                                        const data = await res.json();
                                        if (data.success && data.results.length > 0) {
                                            return `Results for "${query}":\n` + data.results.map((r, i) => {
                                                const content = r.content ? `\n   Content: ${r.content}` : '';
                                                return `${i + 1}. ${r.title}\n   URL: ${r.url}\n   ${r.snippet || 'No description'}${content}`;
                                            }).join('\n\n');
                                        }
                                        return `No results found for "${query}".`;
                                    } catch (e) {
                                        return `Search failed for "${query}".`;
                                    }
                                });

                                // Execute weather checks in parallel
                                const weatherPromises = weatherCities.map(async (city) => {
                                    try {
                                        const res = await fetch('/api/weather', {
                                            method: 'POST',
                                            headers: { 'Content-Type': 'application/json' },
                                            body: JSON.stringify({ city })
                                        });
                                        const data = await res.json();
                                        if (data.success && data.formatted) {
                                            return `Weather for ${city}:\n${data.formatted}`;
                                        }
                                        return `Could not get weather for ${city}.`;
                                    } catch (e) {
                                        return `Weather check failed for ${city}.`;
                                    }
                                });

                                // Execute file reads in parallel
                                const filePromises = filesToRead.map(async (filename) => {
                                    try {
                                        const res = await fetch(`/${filename}`);
                                        if (!res.ok) {
                                            return `File "${filename}" not found.`;
                                        }
                                        const html = await res.text();
                                        
                                        // Extract relevant content (remove scripts, styles, keep structure)
                                        const parser = new DOMParser();
                                        const doc = parser.parseFromString(html, 'text/html');
                                        
                                        // Remove scripts and styles
                                        doc.querySelectorAll('script, style, link').forEach(el => el.remove());
                                        
                                        // Get text content with some structure
                                        const body = doc.body;
                                        let content = body ? body.innerText : doc.documentElement.innerText;
                                        
                                        // Limit content length (first 3000 chars)
                                        if (content.length > 3000) {
                                            content = content.substring(0, 3000) + '... (content truncated)';
                                        }
                                        
                                        return `Content of "${filename}":\n${content}`;
                                    } catch (e) {
                                        return `Failed to read "${filename}": ${e.message}`;
                                    }
                                });

                                const allResults = await Promise.all([...searchPromises, ...weatherPromises, ...filePromises]);
                                const consolidatedContext = allResults.join('\n\n---\n\n');

                                // Remove JSON search block from the original response
                                const cleanedResponse = fullResponse.replace(/```json[\s\S]*?```/g, '').trim();

                                // Call AI again with consolidated results
                                const finalResponse = await fetch('/api/ai-chat', {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({
                                        messages: messages.concat([{
                                            role: 'assistant',
                                            content: cleanedResponse || 'I need to search for information.'
                                        }, {
                                            role: 'user',
                                            content: `Search Results:\n\n${consolidatedContext}\n\nNow please provide a comprehensive answer to my original question using these search results. Be specific and cite the information.`
                                        }]),
                                        enableSearch: false,
                                        thinking: false,
                                        model: preferredModel || 'auto'
                                    })
                                });

                                if (!finalResponse.ok) {
                                    if (statusContent) {
                                        statusContent.textContent = 'âŒ Failed to process the information.';
                                    } else {
                                        addMessage('âŒ Failed to process the information.', false);
                                    }
                                    return;
                                }

                                const finalData = await finalResponse.json();
                                if (finalData.success) {
                                    // Check if response has actual content
                                    const cleanResponse = finalData.response.trim();
                                    
                                    // If response is too short or only thinking, show fallback
                                    if (!cleanResponse || cleanResponse.length < 5) {
                                        if (statusContent) {
                                            statusContent.innerHTML = formatAIContent('ðŸ‘‹ Hello! How can I help you today?');
                                        } else {
                                            addMessage('ðŸ‘‹ Hello! How can I help you today?', false);
                                        }
                                        conversationHistory.push({
                                            role: 'model',
                                            parts: [{ text: 'ðŸ‘‹ Hello! How can I help you today?' }]
                                        });
                                    } else {
                                        if (statusContent) {
                                            statusContent.innerHTML = formatAIContent(cleanResponse);
                                        } else {
                                            addMessage(cleanResponse, false);
                                        }
                                        conversationHistory.push({
                                            role: 'model',
                                            parts: [{ text: cleanResponse }]
                                        });
                                    }
                                    // Add speech and stop buttons after final response
                                    if (streamingDiv) {
                                        const buttonContainer = document.createElement('div');
                                        buttonContainer.className = 'flex items-center gap-2 justify-start ml-1 mt-1';
                                        buttonContainer.innerHTML = `
                    <button onclick="speakText(this.closest('.flex-col').querySelector('.text-sm').innerText, this)" class="speak-btn p-1 text-slate-500 hover:text-primary transition-colors opacity-0 group-hover:opacity-100" title="Read Aloud">
                        <span class="material-symbols-outlined text-[16px]">volume_up</span>
                    </button>
                    <button onclick="stopSpeaking()" class="p-1 text-slate-500 hover:text-red-400 transition-colors opacity-0 group-hover:opacity-100" title="Stop Reading">
                        <span class="material-symbols-outlined text-[16px]">stop_circle</span>
                    </button>
                `;
                                        streamingDiv.querySelector('.flex-col')?.appendChild(buttonContainer);
                                    }
                                    saveConversation();
                                } else {
                                    if (statusContent) {
                                        statusContent.textContent = 'âŒ Something went wrong while processing the information.';
                                    } else {
                                        addMessage('âŒ Something went wrong while processing the information.', false);
                                    }
                                }
                            } catch (err) {
                                console.error('Error processing multi-requests:', err);
                                if (statusContent) {
                                    statusContent.textContent = 'âŒ Something went wrong while gathering information.';
                                } else {
                                    addMessage('âŒ Something went wrong while gathering information.', false);
                                }
                            }

                            return;
                        }

                        // Now format the complete response (only once, after streaming is done)
                        // Remove the cursor/loading indicator if it exists
                        const cursor = streamingDiv.querySelector('.animate-pulse');
                        if (cursor) cursor.remove();

                        textContainer.innerHTML = formatAIContent(fullResponse);

                        // Add speech and stop buttons after streaming is done
                        const buttonContainer = document.createElement('div');
                        buttonContainer.className = 'flex items-center gap-2 justify-start ml-1 mt-1';
                        buttonContainer.innerHTML = `
                    <button onclick="speakText(this.closest('.flex-col').querySelector('.text-sm').innerText, this)" class="speak-btn p-1 text-slate-500 hover:text-primary transition-colors opacity-0 group-hover:opacity-100" title="Read Aloud">
                        <span class="material-symbols-outlined text-[16px]">volume_up</span>
                    </button>
                    <button onclick="stopSpeaking()" class="p-1 text-slate-500 hover:text-red-400 transition-colors opacity-0 group-hover:opacity-100" title="Stop Reading">
                        <span class="material-symbols-outlined text-[16px]">stop_circle</span>
                    </button>
                `;
                        streamingDiv.querySelector('.flex-col').appendChild(buttonContainer);

                        // Add AI response to history
                        if (fullResponse) {
                            conversationHistory.push({ role: 'model', parts: [{ text: fullResponse }] });
                            saveConversation(); // Auto-save after AI response
                        }

                    } catch (error) {
                        console.error('AI error:', error);
                        // Try to remove any streaming message if it exists
                        const existingStreamingMsg = document.querySelector('.streaming-ai-message');
                        if (existingStreamingMsg) {
                            existingStreamingMsg.remove();
                        }
                        addMessage('Sorry, I encountered an error. Please try again.', false);
                    }
                }

                function sendCommand(command) {
                    messageInput.value = command + ' ';
                    messageInput.focus();
                }

                let currentUtterance = null;
                let audioTimer = null;
                let audioStartTime = 0;

                function speakText(text, buttonElement) {
                    const player = document.getElementById('audioPlayer');
                    const progress = document.getElementById('audioProgress');
                    const timeDisplay = document.getElementById('audioTime');

                    // If already speaking, stop it
                    if (window.speechSynthesis.speaking) {
                        window.speechSynthesis.cancel();
                        if (audioTimer) clearInterval(audioTimer);

                        // If the same button was clicked, we just want to stop
                        if (currentUtterance && currentUtterance._button === buttonElement) {
                            resetButtonStates();
                            player.classList.add('translate-x-[200%]');
                            setTimeout(() => player.classList.add('hidden'), 300);
                            currentUtterance = null;
                            return;
                        }

                        resetButtonStates();
                    }

                    // Simple text cleanup for better reading
                    const cleanText = text.replace(/\[SEARCH:.*?\]/g, '').replace(/```json[\s\S]*?```/g, '')
                        .replace(/\[WEATHER:.*?\]/g, '')
                        .replace(/>\s*âš ï¸\s*Notice:.*?\n\n/g, '') // Remove fallback notice
                        .replace(/```[\s\S]*?```/g, 'Code block skipped.') // Skip large code blocks
                        .replace(/[*#\_`]/g, ''); // Remove basic markdown

                    const utterance = new SpeechSynthesisUtterance(cleanText);

                    // Try to find a better voice (Microsoft/Google voices are usually better)
                    const voices = window.speechSynthesis.getVoices();
                    const preferredVoice = voices.find(v => (v.name.includes('Google') || v.name.includes('Microsoft') || v.name.includes('Natural')) && v.lang.startsWith('en')) ||
                        voices.find(v => v.lang.startsWith('en'));

                    if (preferredVoice) utterance.voice = preferredVoice;

                    utterance._button = buttonElement;
                    currentUtterance = utterance;

                    utterance.onstart = () => {
                        buttonElement.querySelector('.material-symbols-outlined').textContent = 'stop_circle';
                        buttonElement.classList.add('text-primary');
                        buttonElement.classList.remove('text-slate-500');

                        // Show player
                        player.classList.remove('hidden');
                        setTimeout(() => player.classList.remove('translate-x-[200%]'), 10);

                        // Start timer
                        audioStartTime = Date.now();
                        audioTimer = setInterval(() => {
                            const elapsed = Math.floor((Date.now() - audioStartTime) / 1000);
                            const mins = Math.floor(elapsed / 60);
                            const secs = elapsed % 60;
                            timeDisplay.textContent = `${mins}:${secs.toString().padStart(2, '0')}`;

                            // Simple progress estimation based on chars (crude but better than nothing)
                            const percent = Math.min(95, (elapsed / (cleanText.length / 15)) * 100);
                            progress.style.width = `${percent}%`;
                        }, 1000);
                    };

                    utterance.onend = () => {
                        resetButtonStates();
                        player.classList.add('translate-x-[200%]');
                        setTimeout(() => player.classList.add('hidden'), 300);
                        if (audioTimer) clearInterval(audioTimer);
                        currentUtterance = null;
                    };

                    utterance.onerror = () => {
                        resetButtonStates();
                        player.classList.add('hidden');
                        if (audioTimer) clearInterval(audioTimer);
                        currentUtterance = null;
                    };

                    window.speechSynthesis.speak(utterance);
                }

                function stopSpeaking() {
                    window.speechSynthesis.cancel();
                    resetButtonStates();
                    const player = document.getElementById('audioPlayer');
                    player.classList.add('translate-x-[200%]');
                    setTimeout(() => player.classList.add('hidden'), 300);
                    if (audioTimer) clearInterval(audioTimer);
                    currentUtterance = null;
                }

                function resetButtonStates() {
                    document.querySelectorAll('.speak-btn').forEach(btn => {
                        btn.querySelector('.material-symbols-outlined').textContent = 'volume_up';
                        btn.classList.remove('text-primary');
                        btn.classList.add('text-slate-500');
                    });
                }

                function addMessage(content, isUser = false) {
                    const messageDiv = document.createElement('div');
                    messageDiv.className = isUser ? 'flex gap-3 flex-row-reverse group' : 'flex gap-3 group';

                    const avatar = isUser
                        ? '<div class="bg-center bg-no-repeat aspect-square bg-cover rounded-full size-8 shrink-0 self-end mb-1 bg-primary"></div>'
                        : '<div class="bg-center bg-no-repeat aspect-square bg-cover rounded-full size-8 shrink-0 self-end mb-1 ring-2 ring-transparent group-hover:ring-primary/20 transition-all" style=\'background-image: url("/nobackwave.png");\'></div>';

                    const bubbleClass = isUser
                        ? 'bg-gradient-to-br from-primary to-sky-600 p-3.5 rounded-2xl rounded-br-none shadow-lg shadow-primary/10'
                        : 'bg-surface-dark p-3.5 rounded-2xl rounded-bl-none border border-white/5 shadow-sm';

                    const textClass = isUser ? 'text-white' : 'text-slate-200';

                    // Format content with markdown-like formatting
                    const formattedContent = formatAIContent(content);

                    messageDiv.innerHTML = `
                ${avatar}
                <div class="flex flex-col gap-1 max-w-[85%]">
                    ${!isUser ? '<p class="text-[10px] font-medium text-slate-400 ml-1 mb-0.5">Wave AI</p>' : ''}
                    <div class="${bubbleClass}">
                        <div class="text-sm leading-relaxed ${textClass}">${formattedContent}</div>
                    </div>
                    <div class="flex items-center gap-2 ${isUser ? 'justify-end mr-1' : 'justify-start ml-1'}">
                        ${!isUser ? `
                            <button onclick="speakText(this.closest('.flex-col').querySelector('.text-sm').innerText, this)" class="speak-btn p-1 text-slate-500 hover:text-primary transition-colors opacity-0 group-hover:opacity-100" title="Read Aloud">
                                <span class="material-symbols-outlined text-[16px]">volume_up</span>
                            </button>
                            <button onclick="stopSpeaking()" class="p-1 text-slate-500 hover:text-red-400 transition-colors opacity-0 group-hover:opacity-100" title="Stop Reading">
                                <span class="material-symbols-outlined text-[16px]">stop_circle</span>
                            </button>
                        ` : ''}
                        ${isUser ? '<span class="text-[10px] font-medium text-slate-500 opacity-0 group-hover:opacity-100 transition-opacity">' + new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' }) + '</span>' : ''}
                    </div>
                </div>
            `;

                    messagesContainer.appendChild(messageDiv);
                    scrollContainer.scrollTop = scrollContainer.scrollHeight;

                    return messageDiv; // Return the element so it can be manipulated
                }

                // Get language flag emoji
                function getLanguageFlag(language) {
                    const flags = {
                        'Spanish': 'ðŸ‡ªðŸ‡¸', 'French': 'ðŸ‡«ðŸ‡·', 'German': 'ðŸ‡©ðŸ‡ª', 'Italian': 'ðŸ‡®ðŸ‡¹',
                        'Portuguese': 'ðŸ‡µðŸ‡¹', 'Russian': 'ðŸ‡·ðŸ‡º', 'Chinese': 'ðŸ‡¨ðŸ‡³', 'Japanese': 'ðŸ‡¯ðŸ‡µ',
                        'Korean': 'ðŸ‡°ðŸ‡·', 'Arabic': 'ðŸ‡¸ðŸ‡¦', 'Hindi': 'ðŸ‡®ðŸ‡³', 'Turkish': 'ðŸ‡¹ðŸ‡·',
                        'Polish': 'ðŸ‡µðŸ‡±', 'Dutch': 'ðŸ‡³ðŸ‡±', 'Ukrainian': 'ðŸ‡ºðŸ‡¦', 'Swedish': 'ðŸ‡¸ðŸ‡ª',
                        'Greek': 'ðŸ‡¬ðŸ‡·', 'Czech': 'ðŸ‡¨ðŸ‡¿', 'English': 'ðŸ‡¬ðŸ‡§'
                    };
                    return flags[language] || 'ðŸŒ';
                }

                function formatAIContent(content) {
                    // 1. Remove systemic junk (Fallback notices, etc)
                    let cleanContent = content.replace(/âš ï¸ Notice: The requested model was temporarily unavailable\..*?\n*/g, '').trim();

                    // 2. Try to extract JSON for special cards (Translation, etc)
                    // This handles cases where the AI adds chatter around the JSON
                    const jsonRegex = /\{[\s\n]*"original"[\s\S]*?\}/;
                    const jsonMatch = cleanContent.match(jsonRegex);

                    if (jsonMatch) {
                        try {
                            const parsed = JSON.parse(jsonMatch[0]);

                            // Check if it's a translation JSON (has original, translation, and from/to or language)
                            if (parsed.original && parsed.translation && (parsed.language || parsed.to)) {
                                const targetLang = parsed.to || parsed.language;
                                const sourceLang = parsed.from || 'Original';
                                const flag = getLanguageFlag(targetLang);
                                
                                // Check if translation contains template placeholders - if so, skip rendering
                                if (parsed.translation.includes('YOUR_TRANSLATION_HERE') || 
                                    parsed.translation.includes('DETECTED_LANGUAGE') ||
                                    sourceLang.includes('DETECTED_LANGUAGE')) {
                                    // Return empty or error message
                                    return `<div class="bg-red-500/10 rounded-xl p-3 border border-red-500/30 my-2 max-w-[95%]">
                                        <div class="flex items-center gap-2 text-red-400">
                                            <span class="material-symbols-outlined text-[16px]">error</span>
                                            <span class="text-xs font-medium">Translation failed - AI returned template placeholders. Please try again.</span>
                                        </div>
                                    </div>`;
                                }

                                // IMMEDIATE RETURN: If we found a translation, ONLY show the card
                                return `<div class="bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 rounded-xl shadow-lg p-0 overflow-hidden border border-primary/20 hover:border-primary/40 transition-all my-2 max-w-[95%]">
                            <div class="bg-primary/10 px-3 py-2 border-b border-white/5 flex items-center justify-between">
                                <div class="flex items-center gap-2">
                                    <div class="size-5 rounded-lg bg-primary/20 flex items-center justify-center">
                                        <span class="material-symbols-outlined text-primary text-[12px]">translate</span>
                                    </div>
                                    <h3 class="text-[10px] font-bold text-white uppercase tracking-wider">${sourceLang} âž” ${flag} ${targetLang}</h3>
                                </div>
                                <button onclick="copyTranslation(this)" class="p-1 hover:bg-white/10 rounded-lg text-slate-400 hover:text-primary transition-all" title="Copy Translation">
                                    <span class="material-symbols-outlined text-[14px]">content_copy</span>
                                </button>
                            </div>
                            <div class="p-3 space-y-2">
                                <div class="bg-white/5 rounded-lg p-2.5 border border-white/5">
                                    <span class="text-[8px] font-bold text-slate-500 uppercase tracking-widest block mb-1">Translation</span>
                                    <p class="text-sm text-white font-medium leading-relaxed translation-text">${parsed.translation}</p>
                                </div>
                                <div class="space-y-1">
                                    <button onclick="toggleOriginal(this)" class="flex items-center gap-1 text-[8px] font-bold text-primary/70 hover:text-primary uppercase tracking-widest transition-colors">
                                        <span class="material-symbols-outlined text-[10px]">expand_more</span>
                                        <span>Show Original</span>
                                    </button>
                                    <p class="text-xs text-slate-400 leading-relaxed hidden bg-black/20 p-2 rounded-lg border border-white/5 font-mono italic whitespace-pre-wrap">${parsed.original}</p>
                                </div>
                            </div>
                        </div>`;
                            }

                            // Otherwise, render as code block with compact spacing (left-aligned, max-width)
                            const formattedJson = JSON.stringify(parsed, null, 1); // Changed from 2 to 1 for tighter spacing
                            return `<div class="my-3 rounded-xl overflow-hidden border border-slate-700/50 bg-slate-900/30 inline-block max-w-[90%]">
                        <div class="bg-gradient-to-r from-slate-800 to-slate-800/80 px-4 py-2.5 flex items-center justify-between border-b border-slate-700/50">
                            <span class="text-xs font-bold text-slate-300 uppercase tracking-wide">json</span>
                            <button onclick="copyCode(this)" class="px-3 py-1.5 text-xs text-slate-400 hover:text-white hover:bg-slate-700 rounded-lg transition-all flex items-center gap-1.5 font-medium">
                                <span class="material-symbols-outlined text-[16px]">content_copy</span>
                                Copy
                            </button>
                        </div>
                        <pre class="bg-slate-950 p-4 overflow-x-auto max-h-[500px]"><code class="text-emerald-400 font-mono text-sm leading-snug">${formattedJson}</code></pre>
                    </div>`;
                        } catch (e) {
                            console.error('Failed to parse JSON:', e);
                            console.error('Content was:', cleanContent);
                            // Not valid JSON, continue with normal formatting
                        }
                    }

                    // Extract and process code blocks BEFORE escaping HTML
                    let codeBlocks = [];
                    let codeBlockCounter = 0;

                    // Extract and process tables BEFORE escaping HTML
                    let tables = [];
                    let tableCounter = 0;

                    // Replace tables with placeholders FIRST
                    let contentWithTablePlaceholders = content.replace(/(\|.+\|\n)+/g, function (match) {
                        const placeholder = `___TABLE_${tableCounter}___`;

                        // Remove separator lines
                        const cleanedTable = match.replace(/\|[\s\-:]+\|[\s\-:]*\|?\n/g, '');

                        // Split into rows
                        const rows = cleanedTable.trim().split('\n').filter(r => r.trim());
                        if (rows.length === 0) return match;

                        // Process each row
                        const tableRows = rows.map((row, index) => {
                            const cells = row.split('|').filter(c => c.trim());
                            const isHeader = index === 0;
                            const tag = isHeader ? 'th' : 'td';
                            const cellClass = isHeader
                                ? 'border border-slate-700/50 px-3 py-2 text-sm font-bold text-white bg-slate-800/50 align-top'
                                : 'border border-slate-700/50 px-3 py-2 text-sm align-top';

                            return '<tr>' + cells.map(c => `<${tag} class="${cellClass}">${c.trim()}</${tag}>`).join('') + '</tr>';
                        }).join('');

                        tables[tableCounter] = '<div class="my-3 overflow-x-auto rounded-xl border border-slate-700/50 inline-block max-w-fit">' +
                            '<table class="border-collapse text-sm bg-slate-900/30">' + tableRows + '</table></div>';

                        tableCounter++;
                        return placeholder;
                    });

                    // Replace code blocks with placeholders
                    let contentWithPlaceholders = contentWithTablePlaceholders.replace(/```(\w+)?\n([\s\S]+?)```/g, function (match, lang, code) {
                        const placeholder = `___CODE_BLOCK_${codeBlockCounter}___`;
                        const language = lang || 'code';
                        const uniqueId = `code-block-${Date.now()}-${codeBlockCounter}`;

                        // Get the raw code
                        let rawCode = code.trim();

                        // Detect if it's JSON and format it with compact spacing
                        if (language === 'json' || (language === 'text' && (rawCode.startsWith('{') || rawCode.startsWith('[')))) {
                            try {
                                const parsed = JSON.parse(rawCode);
                                rawCode = JSON.stringify(parsed, null, 1); // Changed from 2 to 1 for tighter spacing
                            } catch (e) {
                                // Not valid JSON, keep as is
                            }
                        }

                        // Count actual lines
                        const lineCount = rawCode.split(/\r?\n/).length;

                        // Escape HTML for display but preserve line breaks
                        const escapedCode = rawCode
                            .replace(/&/g, '&amp;')
                            .replace(/</g, '&lt;')
                            .replace(/>/g, '&gt;')
                            .replace(/"/g, '&quot;')
                            .replace(/'/g, '&#039;');

                        const languageLabel = `<span class="text-xs font-bold text-slate-300 uppercase tracking-wide">${language}</span>`;

                        // Store the formatted code block with better styling (left-aligned, max-width)
                        codeBlocks[codeBlockCounter] = `<div class="my-3 rounded-xl overflow-hidden border border-slate-700/50 bg-slate-900/30 shadow-lg inline-block max-w-[90%]">
                    <div class="bg-gradient-to-r from-slate-800 to-slate-800/80 px-4 py-2.5 flex items-center justify-between border-b border-slate-700/50">
                        <div class="flex items-center gap-3">
                            ${languageLabel}
                            <span class="text-xs text-slate-500 font-medium">${lineCount} ${lineCount === 1 ? 'line' : 'lines'}</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <button onclick="copyCodeFromCollapsed('${uniqueId}')" class="px-3 py-1.5 text-xs text-slate-400 hover:text-white hover:bg-slate-700 rounded-lg transition-all flex items-center gap-1.5 font-medium">
                                <span class="material-symbols-outlined text-[16px]">content_copy</span>
                                Copy
                            </button>
                            <button onclick="toggleCodeBlock('${uniqueId}')" class="px-3 py-1.5 text-xs text-primary hover:text-white hover:bg-primary/20 rounded-lg transition-all flex items-center gap-1.5 font-medium">
                                <span class="material-symbols-outlined text-[18px]" id="${uniqueId}-icon">expand_more</span>
                                <span id="${uniqueId}-text">Show</span>
                            </button>
                        </div>
                    </div>
                    <div id="${uniqueId}" class="hidden">
                        <pre class="bg-slate-950 p-4 overflow-x-auto max-h-[600px] text-sm leading-snug"><code class="text-emerald-400 font-mono whitespace-pre">${escapedCode}</code></pre>
                    </div>
                </div>`;

                        codeBlockCounter++;
                        return placeholder;
                    });

                    // Now escape the rest of the HTML (non-code, non-table content)
                    const div = document.createElement('div');
                    div.textContent = contentWithPlaceholders;
                    let formatted = div.innerHTML;

                    // Restore tables from placeholders FIRST
                    for (let i = 0; i < tables.length; i++) {
                        formatted = formatted.replace(`___TABLE_${i}___`, tables[i]);
                    }

                    // Restore code blocks from placeholders
                    for (let i = 0; i < codeBlocks.length; i++) {
                        formatted = formatted.replace(`___CODE_BLOCK_${i}___`, codeBlocks[i]);
                    }

                    // Remove literal openinnew/open_in_new text that often leaks from AI output
                    formatted = formatted.replace(/\s(open_in_new|openinnew)/gi, '');
                    formatted = formatted.replace(/- (open_in_new|openinnew)/gi, '');
                    formatted = formatted.replace(/\[\s*(open_in_new|openinnew)\s*\]/gi, '');

                    // Remove thinking/reasoning text patterns (AI internal monologue) - ONLY if thinking mode is OFF
                    if (!thinkingEnabled) {
                        // First, remove entire paragraphs that are clearly thinking
                        formatted = formatted.replace(/^(We need to|As per system|We are|We should|Should we|Possibly respond|First|Okay|Alright|Let me|Let's see|I need to|I should|According to|The user|Double-check|Just make sure|No need for|So I should|That should|Hmm|Since they|But according|There's the|I can't say|maybe they|I'll say|I'll craft|I'll respond|Wait|Looking at|Now they're|followed by|which is a new|But the current|Since I know|Also avoid|Make sure to|Wait the user|Example:|User:|You:|Key points to include|I notice that|Might be a|Provide a|Keep conversation)[^.!?]*[.!?]/gi, '');
                        
                        // Remove sentences that contain thinking keywords
                        formatted = formatted.replace(/[^.!?]*\b(we need to|as per system|we are|we should|should we|possibly respond|provide a|keep conversation|the user asked|the user might|the user's last|looking at the rules|according to the rules|I should never|I must respond|I need to|I can answer|avoid any markdown|remind them|explaining my role|in the context of|I'll treat|I notice|could be a|seems like a|appears to be|might be a|I'll craft|Key points|key concept)\b[^.!?]*[.!?]/gi, '');
                        
                        // Split into sentences and filter out remaining thinking
                        const sentences = formatted.split(/(?<=[.!?])\s+/);
                        const filteredSentences = sentences.filter(sentence => {
                            const trimmed = sentence.trim();
                            const lower = trimmed.toLowerCase();
                            
                            // Remove if it starts with thinking phrases
                            if (/^(We need|We are|We should|Should we|As per|Possibly|Provide a|Keep conversation|First|Okay|Alright|Let me|Let's see|I need to|I should|According to|The user|Double-check|Just make sure|No need for|So I should|That should|Hmm|Since they|But according|There's the|I can't say|maybe they|I'll say|I'll craft|Wait|Looking|Now they|followed by|which is|But the current|Since I|Also avoid|Make sure|Example|User|You|Key points|I notice)/i.test(trimmed)) {
                                return false;
                            }
                            
                            // Remove if contains thinking keywords anywhere
                            if (lower.includes('we need to') || lower.includes('we are') || lower.includes('we should') || 
                                lower.includes('as per system') || lower.includes('should we') || lower.includes('possibly respond') ||
                                lower.includes('provide a') || lower.includes('keep conversation') ||
                                lower.includes('the user') || lower.includes('looking at') || lower.includes('according to the rules') || 
                                lower.includes('i should') || lower.includes('i need to') || lower.includes('i must') ||
                                lower.includes('wait,') || lower.includes('hmm,') || lower.includes('example:') ||
                                lower.includes('i notice') || lower.includes('i\'ll craft') || lower.includes('i\'ll treat') ||
                                lower.includes('key points') || lower.includes('might be a') || lower.includes('seems like')) {
                                return false;
                            }
                            
                            // Remove tool/function reasoning
                            if (/function|tool|ddgsearch|available/i.test(trimmed) && trimmed.length < 100) {
                                return false;
                            }
                            
                            return trimmed.length > 0;
                        });
                        
                        formatted = filteredSentences.join(' ').trim();
                        
                        // Remove any remaining thinking artifacts
                        formatted = formatted.replace(/\s+(First|Okay|Alright|Wait|Hmm|Let me|Let's see)\s+/gi, ' ');
                    }
                    
                    // Remove template placeholders from failed translations
                    formatted = formatted.replace(/YOUR_TRANSLATION_HERE|DETECTED_LANGUAGE|Actual text to translate goes here|The translated result goes here|Language name detected/gi, '');
                    
                    // Handle thinking tags based on thinking mode
                    if (!thinkingEnabled) {
                        // REMOVE thinking tags when thinking mode is OFF
                        formatted = formatted.replace(/<thinking>[\s\S]*?<\/thinking>/gi, '');
                        formatted = formatted.replace(/&lt;thinking&gt;[\s\S]*?&lt;\/thinking&gt;/gi, '');
                        formatted = formatted.replace(/\[thinking\][\s\S]*?\[\/thinking\]/gi, '');
                        
                        // Remove any stray thinking tag remnants
                        formatted = formatted.replace(/<\/?thinking>/gi, '');
                        formatted = formatted.replace(/&lt;\/?thinking&gt;/gi, '');
                    }
                    
                    // Clean up extra whitespace left by removed tags
                    formatted = formatted.replace(/\n{3,}/g, '\n\n').trim();
                    
                    // Format thinking tags (<thinking>...</thinking>) - handle escaped versions
                    formatted = formatted.replace(/&lt;thinking&gt;([\s\S]+?)&lt;\/thinking&gt;/gi, function (match, thinkContent) {
                        const uniqueId = `thinking-${Date.now()}-${Math.floor(Math.random() * 1000)}`;
                        // Clean up thinking content from systemic noise
                        const cleanThink = thinkContent.replace(/âš ï¸ Notice:.*?\n/g, '').trim();
                        if (!cleanThink) return ''; // Hide empty thinking

                        return `<div class="my-4 rounded-xl overflow-hidden border border-purple-500/30 bg-purple-500/5 shadow-lg max-w-[95%]">` +
                            `<button onclick="const el = document.getElementById('${uniqueId}'); el.classList.toggle('hidden'); this.querySelector('.arrow').classList.toggle('rotate-180')" class="w-full flex items-center justify-between px-4 py-2.5 bg-purple-500/10 hover:bg-purple-500/20 transition-all text-purple-300">` +
                            `<div class="flex items-center gap-2">` +
                            `<div class="loader loader-xs"><div class="circle" style="--color: #a855f7;"></div><div class="circle" style="--color: #a855f7;"></div><div class="circle" style="--color: #a855f7;"></div><div class="circle" style="--color: #a855f7;"></div></div>` +
                            `<span class="text-[10px] font-bold uppercase tracking-widest">Model Reasoning</span>` +
                            `</div>` +
                            `<span class="material-symbols-outlined text-sm arrow transition-transform">expand_more</span>` +
                            `</button>` +
                            `<div id="${uniqueId}" class="hidden p-4 text-[11px] text-slate-400 leading-relaxed border-t border-purple-500/20 bg-purple-950/20 whitespace-pre-wrap font-mono" style="font-family: 'JetBrains Mono', monospace;">${cleanThink}</div>` +
                            `</div>`;
                    });

                    // Format headings (###, ##, #) - removed arrow symbols
                    formatted = formatted.replace(/^### (.+)$/gm, '<h3 class="text-lg font-bold text-white mt-4 mb-2">$1</h3>');
                    formatted = formatted.replace(/^## (.+)$/gm, '<h2 class="text-xl font-bold text-white mt-4 mb-2">$1</h2>');
                    formatted = formatted.replace(/^# (.+)$/gm, '<h1 class="text-2xl font-bold text-white mt-4 mb-2">$1</h1>');

                    // Format bold text (**text**)
                    formatted = formatted.replace(/\*\*(.+?)\*\*/g, '<strong class="font-semibold text-white">$1</strong>');

                    // Format italic text (*text* or _text_)
                    formatted = formatted.replace(/\*(.+?)\*/g, '<em class="italic text-slate-300">$1</em>');
                    formatted = formatted.replace(/_(.+?)_/g, '<em class="italic text-slate-300">$1</em>');

                    // Format inline code (`code`)
                    formatted = formatted.replace(/`([^`]+)`/g, '<code class="bg-slate-800 px-2 py-0.5 rounded text-primary font-mono text-xs border border-slate-700">$1</code>');

                    // Format links [text](url) - Improved with automatic detection and keyword cleanup
                    formatted = formatted.replace(/\[([^\]]+)\]\(([^)]+)\)/g, (match, text, url) => {
                        // Clean up any "openinnew" or "open_in_new" strings inside the link text
                        const cleanText = text.replace(/open_in_new|openinnew/gi, '').trim();
                        return `<a href="${url}" target="_blank" class="text-primary hover:text-sky-400 font-bold underline decoration-primary/30 hover:decoration-sky-400 transition-colors inline-flex items-center gap-1 group">${cleanText || 'Link'} <span class="material-symbols-outlined text-[14px] opacity-70 group-hover:opacity-100 transition-opacity">open_in_new</span></a>`;
                    });

                    // Remove literal openinnew/open_in_new text that often leaks from AI output
                    formatted = formatted.replace(/\s(open_in_new|openinnew)/gi, '');
                    formatted = formatted.replace(/- (open_in_new|openinnew)/gi, '');

                    // Auto-linkify URLs that aren't already in markdown (e.g. engadget.com)
                    formatted = formatted.replace(/(^|\s)((?:https?:\/\/|www\.)[a-z0-9][a-z0-9.-]+\.[a-z]{2,}(?:\/[^\s<>]*)?)/gi, function (match, space, url) {
                        const fullUrl = url.startsWith('http') ? url : 'https://' + url;
                        // Avoid double wrapping if already processed
                        if (match.includes('href=')) return match;
                        const displayUrl = url.replace(/^https?:\/\//, '').split('/')[0];
                        return `${space}<a href="${fullUrl}" target="_blank" class="text-primary hover:text-sky-400 font-bold underline decoration-primary/30 hover:decoration-sky-400 transition-colors inline-flex items-center gap-1 group">${displayUrl} <span class="material-symbols-outlined text-[14px] opacity-70 group-hover:opacity-100 transition-opacity">open_in_new</span></a>`;
                    });

                    // Format unordered lists (- item or * item)
                    formatted = formatted.replace(/^[â€¢\-\*] (.+)$/gm, '<li class="ml-4 flex items-start gap-2"><span class="text-primary mt-1">â€¢</span><span>$1</span></li>');

                    // Format numbered lists (1. item)
                    let listCounter = 0;
                    formatted = formatted.replace(/^\d+\. (.+)$/gm, function (match, text) {
                        listCounter++;
                        return `<li class="ml-4 flex items-start gap-2"><span class="text-primary font-semibold min-w-[20px]">${listCounter}.</span><span>${text}</span></li>`;
                    });

                    // Wrap consecutive list items in ul
                    formatted = formatted.replace(/(<li class="ml-4[^>]*>.*?<\/li>\n?)+/g, function (match) {
                        return '<ul class="my-2 space-y-1.5">' + match + '</ul>';
                    });

                    // Format blockquotes (> text)
                    formatted = formatted.replace(/^&gt; (.+)$/gm, '<blockquote class="border-l-4 border-primary/50 bg-slate-800/30 pl-4 py-2 italic text-slate-300 my-2 rounded-r">$1</blockquote>');

                    // Format horizontal rules (---)
                    formatted = formatted.replace(/^---$/gm, '<hr class="border-slate-700 my-4">');

                    // Format checkboxes with Material Icons style
                    formatted = formatted.replace(/\[x\]/gi, '<span class="inline-flex items-center justify-center w-5 h-5 rounded bg-green-500/20 border border-green-500/50"><span class="material-symbols-outlined text-green-500 text-[14px]">check</span></span>');
                    formatted = formatted.replace(/\[ \]/g, '<span class="inline-flex items-center justify-center w-5 h-5 rounded bg-slate-700/30 border border-slate-600"><span class="material-symbols-outlined text-slate-500 text-[14px]">close</span></span>');

                    // Format line breaks
                    formatted = formatted.replace(/\n/g, '<br>');

                    return formatted;
                }

                // Copy code to clipboard
                function copyCode(button) {
                    try {
                        // Find the code block - it's in the next sibling (pre element)
                        const container = button.closest('.rounded-lg');
                        const codeBlock = container.querySelector('code');

                        if (!codeBlock) {
                            console.error('Code block not found');
                            return;
                        }

                        const text = codeBlock.textContent;

                        navigator.clipboard.writeText(text).then(() => {
                            const originalText = button.innerHTML;
                            button.innerHTML = '<span class="material-symbols-outlined text-[14px]">check</span>Copied!';
                            button.classList.add('text-green-500');

                            setTimeout(() => {
                                button.innerHTML = originalText;
                                button.classList.remove('text-green-500');
                            }, 2000);
                        }).catch(err => {
                            console.error('Failed to copy:', err);
                            alert('Failed to copy to clipboard');
                        });
                    } catch (error) {
                        console.error('Copy error:', error);
                    }
                }

                // Toggle collapsible code block
                function toggleCodeBlock(blockId) {
                    const codeBlock = document.getElementById(blockId);
                    const icon = document.getElementById(blockId + '-icon');
                    const text = document.getElementById(blockId + '-text');

                    if (codeBlock.classList.contains('hidden')) {
                        // Show code
                        codeBlock.classList.remove('hidden');
                        icon.textContent = 'expand_less';
                        text.textContent = 'Hide';
                    } else {
                        // Hide code
                        codeBlock.classList.add('hidden');
                        icon.textContent = 'expand_more';
                        text.textContent = 'Show';
                    }
                }

                // Toggle original text in translation card
                function toggleOriginal(btn) {
                    const text = btn.nextElementSibling;
                    const icon = btn.querySelector('.material-symbols-outlined');
                    const label = btn.querySelector('span:last-child');

                    if (text.classList.contains('hidden')) {
                        text.classList.remove('hidden');
                        icon.innerText = 'expand_less';
                        label.innerText = 'Hide Original Text';
                    } else {
                        text.classList.add('hidden');
                        icon.innerText = 'expand_more';
                        label.innerText = 'Show Original Text';
                    }
                }

                // Copy translation to clipboard
                function copyTranslation(btn) {
                    const card = btn.closest('.bg-gradient-to-br');
                    const text = card.querySelector('.translation-text').innerText;

                    navigator.clipboard.writeText(text).then(() => {
                        const originalIcon = btn.querySelector('.material-symbols-outlined').innerText;
                        btn.querySelector('.material-symbols-outlined').innerText = 'check';
                        btn.classList.add('text-green-500');

                        setTimeout(() => {
                            btn.querySelector('.material-symbols-outlined').innerText = originalIcon;
                            btn.classList.remove('text-green-500');
                        }, 2000);
                    });
                }

                // Copy code from collapsed block (without opening it)
                function copyCodeFromCollapsed(blockId) {
                    const codeBlock = document.getElementById(blockId);
                    const codeElement = codeBlock.querySelector('code');

                    if (!codeElement) {
                        console.error('Code element not found');
                        return;
                    }

                    const text = codeElement.textContent;

                    navigator.clipboard.writeText(text).then(() => {
                        // Find the copy button
                        const container = codeBlock.closest('.rounded-lg');
                        const copyButton = container.querySelector('button[onclick*="copyCodeFromCollapsed"]');

                        if (copyButton) {
                            const originalHTML = copyButton.innerHTML;
                            copyButton.innerHTML = '<span class="material-symbols-outlined text-[14px]">check</span>Copied!';
                            copyButton.classList.add('text-green-500');

                            setTimeout(() => {
                                copyButton.innerHTML = originalHTML;
                                copyButton.classList.remove('text-green-500');
                            }, 2000);
                        }
                    }).catch(err => {
                        console.error('Failed to copy:', err);
                        alert('Failed to copy to clipboard');
                    });
                }

                // ===== CHAT SAVING FUNCTIONS =====

                function saveCurrentChat() {
                    if (conversationHistory.length === 0) {
                        alert('No conversation to save!');
                        return;
                    }
                    document.getElementById('saveChatModal').classList.remove('hidden');
                    document.getElementById('chatNameInput').focus();
                }

                function closeSaveChatModal() {
                    document.getElementById('saveChatModal').classList.add('hidden');
                    document.getElementById('chatNameInput').value = '';
                }

                function confirmSaveChat() {
                    const chatName = document.getElementById('chatNameInput').value.trim();
                    if (!chatName) {
                        alert('Please enter a chat name');
                        return;
                    }

                    // Get existing saved chats
                    const savedChats = JSON.parse(localStorage.getItem('aiSavedChats') || '[]');

                    // Create new chat object
                    const newChat = {
                        id: Date.now(),
                        name: chatName,
                        timestamp: new Date().toISOString(),
                        history: conversationHistory,
                        model: localStorage.getItem('preferredAIModel') || 'wave-flash-2',
                        messageCount: conversationHistory.length
                    };

                    // Add to saved chats
                    savedChats.unshift(newChat); // Add to beginning

                    // Keep only last 50 chats
                    if (savedChats.length > 50) {
                        savedChats.pop();
                    }

                    // Save to localStorage
                    localStorage.setItem('aiSavedChats', JSON.stringify(savedChats));

                    closeSaveChatModal();
                    loadSidebarChats(); // Refresh sidebar

                    // Show success message
                    const successDiv = document.createElement('div');
                    const t = window.i18n?.t ? window.i18n.t.bind(window.i18n) : (key) => key;
                    successDiv.className = 'fixed top-20 right-6 bg-primary text-white px-6 py-3 rounded-xl shadow-lg z-50 animate-fade-in';
                    successDiv.innerHTML = `
                <div class="flex items-center gap-2">
                    <span class="material-symbols-outlined">check_circle</span>
                    <span>${t('ai.chatSavedSuccess')}</span>
                </div>
            `;
                    document.body.appendChild(successDiv);
                    setTimeout(() => successDiv.remove(), 3000);
                }

                async function showSavedChats() {
                    const savedChats = JSON.parse(localStorage.getItem('aiSavedChats') || '[]');
                    const listContainer = document.getElementById('savedChatsList');
                    if (window.i18n && !window.i18n.translations?.[window.i18n.currentLang]) {
                        await window.i18n.init();
                    }
                    const t = window.i18n?.t ? window.i18n.t.bind(window.i18n) : (key) => key;

                    if (savedChats.length === 0) {
                        listContainer.innerHTML = `
                    <div class="text-center py-12 text-slate-400">
                        <span class="material-symbols-outlined text-5xl mb-3 opacity-50">bookmark_border</span>
                        <p>${t('ai.noSavedChats')}</p>
                        <p class="text-xs mt-2">${t('ai.saveConversations')}</p>
                    </div>
                `;
                    } else {
                        listContainer.innerHTML = savedChats.map(chat => {
                            const date = new Date(chat.timestamp);
                            const dateStr = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                            const timeStr = date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });

                            return `
                        <div class="bg-background-dark rounded-xl p-4 border border-white/5 hover:border-primary/30 transition-all group cursor-pointer">
                            <div class="flex items-start justify-between gap-3">
                                <div class="flex-1" onclick="loadSavedChat(${chat.id})">
                                    <h4 class="font-semibold text-white group-hover:text-primary transition-colors">${chat.name}</h4>
                                    <p class="text-xs text-slate-400 mt-1">${chat.messageCount} messages â€¢ ${dateStr} at ${timeStr}</p>
                                    <p class="text-xs text-slate-500 mt-1">Model: ${chat.model.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}</p>
                                </div>
                                <button onclick="deleteSavedChat(${chat.id}); event.stopPropagation();" class="text-slate-400 hover:text-red-400 transition-colors p-2" title="Delete">
                                    <span class="material-symbols-outlined text-[20px]">delete</span>
                                </button>
                            </div>
                        </div>
                    `;
                        }).join('');
                    }

                    document.getElementById('savedChatsModal').classList.remove('hidden');
                }

                function closeSavedChatsModal() {
                    document.getElementById('savedChatsModal').classList.add('hidden');
                }

                function loadSavedChat(chatId) {
                    const savedChats = JSON.parse(localStorage.getItem('aiSavedChats') || '[]');
                    const chat = savedChats.find(c => c.id === chatId);

                    if (!chat) {
                        alert('Chat not found');
                        return;
                    }

                    // Clear current chat
                    clearChat(false);

                    // Load conversation history
                    conversationHistory = chat.history;

                    // Render messages
                    chat.history.forEach(msg => {
                        const isUser = msg.role === 'user';
                        const content = msg.parts[0].text;
                        addMessage(content, isUser);
                    });

                    closeSavedChatsModal();

                    // Show success message
                    const successDiv = document.createElement('div');
                    successDiv.className = 'fixed top-20 right-6 bg-primary text-white px-6 py-3 rounded-xl shadow-lg z-50';
                    successDiv.innerHTML = `
                <div class="flex items-center gap-2">
                    <span class="material-symbols-outlined">history</span>
                    <span>Chat loaded: ${chat.name}</span>
                </div>
            `;
                    document.body.appendChild(successDiv);
                    setTimeout(() => successDiv.remove(), 3000);
                }

                function deleteSavedChat(chatId) {
                    if (!confirm('Delete this chat? This cannot be undone.')) {
                        return;
                    }

                    let savedChats = JSON.parse(localStorage.getItem('aiSavedChats') || '[]');
                    savedChats = savedChats.filter(c => c.id !== chatId);
                    localStorage.setItem('aiSavedChats', JSON.stringify(savedChats));

                    // Refresh the list
                    showSavedChats();
                }

                function clearChat(showConfirm = true) {
                    if (showConfirm && conversationHistory.length > 0) {
                        if (!confirm('Start a new chat? Current conversation will be lost if not saved.')) {
                            return;
                        }
                    }

                    // Clear conversation history
                    conversationHistory = [];

                    // Clear saved conversation from localStorage
                    localStorage.removeItem('aiCurrentConversation');

                    // Clear messages container
                    messagesContainer.innerHTML = `
                <div class="flex justify-center my-4">
                    <span class="text-[10px] font-semibold tracking-wider text-slate-500 uppercase bg-surface-dark px-3 py-1 rounded-full border border-white/5">Today</span>
                </div>
            `;

                    // Reload welcome message
                    loadAIStatus();
                }

                // Load AI status on page load
                async function loadAIStatus() {
                    console.log('loadAIStatus called');
                    
                    // Wait for i18n to be ready (simple check with timeout)
                    if (!window.i18n) {
                        console.log('i18n not ready, waiting...');
                        setTimeout(loadAIStatus, 100);
                        return;
                    }
                    
                    // Ensure messagesContainer exists
                    const container = document.getElementById('messages-inner-container');
                    if (!container) {
                        console.error('Messages container not found! Retrying in 100ms...');
                        setTimeout(loadAIStatus, 100);
                        return;
                    }
                    
                    // First restore conversation if available
                    if (!conversationRestored) {
                        restoreConversation();
                    }
                    
                    // Check for visible messages instead of total history
                    const visibleMessages = conversationHistory.filter(msg => !msg._hidden);
                    console.log('Visible messages count:', visibleMessages.length);
                    if (visibleMessages.length > 0) {
                        console.log('Conversation already has messages, skipping welcome');
                        return;
                    }

                    // Get preferred model from localStorage (check settings first)
                    const savedSettings = JSON.parse(localStorage.getItem('aiSettings') || '{}');
                    const preferredModel = savedSettings.model || localStorage.getItem('preferredAIModel') || 'auto';
                    const modelName = preferredModel === 'auto' ? 'Auto Select' : preferredModel.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase());

                    // Add welcome message without HTML tags
                    const welcomeDiv = document.createElement('div');
                    welcomeDiv.className = 'flex gap-3 group';
                    welcomeDiv.id = 'aiWelcomeMessage'; // Add ID for easier removal if needed
                    
                    // Get translations (bind context to preserve 'this')
                    const aiAssistantText = window.i18n.t('ai.aiAssistant');
                    const welcomeMsg = window.i18n.t('ai.welcomeMessage');
                    const welcomeDesc = window.i18n.t('ai.welcomeDescription');
                    const currentlyUsingText = window.i18n.t('ai.currentlyUsing');
                    const changeInSettingsText = window.i18n.t('ai.changeInSettings');
                    
                    welcomeDiv.innerHTML = `
                <div class="bg-center bg-no-repeat aspect-square bg-cover rounded-full size-8 shrink-0 self-end mb-1 ring-2 ring-transparent group-hover:ring-primary/20 transition-all" style='background-image: url("/nobackwave.png");'></div>
                <div class="flex flex-col gap-1 max-w-[85%]">
                    <p class="text-[10px] font-medium text-slate-400 ml-1 mb-0.5">${aiAssistantText}</p>
                    <div class="bg-surface-dark p-3.5 rounded-2xl rounded-bl-none border border-white/5 shadow-sm">
                        <div class="text-sm leading-relaxed text-slate-200">
                            ${welcomeMsg}<br><br>
                            ${welcomeDesc}
                        </div>
                        <div class="text-[10px] text-slate-500 mt-2">${currentlyUsingText}: ${modelName} â€¢ ${changeInSettingsText}</div>
                    </div>
                </div>
            `;
                    // Reuse container from earlier in function
                    if (container) {
                        container.appendChild(welcomeDiv);
                        console.log('Welcome message added to chat');
                    } else {
                        console.error('Messages container not found when trying to show welcome!');
                    }
                }

                // Wait for DOM to be ready before loading AI status
                if (document.readyState === 'loading') {
                    document.addEventListener('DOMContentLoaded', async () => {
                        // Initialize i18n first
                        if (window.i18n) {
                            await window.i18n.init();
                        }
                        loadAIStatus();
                    });
                } else {
                    // DOM already loaded, initialize i18n then load AI status
                    (async () => {
                        if (window.i18n) {
                            await window.i18n.init();
                        }
                        loadAIStatus();
                    })();
                }
            </script>

            <!-- Background Image Script -->
            <script>
                // Load theme colors from localStorage
                (function () {
                    const primary = localStorage.getItem('themeColorPrimary');
                    const secondary = localStorage.getItem('themeColorSecondary');
                    const tertiary = localStorage.getItem('themeColorTertiary');
                    const background = localStorage.getItem('themeColorBackground');
                    const surface = localStorage.getItem('themeColorSurface');
                    const highlight = localStorage.getItem('themeColorHighlight');

                    if (primary) document.documentElement.style.setProperty('--color-primary', primary);
                    if (secondary) document.documentElement.style.setProperty('--color-secondary', secondary);
                    if (tertiary) document.documentElement.style.setProperty('--color-tertiary', tertiary);
                    if (background) {
                        document.documentElement.style.setProperty('--bg-page', background);
                        document.body.style.backgroundColor = background;
                        setTimeout(() => {
                            const mainAreas = document.querySelectorAll('main, .relative.flex.h-screen, #chat-container');
                            mainAreas.forEach(el => el.style.backgroundColor = background);
                        }, 100);
                    }
                    if (surface) {
                        document.documentElement.style.setProperty('--bg-surface', surface);
                        setTimeout(() => {
                            const surfaceElements = document.querySelectorAll('.bg-surface-dark, .bg-\\[\\#16262c\\], .bg-\\[\\#1e2433\\]');
                            surfaceElements.forEach(el => el.style.backgroundColor = surface);
                        }, 100);
                    }
                    if (highlight) {
                        document.documentElement.style.setProperty('--surface-hover', highlight);
                        document.documentElement.style.setProperty('--bg-surface-lighter', highlight);
                    }
                })();

                // Load transparency mode from localStorage
                (function () {
                    const isTransparent = localStorage.getItem('transparencyMode') === 'true';
                    if (isTransparent) {
                        document.body.classList.add('transparency-mode');
                    }
                })();

                // Load custom background from localStorage
                (function () {
                    const bgDiv = document.getElementById('customBackground');
                    if (!bgDiv) return;

                    const chatBackground = localStorage.getItem('chatBackground');
                    const customBgUrl = localStorage.getItem('customBackgroundUrl');
                    const bgOpacity = localStorage.getItem('bgOpacity') || 10;
                    const bgBlur = localStorage.getItem('bgBlur') || 4;

                    let backgroundUrl = '';

                    if (chatBackground && chatBackground !== 'none') {
                        if (chatBackground === 'custom' && customBgUrl) {
                            backgroundUrl = customBgUrl;
                        } else if (chatBackground.startsWith('bg')) {
                            const bgMap = {
                                'bg1': '1769528516',
                                'bg2': '1769528550',
                                'bg3': '1769528632',
                                'bg4': '1769528667',
                                'bg5': '1769528899',
                                'bg6': '1769529072'
                            };
                            const bgNum = bgMap[chatBackground];
                            if (bgNum) {
                                backgroundUrl = `/backgrounds/${bgNum}.png`;
                            }
                        }
                    }

                    if (backgroundUrl) {
                        bgDiv.classList.remove('hidden');
                        // NEW STYLING: Image in center, solid color on sides
                        bgDiv.style.cssText = `
                    background-image: url('${backgroundUrl}');
                    background-size: contain;
                    background-position: center;
                    background-repeat: no-repeat;
                    background-color: #101e22;
                    opacity: ${bgOpacity / 100};
                    filter: blur(${bgBlur}px);
                `;
                    } else {
                        bgDiv.classList.add('hidden');
                    }
                })();

                // ===== MOBILE-SPECIFIC FUNCTIONS =====

                // Mobile Sidebar Functions
                function openSidebar() {
                    const sidebar = document.querySelector('.mobile-sidebar');
                    const overlay = document.querySelector('.sidebar-overlay');
                    if (sidebar) sidebar.classList.add('open');
                    if (overlay) overlay.classList.add('active');
                    document.body.style.overflow = 'hidden';
                    loadSidebarChats();
                    // Update hamburger menu state
                    updateHamburgerState();
                }

                function closeSidebar() {
                    const sidebar = document.querySelector('.mobile-sidebar');
                    const overlay = document.querySelector('.sidebar-overlay');
                    if (sidebar) sidebar.classList.remove('open');
                    if (overlay) overlay.classList.remove('active');
                    document.body.style.overflow = '';
                    // Update hamburger menu state
                    updateHamburgerState();
                }

                function toggleSidebar() {
                    const sidebar = document.querySelector('.mobile-sidebar');
                    if (sidebar && sidebar.classList.contains('open')) {
                        closeSidebar();
                    } else {
                        openSidebar();
                    }
                }

                function updateHamburgerState() {
                    const sidebar = document.querySelector('.mobile-sidebar');
                    const hamburger = document.querySelector('.hamburger-menu');
                    if (hamburger) {
                        if (sidebar && sidebar.classList.contains('open')) {
                            hamburger.classList.add('active');
                        } else {
                            hamburger.classList.remove('active');
                        }
                    }
                }

                // Tab switching
                function switchTab(tabName) {
                    // Update tab buttons
                    document.querySelectorAll('.tab-button').forEach(btn => {
                        btn.classList.remove('active');
                        btn.classList.add('text-slate-400');
                    });
                    document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
                    document.querySelector(`[data-tab="${tabName}"]`).classList.remove('text-slate-400');
                    // Update tab content
                    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                    document.getElementById(`${tabName}-tab`).classList.add('active');
                }

                // Settings functions
                function saveSettings() {
                    const settings = {
                        model: document.getElementById('modelSelect').value,
                        temperature: document.getElementById('temperatureSlider').value,
                        maxTokens: document.getElementById('maxTokensSlider').value,
                        systemPrompt: document.getElementById('systemPrompt').value,
                        thinkingMode: document.getElementById('thinkingMode').checked,
                        searchMode: document.getElementById('searchMode').checked
                    };
                    localStorage.setItem('aiSettings', JSON.stringify(settings));
                    alert('Settings saved!');
                }

                // Load settings on page load
                document.addEventListener('DOMContentLoaded', () => {
                    const settings = JSON.parse(localStorage.getItem('aiSettings') || '{}');
                    if (settings.model) document.getElementById('modelSelect').value = settings.model;
                    if (settings.temperature) {
                        document.getElementById('temperatureSlider').value = settings.temperature;
                        document.getElementById('temperatureValue').textContent = settings.temperature;
                    }
                    if (settings.maxTokens) {
                        document.getElementById('maxTokensSlider').value = settings.maxTokens;
                        document.getElementById('maxTokensValue').textContent = settings.maxTokens;
                    }
                    if (settings.systemPrompt) document.getElementById('systemPrompt').value = settings.systemPrompt;
                    if (settings.thinkingMode !== undefined) {
                        document.getElementById('thinkingMode').checked = settings.thinkingMode;
                        thinkingEnabled = settings.thinkingMode;
                        // Update toggle button appearance
                        if (thinkingEnabled) {
                            const btn = document.getElementById('thinkingToggle');
                            if (btn) {
                                btn.classList.add('bg-primary', 'border-primary');
                                btn.classList.remove('bg-surface-dark');
                                const icon = btn.querySelector('.material-symbols-outlined');
                                const text = btn.querySelector('.text-xs');
                                icon?.classList.remove('text-slate-400');
                                icon?.classList.add('text-white');
                                text?.classList.remove('text-slate-400');
                                text?.classList.add('text-white');
                            }
                        }
                    }
                    if (settings.searchMode !== undefined) {
                        document.getElementById('searchMode').checked = settings.searchMode;
                        searchEnabled = settings.searchMode;
                        // Update toggle button appearance
                        if (searchEnabled) {
                            const btn = document.getElementById('searchToggle');
                            if (btn) {
                                btn.classList.add('bg-primary', 'border-primary');
                                btn.classList.remove('bg-surface-dark');
                                const icon = btn.querySelector('.material-symbols-outlined');
                                const text = btn.querySelector('.text-xs');
                                icon?.classList.remove('text-slate-400');
                                icon?.classList.add('text-white');
                                text?.classList.remove('text-slate-400');
                                text?.classList.add('text-white');
                            }
                        }
                    }
                    
                    // Add event listeners to checkboxes
                    document.getElementById('thinkingMode')?.addEventListener('change', function() {
                        thinkingEnabled = this.checked;
                        const btn = document.getElementById('thinkingToggle');
                        if (!btn) return;
                        const icon = btn.querySelector('.material-symbols-outlined');
                        const text = btn.querySelector('.text-xs');
                        
                        if (this.checked) {
                            btn.classList.add('bg-primary', 'border-primary');
                            btn.classList.remove('bg-surface-dark');
                            icon?.classList.remove('text-slate-400');
                            icon?.classList.add('text-white');
                            text?.classList.remove('text-slate-400');
                            text?.classList.add('text-white');
                        } else {
                            btn.classList.remove('bg-primary', 'border-primary');
                            btn.classList.add('bg-surface-dark');
                            icon?.classList.add('text-slate-400');
                            icon?.classList.remove('text-white');
                            text?.classList.add('text-slate-400');
                            text?.classList.remove('text-white');
                        }
                    });
                    
                    document.getElementById('searchMode')?.addEventListener('change', function() {
                        searchEnabled = this.checked;
                        const btn = document.getElementById('searchToggle');
                        if (!btn) return;
                        const icon = btn.querySelector('.material-symbols-outlined');
                        const text = btn.querySelector('.text-xs');
                        
                        if (this.checked) {
                            btn.classList.add('bg-primary', 'border-primary');
                            btn.classList.remove('bg-surface-dark');
                            icon?.classList.remove('text-slate-400');
                            icon?.classList.add('text-white');
                            text?.classList.remove('text-slate-400');
                            text?.classList.add('text-white');
                        } else {
                            btn.classList.remove('bg-primary', 'border-primary');
                            btn.classList.add('bg-surface-dark');
                            icon?.classList.add('text-slate-400');
                            icon?.classList.remove('text-white');
                            text?.classList.add('text-slate-400');
                            text?.classList.remove('text-white');
                        }
                    });
                });

                // Settings sliders
                document.addEventListener('DOMContentLoaded', () => {
                    document.getElementById('temperatureSlider').addEventListener('input', function() {
                        document.getElementById('temperatureValue').textContent = this.value;
                    });
                    document.getElementById('maxTokensSlider').addEventListener('input', function() {
                        document.getElementById('maxTokensValue').textContent = this.value;
                    });
                });

                // Mobile swipe gestures - FIXED
                document.addEventListener('DOMContentLoaded', () => {
                    if (window.innerWidth <= 1023) {
                        let touchStartX = 0;
                        let touchStartY = 0;
                        let touchEndX = 0;
                        let touchEndY = 0;
                        let isSwiping = false;

                        const chatList = document.querySelector('.mobile-sidebar');
                        const mainChat = document.querySelector('.flex-1.relative.flex.flex-col');

                        console.log('[Mobile Swipe] Elements found:', {
                            chatList: !!chatList,
                            mainChat: !!mainChat
                        });

                        function handleSwipe() {
                            if (!isSwiping) return;
                            
                            const diffX = touchEndX - touchStartX;
                            const diffY = touchEndY - touchStartY;

                            console.log('[Mobile Swipe] Swipe detected:', { diffX, diffY });

                            // Only trigger if horizontal swipe is dominant
                            if (Math.abs(diffX) > Math.abs(diffY) && Math.abs(diffX) > 80) {
                                if (diffX > 0) {
                                    // Swipe right - open chat list (from left)
                                    console.log('[Mobile Swipe] Opening chat list');
                                    openSidebar();
                                }
                            }
                            
                            isSwiping = false;
                        }

                        // Touch events on main chat area
                        mainChat?.addEventListener('touchstart', (e) => {
                            // Don't interfere with button clicks
                            if (e.target.closest('button') || e.target.closest('a') || e.target.closest('input') || e.target.closest('textarea')) {
                                return;
                            }
                            
                            isSwiping = true;
                            touchStartX = e.changedTouches[0].screenX;
                            touchStartY = e.changedTouches[0].screenY;
                        });
                        
                        mainChat?.addEventListener('touchmove', (e) => {
                            if (!isSwiping) return;
                            touchEndX = e.changedTouches[0].screenX;
                            touchEndY = e.changedTouches[0].screenY;
                        });

                        mainChat?.addEventListener('touchend', (e) => {
                            if (!isSwiping) return;
                            touchEndX = e.changedTouches[0].screenX;
                            touchEndY = e.changedTouches[0].screenY;
                            handleSwipe();
                        });

                        // Swipe on sidebars to close them
                        if (chatList) {
                            chatList.addEventListener('touchstart', (e) => {
                                // Don't interfere with button clicks
                                if (e.target.closest('button') || e.target.closest('a')) {
                                    return;
                                }
                                
                                isSwiping = true;
                                touchStartX = e.changedTouches[0].screenX;
                                touchStartY = e.changedTouches[0].screenY;
                            });
                            
                            chatList.addEventListener('touchmove', (e) => {
                                if (!isSwiping) return;
                                touchEndX = e.changedTouches[0].screenX;
                                touchEndY = e.changedTouches[0].screenY;
                            });

                            chatList.addEventListener('touchend', (e) => {
                                if (!isSwiping) return;
                                
                                touchEndX = e.changedTouches[0].screenX;
                                touchEndY = e.changedTouches[0].screenY;

                                const diffX = touchEndX - touchStartX;
                                const diffY = touchEndY - touchStartY;

                                // Swipe to close
                                if (Math.abs(diffX) > Math.abs(diffY) && Math.abs(diffX) > 80 && diffX < 0) {
                                    closeSidebar(); // Swipe left to close chat list
                                }
                                
                                isSwiping = false;
                            });
                        }

                        // Click on overlay to close
                        const overlay = document.querySelector('.sidebar-overlay');
                        overlay?.addEventListener('click', closeSidebar);
                    }
                });

                // Load saved chats in sidebar
                async function loadSidebarChats() {
                    try {
                        const savedChats = JSON.parse(localStorage.getItem('aiSavedChats') || '[]');
                        const container = document.getElementById('sidebarChatsList');
                        if (window.i18n && !window.i18n.translations?.[window.i18n.currentLang]) {
                            await window.i18n.init();
                        }
                        const t = window.i18n?.t ? window.i18n.t.bind(window.i18n) : (key) => key;

                        if (!container) return;

                        if (savedChats.length === 0) {
                            container.innerHTML = `
                        <div class="text-center py-8 text-slate-400">
                            <span class="material-symbols-outlined text-4xl mb-2 opacity-50">bookmark_border</span>
                            <p class="text-sm">${t('ai.noSavedChats')}</p>
                            <p class="text-xs mt-1 text-slate-500">${t('ai.saveConversations')}</p>
                        </div>
                    `;
                        } else {
                            container.innerHTML = savedChats.slice(0, 20).map(chat => {
                                const date = new Date(chat.timestamp);
                                const dateStr = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                                const timeStr = date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });

                                return `
                            <div class="flex items-center gap-3 p-3 rounded-xl bg-background-dark hover:bg-surface-hover border border-transparent hover:border-primary/30 transition-all cursor-pointer group" onclick="loadChat(${chat.id})">
                                <div class="flex-1 min-w-0">
                                    <div class="font-medium text-sm text-white truncate group-hover:text-primary transition-colors">${chat.name}</div>
                                    <div class="text-xs text-slate-400 mt-0.5">${chat.messageCount} msgs â€¢ ${dateStr} ${timeStr}</div>
                                </div>
                                <button onclick="event.stopPropagation(); deleteChat(${chat.id})" class="p-1.5 text-slate-400 hover:text-red-400 transition-colors opacity-0 group-hover:opacity-100">
                                    <span class="material-symbols-outlined text-[18px]">delete</span>
                                </button>
                            </div>
                        `;
                            }).join('');
                        }
                    } catch (e) {
                        console.error('Failed to load sidebar chats:', e);
                    }
                }

                function loadChat(chatId) {
                    try {
                        const savedChats = JSON.parse(localStorage.getItem('aiSavedChats') || '[]');
                        const chat = savedChats.find(c => c.id === chatId);

                        if (chat) {
                            conversationHistory = chat.history;
                            messagesContainer.innerHTML = '<div class="flex justify-center my-4"><span class="text-[10px] font-semibold tracking-wider text-slate-500 uppercase bg-surface-dark px-3 py-1 rounded-full border border-white/5">Today</span></div>';

                            conversationHistory.forEach(msg => {
                                if (msg._hidden) return;
                                if (msg.role === 'user') {
                                    addMessage(msg.parts[0].text, true);
                                } else if (msg.role === 'model') {
                                    addMessage(msg.parts[0].text, false);
                                }
                            });

                            saveConversation();
                            closeSidebar();
                        }
                    } catch (e) {
                        console.error('Failed to load chat:', e);
                    }
                }

                function deleteChat(chatId) {
                    if (confirm('Delete this chat?')) {
                        try {
                            const savedChats = JSON.parse(localStorage.getItem('aiSavedChats') || '[]');
                            const filtered = savedChats.filter(c => c.id !== chatId);
                            localStorage.setItem('aiSavedChats', JSON.stringify(filtered));
                            loadSidebarChats();
                        } catch (e) {
                            console.error('Failed to delete chat:', e);
                        }
                    }
                }
            </script>
            <!-- Mobile Bottom Navigation Removed per user request -->
        </div>
</body>

</html>