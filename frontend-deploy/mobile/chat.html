<!DOCTYPE html>
<html class="dark" lang="en"><head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Chats Screen (Dark Mode)</title>
<script src="/js/theme-init.js"></script>
<link href="/css/theme.css" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Spline+Sans:wght@300;400;500;600;700&amp;display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap" rel="stylesheet"/>
<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
<script src="/js/api.js"></script>
<script src="/js/socket.js"></script>
<script src="/js/state.js"></script>
<script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#2b8cee",
                        "background-light": "#f6f7f8",
                        "background-dark": "#0B1116","card-dark": "#151e29",
                    },
                    fontFamily: {
                        "display": ["Spline Sans", "sans-serif"]
                    },
                    borderRadius: {"DEFAULT": "1rem", "lg": "2rem", "xl": "3rem", "full": "9999px"},
                    animation: {
                        'spin-slow': 'spin 8s linear infinite',
                    }
                },
            },
        }
    </script>
<style>
        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .hide-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .wave-bg {
            background: linear-gradient(180deg, rgba(43, 140, 238, 0.08) 0%, rgba(246, 247, 248, 0) 100%);
        }
        .dark .wave-bg {
            background: linear-gradient(180deg, rgba(43, 140, 238, 0.12) 0%, rgba(11, 17, 22, 0) 100%);
        }
    </style>
<style>
    body {
      min-height: max(884px, 100dvh);
    }
  </style>
<style>
    body {
      min-height: max(884px, 100dvh);
    }
  </style>
  </head>
<body class="bg-background-light dark:bg-background-dark text-[#111418] dark:text-gray-100 font-display overflow-x-hidden min-h-screen relative flex flex-col">
<div class="absolute top-0 left-0 right-0 h-80 wave-bg pointer-events-none z-0"></div>
<header class="sticky top-0 z-50 bg-background-light/90 dark:bg-background-dark/90 backdrop-blur-xl px-4 pt-6 pb-2 flex items-center justify-between border-b border-transparent dark:border-white/5 transition-colors">
<h2 class="text-3xl font-bold leading-tight tracking-tight text-[#111418] dark:text-white">Chats</h2>
<div class="flex gap-2">
<button onclick="toggleSearch()" class="flex items-center justify-center w-10 h-10 rounded-full bg-primary/10 text-primary hover:bg-primary/20 transition-colors">
<span class="material-symbols-outlined" style="font-size: 24px;">search</span>
</button>
<button onclick="createNewChat()" class="flex items-center justify-center w-10 h-10 rounded-full bg-primary/10 text-primary hover:bg-primary/20 transition-colors">
<span class="material-symbols-outlined" style="font-size: 24px;">add_comment</span>
</button>
<button onclick="toggleMenu()" class="flex items-center justify-center w-10 h-10 rounded-full bg-transparent dark:text-gray-300 text-gray-600 hover:bg-gray-100 dark:hover:bg-white/5 transition-colors">
<span class="material-symbols-outlined" style="font-size: 24px;">more_vert</span>
</button>
</div>
</header>
<div class="px-4 py-2 relative z-10" id="menuContainer" style="display: none;">
<div class="bg-white dark:bg-[#1a232e] rounded-2xl shadow-lg overflow-hidden">
<button onclick="window.location.href='/mobile/settings.html'" class="w-full flex items-center gap-3 px-4 py-3 hover:bg-white/5 transition-colors border-b border-gray-100 dark:border-white/5">
<span class="material-symbols-outlined text-primary">settings</span>
<span class="text-sm font-medium">Settings</span>
</button>
<button onclick="window.location.href='/mobile/bio.html'" class="w-full flex items-center gap-3 px-4 py-3 hover:bg-white/5 transition-colors border-b border-gray-100 dark:border-white/5">
<span class="material-symbols-outlined text-primary">person</span>
<span class="text-sm font-medium">Profile</span>
</button>
<button onclick="logout()" class="w-full flex items-center gap-3 px-4 py-3 hover:bg-red-500/5 transition-colors">
<span class="material-symbols-outlined text-red-500">logout</span>
<span class="text-sm font-medium text-red-500">Logout</span>
</button>
</div>
</div>
<div class="px-4 py-2 relative z-10" id="searchContainer" style="display: none;">
<label class="flex w-full items-center h-12 rounded-2xl bg-white dark:bg-[#1a232e] shadow-sm shadow-blue-900/5 dark:shadow-black/20 ring-1 ring-gray-100 dark:ring-white/5 focus-within:ring-2 focus-within:ring-primary transition-all group">
<div class="flex items-center justify-center pl-4 text-gray-400 dark:text-gray-500 group-focus-within:text-primary transition-colors">
<span class="material-symbols-outlined" style="font-size: 24px;">search</span>
</div>
<input id="searchInput" class="flex-1 w-full bg-transparent border-none text-base font-normal text-[#111418] dark:text-white placeholder:text-gray-400 dark:placeholder:text-gray-500 focus:ring-0 px-3" placeholder="Search users to start DM..."/>
<button onclick="toggleSearch()" class="flex items-center justify-center pr-4 text-gray-400 hover:text-primary transition-colors">
<span class="material-symbols-outlined" style="font-size: 20px;">close</span>
</button>
</label>
<div id="searchResults" class="mt-2 bg-white dark:bg-[#1a232e] rounded-2xl shadow-lg max-h-64 overflow-y-auto hidden"></div>
</div>
<div class="relative w-full z-10 mt-3">
<div class="flex gap-3 px-4 overflow-x-auto hide-scrollbar pb-2">
<button class="flex-shrink-0 px-5 h-9 flex items-center justify-center rounded-full bg-primary text-white text-sm font-medium shadow-md shadow-primary/20 transition-transform active:scale-95">
            All
        </button>
<button class="flex-shrink-0 px-5 h-9 flex items-center justify-center rounded-full bg-white dark:bg-[#1a232e] text-gray-600 dark:text-gray-300 border border-gray-100 dark:border-white/5 text-sm font-medium hover:bg-gray-50 dark:hover:bg-[#202b38] transition-colors">
            Guest Rooms
        </button>
<button class="flex-shrink-0 px-5 h-9 flex items-center justify-center rounded-full bg-white dark:bg-[#1a232e] text-gray-600 dark:text-gray-300 border border-gray-100 dark:border-white/5 text-sm font-medium hover:bg-gray-50 dark:hover:bg-[#202b38] transition-colors">
<span class="material-symbols-outlined mr-1" style="font-size: 16px;">smart_toy</span>
            AI
        </button>
</div>
</div>
<!-- Pinned & Live stories section removed - will be added later with real data -->
<div class="flex flex-col flex-1 pb-24 z-10 mt-2">
<!-- Real chats will be loaded here by JavaScript -->
</div>
<nav class="fixed bottom-0 left-0 right-0 z-50 bg-white dark:bg-[#0B1116]/95 backdrop-blur-lg border-t border-gray-100 dark:border-white/5 pb-safe pt-2 px-6 h-20">
<div class="flex justify-between items-center h-full pb-2">
<button class="flex flex-col items-center gap-1 w-12 text-primary">
<div class="w-10 h-8 flex items-center justify-center bg-primary/10 rounded-full">
<span class="material-symbols-outlined fill-current" style="font-size: 24px;">chat_bubble</span>
</div>
<span class="text-[10px] font-semibold">Chats</span>
</button>
<button class="flex flex-col items-center gap-1 w-12 text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 transition-colors">
<span class="material-symbols-outlined" style="font-size: 24px;">music_note</span>
<span class="text-[10px] font-medium">Music</span>
</button>
<button class="flex flex-col items-center justify-center -mt-6">
<div class="w-14 h-14 rounded-full bg-gradient-to-tr from-primary to-blue-400 shadow-[0_8px_16px_rgba(43,140,238,0.3)] flex items-center justify-center text-white transform active:scale-95 transition-transform">
<span class="material-symbols-outlined" style="font-size: 28px;">waves</span>
</div>
</button>
<button class="flex flex-col items-center gap-1 w-12 text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 transition-colors">
<span class="material-symbols-outlined" style="font-size: 24px;">smart_toy</span>
<span class="text-[10px] font-medium">AI</span>
</button>
<button class="flex flex-col items-center gap-1 w-12 text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 transition-colors">
<div class="w-6 h-6 rounded-full overflow-hidden bg-gray-200 ring-2 ring-transparent hover:ring-primary transition-all">
<img alt="User profile" class="w-full h-full object-cover" src="https://lh3.googleusercontent.com/aida-public/AB6AXuA4ct3h1btqZWtHH-XlCFfpfoTd2vSKt14D6UDSGW6mofD96Kp_V9cvJ8CV5enqPc0mO42YDy2X1fpGBdrc1EOCeiUIJRFpvlblZjZs3xnR8YO8z-Y0miGdkS0Dj81rCivTf94C2jwMN-GD1BytNGK5H3IkQCWAx-liN81366wOd1RE1ehWt9v6uFJd1rk0bdPP8LnHSM_Zg29VcceZy-q-M9vLeNTkMAIFPZiF0B7MaUw0Jdef1JMpDo6X7esOui4zSZsFKtFly-w"/>
</div>
<span class="text-[10px] font-medium">Profile</span>
</button>
</div>
</nav>

<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
<script src="/js/api.js"></script>
<script src="/js/socket.js"></script>

<script>
// Mobile Chat - Add Search for Username and DM
const authToken = localStorage.getItem('authToken');
if (!authToken) window.location.href = '/login.html';

socketManager.connect();

let chats = [];
let originalChats = [];

// Register user
const username = localStorage.getItem('username');
if (username) {
    socketManager.socket.on('connect', () => {
        socketManager.registerUsername(username, username);
    });
}

// Load chats from localStorage (same as desktop)
async function loadChats() {
    console.log('[Mobile Chat] Loading chats from localStorage...');
    
    // Load DM conversations from localStorage (same as desktop)
    try {
        const savedSession = localStorage.getItem('wave_session');
        if (savedSession) {
            const session = JSON.parse(savedSession);
            if (session.dmConversations && Array.isArray(session.dmConversations)) {
                console.log('[Mobile Chat] Found', session.dmConversations.length, 'DM conversations');
                chats = session.dmConversations.map(username => ({
                    name: username,
                    username: username,
                    isDM: true,
                    lastMessage: { content: 'Tap to open chat', timestamp: new Date() },
                    unreadCount: 0
                }));
                originalChats = [...chats];
                renderChats();
                return;
            }
        }
    } catch (error) {
        console.error('[Mobile Chat] Error loading from localStorage:', error);
    }
    
    // No chats found - show search prompt
    const container = document.querySelector('.flex.flex-col.flex-1.pb-24');
    if (container) {
        container.innerHTML = `
            <div class="text-center py-12 px-4">
                <span class="material-symbols-outlined text-primary text-6xl">search</span>
                <p class="text-slate-200 mt-4 text-lg font-bold">Find Friends</p>
                <p class="text-slate-400 text-sm mt-2">Search for users to start a conversation</p>
                <button onclick="toggleSearch()" class="mt-6 px-6 py-3 bg-primary text-white rounded-xl font-semibold hover:bg-primary-hover transition-colors">
                    <span class="material-symbols-outlined inline-block mr-2" style="vertical-align: middle;">search</span>
                    Search Users
                </button>
            </div>
        `;
    }
}

function renderChats() {
    const container = document.querySelector('.flex.flex-col.flex-1.pb-24');
    if (!container) return;
    
    const existingChats = container.querySelectorAll('[data-chat-item]');
    existingChats.forEach(el => el.remove());
    
    if (chats.length === 0) {
        container.innerHTML = `
            <div class="text-center py-12 px-4">
                <span class="material-symbols-outlined text-slate-500 text-6xl">chat_bubble</span>
                <p class="text-slate-400 mt-4 text-lg">No chats yet</p>
                <p class="text-slate-500 text-sm mt-2">Search for users to start a conversation</p>
                <button onclick="toggleSearch()" class="mt-4 px-4 py-2 bg-primary text-white rounded-lg">Find Friends</button>
            </div>
        `;
        return;
    }
    
    chats.forEach(chat => {
        const chatEl = createChatElement(chat);
        container.appendChild(chatEl);
    });
}

function createChatElement(chat) {
    const div = document.createElement('div');
    div.className = 'relative z-10 flex items-center gap-4 px-4 py-3.5 bg-background-light dark:bg-background-dark hover:bg-white dark:hover:bg-[#151e29] transition-colors cursor-pointer border-b border-transparent dark:border-white/5';
    div.setAttribute('data-chat-item', 'true');
    div.onclick = () => openChat(chat);
    
    const lastMessage = chat.lastMessage || {};
    const unreadCount = chat.unreadCount || 0;
    const timeAgo = formatTimeAgo(lastMessage.timestamp);
    
    div.innerHTML = `
        <div class="relative shrink-0">
            <div class="w-14 h-14 rounded-full overflow-hidden bg-gray-800">
                <div class="w-full h-full bg-primary flex items-center justify-center text-white text-xl font-bold">
                    ${chat.name?.[0]?.toUpperCase() || '?'}
                </div>
            </div>
            ${chat.isOnline ? '<div class="absolute bottom-0 right-0 w-3.5 h-3.5 bg-green-500 rounded-full border-2 border-white dark:border-background-dark"></div>' : ''}
        </div>
        <div class="flex-1 min-w-0">
            <div class="flex items-center justify-between mb-0.5">
                <h4 class="text-base font-bold text-[#111418] dark:text-white truncate">${chat.name || 'Unknown'}</h4>
                <span class="text-xs text-gray-500">${timeAgo}</span>
            </div>
            <p class="text-sm text-gray-500 dark:text-gray-400 font-normal truncate">${lastMessage.content || 'No messages yet'}</p>
        </div>
        ${unreadCount > 0 ? `
        <div class="shrink-0 flex flex-col items-end gap-1">
            <div class="flex items-center justify-center min-w-[20px] h-5 bg-primary px-1.5 rounded-full">
                <span class="text-[10px] font-bold text-white">${unreadCount}</span>
            </div>
        </div>
        ` : ''}
    `;
    
    return div;
}

function formatTimeAgo(date) {
    if (!date) return '';
    const seconds = Math.floor((new Date() - new Date(date)) / 1000);
    if (seconds < 60) return 'Just now';
    if (seconds < 3600) return `${Math.floor(seconds / 60)}m`;
    if (seconds < 86400) return `${Math.floor(seconds / 3600)}h`;
    if (seconds < 604800) return `${Math.floor(seconds / 86400)}d`;
    return new Date(date).toLocaleDateString();
}

function openChat(chat) {
    if (chat.isDM) {
        localStorage.setItem('currentDM', chat.username);
        localStorage.removeItem('currentRoomCode');
    } else {
        localStorage.setItem('currentRoomCode', chat.code);
        localStorage.removeItem('currentDM');
    }
    window.location.href = '/chat.html';
}

// Search functionality - search for users to start DM
let searchTimeout;

function toggleSearch() {
    const container = document.getElementById('searchContainer');
    const searchInput = document.getElementById('searchInput');
    const searchResults = document.getElementById('searchResults');
    const menu = document.getElementById('menuContainer');
    
    if (container.style.display === 'none') {
        container.style.display = 'block';
        menu.style.display = 'none';
        searchInput.focus();
    } else {
        container.style.display = 'none';
        searchInput.value = '';
        searchResults.classList.add('hidden');
        searchResults.innerHTML = '';
        chats = [...originalChats];
        renderChats();
    }
}

if (document.getElementById('searchInput')) {
    document.getElementById('searchInput').oninput = async (e) => {
        const query = e.target.value.trim();
        const searchResults = document.getElementById('searchResults');
        
        if (searchTimeout) clearTimeout(searchTimeout);
        
        if (!query) {
            searchResults.classList.add('hidden');
            searchResults.innerHTML = '';
            chats = [...originalChats];
            renderChats();
            return;
        }
        
        // Search in existing chats first
        const localResults = originalChats.filter(chat => 
            chat.name?.toLowerCase().includes(query.toLowerCase())
        );
        
        chats = localResults;
        renderChats();
        
        // Search for users in backend
        searchTimeout = setTimeout(async () => {
            try {
                const response = await fetch(`/api/users/search?q=${encodeURIComponent(query)}`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    const users = result.data || result;
                    
                    if (users.length > 0) {
                        searchResults.innerHTML = users.map(user => `
                            <div class="flex items-center gap-3 p-3 hover:bg-white/5 dark:hover:bg-white/5 cursor-pointer transition-colors border-b border-gray-100 dark:border-white/5 last:border-0" onclick="startDM('${user.username || user.nickname}')">
                                <div class="w-10 h-10 rounded-full bg-primary flex items-center justify-center text-white font-bold">
                                    ${(user.username || user.nickname)?.[0]?.toUpperCase() || '?'}
                                </div>
                                <div class="flex-1">
                                    <div class="text-sm font-bold text-[#111418] dark:text-white">${user.username || user.nickname}</div>
                                    <div class="text-xs text-gray-500 dark:text-gray-400">Click to start DM</div>
                                </div>
                                <span class="material-symbols-outlined text-primary">chat</span>
                            </div>
                        `).join('');
                        searchResults.classList.remove('hidden');
                    } else {
                        searchResults.innerHTML = '<div class="p-4 text-center text-gray-500 dark:text-gray-400 text-sm">No users found</div>';
                        searchResults.classList.remove('hidden');
                    }
                }
            } catch (error) {
                console.error('Search error:', error);
            }
        }, 300);
    };
}

function startDM(username) {
    localStorage.setItem('currentDM', username);
    localStorage.removeItem('currentRoomCode');
    window.location.href = '/chat.html';
}

// Menu toggle
function toggleMenu() {
    const menu = document.getElementById('menuContainer');
    const search = document.getElementById('searchContainer');
    
    if (menu.style.display === 'none') {
        menu.style.display = 'block';
        search.style.display = 'none';
    } else {
        menu.style.display = 'none';
    }
}

// Create new chat - opens search
function createNewChat() {
    const search = document.getElementById('searchContainer');
    const menu = document.getElementById('menuContainer');
    const searchInput = document.getElementById('searchInput');
    
    menu.style.display = 'none';
    search.style.display = 'block';
    searchInput.focus();
}

// Logout function
function logout() {
    localStorage.clear();
    window.location.href = '/login.html';
}

// Real-time updates
socketManager.on('message:new', () => loadChats());
socketManager.on('dm:received', () => loadChats());

// Bottom nav
document.querySelectorAll('nav button').forEach((btn, index) => {
    const pages = ['/mobile/chat.html', '/mobile/playlist.html', '/mobile/feed.html', '/mobile/aichat.html', '/mobile/bio.html'];
    if (pages[index]) {
        btn.onclick = () => window.location.href = pages[index];
    }
});

// Initialize
loadChats();
</script>

</body></html>