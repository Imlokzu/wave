<!DOCTYPE html>
<html class="dark" lang="en">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>WaveChat AI Helper</title>
    <!-- Theme Init -->
    <script src="/js/theme-init.js"></script>
    <link href="/css/theme.css" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
    <script src="/js/auth-guard.js"></script>
    <script src="/js/mobile-detector.js"></script>
    <script src="/js/update-checker.js"></script>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#0db9f2",
                        "primary-hover": "#0a91be",
                        "primary-light": "#34caff",
                        "background-dark": "#101e22",
                        "surface-dark": "#16262c",
                        "surface-dark-lighter": "#1d2f36",
                        "accent-cyan": "#06b6d4",
                    },
                    fontFamily: {
                        "display": ["Inter", "sans-serif"],
                        "body": ["Inter", "sans-serif"],
                    },
                    borderRadius: {"DEFAULT": "1rem", "lg": "1.5rem", "xl": "2rem", "full": "9999px"},
                },
            },
        }
    </script>
    <style>
        body { min-height: 100vh; scrollbar-width: thin; scrollbar-color: #1d2f36 #101e22; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #101e22; }
        ::-webkit-scrollbar-thumb { background-color: #1d2f36; border-radius: 20px; }
        .mask-gradient-right {
            mask-image: linear-gradient(to right, black 85%, transparent 100%);
            -webkit-mask-image: linear-gradient(to right, black 85%, transparent 100%);
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fadeIn 0.3s ease-out;
        }
    </style>
</head>
<body class="bg-background-dark font-display text-white antialiased overflow-hidden selection:bg-primary selection:text-white pb-20 lg:pb-0">
    <div class="relative flex h-screen w-full flex-col max-w-7xl mx-auto">
        <div class="flex items-center px-6 py-3 justify-between bg-background-dark/80 backdrop-blur-xl sticky top-0 z-30 border-b border-white/5">
            <div class="flex items-center gap-3">
                <a href="/chat.html" class="flex items-center justify-center size-10 rounded-full hover:bg-white/10 transition-colors active:scale-95">
                    <span class="material-symbols-outlined text-slate-400">arrow_back</span>
                </a>
                <div class="relative group cursor-pointer">
                    <div class="bg-center bg-no-repeat aspect-square bg-cover rounded-full size-10 border-2 border-primary/50 group-hover:border-primary transition-colors" style='background-image: url("/wavechat.png");'></div>
                    <div class="absolute bottom-0 right-0 size-3 bg-emerald-500 border-2 border-background-dark rounded-full shadow-[0_0_8px_rgba(16,185,129,0.5)]"></div>
                </div>
                <div class="flex flex-col">
                    <h2 class="text-base font-bold leading-tight tracking-wide">WaveBot AI</h2>
                    <div class="flex items-center gap-1">
                        <span class="size-1.5 rounded-full bg-primary animate-pulse"></span>
                        <p class="text-xs text-primary font-medium">Online</p>
                    </div>
                </div>
            </div>
            <div class="flex items-center gap-2">
                <button onclick="showSavedChats()" class="flex items-center justify-center size-10 rounded-full hover:bg-white/10 transition-colors active:scale-95" title="Saved Chats">
                    <span class="material-symbols-outlined text-slate-400">history</span>
                </button>
                <button onclick="saveCurrentChat()" class="flex items-center justify-center size-10 rounded-full hover:bg-white/10 transition-colors active:scale-95" title="Save Chat">
                    <span class="material-symbols-outlined text-slate-400">bookmark</span>
                </button>
                <button onclick="clearChat()" class="flex items-center justify-center size-10 rounded-full hover:bg-white/10 transition-colors active:scale-95" title="New Chat">
                    <span class="material-symbols-outlined text-slate-400">add</span>
                </button>
                <a href="/settings.html" class="flex items-center justify-center size-10 rounded-full hover:bg-white/10 transition-colors">
                    <span class="material-symbols-outlined text-slate-400">settings</span>
                </a>
            </div>
        </div>
        
        <div class="flex-1 overflow-y-auto p-6 space-y-6 scroll-smooth" id="chat-container">
            <div class="flex justify-center my-4">
                <span class="text-[10px] font-semibold tracking-wider text-slate-500 uppercase bg-surface-dark px-3 py-1 rounded-full border border-white/5">Today</span>
            </div>
        </div>
        
        <div class="bg-background-dark/95 backdrop-blur-xl border-t border-white/5 pb-6 pt-2 z-40">
            <div class="flex gap-2 overflow-x-auto px-6 py-2 mb-1 no-scrollbar mask-gradient-right">
                <button id="thinkingToggle" class="flex shrink-0 items-center justify-center gap-1.5 h-8 rounded-full bg-surface-dark border border-white/10 px-4 hover:bg-primary hover:border-primary hover:shadow-[0_0_15px_rgba(14,165,233,0.3)] transition-all group active:scale-95" onclick="toggleThinking()">
                    <span class="material-symbols-outlined text-[16px] text-slate-400 group-hover:text-white transition-colors">psychology</span>
                    <span class="text-xs font-medium text-slate-400 group-hover:text-white transition-colors">Thinking</span>
                </button>
                <button id="searchToggle" class="flex shrink-0 items-center justify-center gap-1.5 h-8 rounded-full bg-surface-dark border border-white/10 px-4 hover:bg-primary hover:border-primary hover:shadow-[0_0_15px_rgba(14,165,233,0.3)] transition-all group active:scale-95" onclick="toggleSearch()">
                    <span class="material-symbols-outlined text-[16px] text-slate-400 group-hover:text-white transition-colors">search</span>
                    <span class="text-xs font-medium text-slate-400 group-hover:text-white transition-colors">Search</span>
                </button>
                <button class="flex shrink-0 items-center justify-center gap-1.5 h-8 rounded-full bg-surface-dark border border-white/10 px-4 hover:bg-primary hover:border-primary hover:shadow-[0_0_15px_rgba(14,165,233,0.3)] transition-all group active:scale-95" onclick="showAICommand('translate')">
                    <span class="material-symbols-outlined text-[16px] text-primary group-hover:text-white transition-colors">translate</span>
                    <span class="text-xs font-medium text-slate-200 group-hover:text-white transition-colors">Translate</span>
                </button>
                <button class="flex shrink-0 items-center justify-center gap-1.5 h-8 rounded-full bg-surface-dark border border-white/10 px-4 hover:bg-primary hover:border-primary hover:shadow-[0_0_15px_rgba(14,165,233,0.3)] transition-all group active:scale-95" onclick="showAICommand('summarize')">
                    <span class="material-symbols-outlined text-[16px] text-primary group-hover:text-white transition-colors">summarize</span>
                    <span class="text-xs font-medium text-slate-200 group-hover:text-white transition-colors">Summarize</span>
                </button>
                <button class="flex shrink-0 items-center justify-center gap-1.5 h-8 rounded-full bg-surface-dark border border-white/10 px-4 hover:bg-primary hover:border-primary hover:shadow-[0_0_15px_rgba(14,165,233,0.3)] transition-all group active:scale-95" onclick="showAICommand('code')">
                    <span class="material-symbols-outlined text-[16px] text-primary group-hover:text-white transition-colors">code</span>
                    <span class="text-xs font-medium text-slate-200 group-hover:text-white transition-colors">Write Code</span>
                </button>
                <button class="flex shrink-0 items-center justify-center gap-1.5 h-8 rounded-full bg-surface-dark border border-white/10 px-4 hover:bg-primary hover:border-primary hover:shadow-[0_0_15px_rgba(14,165,233,0.3)] transition-all group active:scale-95" onclick="showAICommand('explain')">
                    <span class="material-symbols-outlined text-[16px] text-primary group-hover:text-white transition-colors">school</span>
                    <span class="text-xs font-medium text-slate-200 group-hover:text-white transition-colors">Explain</span>
                </button>
            </div>
            <div class="px-6 flex items-end gap-2 mt-2">
                <div class="relative">
                    <button id="attachButton" onclick="toggleAttachMenu()" class="size-11 shrink-0 flex items-center justify-center rounded-full bg-surface-dark border border-white/5 text-slate-400 hover:text-primary hover:border-primary/50 transition-all active:scale-95">
                        <span class="material-symbols-outlined text-[24px]">add</span>
                    </button>
                    <!-- Attach Menu -->
                    <div id="attachMenu" class="hidden absolute bottom-full left-0 mb-2 bg-surface-dark rounded-2xl border border-white/10 shadow-2xl p-2 min-w-[200px]">
                        <button onclick="openCodeEditor()" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-primary/10 hover:border-primary/30 border border-transparent transition-all text-left group">
                            <span class="material-symbols-outlined text-primary text-[20px]">code</span>
                            <div>
                                <div class="text-sm font-medium text-white group-hover:text-primary transition-colors">Attach Code</div>
                                <div class="text-xs text-slate-400">Open code editor</div>
                            </div>
                        </button>
                        <button onclick="openFileUpload()" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-primary/10 hover:border-primary/30 border border-transparent transition-all text-left group">
                            <span class="material-symbols-outlined text-primary text-[20px]">description</span>
                            <div>
                                <div class="text-sm font-medium text-white group-hover:text-primary transition-colors">Attach File</div>
                                <div class="text-xs text-slate-400">Upload text file</div>
                            </div>
                        </button>
                    </div>
                </div>
                <div class="flex-1 bg-surface-dark rounded-3xl min-h-[2.75rem] px-4 py-2.5 flex items-center gap-2 border border-white/5 focus-within:border-primary/50 focus-within:bg-surface-dark-lighter transition-all shadow-sm">
                    <input id="messageInput" class="bg-transparent border-none outline-none text-sm w-full text-white placeholder-slate-500 focus:ring-0 p-0" placeholder="Message or type / for commands..." type="text" onkeypress="handleKeyPress(event)"/>
                </div>
                <button onclick="sendMessage()" class="size-11 shrink-0 flex items-center justify-center rounded-full bg-primary text-white shadow-[0_4px_12px_rgba(14,165,233,0.3)] hover:scale-105 hover:bg-primary-hover transition-all active:scale-95">
                    <span class="material-symbols-outlined text-[24px]">send</span>
                </button>
            </div>
        </div>
    </div>

    <!-- AI Command Modal -->
    <div id="aiCommandModal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm">
        <div class="bg-surface-dark rounded-3xl p-6 w-full max-w-2xl mx-4 border border-white/10 shadow-2xl">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-bold text-white flex items-center gap-2" id="modalTitle">
                    <span class="material-symbols-outlined text-primary">translate</span>
                    AI Command
                </h3>
                <button onclick="closeAIModal()" class="text-slate-400 hover:text-white transition-colors">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>
            
            <!-- Language Selection (for translate) -->
            <div id="languageSelection" class="hidden mb-4">
                <p class="text-sm text-slate-400 mb-3">Select target language:</p>
                <div class="grid grid-cols-3 gap-2 max-h-[300px] overflow-y-auto">
                    <button onclick="selectLanguage('Spanish', 'üá™üá∏')" class="flex items-center gap-2 p-3 rounded-xl bg-background-dark hover:bg-primary/20 hover:border-primary border border-white/10 transition-all group">
                        <span class="text-2xl">üá™üá∏</span>
                        <span class="text-sm font-medium text-slate-300 group-hover:text-white">Spanish</span>
                    </button>
                    <button onclick="selectLanguage('French', 'üá´üá∑')" class="flex items-center gap-2 p-3 rounded-xl bg-background-dark hover:bg-primary/20 hover:border-primary border border-white/10 transition-all group">
                        <span class="text-2xl">üá´üá∑</span>
                        <span class="text-sm font-medium text-slate-300 group-hover:text-white">French</span>
                    </button>
                    <button onclick="selectLanguage('German', 'üá©üá™')" class="flex items-center gap-2 p-3 rounded-xl bg-background-dark hover:bg-primary/20 hover:border-primary border border-white/10 transition-all group">
                        <span class="text-2xl">üá©üá™</span>
                        <span class="text-sm font-medium text-slate-300 group-hover:text-white">German</span>
                    </button>
                    <button onclick="selectLanguage('Italian', 'üáÆüáπ')" class="flex items-center gap-2 p-3 rounded-xl bg-background-dark hover:bg-primary/20 hover:border-primary border border-white/10 transition-all group">
                        <span class="text-2xl">üáÆüáπ</span>
                        <span class="text-sm font-medium text-slate-300 group-hover:text-white">Italian</span>
                    </button>
                    <button onclick="selectLanguage('Portuguese', 'üáµüáπ')" class="flex items-center gap-2 p-3 rounded-xl bg-background-dark hover:bg-primary/20 hover:border-primary border border-white/10 transition-all group">
                        <span class="text-2xl">üáµüáπ</span>
                        <span class="text-sm font-medium text-slate-300 group-hover:text-white">Portuguese</span>
                    </button>
                    <button onclick="selectLanguage('Russian', 'üá∑üá∫')" class="flex items-center gap-2 p-3 rounded-xl bg-background-dark hover:bg-primary/20 hover:border-primary border border-white/10 transition-all group">
                        <span class="text-2xl">üá∑üá∫</span>
                        <span class="text-sm font-medium text-slate-300 group-hover:text-white">Russian</span>
                    </button>
                    <button onclick="selectLanguage('Chinese', 'üá®üá≥')" class="flex items-center gap-2 p-3 rounded-xl bg-background-dark hover:bg-primary/20 hover:border-primary border border-white/10 transition-all group">
                        <span class="text-2xl">üá®üá≥</span>
                        <span class="text-sm font-medium text-slate-300 group-hover:text-white">Chinese</span>
                    </button>
                    <button onclick="selectLanguage('Japanese', 'üáØüáµ')" class="flex items-center gap-2 p-3 rounded-xl bg-background-dark hover:bg-primary/20 hover:border-primary border border-white/10 transition-all group">
                        <span class="text-2xl">üáØüáµ</span>
                        <span class="text-sm font-medium text-slate-300 group-hover:text-white">Japanese</span>
                    </button>
                    <button onclick="selectLanguage('Korean', 'üá∞üá∑')" class="flex items-center gap-2 p-3 rounded-xl bg-background-dark hover:bg-primary/20 hover:border-primary border border-white/10 transition-all group">
                        <span class="text-2xl">üá∞üá∑</span>
                        <span class="text-sm font-medium text-slate-300 group-hover:text-white">Korean</span>
                    </button>
                    <button onclick="selectLanguage('Arabic', 'üá∏üá¶')" class="flex items-center gap-2 p-3 rounded-xl bg-background-dark hover:bg-primary/20 hover:border-primary border border-white/10 transition-all group">
                        <span class="text-2xl">üá∏üá¶</span>
                        <span class="text-sm font-medium text-slate-300 group-hover:text-white">Arabic</span>
                    </button>
                    <button onclick="selectLanguage('Hindi', 'üáÆüá≥')" class="flex items-center gap-2 p-3 rounded-xl bg-background-dark hover:bg-primary/20 hover:border-primary border border-white/10 transition-all group">
                        <span class="text-2xl">üáÆüá≥</span>
                        <span class="text-sm font-medium text-slate-300 group-hover:text-white">Hindi</span>
                    </button>
                    <button onclick="selectLanguage('Turkish', 'üáπüá∑')" class="flex items-center gap-2 p-3 rounded-xl bg-background-dark hover:bg-primary/20 hover:border-primary border border-white/10 transition-all group">
                        <span class="text-2xl">üáπüá∑</span>
                        <span class="text-sm font-medium text-slate-300 group-hover:text-white">Turkish</span>
                    </button>
                    <button onclick="selectLanguage('Polish', 'üáµüá±')" class="flex items-center gap-2 p-3 rounded-xl bg-background-dark hover:bg-primary/20 hover:border-primary border border-white/10 transition-all group">
                        <span class="text-2xl">üáµüá±</span>
                        <span class="text-sm font-medium text-slate-300 group-hover:text-white">Polish</span>
                    </button>
                    <button onclick="selectLanguage('Dutch', 'üá≥üá±')" class="flex items-center gap-2 p-3 rounded-xl bg-background-dark hover:bg-primary/20 hover:border-primary border border-white/10 transition-all group">
                        <span class="text-2xl">üá≥üá±</span>
                        <span class="text-sm font-medium text-slate-300 group-hover:text-white">Dutch</span>
                    </button>
                    <button onclick="selectLanguage('Ukrainian', 'üá∫üá¶')" class="flex items-center gap-2 p-3 rounded-xl bg-background-dark hover:bg-primary/20 hover:border-primary border border-white/10 transition-all group">
                        <span class="text-2xl">üá∫üá¶</span>
                        <span class="text-sm font-medium text-slate-300 group-hover:text-white">Ukrainian</span>
                    </button>
                    <button onclick="selectLanguage('Swedish', 'üá∏üá™')" class="flex items-center gap-2 p-3 rounded-xl bg-background-dark hover:bg-primary/20 hover:border-primary border border-white/10 transition-all group">
                        <span class="text-2xl">üá∏üá™</span>
                        <span class="text-sm font-medium text-slate-300 group-hover:text-white">Swedish</span>
                    </button>
                    <button onclick="selectLanguage('Greek', 'üá¨üá∑')" class="flex items-center gap-2 p-3 rounded-xl bg-background-dark hover:bg-primary/20 hover:border-primary border border-white/10 transition-all group">
                        <span class="text-2xl">üá¨üá∑</span>
                        <span class="text-sm font-medium text-slate-300 group-hover:text-white">Greek</span>
                    </button>
                    <button onclick="selectLanguage('Czech', 'üá®üáø')" class="flex items-center gap-2 p-3 rounded-xl bg-background-dark hover:bg-primary/20 hover:border-primary border border-white/10 transition-all group">
                        <span class="text-2xl">üá®üáø</span>
                        <span class="text-sm font-medium text-slate-300 group-hover:text-white">Czech</span>
                    </button>
                </div>
            </div>
            
            <!-- Text Input -->
            <div id="textInputSection">
                <textarea id="aiCommandInput" class="w-full bg-background-dark text-white rounded-xl p-4 border border-white/10 focus:border-primary/50 focus:outline-none resize-none" rows="4" placeholder="Enter your text here..."></textarea>
            </div>
            
            <div class="flex gap-3 mt-4">
                <button onclick="closeAIModal()" class="flex-1 py-3 rounded-xl bg-surface-lighter text-slate-300 font-medium hover:bg-slate-700 transition-all">
                    Cancel
                </button>
                <button onclick="executeAICommand()" class="flex-1 py-3 rounded-xl bg-gradient-to-r from-primary to-blue-600 text-white font-bold shadow-lg hover:shadow-xl transition-all">
                    Execute
                </button>
            </div>
        </div>
    </div>

    <!-- Saved Chats Modal -->
    <div id="savedChatsModal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm">
        <div class="bg-surface-dark rounded-3xl p-6 w-full max-w-2xl mx-4 border border-white/10 shadow-2xl max-h-[80vh] flex flex-col">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-bold text-white">Saved Chats</h3>
                <button onclick="closeSavedChatsModal()" class="text-slate-400 hover:text-white transition-colors">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>
            <div id="savedChatsList" class="flex-1 overflow-y-auto space-y-2">
                <!-- Saved chats will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Save Chat Modal -->
    <div id="saveChatModal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm">
        <div class="bg-surface-dark rounded-3xl p-6 w-full max-w-md mx-4 border border-white/10 shadow-2xl">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-bold text-white">Save Chat</h3>
                <button onclick="closeSaveChatModal()" class="text-slate-400 hover:text-white transition-colors">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>
            <input id="chatNameInput" type="text" class="w-full bg-background-dark text-white rounded-xl p-4 border border-white/10 focus:border-primary/50 focus:outline-none" placeholder="Enter chat name..."/>
            <div class="flex gap-3 mt-4">
                <button onclick="closeSaveChatModal()" class="flex-1 py-3 rounded-xl bg-surface-lighter text-slate-300 font-medium hover:bg-slate-700 transition-all">
                    Cancel
                </button>
                <button onclick="confirmSaveChat()" class="flex-1 py-3 rounded-xl bg-gradient-to-r from-primary to-blue-600 text-white font-bold shadow-lg hover:shadow-xl transition-all">
                    Save
                </button>
            </div>
        </div>
    </div>

    <!-- Code Editor Modal -->
    <div id="codeEditorModal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm">
        <div class="bg-surface-dark rounded-3xl p-6 w-full max-w-4xl mx-4 border border-white/10 shadow-2xl max-h-[80vh] flex flex-col">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-bold text-white flex items-center gap-2">
                    <span class="material-symbols-outlined text-primary">code</span>
                    Code Editor
                </h3>
                <button onclick="closeCodeEditor()" class="text-slate-400 hover:text-white transition-colors">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>
            <div class="mb-3">
                <label class="text-sm text-slate-400 mb-2 block">Language (optional)</label>
                <input id="codeLanguage" type="text" class="w-full bg-background-dark text-white rounded-xl px-4 py-2 border border-white/10 focus:border-primary/50 focus:outline-none text-sm" placeholder="e.g., javascript, python, html..."/>
            </div>
            <textarea id="codeEditorInput" class="flex-1 w-full bg-background-dark text-white rounded-xl p-4 border border-white/10 focus:border-primary/50 focus:outline-none resize-none font-mono text-sm" placeholder="Paste or type your code here..."></textarea>
            <div class="flex gap-3 mt-4">
                <button onclick="closeCodeEditor()" class="flex-1 py-3 rounded-xl bg-surface-lighter text-slate-300 font-medium hover:bg-slate-700 transition-all">
                    Cancel
                </button>
                <button onclick="attachCode()" class="flex-1 py-3 rounded-xl bg-gradient-to-r from-primary to-blue-600 text-white font-bold shadow-lg hover:shadow-xl transition-all">
                    Attach Code
                </button>
            </div>
        </div>
    </div>

    <!-- File Upload Input (hidden) -->
    <input type="file" id="fileInput" accept=".txt,.md,.json,.js,.ts,.py,.html,.css,.java,.cpp,.c,.go,.rs" class="hidden" onchange="handleFileUpload(event)"/>

    <script src="/js/features-api.js"></script>
    <script>
        const socket = io();
        const messagesContainer = document.getElementById('chat-container');
        const messageInput = document.getElementById('messageInput');
        let currentAICommand = null;
        let conversationHistory = [];
        let thinkingEnabled = false;
        let searchEnabled = false;
        let attachedCode = null; // Store attached code

        // Auto-save conversation to localStorage
        function saveConversation() {
            try {
                localStorage.setItem('aiCurrentConversation', JSON.stringify({
                    history: conversationHistory,
                    timestamp: Date.now(),
                    model: localStorage.getItem('preferredAIModel') || 'wave-flash-2'
                }));
            } catch (e) {
                console.error('Failed to save conversation:', e);
            }
        }

        // Restore conversation from localStorage on page load
        function restoreConversation() {
            try {
                const saved = localStorage.getItem('aiCurrentConversation');
                if (saved) {
                    const data = JSON.parse(saved);
                    // Only restore if less than 24 hours old
                    if (Date.now() - data.timestamp < 24 * 60 * 60 * 1000) {
                        conversationHistory = data.history || [];
                        console.log(`Restored ${conversationHistory.length} messages from previous session`);
                        
                        // Display restored messages (skip hidden system messages)
                        conversationHistory.forEach(msg => {
                            // Skip hidden messages (search results, system prompts)
                            if (msg._hidden) return;
                            
                            if (msg.role === 'user') {
                                addMessage(msg.parts[0].text, true);
                            } else if (msg.role === 'model') {
                                addMessage(msg.parts[0].text, false);
                            }
                        });
                    }
                }
            } catch (e) {
                console.error('Failed to restore conversation:', e);
            }
        }

        // Restore conversation on page load
        restoreConversation();

        // ===== FILE/CODE ATTACHMENT FUNCTIONS =====
        
        // Toggle attach menu
        function toggleAttachMenu() {
            const menu = document.getElementById('attachMenu');
            menu.classList.toggle('hidden');
        }

        // Close attach menu when clicking outside
        document.addEventListener('click', function(event) {
            const menu = document.getElementById('attachMenu');
            const button = document.getElementById('attachButton');
            if (!menu.contains(event.target) && !button.contains(event.target)) {
                menu.classList.add('hidden');
            }
        });

        // Open code editor
        function openCodeEditor() {
            document.getElementById('attachMenu').classList.add('hidden');
            document.getElementById('codeEditorModal').classList.remove('hidden');
            document.getElementById('codeEditorInput').focus();
        }

        // Close code editor
        function closeCodeEditor() {
            document.getElementById('codeEditorModal').classList.add('hidden');
            document.getElementById('codeEditorInput').value = '';
            document.getElementById('codeLanguage').value = '';
        }

        // Attach code
        function attachCode() {
            const code = document.getElementById('codeEditorInput').value.trim();
            const language = document.getElementById('codeLanguage').value.trim() || 'code';
            
            if (!code) {
                alert('Please enter some code first!');
                return;
            }
            
            const lineCount = code.split('\n').length;
            attachedCode = { code, language, lineCount };
            
            // Show attached code indicator in input
            messageInput.placeholder = `üìé ${language} code attached (${lineCount} lines) - Type your question...`;
            messageInput.classList.add('text-primary');
            
            closeCodeEditor();
        }

        // Open file upload
        function openFileUpload() {
            document.getElementById('attachMenu').classList.add('hidden');
            document.getElementById('fileInput').click();
        }

        // Handle file upload
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const content = e.target.result;
                const lineCount = content.split('\n').length;
                const extension = file.name.split('.').pop();
                
                attachedCode = { 
                    code: content, 
                    language: extension, 
                    lineCount,
                    filename: file.name
                };
                
                messageInput.placeholder = `üìé ${file.name} attached (${lineCount} lines) - Type your question...`;
                messageInput.classList.add('text-primary');
            };
            reader.readAsText(file);
            
            // Reset file input
            event.target.value = '';
        }

        // Check authentication
        const authToken = localStorage.getItem('authToken');
        if (!authToken) {
            window.location.href = '/login.html';
        }

        // Register user for socket events
        const userId = localStorage.getItem('userId');
        const username = localStorage.getItem('username');
        const nickname = localStorage.getItem('nickname');

        if (userId && username) {
            socket.emit('user:setup', { userId });
        }

        function toggleThinking() {
            thinkingEnabled = !thinkingEnabled;
            const btn = document.getElementById('thinkingToggle');
            const icon = btn.querySelector('.material-symbols-outlined');
            const text = btn.querySelector('.text-xs');
            
            if (thinkingEnabled) {
                btn.classList.add('bg-primary', 'border-primary');
                btn.classList.remove('bg-surface-dark');
                icon.classList.remove('text-slate-400');
                icon.classList.add('text-white');
                text.classList.remove('text-slate-400');
                text.classList.add('text-white');
            } else {
                btn.classList.remove('bg-primary', 'border-primary');
                btn.classList.add('bg-surface-dark');
                icon.classList.add('text-slate-400');
                icon.classList.remove('text-white');
                text.classList.add('text-slate-400');
                text.classList.remove('text-white');
            }
        }

        function toggleSearch() {
            searchEnabled = !searchEnabled;
            const btn = document.getElementById('searchToggle');
            const icon = btn.querySelector('.material-symbols-outlined');
            const text = btn.querySelector('.text-xs');
            
            if (searchEnabled) {
                btn.classList.add('bg-primary', 'border-primary');
                btn.classList.remove('bg-surface-dark');
                icon.classList.remove('text-slate-400');
                icon.classList.add('text-white');
                text.classList.remove('text-slate-400');
                text.classList.add('text-white');
            } else {
                btn.classList.remove('bg-primary', 'border-primary');
                btn.classList.add('bg-surface-dark');
                icon.classList.add('text-slate-400');
                icon.classList.remove('text-white');
                text.classList.add('text-slate-400');
                text.classList.remove('text-white');
            }
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        let selectedLanguage = null;
        let selectedLanguageFlag = null;

        function showAICommand(command) {
            currentAICommand = command;
            const modal = document.getElementById('aiCommandModal');
            const title = document.getElementById('modalTitle');
            const input = document.getElementById('aiCommandInput');
            const languageSelection = document.getElementById('languageSelection');
            const textInputSection = document.getElementById('textInputSection');
            
            const titles = {
                'translate': 'üåê Translate Text',
                'summarize': 'üìù Summarize Text',
                'code': 'üíª Write Code',
                'explain': 'üéì Explain Topic'
            };
            
            const placeholders = {
                'translate': 'Enter text to translate...',
                'summarize': 'Enter text to summarize...',
                'code': 'Describe what code you need...',
                'explain': 'What would you like me to explain?'
            };
            
            title.innerHTML = titles[command] || 'AI Command';
            input.placeholder = placeholders[command] || 'Enter your text...';
            input.value = '';
            
            // Show language selection only for translate
            if (command === 'translate') {
                languageSelection.classList.remove('hidden');
                selectedLanguage = null;
                selectedLanguageFlag = null;
            } else {
                languageSelection.classList.add('hidden');
            }
            
            modal.classList.remove('hidden');
            input.focus();
        }

        function selectLanguage(language, flag) {
            selectedLanguage = language;
            selectedLanguageFlag = flag;
            
            // Update title to show selected language
            const title = document.getElementById('modalTitle');
            title.innerHTML = `üåê Translate to ${flag} ${language}`;
            
            // Hide language selection, show text input
            document.getElementById('languageSelection').classList.add('hidden');
            document.getElementById('aiCommandInput').focus();
        }

        function closeAIModal() {
            document.getElementById('aiCommandModal').classList.add('hidden');
            currentAICommand = null;
            selectedLanguage = null;
            selectedLanguageFlag = null;
        }

        async function executeAICommand() {
            const input = document.getElementById('aiCommandInput');
            const text = input.value.trim();
            
            if (!text) return;
            
            let prompt;
            if (currentAICommand === 'translate') {
                if (!selectedLanguage) {
                    alert('Please select a target language first!');
                    document.getElementById('languageSelection').classList.remove('hidden');
                    return;
                }
                prompt = `Translate the following text to ${selectedLanguage}. 

Respond with ONLY a JSON object in this format (no explanations, no code blocks, just the JSON):

{"original": "text here", "translation": "translated text", "language": "${selectedLanguage}"}

Text to translate: ${text}`;
            } else {
                const prompts = {
                    'summarize': `Summarize the following text concisely:\n\n${text}`,
                    'code': `Write clean, well-commented code for: ${text}`,
                    'explain': `Explain in detail: ${text}`
                };
                prompt = prompts[currentAICommand] || text;
            }
            
            closeAIModal();
            
            // Add user message with language flag if translating
            if (currentAICommand === 'translate' && selectedLanguageFlag) {
                addMessage(`${selectedLanguageFlag} Translate to ${selectedLanguage}: ${text}`, true);
            } else {
                addMessage(text, true);
            }
            
            // Send to AI
            await sendToQwenAI(prompt);
        }

        async function sendMessage() {
            const content = messageInput.value.trim();
            if (!content && !attachedCode) return;

            let userMessage = content;
            let aiPrompt = content;
            
            // Handle attached code
            if (attachedCode) {
                // User sees: "üìé Attached code.js (50 lines)"
                userMessage = `üìé Attached ${attachedCode.filename || attachedCode.language} code (${attachedCode.lineCount} lines)\n${content}`;
                
                // AI gets: full code + user question
                aiPrompt = `Here's the code:\n\`\`\`${attachedCode.language}\n${attachedCode.code}\n\`\`\`\n\n${content}`;
                
                // Clear attachment
                attachedCode = null;
                messageInput.placeholder = 'Message or type / for commands...';
                messageInput.classList.remove('text-primary');
            }

            // Add user message to UI (shows attachment summary)
            addMessage(userMessage, true);
            messageInput.value = '';

            // Send to AI (with full code)
            await sendToQwenAI(aiPrompt);
        }

        async function sendToQwenAI(content) {
            try {
                // Get preferred model from localStorage (set in Settings)
                const preferredModel = localStorage.getItem('preferredAIModel');
                
                // Model mapping from settings ID to OpenRouter model (matching llms.md)
                const modelMap = {
                    // Pro models
                    'wave-r1': 'deepseek/deepseek-r1-0528:free',
                    'wave-hermes-3': 'nous/hermes-3-405b-instruct:free',
                    'wave-gemini-3': 'google/gemma-3-27b:free',
                    'wave-llama-3.3': 'meta/llama-3.3-70b-instruct:free',
                    'wave-llama-3.1': 'meta/llama-3.1-405b-instruct:free',
                    'wave-qwen-3': 'qwen/qwen-3-4b:free',
                    // Free models
                    'wave-r1t-chimera': 'tngtech/deepseek-r1t-chimera:free',
                    'wave-r1t2-chimera': 'tngtech/deepseek-r1t2-chimera:free',
                    'wave-deepseek-v3.1': 'nex-agi/deepseek-v3.1-nex-n1:free',
                    'wave-flash-2': 'xiaomi/mimo-v2-flash:free',
                    'wave-glm-air': 'z-ai/glm-4.5-air:free',
                    'wave-nemotron-30b': 'nvidia/nemotron-3-nano-30b-a3b:free',
                    'wave-nemotron-12b-vl': 'nvidia/nemotron-nano-12b-2-vl:free',
                    'wave-gemini-flash-2': 'google/gemini-2.0-flash-experimental:free',
                    'wave-llama-3.2': 'meta-llama/llama-3.2-3b-instruct:free',
                    'wave-qwen-2.5-vl': 'qwen/qwen-2.5-vl-7b-instruct:free',
                    'wave-olmo-3.1': 'allenai/olmo-3.1-32b-think:free',
                    'wave-kat-coder-pro': 'kwaipilot/kat-coder-pro-v1:free',
                    'wave-devstral-2': 'mistralai/devstral-2-2512:free',
                    'wave-trinity-mini': 'arcee-ai/trinity-mini:free',
                    // Auto/default (use free model - MiMo Flash)
                    'auto': 'xiaomi/mimo-v2-flash:free'
                };
                
                // Select model (default to free MiMo Flash)
                const selectedModel = modelMap[preferredModel] || 'xiaomi/mimo-v2-flash:free';
                const modelName = preferredModel ? preferredModel.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase()) : 'Wave Flash 2';
                
                console.log('ü§ñ Using AI model:', selectedModel, '(', modelName, ')');
                
                // Build OpenRouter-compatible message history
                let messages = [];
                
                // Add system message with model identity and search instructions
                messages.push({
                    role: 'system',
                    content: `You are a helpful AI assistant with web search and weather capabilities.

üö® CRITICAL RULES:

FOR WEATHER QUESTIONS - Use this format:
[WEATHER: city name]

FOR OTHER QUESTIONS - Use this format:
[SEARCH: your search query]

DO NOT:
‚ùå Say "I don't know" or "I don't have information"
‚ùå Make up or guess answers
‚ùå Give outdated information

DO:
‚úÖ Use [WEATHER: ...] for weather questions (e.g., "weather in Munich")
‚úÖ Use [SEARCH: ...] for products, prices, news, events after 2023
‚úÖ After getting results, answer using that information

EXAMPLES:
User: "Weather in Munich?"
You: [WEATHER: Munich]

User: "What's the temperature in Tokyo?"
You: [WEATHER: Tokyo]

User: "How much is OnePlus Pad 2?"
You: [SEARCH: OnePlus Pad 2 price 2024]

User: "Latest AI news?"
You: [SEARCH: latest AI news 2025]

ONLY answer directly WITHOUT search/weather for:
- Math (2+2=4)
- Code writing
- Translations
- General knowledge you're certain about

üìù FORMATTING:
Use markdown: **bold**, *italic*, \`code\`, ### headings, - lists

‚ö†Ô∏è NEVER add signatures, footers, or "powered by" messages.`
                });
                
                // Convert conversation history to OpenRouter format
                for (let i = 0; i < conversationHistory.length; i++) {
                    const msg = conversationHistory[i];
                    messages.push({
                        role: msg.role === 'model' ? 'assistant' : msg.role,
                        content: msg.parts[0].text
                    });
                }
                
                // Add current user message
                messages.push({ role: 'user', content: content });
                conversationHistory.push({ role: 'user', parts: [{ text: content }] });
                saveConversation(); // Auto-save after user message
                
                // Create streaming message bubble (no fixed ID to avoid conflicts)
                const streamingDiv = document.createElement('div');
                streamingDiv.className = 'flex gap-3 group streaming-ai-message';
                streamingDiv.innerHTML = `
                    <div class="bg-center bg-no-repeat aspect-square bg-cover rounded-full size-8 shrink-0 self-end mb-1 ring-2 ring-transparent group-hover:ring-primary/20 transition-all" style='background-image: url("/wavechat.png");'></div>
                    <div class="flex flex-col gap-1 max-w-[85%]">
                        <p class="text-[10px] font-medium text-slate-400 ml-1 mb-0.5">AI Assistant</p>
                        <div class="bg-surface-dark p-3.5 rounded-2xl rounded-bl-none border border-white/5 shadow-sm">
                            <div class="streaming-content text-sm leading-relaxed text-slate-200"><span class="inline-block w-2 h-4 bg-primary animate-pulse"></span></div>
                        </div>
                    </div>
                `;
                messagesContainer.appendChild(streamingDiv);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
                
                // Call OpenRouter API with selected model
                const requestBody = {
                    model: selectedModel,
                    messages: messages,
                    stream: true
                };
                
                // Note: Free models don't support tools/web search
                // Search and Thinking toggles are just UI elements for now
                
                const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer 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',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    streamingDiv?.remove();
                    if (response.status === 429) {
                        addMessage('‚ö†Ô∏è Rate limit reached. Please wait a moment and try again.', false);
                    } else {
                        addMessage(`Error: ${errorData.error?.message || 'Something went wrong'}`, false);
                    }
                    return;
                }
                
                // Read streaming response
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let fullResponse = '';
                const contentDiv = streamingDiv.querySelector('.streaming-content');
                
                // Create container for plain text and cursor
                contentDiv.innerHTML = '';
                const textContainer = document.createElement('span');
                textContainer.className = 'whitespace-pre-wrap';
                const cursor = document.createElement('span');
                cursor.className = 'inline-block w-2 h-4 bg-primary animate-pulse ml-1';
                contentDiv.appendChild(textContainer);
                contentDiv.appendChild(cursor);
                
                // Throttle DOM updates to prevent freezing on large code responses
                let lastUpdateTime = 0;
                const UPDATE_INTERVAL = 100; // Update every 100ms instead of every chunk
                let isInCodeBlock = false; // Track if we're currently in a code block
                
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    
                    const chunk = decoder.decode(value, { stream: true });
                    const lines = chunk.split('\n');
                    
                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const jsonStr = line.slice(6).trim();
                            if (jsonStr === '[DONE]') continue;
                            
                            try {
                                if (jsonStr) {
                                    const data = JSON.parse(jsonStr);
                                    const delta = data.choices?.[0]?.delta?.content;
                                    if (delta) {
                                        fullResponse += delta;
                                        
                                        // Detect code block start/end
                                        if (delta.includes('```')) {
                                            isInCodeBlock = !isInCodeBlock;
                                        }
                                        
                                        // Throttle updates - only update DOM every 100ms
                                        const now = Date.now();
                                        if (now - lastUpdateTime > UPDATE_INTERVAL) {
                                            // If we're in a code block, show placeholder instead of code
                                            if (isInCodeBlock || fullResponse.includes('```')) {
                                                // Show a placeholder for code blocks
                                                const beforeCode = fullResponse.split('```')[0];
                                                const codeBlockCount = (fullResponse.match(/```/g) || []).length;
                                                const hasOpenBlock = codeBlockCount % 2 === 1;
                                                
                                                textContainer.innerHTML = beforeCode + 
                                                    (hasOpenBlock ? '<div class="inline-flex items-center gap-2 px-3 py-2 bg-slate-800 rounded-lg border border-primary/30 my-2"><span class="material-symbols-outlined text-primary text-[16px] animate-pulse">code</span><span class="text-sm text-slate-300">Writing code...</span></div>' : '');
                                            } else {
                                                // Show normal text
                                                textContainer.textContent = fullResponse;
                                            }
                                            messagesContainer.scrollTop = messagesContainer.scrollHeight;
                                            lastUpdateTime = now;
                                        }
                                    }
                                }
                            } catch (e) {
                                // Skip invalid JSON chunks
                            }
                        }
                    }
                }
                
                // Final update to ensure we show all text
                textContainer.textContent = fullResponse;
                
                // Check if response is JSON (translation or other structured data)
                const isJSON = fullResponse.trim().match(/^(?:json\s*)?\{[\s\S]*\}$/);
                
                if (isJSON) {
                    // For JSON responses, remove streaming div and show final card instantly
                    streamingDiv.remove();
                    addMessage(fullResponse, false);
                } else {
                    // For text responses, finalize the streaming message
                    cursor.remove();
                }
                
                // Check if AI requested search
                const searchMatch = fullResponse.match(/\[SEARCH:\s*(.+?)\]/);
                if (searchMatch) {
                    const searchQuery = searchMatch[1].trim();
                    console.log('üîç AI requested search:', searchQuery);
                    
                    // Remove the streaming message
                    streamingDiv.remove();
                    
                    // Show searching indicator with location
                    const searchingMsg = addMessage('üîç Searching the web...', false);
                    
                    try {
                        // Call backend search API (automatically detects user location)
                        const searchResponse = await fetch('/api/search', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ query: searchQuery, maxResults: 5 })
                        });
                        
                        const searchData = await searchResponse.json();
                        console.log('Search results:', searchData);
                        
                        // Update searching message with location if available
                        if (searchData.location) {
                            const locationText = `${searchData.location.city}, ${searchData.location.country}`;
                            const contentDiv = searchingMsg.querySelector('.text-sm');
                            if (contentDiv) {
                                contentDiv.textContent = `üîç Searching in ${locationText}...`;
                            }
                        }
                        
                        if (searchData.success && searchData.results.length > 0) {
                            // Format search results for AI
                            const formattedResults = searchData.results.map((r, i) => 
                                `${i + 1}. ${r.title}\n   URL: ${r.url}\n   ${r.snippet || 'No description'}`
                            ).join('\n\n');
                            
                            // Add search results to conversation (hidden from UI with _hidden flag)
                            conversationHistory.push({ 
                                role: 'system',
                                parts: [{ text: `Search results:\n${formattedResults}` }],
                                _hidden: true // Mark as hidden from UI
                            });
                            
                            // Ask AI to answer using search results (also hidden)
                            conversationHistory.push({
                                role: 'user',
                                parts: [{ text: `Answer my previous question using these search results:\n${formattedResults}` }],
                                _hidden: true // Mark as hidden from UI
                            });
                            saveConversation(); // Save before making next AI call
                            
                            // Remove searching message
                            searchingMsg.remove();
                            
                            // Call AI again with search results
                            await sendToQwenAI(`Answer my previous question using these search results:\n${formattedResults}`);
                        } else {
                            searchingMsg.remove();
                            addMessage('‚ùå No search results found. Please try rephrasing your question.', false);
                        }
                    } catch (searchError) {
                        console.error('Search error:', searchError);
                        searchingMsg.remove();
                        addMessage('‚ùå Search failed. Please try again.', false);
                    }
                    
                    return; // Don't add the [SEARCH:...] message to UI
                }
                
                // Check if AI requested weather
                const weatherMatch = fullResponse.match(/\[WEATHER:\s*(.+?)\]/);
                if (weatherMatch) {
                    const cityName = weatherMatch[1].trim();
                    console.log('üå§Ô∏è AI requested weather:', cityName);
                    
                    // Remove the streaming message
                    streamingDiv.remove();
                    
                    // Show weather loading indicator
                    const weatherMsg = addMessage('üå§Ô∏è Getting weather data...', false);
                    
                    try {
                        // Call backend weather API
                        const weatherResponse = await fetch('/api/weather', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ city: cityName })
                        });
                        
                        const weatherData = await weatherResponse.json();
                        console.log('Weather data:', weatherData);
                        
                        if (weatherData.success && weatherData.weather) {
                            // Format weather data for AI
                            const formattedWeather = weatherData.formatted;
                            
                            // Add weather data to conversation (hidden from UI)
                            conversationHistory.push({ 
                                role: 'system',
                                parts: [{ text: `Weather data:\n${formattedWeather}` }],
                                _hidden: true
                            });
                            
                            // Ask AI to answer using weather data
                            conversationHistory.push({
                                role: 'user',
                                parts: [{ text: `Answer my previous question using this weather data:\n${formattedWeather}` }],
                                _hidden: true
                            });
                            saveConversation();
                            
                            // Remove weather message
                            weatherMsg.remove();
                            
                            // Call AI again with weather data
                            await sendToQwenAI(`Answer my previous question using this weather data:\n${formattedWeather}`);
                        } else {
                            weatherMsg.remove();
                            addMessage(`‚ùå Could not get weather for "${cityName}". Please check the city name.`, false);
                        }
                    } catch (weatherError) {
                        console.error('Weather error:', weatherError);
                        weatherMsg.remove();
                        addMessage('‚ùå Weather service failed. Please try again.', false);
                    }
                    
                    return; // Don't add the [WEATHER:...] message to UI
                }
                
                // Now format the complete response (only once, after streaming is done)
                cursor.remove();
                textContainer.innerHTML = formatAIContent(fullResponse);
                
                // Add AI response to history
                if (fullResponse) {
                    conversationHistory.push({ role: 'model', parts: [{ text: fullResponse }] });
                    saveConversation(); // Auto-save after AI response
                }
                
            } catch (error) {
                console.error('AI error:', error);
                streamingDiv?.remove();
                addMessage('Sorry, I encountered an error. Please try again.', false);
            }
        }

        function sendCommand(command) {
            messageInput.value = command + ' ';
            messageInput.focus();
        }

        function addMessage(content, isUser = false) {
            const messageDiv = document.createElement('div');
            messageDiv.className = isUser ? 'flex gap-3 flex-row-reverse group' : 'flex gap-3 group';
            
            const avatar = isUser 
                ? '<div class="bg-center bg-no-repeat aspect-square bg-cover rounded-full size-8 shrink-0 self-end mb-1 bg-primary"></div>'
                : '<div class="bg-center bg-no-repeat aspect-square bg-cover rounded-full size-8 shrink-0 self-end mb-1 ring-2 ring-transparent group-hover:ring-primary/20 transition-all" style=\'background-image: url("/wavechat.png");\'></div>';
            
            const bubbleClass = isUser 
                ? 'bg-gradient-to-br from-primary to-sky-600 p-3.5 rounded-2xl rounded-br-none shadow-lg shadow-primary/10'
                : 'bg-surface-dark p-3.5 rounded-2xl rounded-bl-none border border-white/5 shadow-sm';
            
            const textClass = isUser ? 'text-white' : 'text-slate-200';
            
            // Format content with markdown-like formatting
            const formattedContent = formatAIContent(content);
            
            messageDiv.innerHTML = `
                ${avatar}
                <div class="flex flex-col gap-1 max-w-[85%]">
                    ${!isUser ? '<p class="text-[10px] font-medium text-slate-400 ml-1 mb-0.5">AI Assistant</p>' : ''}
                    <div class="${bubbleClass}">
                        <div class="text-sm leading-relaxed ${textClass}">${formattedContent}</div>
                    </div>
                    ${isUser ? '<span class="text-[10px] font-medium text-slate-500 mr-1 opacity-0 group-hover:opacity-100 transition-opacity">' + new Date().toLocaleTimeString('en-US', {hour: '2-digit', minute: '2-digit'}) + '</span>' : ''}
                </div>
            `;
            
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            return messageDiv; // Return the element so it can be manipulated
        }

        // Get language flag emoji
        function getLanguageFlag(language) {
            const flags = {
                'Spanish': 'üá™üá∏', 'French': 'üá´üá∑', 'German': 'üá©üá™', 'Italian': 'üáÆüáπ',
                'Portuguese': 'üáµüáπ', 'Russian': 'üá∑üá∫', 'Chinese': 'üá®üá≥', 'Japanese': 'üáØüáµ',
                'Korean': 'üá∞üá∑', 'Arabic': 'üá∏üá¶', 'Hindi': 'üáÆüá≥', 'Turkish': 'üáπüá∑',
                'Polish': 'üáµüá±', 'Dutch': 'üá≥üá±', 'Ukrainian': 'üá∫üá¶', 'Swedish': 'üá∏üá™',
                'Greek': 'üá¨üá∑', 'Czech': 'üá®üáø', 'English': 'üá¨üáß'
            };
            return flags[language] || 'üåê';
        }

        function formatAIContent(content) {
            const trimmedContent = content.trim();
            
            // Check if it's standalone JSON
            let cleanContent = trimmedContent;
            if (cleanContent.toLowerCase().startsWith('json')) {
                cleanContent = cleanContent.substring(4).trim();
            }
            
            // Check if the cleaned content is a JSON object
            if (cleanContent.startsWith('{') && cleanContent.endsWith('}')) {
                try {
                    // Replace any weird whitespace with regular spaces
                    cleanContent = cleanContent.replace(/\s+/g, ' ');
                    const parsed = JSON.parse(cleanContent);
                    
                    // Check if it's a translation JSON (has original, translation, language)
                    if (parsed.original && parsed.translation && parsed.language) {
                        // Render as beautiful translation card
                        const flag = getLanguageFlag(parsed.language);
                        return `<div class="bg-gradient-to-br from-slate-800 to-slate-900 rounded-2xl shadow-xl p-6 border border-primary/20 hover:border-primary/40 transition-all duration-300 my-3">
                            <div class="flex items-center gap-2 mb-4">
                                <span class="text-2xl">${flag}</span>
                                <h3 class="text-xl font-bold text-white">Translation</h3>
                            </div>
                            <div class="space-y-3">
                                <div class="bg-slate-900/50 rounded-xl p-3 border border-white/5">
                                    <span class="text-xs font-semibold text-slate-400 uppercase tracking-wider">Original</span>
                                    <p class="text-base text-slate-200 mt-1">${parsed.original}</p>
                                </div>
                                <div class="bg-gradient-to-r from-primary/10 to-sky-500/10 rounded-xl p-3 border border-primary/30">
                                    <span class="text-xs font-semibold text-primary uppercase tracking-wider">Translation</span>
                                    <p class="text-lg text-white font-medium mt-1">${parsed.translation}</p>
                                </div>
                                <div class="flex items-center gap-2 text-sm">
                                    <span class="text-slate-400">Language:</span>
                                    <span class="px-3 py-1 rounded-full bg-primary/20 text-primary font-semibold">${parsed.language}</span>
                                </div>
                            </div>
                        </div>`;
                    }
                    
                    // Otherwise, render as code block
                    const formattedJson = JSON.stringify(parsed, null, 2);
                    return `<div class="my-3 rounded-lg overflow-hidden border border-slate-700">
                        <div class="bg-slate-800/80 px-3 py-1.5 flex items-center justify-between border-b border-slate-700">
                            <span class="text-xs font-semibold text-slate-400 uppercase">json</span>
                            <button onclick="copyCode(this)" class="text-xs text-slate-400 hover:text-primary transition-colors flex items-center gap-1">
                                <span class="material-symbols-outlined text-[14px]">content_copy</span>
                                Copy
                            </button>
                        </div>
                        <pre class="bg-slate-900 p-3 overflow-x-auto"><code class="text-primary font-mono text-sm">${formattedJson}</code></pre>
                    </div>`;
                } catch (e) {
                    console.error('Failed to parse JSON:', e);
                    console.error('Content was:', cleanContent);
                    // Not valid JSON, continue with normal formatting
                }
            }
            
            // Extract and process code blocks BEFORE escaping HTML
            let codeBlocks = [];
            let codeBlockCounter = 0;
            
            // Replace code blocks with placeholders
            let contentWithPlaceholders = content.replace(/```(\w+)?\n([\s\S]+?)```/g, function(match, lang, code) {
                const placeholder = `___CODE_BLOCK_${codeBlockCounter}___`;
                const language = lang || 'code';
                const uniqueId = `code-block-${Date.now()}-${codeBlockCounter}`;
                
                // Get the raw code
                let rawCode = code.trim();
                
                // Detect if it's JSON and format it
                if (language === 'json' || (language === 'text' && (rawCode.startsWith('{') || rawCode.startsWith('[')))) {
                    try {
                        const parsed = JSON.parse(rawCode);
                        rawCode = JSON.stringify(parsed, null, 2);
                    } catch (e) {
                        // Not valid JSON, keep as is
                    }
                }
                
                // Count actual lines
                const lineCount = rawCode.split(/\r?\n/).length;
                
                // Escape HTML for display but preserve line breaks
                const escapedCode = rawCode
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/"/g, '&quot;')
                    .replace(/'/g, '&#039;');
                
                const languageLabel = `<span class="text-xs font-semibold text-slate-400 uppercase">${language}</span>`;
                
                // Store the formatted code block
                codeBlocks[codeBlockCounter] = `<div class="my-3 rounded-xl overflow-hidden border border-slate-700 bg-slate-900/50">
                    <div class="bg-gradient-to-r from-slate-800 to-slate-800/80 px-4 py-2.5 flex items-center justify-between border-b border-slate-700/50">
                        <div class="flex items-center gap-3">
                            ${languageLabel}
                            <span class="text-xs text-slate-500 font-medium">${lineCount} ${lineCount === 1 ? 'line' : 'lines'}</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <button onclick="copyCodeFromCollapsed('${uniqueId}')" class="px-2.5 py-1.5 text-xs text-slate-400 hover:text-white hover:bg-slate-700 rounded-lg transition-all flex items-center gap-1.5">
                                <span class="material-symbols-outlined text-[14px]">content_copy</span>
                                Copy
                            </button>
                            <button onclick="toggleCodeBlock('${uniqueId}')" class="px-2.5 py-1.5 text-xs text-primary hover:text-white hover:bg-primary/20 rounded-lg transition-all flex items-center gap-1.5 font-medium">
                                <span class="material-symbols-outlined text-[16px]" id="${uniqueId}-icon">expand_more</span>
                                <span id="${uniqueId}-text">Show</span>
                            </button>
                        </div>
                    </div>
                    <div id="${uniqueId}" class="hidden">
                        <pre class="bg-slate-950 p-4 overflow-x-auto max-h-[600px] text-sm leading-relaxed"><code class="text-emerald-400 font-mono whitespace-pre">${escapedCode}</code></pre>
                    </div>
                </div>`;
                
                codeBlockCounter++;
                return placeholder;
            });
            
            // Now escape the rest of the HTML (non-code content)
            const div = document.createElement('div');
            div.textContent = contentWithPlaceholders;
            let formatted = div.innerHTML;
            
            // Restore code blocks from placeholders
            for (let i = 0; i < codeBlocks.length; i++) {
                formatted = formatted.replace(`___CODE_BLOCK_${i}___`, codeBlocks[i]);
            }
            
            // Format headings (###, ##, #) - removed arrow symbols
            formatted = formatted.replace(/^### (.+)$/gm, '<h3 class="text-lg font-bold text-white mt-4 mb-2">$1</h3>');
            formatted = formatted.replace(/^## (.+)$/gm, '<h2 class="text-xl font-bold text-white mt-4 mb-2">$1</h2>');
            formatted = formatted.replace(/^# (.+)$/gm, '<h1 class="text-2xl font-bold text-white mt-4 mb-2">$1</h1>');
            
            // Format bold text (**text**)
            formatted = formatted.replace(/\*\*(.+?)\*\*/g, '<strong class="font-semibold text-white">$1</strong>');
            
            // Format italic text (*text* or _text_)
            formatted = formatted.replace(/\*(.+?)\*/g, '<em class="italic text-slate-300">$1</em>');
            formatted = formatted.replace(/_(.+?)_/g, '<em class="italic text-slate-300">$1</em>');
            
            // Format inline code (`code`)
            formatted = formatted.replace(/`([^`]+)`/g, '<code class="bg-slate-800 px-2 py-0.5 rounded text-primary font-mono text-xs border border-slate-700">$1</code>');
            
            // Format links [text](url)
            formatted = formatted.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank" class="text-primary hover:text-sky-400 underline decoration-primary/30 hover:decoration-sky-400 transition-colors">$1 <span class="material-symbols-outlined text-[12px] align-middle">open_in_new</span></a>');
            
            // Format unordered lists (- item or * item)
            formatted = formatted.replace(/^[‚Ä¢\-\*] (.+)$/gm, '<li class="ml-4 flex items-start gap-2"><span class="text-primary mt-1">‚Ä¢</span><span>$1</span></li>');
            
            // Format numbered lists (1. item)
            let listCounter = 0;
            formatted = formatted.replace(/^\d+\. (.+)$/gm, function(match, text) {
                listCounter++;
                return `<li class="ml-4 flex items-start gap-2"><span class="text-primary font-semibold min-w-[20px]">${listCounter}.</span><span>${text}</span></li>`;
            });
            
            // Wrap consecutive list items in ul
            formatted = formatted.replace(/(<li class="ml-4[^>]*>.*?<\/li>\n?)+/g, function(match) {
                return '<ul class="my-2 space-y-1.5">' + match + '</ul>';
            });
            
            // Format blockquotes (> text)
            formatted = formatted.replace(/^&gt; (.+)$/gm, '<blockquote class="border-l-4 border-primary/50 bg-slate-800/30 pl-4 py-2 italic text-slate-300 my-2 rounded-r">$1</blockquote>');
            
            // Format horizontal rules (---)
            formatted = formatted.replace(/^---$/gm, '<hr class="border-slate-700 my-4">');
            
            // Format checkboxes
            formatted = formatted.replace(/\[x\]/gi, '<span class="inline-flex items-center justify-center w-4 h-4 rounded bg-green-500/20 text-green-500 text-xs">‚úì</span>');
            formatted = formatted.replace(/\[ \]/g, '<span class="inline-flex items-center justify-center w-4 h-4 rounded bg-slate-700 text-slate-500 text-xs">‚òê</span>');
            
            // Format tables (basic support)
            formatted = formatted.replace(/\|(.+)\|/g, function(match) {
                const cells = match.split('|').filter(c => c.trim());
                return '<tr>' + cells.map(c => `<td class="border border-slate-700 px-2 py-1">${c.trim()}</td>`).join('') + '</tr>';
            });
            
            // Wrap table rows
            formatted = formatted.replace(/(<tr>.*?<\/tr>\n?)+/g, function(match) {
                return '<table class="my-2 border-collapse w-full text-sm">' + match + '</table>';
            });
            
            // Format line breaks
            formatted = formatted.replace(/\n/g, '<br>');

            return formatted;
        }

        // Copy code to clipboard
        function copyCode(button) {
            try {
                // Find the code block - it's in the next sibling (pre element)
                const container = button.closest('.rounded-lg');
                const codeBlock = container.querySelector('code');
                
                if (!codeBlock) {
                    console.error('Code block not found');
                    return;
                }
                
                const text = codeBlock.textContent;
                
                navigator.clipboard.writeText(text).then(() => {
                    const originalText = button.innerHTML;
                    button.innerHTML = '<span class="material-symbols-outlined text-[14px]">check</span>Copied!';
                    button.classList.add('text-green-500');
                    
                    setTimeout(() => {
                        button.innerHTML = originalText;
                        button.classList.remove('text-green-500');
                    }, 2000);
                }).catch(err => {
                    console.error('Failed to copy:', err);
                    alert('Failed to copy to clipboard');
                });
            } catch (error) {
                console.error('Copy error:', error);
            }
        }

        // Toggle collapsible code block
        function toggleCodeBlock(blockId) {
            const codeBlock = document.getElementById(blockId);
            const icon = document.getElementById(blockId + '-icon');
            const text = document.getElementById(blockId + '-text');
            
            if (codeBlock.classList.contains('hidden')) {
                // Show code
                codeBlock.classList.remove('hidden');
                icon.textContent = 'expand_less';
                text.textContent = 'Hide';
            } else {
                // Hide code
                codeBlock.classList.add('hidden');
                icon.textContent = 'expand_more';
                text.textContent = 'Show';
            }
        }

        // Copy code from collapsed block (without opening it)
        function copyCodeFromCollapsed(blockId) {
            const codeBlock = document.getElementById(blockId);
            const codeElement = codeBlock.querySelector('code');
            
            if (!codeElement) {
                console.error('Code element not found');
                return;
            }
            
            const text = codeElement.textContent;
            
            navigator.clipboard.writeText(text).then(() => {
                // Find the copy button
                const container = codeBlock.closest('.rounded-lg');
                const copyButton = container.querySelector('button[onclick*="copyCodeFromCollapsed"]');
                
                if (copyButton) {
                    const originalHTML = copyButton.innerHTML;
                    copyButton.innerHTML = '<span class="material-symbols-outlined text-[14px]">check</span>Copied!';
                    copyButton.classList.add('text-green-500');
                    
                    setTimeout(() => {
                        copyButton.innerHTML = originalHTML;
                        copyButton.classList.remove('text-green-500');
                    }, 2000);
                }
            }).catch(err => {
                console.error('Failed to copy:', err);
                alert('Failed to copy to clipboard');
            });
        }

        // ===== CHAT SAVING FUNCTIONS =====
        
        function saveCurrentChat() {
            if (conversationHistory.length === 0) {
                alert('No conversation to save!');
                return;
            }
            document.getElementById('saveChatModal').classList.remove('hidden');
            document.getElementById('chatNameInput').focus();
        }

        function closeSaveChatModal() {
            document.getElementById('saveChatModal').classList.add('hidden');
            document.getElementById('chatNameInput').value = '';
        }

        function confirmSaveChat() {
            const chatName = document.getElementById('chatNameInput').value.trim();
            if (!chatName) {
                alert('Please enter a chat name');
                return;
            }

            // Get existing saved chats
            const savedChats = JSON.parse(localStorage.getItem('aiSavedChats') || '[]');
            
            // Create new chat object
            const newChat = {
                id: Date.now(),
                name: chatName,
                timestamp: new Date().toISOString(),
                history: conversationHistory,
                model: localStorage.getItem('preferredAIModel') || 'wave-flash-2',
                messageCount: conversationHistory.length
            };

            // Add to saved chats
            savedChats.unshift(newChat); // Add to beginning
            
            // Keep only last 50 chats
            if (savedChats.length > 50) {
                savedChats.pop();
            }

            // Save to localStorage
            localStorage.setItem('aiSavedChats', JSON.stringify(savedChats));
            
            closeSaveChatModal();
            
            // Show success message
            const successDiv = document.createElement('div');
            successDiv.className = 'fixed top-20 right-6 bg-primary text-white px-6 py-3 rounded-xl shadow-lg z-50 animate-fade-in';
            successDiv.innerHTML = `
                <div class="flex items-center gap-2">
                    <span class="material-symbols-outlined">check_circle</span>
                    <span>Chat saved successfully!</span>
                </div>
            `;
            document.body.appendChild(successDiv);
            setTimeout(() => successDiv.remove(), 3000);
        }

        function showSavedChats() {
            const savedChats = JSON.parse(localStorage.getItem('aiSavedChats') || '[]');
            const listContainer = document.getElementById('savedChatsList');
            
            if (savedChats.length === 0) {
                listContainer.innerHTML = `
                    <div class="text-center py-12 text-slate-400">
                        <span class="material-symbols-outlined text-5xl mb-3 opacity-50">bookmark_border</span>
                        <p>No saved chats yet</p>
                        <p class="text-xs mt-2">Save your conversations to access them later</p>
                    </div>
                `;
            } else {
                listContainer.innerHTML = savedChats.map(chat => {
                    const date = new Date(chat.timestamp);
                    const dateStr = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                    const timeStr = date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
                    
                    return `
                        <div class="bg-background-dark rounded-xl p-4 border border-white/5 hover:border-primary/30 transition-all group cursor-pointer">
                            <div class="flex items-start justify-between gap-3">
                                <div class="flex-1" onclick="loadSavedChat(${chat.id})">
                                    <h4 class="font-semibold text-white group-hover:text-primary transition-colors">${chat.name}</h4>
                                    <p class="text-xs text-slate-400 mt-1">${chat.messageCount} messages ‚Ä¢ ${dateStr} at ${timeStr}</p>
                                    <p class="text-xs text-slate-500 mt-1">Model: ${chat.model.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}</p>
                                </div>
                                <button onclick="deleteSavedChat(${chat.id}); event.stopPropagation();" class="text-slate-400 hover:text-red-400 transition-colors p-2" title="Delete">
                                    <span class="material-symbols-outlined text-[20px]">delete</span>
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');
            }
            
            document.getElementById('savedChatsModal').classList.remove('hidden');
        }

        function closeSavedChatsModal() {
            document.getElementById('savedChatsModal').classList.add('hidden');
        }

        function loadSavedChat(chatId) {
            const savedChats = JSON.parse(localStorage.getItem('aiSavedChats') || '[]');
            const chat = savedChats.find(c => c.id === chatId);
            
            if (!chat) {
                alert('Chat not found');
                return;
            }

            // Clear current chat
            clearChat(false);
            
            // Load conversation history
            conversationHistory = chat.history;
            
            // Render messages
            chat.history.forEach(msg => {
                const isUser = msg.role === 'user';
                const content = msg.parts[0].text;
                addMessage(content, isUser);
            });
            
            closeSavedChatsModal();
            
            // Show success message
            const successDiv = document.createElement('div');
            successDiv.className = 'fixed top-20 right-6 bg-primary text-white px-6 py-3 rounded-xl shadow-lg z-50';
            successDiv.innerHTML = `
                <div class="flex items-center gap-2">
                    <span class="material-symbols-outlined">history</span>
                    <span>Chat loaded: ${chat.name}</span>
                </div>
            `;
            document.body.appendChild(successDiv);
            setTimeout(() => successDiv.remove(), 3000);
        }

        function deleteSavedChat(chatId) {
            if (!confirm('Delete this chat? This cannot be undone.')) {
                return;
            }
            
            let savedChats = JSON.parse(localStorage.getItem('aiSavedChats') || '[]');
            savedChats = savedChats.filter(c => c.id !== chatId);
            localStorage.setItem('aiSavedChats', JSON.stringify(savedChats));
            
            // Refresh the list
            showSavedChats();
        }

        function clearChat(showConfirm = true) {
            if (showConfirm && conversationHistory.length > 0) {
                if (!confirm('Start a new chat? Current conversation will be lost if not saved.')) {
                    return;
                }
            }
            
            // Clear conversation history
            conversationHistory = [];
            
            // Clear saved conversation from localStorage
            localStorage.removeItem('aiCurrentConversation');
            
            // Clear messages container
            messagesContainer.innerHTML = `
                <div class="flex justify-center my-4">
                    <span class="text-[10px] font-semibold tracking-wider text-slate-500 uppercase bg-surface-dark px-3 py-1 rounded-full border border-white/5">Today</span>
                </div>
            `;
            
            // Reload welcome message
            loadAIStatus();
        }

        // Load AI status on page load
        async function loadAIStatus() {
            // Get preferred model from localStorage
            const preferredModel = localStorage.getItem('preferredAIModel');
            const modelName = preferredModel ? preferredModel.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase()) : 'Wave Flash 2';
            
            // Add welcome message without HTML tags
            const welcomeDiv = document.createElement('div');
            welcomeDiv.className = 'flex gap-3 group';
            welcomeDiv.innerHTML = `
                <div class="bg-center bg-no-repeat aspect-square bg-cover rounded-full size-8 shrink-0 self-end mb-1 ring-2 ring-transparent group-hover:ring-primary/20 transition-all" style='background-image: url("/wavechat.png");'></div>
                <div class="flex flex-col gap-1 max-w-[85%]">
                    <p class="text-[10px] font-medium text-slate-400 ml-1 mb-0.5">AI Assistant</p>
                    <div class="bg-surface-dark p-3.5 rounded-2xl rounded-bl-none border border-white/5 shadow-sm">
                        <div class="text-sm leading-relaxed text-slate-200">
                            Hello! I'm your Wave AI assistant üåä<br><br>
                            I can help you translate, summarize, write code, and explain topics. Use the buttons below or just chat with me!
                        </div>
                        <div class="text-[10px] text-slate-500 mt-2">Currently using: ${modelName} ‚Ä¢ Change in Settings</div>
                    </div>
                </div>
            `;
            messagesContainer.appendChild(welcomeDiv);
        }

        loadAIStatus();
    </script>
    
    <!-- Bottom Navigation (Desktop Sidebar Style) -->
    <nav class="hidden lg:block fixed bottom-6 left-6 z-50">
        <div class="p-2 bg-[#0b1418] border border-slate-800/40 rounded-xl shadow-2xl">
            <div class="flex items-center gap-1 rounded-xl bg-background-dark p-1">
                <a class="flex flex-col items-center justify-center p-2 rounded-lg text-[#90bccb] hover:text-white hover:bg-surface-hover transition-colors" href="/chat.html" title="Chats">
                    <span class="material-symbols-outlined text-[24px]">chat_bubble</span>
                    <span class="text-[10px] font-medium mt-1">Chats</span>
                </a>
                <a class="flex flex-col items-center justify-center p-2 rounded-lg text-primary bg-primary/10 transition-colors" href="/ai-chat.html" title="AI">
                    <span class="material-symbols-outlined text-[24px]">smart_toy</span>
                    <span class="text-[10px] font-medium mt-1">AI</span>
                </a>
                <a class="flex flex-col items-center justify-center p-2 rounded-lg text-[#90bccb] hover:text-white hover:bg-surface-hover transition-colors" href="/feed.html" title="Feed">
                    <span class="material-symbols-outlined text-[24px]">newspaper</span>
                    <span class="text-[10px] font-medium mt-1">Feed</span>
                </a>
                <a class="flex flex-col items-center justify-center p-2 rounded-lg text-[#90bccb] hover:text-white hover:bg-surface-hover transition-colors" href="/music.html" title="Music">
                    <span class="material-symbols-outlined text-[24px]">music_note</span>
                    <span class="text-[10px] font-medium mt-1">Music</span>
                </a>
                <a class="flex flex-col items-center justify-center p-2 rounded-lg text-[#90bccb] hover:text-white hover:bg-surface-hover transition-colors" href="/profile.html" title="Profile">
                    <span class="material-symbols-outlined text-[24px]">person</span>
                    <span class="text-[10px] font-medium mt-1">Profile</span>
                </a>
                <a class="flex flex-col items-center justify-center p-2 rounded-lg text-[#90bccb] hover:text-white hover:bg-surface-hover transition-colors" href="/settings.html" title="Settings">
                    <span class="material-symbols-outlined text-[24px]">settings</span>
                    <span class="text-[10px] font-medium mt-1">Settings</span>
                </a>
            </div>
        </div>
    </nav>
    
    <!-- Mobile Bottom Navigation -->
    <nav class="lg:hidden fixed bottom-0 left-0 right-0 z-50 bg-surface-dark/95 backdrop-blur-lg border-t border-slate-800">
        <div class="flex justify-between items-center h-20 px-6 pb-2">
            <a href="/chat.html" class="flex flex-col items-center gap-1 w-12 text-slate-400 hover:text-slate-200 transition-colors">
                <span class="material-symbols-outlined" style="font-size: 24px;">chat_bubble</span>
                <span class="text-[10px] font-medium">Chats</span>
            </a>
            
            <a href="/music.html" class="flex flex-col items-center gap-1 w-12 text-slate-400 hover:text-slate-200 transition-colors">
                <span class="material-symbols-outlined" style="font-size: 24px;">music_note</span>
                <span class="text-[10px] font-medium">Music</span>
            </a>
            
            <a href="/feed.html" class="flex flex-col items-center justify-center -mt-6">
                <div class="w-14 h-14 rounded-full bg-gradient-to-tr from-primary to-blue-400 shadow-[0_8px_16px_rgba(43,140,238,0.3)] flex items-center justify-center text-white transform active:scale-95 transition-transform">
                    <span class="material-symbols-outlined" style="font-size: 28px;">newspaper</span>
                </div>
            </a>
            
            <a href="/ai-chat.html" class="flex flex-col items-center gap-1 w-12 text-primary transition-colors">
                <div class="w-10 h-8 flex items-center justify-center bg-primary/10 rounded-full">
                    <span class="material-symbols-outlined fill-current" style="font-size: 24px;">smart_toy</span>
                </div>
                <span class="text-[10px] font-semibold">AI</span>
            </a>
            
            <a href="/profile.html" class="flex flex-col items-center gap-1 w-12 text-slate-400 hover:text-slate-200 transition-colors">
                <div class="w-6 h-6 rounded-full overflow-hidden bg-slate-700 ring-2 ring-transparent hover:ring-primary transition-all">
                    <span class="material-symbols-outlined text-slate-400 text-[20px]">person</span>
                </div>
                <span class="text-[10px] font-medium">Profile</span>
            </a>
        </div>
    </nav>
</body>
</html>
